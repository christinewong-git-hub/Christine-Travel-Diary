<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Christine's Travel Diary</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue.js 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Remix Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
    rel="stylesheet"
  />
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <!-- Leaflet CSS & JS (OpenStreetMap) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#97CBFF',
            secondary: '#C7C7E2',
            bgLight: '#ECF5FF',
            white: '#FFFFFF',
            textMain: '#4A5568',
            textSoft: '#A0AEC0'
          },
          fontFamily: {
            sans: ['"Noto Sans TC"', 'system-ui', 'sans-serif']
          }
        }
      }
    };
  </script>
  <style>
    body {
      background: radial-gradient(circle at top left, #ECF5FF 0, #FFFFFF 40%, #ECF5FF 100%);
      font-family: 'Noto Sans TC', system-ui, sans-serif;
      color: #1a202c;
    }
    .app-shell {
      max-width: 1024px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 16px;
    }
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(151, 203, 255, 0.8);
      border-radius: 999px;
    }
    #map {
      min-height: 280px;
      border-radius: 16px;
    }

    /* Flight sky background + moving clouds */
    .flight-sky {
      position: relative;
      overflow: hidden;
    }
    .cloud {
      position: absolute;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 999px;
      filter: blur(0.5px);
      animation: cloud-move 40s linear infinite;
    }
    .cloud::before,
    .cloud::after {
      content: '';
      position: absolute;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 999px;
    }
    .cloud::before {
      width: 60%;
      height: 80%;
      top: -40%;
      left: 10%;
    }
    .cloud::after {
      width: 50%;
      height: 70%;
      top: -30%;
      right: 5%;
    }
    @keyframes cloud-move {
      0% { transform: translateX(-120%); }
      100% { transform: translateX(120%); }
    }

    /* Weather theme backgrounds */
    .weather-card {
      position: relative;
      overflow: hidden;
    }
    .weather-sunny {
      background: radial-gradient(circle at top, #ffeaa7 0, #ffffff 45%, #dff6ff 100%);
    }
    .weather-cloudy {
      background: radial-gradient(circle at top, #dfe6e9 0, #ffffff 40%, #cfd9df 100%);
    }
    .weather-rainy {
      background: radial-gradient(circle at top, #a5b1c2 0, #dfe6e9 40%, #8395a7 100%);
    }
    .sun-icon {
      position: absolute;
      top: -18px;
      right: -18px;
      width: 64px;
      height: 64px;
      background: radial-gradient(circle at center, #ffeaa7 0, #fdcb6e 65%, #e17055 100%);
      border-radius: 999px;
      box-shadow: 0 0 20px rgba(253, 203, 110, 0.6);
      animation: sun-pulse 3s ease-in-out infinite;
    }
    @keyframes sun-pulse {
      0%, 100% { transform: scale(1); opacity: 0.95; }
      50% { transform: scale(1.05); opacity: 1; }
    }
    .rain-drop {
      position: absolute;
      width: 2px;
      height: 16px;
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(52, 152, 219, 0.7));
      border-radius: 999px;
      animation: rain-fall 1.2s linear infinite;
    }
    @keyframes rain-fall {
      0% { transform: translateY(-10px); opacity: 0; }
      50% { opacity: 1; }
      100% { transform: translateY(30px); opacity: 0; }
    }
  </style>
</head>
<body>
<div id="app" class="app-shell flex flex-col gap-4">

  <!-- Top Bar -->
  <header class="flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-primary flex items-center justify-center text-white text-xl shadow-md">
        <i class="ri-earth-line"></i>
      </div>
      <div>
        <div class="text-xs tracking-wide text-textSoft uppercase">
          Christine's Travel Diary
        </div>
        <div class="text-sm font-semibold text-textMain flex items-center gap-1">
          <i class="ri-sparkling-fill text-primary text-base"></i>
          <span>Travel Dashboard</span>
        </div>
      </div>
    </div>
    <button
      @click="handleTripManagerClick"
      class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-secondary bg-white text-xs text-textMain hover:bg-bgLight/60"
    >
      <i class="ri-suitcase-3-line text-sm text-primary"></i>
      <span>æ—…ç¨‹ç®¡ç†</span>
      <span class="text-[10px] text-textSoft">({{ trips.length }})</span>
    </button>
  </header>

  <!-- Tabs -->
  <nav
    class="rounded-2xl border border-secondary/60 bg-white/90 backdrop-blur-sm px-2 py-1 flex flex-wrap gap-1 text-[11px]"
  >
    <button
      v-for="tab in tabs"
      :key="tab.id"
      @click="activeTab = tab.id"
      :class="[
        'flex-1 min-w-[80px] flex items-center justify-center gap-1 px-2 py-1.5 rounded-xl transition',
        activeTab === tab.id
          ? 'bg-primary text-white shadow-sm'
          : 'text-textSoft hover:bg-bgLight/80'
      ]"
    >
      <i :class="tab.icon" class="text-xs"></i>
      <span>{{ tab.label }}</span>
    </button>
  </nav>

  <!-- TAB: Trip Info -->
  <section
    v-if="activeTab === 'info' && activeTrip"
    class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-4"
  >
    <div class="flex flex-col md:flex-row gap-4">
      <!-- Flight Card: sky + moving clouds -->
      <div class="flex-1 rounded-2xl flight-sky bg-gradient-to-br from-sky-300 via-sky-400 to-sky-600 text-white p-4 shadow-md">
        <!-- Moving clouds -->
        <div class="cloud" style="top: 10%; left: -40%; width: 120px; height: 48px; animation-duration: 45s;"></div>
        <div class="cloud" style="top: 45%; left: -60%; width: 160px; height: 60px; animation-duration: 55s; animation-delay: -10s;"></div>
        <div class="cloud" style="top: 75%; left: -50%; width: 130px; height: 52px; animation-duration: 50s; animation-delay: -5s;"></div>

        <div class="relative flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <i class="ri-flight-takeoff-line text-xl"></i>
            <span class="text-sm font-semibold">Flight Details</span>
          </div>
          <span class="text-[11px] bg-white/20 px-2 py-0.5 rounded-full">
            Round Trip
          </span>
        </div>

        <div class="relative grid grid-cols-1 md:grid-cols-2 gap-3 text-[11px]">
          <!-- Outbound -->
          <div class="bg-white/10 rounded-xl p-3 space-y-1">
            <div class="flex items-center gap-1 text-white/80 mb-1">
              <i class="ri-arrow-right-up-line text-xs"></i>
              <span>å»ç¨‹</span>
            </div>
            <div class="flex items-baseline gap-2">
              <input
                v-model="activeTrip.flights.outbound.no"
                class="bg-transparent border-b border-white/50 text-xs font-semibold outline-none flex-1"
                placeholder="Flight No (e.g. NH924)"
              />
              <input
                v-model="activeTrip.flights.outbound.date"
                class="bg-transparent border-b border-white/40 text-[11px] outline-none w-24"
                placeholder="YYYY-MM-DD"
              />
            </div>
            <div class="flex items-center gap-2 mt-1">
              <input
                v-model="activeTrip.flights.outbound.from"
                class="bg-white/10 rounded-lg px-2 py-1 text-[11px] outline-none w-20 text-center"
                placeholder="HKG"
              />
              <i class="ri-arrow-right-line text-xs text-white/70"></i>
              <input
                v-model="activeTrip.flights.outbound.to"
                class="bg-white/10 rounded-lg px-2 py-1 text-[11px] outline-none w-20 text-center"
                placeholder="HND"
              />
            </div>
            <div class="mt-2 flex justify-end">
              <button
                @click="autoFillFlight('outbound')"
                class="px-2 py-1 rounded-full bg-white/80 text-[10px] text-primary font-semibold hover:bg-white"
              >
                è‡ªå‹•å¡«å¯«å»ç¨‹
              </button>
            </div>
          </div>

          <!-- Inbound -->
          <div class="bg-white/10 rounded-xl p-3 space-y-1">
            <div class="flex items-center gap-1 text-white/80 mb-1">
              <i class="ri-arrow-left-down-line text-xs"></i>
              <span>å›ç¨‹</span>
            </div>
            <div class="flex items-baseline gap-2">
              <input
                v-model="activeTrip.flights.inbound.no"
                class="bg-transparent border-b border-white/50 text-xs font-semibold outline-none flex-1"
                placeholder="Flight No (e.g. NH923)"
              />
              <input
                v-model="activeTrip.flights.inbound.date"
                class="bg-transparent border-b border-white/40 text-[11px] outline-none w-24"
                placeholder="YYYY-MM-DD"
              />
            </div>
            <div class="flex items-center gap-2 mt-1">
              <input
                v-model="activeTrip.flights.inbound.from"
                class="bg-white/10 rounded-lg px-2 py-1 text-[11px] outline-none w-20 text-center"
                placeholder="HND"
              />
              <i class="ri-arrow-right-line text-xs text-white/70"></i>
              <input
                v-model="activeTrip.flights.inbound.to"
                class="bg-white/10 rounded-lg px-2 py-1 text-[11px] outline-none w-20 text-center"
                placeholder="HKG"
              />
            </div>
            <div class="mt-2 flex justify-end">
              <button
                @click="autoFillFlight('inbound')"
                class="px-2 py-1 rounded-full bg-white/80 text-[10px] text-primary font-semibold hover:bg-white"
              >
                è‡ªå‹•å¡«å¯«å›ç¨‹
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Weather Card with fantasy backgrounds -->
      <div
        class="w-full md:w-64 rounded-2xl weather-card border border-secondary/50 p-4 flex flex-col justify-between"
        :class="{
          'weather-sunny': weatherTheme === 'sunny',
          'weather-cloudy': weatherTheme === 'cloudy',
          'weather-rainy': weatherTheme === 'rainy'
        }"
      >
        <!-- Weather decoration -->
        <div v-if="weatherTheme === 'sunny'" class="sun-icon"></div>
        <div v-if="weatherTheme === 'rainy'">
          <div class="rain-drop" style="top: 10px; left: 30px;"></div>
          <div class="rain-drop" style="top: 18px; left: 55px; animation-delay: -0.4s;"></div>
          <div class="rain-drop" style="top: 6px; left: 80px; animation-delay: -0.8s;"></div>
        </div>

        <div class="flex items-center justify-between">
          <div class="flex flex-col gap-1">
            <span class="text-[11px] text-textSoft">Today Â· Weather</span>
            <div class="flex items-end gap-2">
              <span class="text-3xl font-semibold text-textMain">
                {{ weather.temp }}Â°
              </span>
              <span class="text-[11px] text-textSoft mb-1">
                {{ weather.desc }}
              </span>
            </div>
          </div>
          <button
            @click="fetchWeather"
            class="w-9 h-9 rounded-full bg-white/80 border border-secondary/50 flex items-center justify-center text-textSoft hover:text-textMain"
            title="æ›´æ–°å¤©æ°£"
          >
            <i class="ri-refresh-line text-xs"></i>
          </button>
        </div>
        <div class="mt-3 text-[11px] text-textSoft space-y-1">
          <div class="flex items-center gap-2">
            <i class="ri-building-2-line text-secondary"></i>
            <span>{{ activeTrip.city }}</span>
          </div>
          <div class="flex items-center gap-2">
            <i class="ri-map-pin-line text-secondary"></i>
            <span>{{ activeTrip.destination }}</span>
          </div>
          <div class="flex items-center gap-2">
            <i class="ri-time-line text-secondary"></i>
            <span>{{ activeTrip.startDate }} â†’ {{ activeTrip.endDate }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stat Strip -->
    <div class="grid md:grid-cols-3 gap-3 text-[11px]">
      <div class="rounded-xl bg-bgLight/80 border border-secondary/50 px-3 py-2 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="ri-map-pin-range-line text-primary"></i>
          <span class="text-textSoft">Stops</span>
        </div>
        <span class="font-semibold text-textMain">
          {{ activeTrip.itinerary.length }}
        </span>
      </div>
      <div class="rounded-xl bg-bgLight/80 border border-secondary/50 px-3 py-2 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="ri-wallet-3-line text-primary"></i>
          <span class="text-textSoft">Total Spend</span>
        </div>
        <span class="font-semibold text-textMain">
          {{ totalExpenseInCurrency.toLocaleString() }} {{ activeTrip.currency }}
        </span>
      </div>
      <div class="rounded-xl bg-bgLight/80 border border-secondary/50 px-3 py-2 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <i class="ri-exchange-dollar-line text-primary"></i>
          <span class="text-textSoft">FX Rate</span>
        </div>
        <span class="font-semibold text-textMain">
          1 HKD â‰ˆ {{ (activeTrip.exchangeRate || 0).toFixed(3) }} {{ activeTrip.currency }}
        </span>
      </div>
    </div>
  </section>

  <!-- TAB: Itinerary / Map -->
  <section v-if="activeTab === 'itinerary'" class="grid md:grid-cols-[minmax(0,2.2fr)_minmax(0,2.8fr)] gap-4">
    <!-- è¡Œç¨‹ Day å¡ç‰‡ï¼šæ›´å¤§ï¼‹æ›´å¤šæ¬„ä½ -->
    <div
      class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-3 max-h-[620px] overflow-x-auto overflow-y-auto"
    >
      <div class="flex items-center justify-between mb-1">
        <h2 class="text-sm font-semibold text-textMain flex items-center gap-1.5">
          <span class="inline-flex w-5 h-5 items-center justify-center rounded-lg bg-primary text-white text-[11px]">
            1
          </span>
          <span>è¡Œç¨‹æ™‚é–“è»¸</span>
        </h2>
        <button
          @click="addItineraryItem"
          class="text-[11px] px-2.5 py-1 rounded-full border border-secondary/70 text-textMain hover:bg-bgLight/80 flex items-center gap-1"
        >
          <i class="ri-add-line text-xs"></i>
          <span>æ–°å¢</span>
        </button>
      </div>

      <div
        v-if="activeTrip.itinerary.length === 0"
        class="text-[11px] text-textSoft py-6 text-center"
      >
        å°šæœªå»ºç«‹è¡Œç¨‹ï¼Œé»æ“Šã€Œæ–°å¢ã€æˆ–ä½¿ç”¨ä¸‹æ–¹ã€Œæ‰¹æ¬¡åŒ¯å…¥åœ°é»ã€ã€‚
      </div>

      <!-- Day Cards -->
      <div class="flex gap-3 overflow-x-auto pb-2">
        <div
          v-for="(dayItems, dayIndex) in groupedItinerary"
          :key="'day-card-' + dayIndex"
          class="min-w-[260px] h-[420px] rounded-2xl border border-secondary/50 bg-gradient-to-b from-bgLight to-white px-3 py-3 flex flex-col gap-2"
        >
          <div class="flex items-center justify-between mb-1">
            <div class="flex items-center gap-2">
              <span class="w-7 h-7 rounded-full bg-primary text-white text-[11px] flex items-center justify-center font-semibold shadow-sm">
                D{{ dayIndex + 1 }}
              </span>
              <div class="flex flex-col">
                <span class="text-[11px] text-textSoft">Day {{ dayIndex + 1 }}</span>
                <span class="text-[10px] text-textSoft">
                  {{ dayItems[0]?.time || '' }} {{ dayItems[0]?.location || '' }}
                </span>
              </div>
            </div>
            <span class="text-[10px] text-textSoft">
              {{ dayItems.length }} stops
            </span>
          </div>

          <div class="flex flex-col gap-2 overflow-y-auto pr-1">
            <div
              v-for="(item, idx) in dayItems"
              :key="'day-' + dayIndex + '-item-' + idx"
              class="flex items-start gap-2"
            >
              <div class="flex flex-col items-center">
                <span class="text-[11px] font-semibold text-textMain">
                  {{ item.time || 'â€”' }}
                </span>
                <div
                  v-if="idx < dayItems.length - 1"
                  class="flex-1 w-px bg-secondary/40 mt-0.5"
                ></div>
              </div>
              <div
                class="flex-1 bg-white/80 rounded-xl border border-secondary/40 px-2.5 py-1.5 text-[11px] shadow-[0_1px_3px_rgba(0,0,0,0.04)]"
              >
                <!-- æ´»å‹•åç¨± -->
                <input
                  v-model="item.activity"
                  class="w-full bg-transparent outline-none text-[11px] font-semibold text-textMain"
                  placeholder="æ´»å‹•åç¨±"
                  @change="updateRoute"
                />
                <!-- åœ°å€ / åœ°é» -->
                <input
                  v-model="item.location"
                  class="w-full bg-transparent outline-none text-[10px] text-textSoft mt-0.5"
                  placeholder="åœ°é» / åœ°å€"
                  @change="updateRoute"
                />
                <!-- Google Maps URL -->
                <input
                  v-model="item.mapsUrl"
                  class="w-full bg-bgLight/70 outline-none text-[10px] text-textSoft mt-1 px-2 py-1 rounded border border-secondary/40"
                  placeholder="è²¼ä¸Š Google Maps URLï¼ˆå¯é¸ï¼‰"
                />
                <!-- Booked + å‚™è¨» -->
                <div class="grid grid-cols-[1.1fr_1.9fr] gap-2 mt-1">
                  <!-- Booked time -->
                  <div class="flex flex-col gap-0.5">
                    <span class="text-[10px] text-textSoft">Booked</span>
                    <input
                      v-model="item.bookingTime"
                      class="w-full bg-bgLight/70 outline-none text-[10px] text-textMain px-2 py-1 rounded border border-secondary/40"
                      placeholder="e.g. 19:30 / 20:00"
                    />
                  </div>
                  <!-- å‚™è¨» -->
                  <div class="flex flex-col gap-0.5">
                    <span class="text-[10px] text-textSoft">å‚™è¨»</span>
                    <input
                      v-model="item.remark"
                      class="w-full bg-bgLight/70 outline-none text-[10px] text-textMain px-2 py-1 rounded border border-secondary/40"
                      placeholder="ä¾‹å¦‚ï¼šé ç´„åã€special note"
                    />
                  </div>
                </div>

                <!-- åº•éƒ¨æŒ‰éˆ• -->
                <div class="flex items-center justify-between mt-1">
                  <a
                    :href="item.mapsUrl || getSingleDirectionLink(item, getGlobalIndex(dayIndex, idx))"
                    target="_blank"
                    rel="noopener"
                    class="text-[10px] text-primary hover:underline flex items-center gap-0.5"
                  >
                    <i class="ri-map-pin-line text-[11px]"></i>
                    <span>é–‹å•Ÿåœ°åœ–</span>
                  </a>
                  <button
                    @click="removeItineraryItem(getGlobalIndex(dayIndex, idx))"
                    class="text-[10px] text-textSoft hover:text-red-500"
                  >
                    åˆªé™¤
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Batch import -->
      <div class="mt-2 rounded-xl border border-secondary/50 bg-bgLight/80 px-3 py-2 text-[11px]">
        <div class="flex items-center justify-between mb-1">
          <span class="flex items-center gap-1 text-textMain">
            <i class="ri-magic-line text-primary"></i>
            <span>æ‰¹æ¬¡åŒ¯å…¥åœ°é»</span>
          </span>
        </div>
        <p class="text-[10px] text-textSoft mb-1">
          å¾ Google Maps æ¸…å–®è¤‡è£½å¤šå€‹åœ°é»ï¼Œæ¯è¡Œä¸€å€‹ã€‚
        </p>
        <textarea
          v-model="bulkPlaces"
          rows="4"
          placeholder="ä¸€è¡Œä¸€å€‹åœ°é»ï¼Œä¾‹å¦‚ï¼š&#10;Blue Bottle Coffee - Shibuya, Tokyo&#10;Ichiran Ramen, Shinjuku, Tokyo"
          class="w-full border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none text-[11px] text-textMain mb-2"
        ></textarea>
        <div class="flex items-center justify-between">
          <span class="text-[10px] text-textSoft">
            å°‡è‡ªå‹•ç‚ºæ¯å€‹åœ°é»å®‰æ’æ™‚é–“ï¼Œä½ å¯ä¹‹å¾Œå†å¾®èª¿ã€‚
          </span>
          <button
            @click="importBulkPlaces"
            class="px-2.5 py-1 rounded-full bg-primary text-white text-[11px] font-semibold hover:bg-primary/90 flex items-center gap-1"
          >
            <i class="ri-download-2-line text-xs"></i>
            <span>åŒ¯å…¥åˆ°è¡Œç¨‹</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Map Pane -->
    <div
      class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-3 flex flex-col gap-3"
    >
      <div class="flex items-center justify-between">
        <h3 class="text-xs font-semibold text-textMain flex items-center gap-1.5">
          <span
            class="inline-flex w-5 h-5 items-center justify-center rounded-lg bg-primary text-white text-[11px]"
          >
            2
          </span>
          <span>MAP</span>
        </h3>
        <div class="flex items-center gap-2 text-[11px] text-textSoft">
          <i class="ri-map-line text-primary"></i>
          <span>Route overview</span>
        </div>
      </div>

      <div id="map" class="w-full bg-bgLight"></div>

      <div v-if="activeTrip.routeSummary" class="flex items-center gap-4 text-[11px] text-textSoft mt-1">
        <div class="flex items-center gap-1">
          <i class="ri-road-map-line text-secondary"></i>
          <span>{{ activeTrip.routeSummary.distance }}</span>
        </div>
        <div class="flex items-center gap-1">
          <i class="ri-time-line text-secondary"></i>
          <span>{{ activeTrip.routeSummary.duration }}</span>
        </div>
        <div class="flex items-center gap-1">
          <i class="ri-map-pin-range-line text-secondary"></i>
          <span>{{ activeTrip.itinerary.length }} stops</span>
        </div>
      </div>

      <div class="mt-2 rounded-xl border border-secondary/50 bg-bgLight/80 px-3 py-2 text-[11px]">
        <div class="flex items-center justify-between mb-1">
          <span class="flex items-center gap-1 text-textMain">
            <i class="ri-star-smile-line text-primary"></i>
            <span>Google Maps å·²å„²å­˜æ¸…å–®é€£çµ</span>
          </span>
          <a
            v-if="activeTrip.savedListLink"
            :href="activeTrip.savedListLink"
            target="_blank"
            class="text-primary hover:underline flex items-center gap-1"
          >
            <i class="ri-external-link-line text-xs"></i>
            <span>é–‹å•Ÿæ¸…å–®</span>
          </a>
        </div>
        <p class="text-[10px] text-textSoft mb-1">
          åœ¨ Google Maps ä¸­åˆ†äº«ä½ çš„ã€Œå·²å„²å­˜æ¸…å–®ã€é€£çµï¼Œè²¼ä¸Šåˆ°é€™è£¡ã€‚
        </p>
        <input
          v-model="activeTrip.savedListLink"
          placeholder="è²¼ä¸Š Google Maps å·²å„²å­˜æ¸…å–®åˆ†äº«é€£çµ"
          class="w-full border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none text-[11px] text-textMain"
        />
      </div>
    </div>
  </section>

  <!-- TAB: Budget -->
  <section
    v-if="activeTab === 'budget'"
    class="grid md:grid-cols-[minmax(0,2fr)_minmax(0,3fr)] gap-4"
  >
    <!-- FX & Add Expense -->
    <div
      class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-3"
    >
      <div
        class="rounded-xl border border-secondary/60 bg-primary text-white px-4 py-3 flex flex-col gap-2"
      >
        <div class="flex items-center justify-between text-[11px]">
          <span class="flex items-center gap-1">
            <i class="ri-exchange-dollar-line"></i>
            <span>å¯¦æ™‚åŒ¯ç‡ Â· HKD â†’ {{ activeTrip?.currency || 'JPY' }}</span>
          </span>
          <button
            @click="fetchRate"
            class="text-white/80 hover:text-white"
            title="æ›´æ–°åŒ¯ç‡"
          >
            <i class="ri-refresh-line text-xs"></i>
          </button>
        </div>
        <div class="flex items-baseline gap-1">
          <span class="text-xl font-semibold">1,000 HKD</span>
          <span class="text-xs text-white/80 mx-1">â‰ˆ</span>
          <span class="text-lg font-semibold">
            {{ (1000 * (activeTrip?.exchangeRate || 0)).toFixed(2) }} {{ activeTrip?.currency || 'JPY' }}
          </span>
        </div>
        <div class="flex items-center gap-2 text-[11px] mt-1">
          <span class="text-white/80">æ‰‹å‹•å¾®èª¿ï¼š</span>
          <input
            type="number"
            v-model.number="activeTrip.exchangeRate"
            class="w-24 px-2 py-1 rounded bg-white/90 text-xs text-textMain outline-none"
            step="0.0001"
          />
        </div>
      </div>

      <div class="flex flex-col gap-2 text-xs">
        <h3 class="text-[11px] font-semibold text-textMain flex items-center gap-1">
          <i class="ri-wallet-3-line text-primary"></i>
          <span>æ–°å¢æ”¯å‡º</span>
        </h3>
        <div class="grid grid-cols-2 gap-2">
          <input
            v-model="newExpense.item"
            placeholder="é …ç›® (e.g. å’–å•¡)"
            class="border border-secondary/60 rounded-lg px-3 py-2 bg-bgLight outline-none text-xs"
          />
          <input
            v-model.number="newExpense.amount"
            type="number"
            placeholder="é‡‘é¡ (HKD)"
            class="border border-secondary/60 rounded-lg px-3 py-2 bg-bgLight outline-none text-xs"
          />
        </div>
        <div class="flex gap-2">
          <select
            v-model="newExpense.payment"
            class="border border-secondary/60 rounded-lg px-3 py-2 bg-bgLight outline-none flex-1 text-xs text-textMain"
          >
            <option value="cash">ğŸ’µ ç¾é‡‘</option>
            <option value="card">ğŸ’³ ä¿¡ç”¨å¡</option>
          </select>
          <button
            @click="addExpense"
            class="px-3 py-2 rounded-lg bg-primary text-white text-xs font-semibold hover:bg-primary/90"
          >
            è¨˜ä¸€ç­†
          </button>
        </div>
      </div>
    </div>

    <!-- Expense List -->
    <div
      class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-2 max-h-[460px] overflow-y-auto"
    >
      <div class="flex items-center justify-between mb-1">
        <h3 class="text-xs font-semibold text-textMain flex items-center gap-1.5">
          <span
            class="inline-flex w-5 h-5 items-center justify-center rounded-lg bg-primary text-white text-[11px]"
          >
            $
          </span>
          <span>æ”¯å‡ºåˆ—è¡¨</span>
        </h3>
        <div class="text-[11px] text-textSoft">
          å…± {{ activeTrip.expenses?.length || 0 }} ç­† Â·
          <span class="font-semibold">
            {{ totalExpenseInCurrency.toLocaleString() }} {{ activeTrip.currency }}
          </span>
        </div>
      </div>

      <div
        v-for="(exp, i) in activeTrip.expenses"
        :key="'exp-' + i"
        class="flex items-center justify-between rounded-xl border border-secondary/40 bg-bgLight/80 px-3 py-2 text-xs"
      >
        <div class="flex items-center gap-3">
          <div
            :class="exp.payment === 'card'
              ? 'bg-white text-primary border border-secondary'
              : 'bg-white text-green-500 border border-secondary'"
            class="w-8 h-8 rounded-lg flex items-center justify-center text-base"
          >
            <i :class="exp.payment === 'card' ? 'ri-bank-card-line' : 'ri-wallet-3-line'"></i>
          </div>
          <div>
            <div class="font-semibold text-textMain text-xs">
              {{ exp.item }}
            </div>
            <div class="text-[11px] text-textSoft">
              {{ exp.date }}
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-xs text-textMain">
            -HKD {{ exp.amount.toLocaleString() }}
          </div>
          <div class="text-[11px] text-textSoft">
            â‰ˆ {{ (exp.amount * (activeTrip.exchangeRate || 0)).toFixed(1) }} {{ activeTrip.currency }}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TAB: Shopping -->
  <section
    v-if="activeTab === 'shopping'"
    class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-3"
  >
    <div class="flex items-center justify-between mb-1">
      <h2 class="text-sm font-semibold text-textMain flex items-center gap-1.5">
        <i class="ri-shopping-bag-3-line text-primary"></i>
        <span>æ—…ç¨‹è³¼ç‰©æ¸…å–®</span>
      </h2>
    </div>

    <div class="rounded-xl border border-secondary/60 bg-bgLight/80 px-3 py-3 text-xs flex flex-col gap-2">
      <div class="grid md:grid-cols-[1.5fr_1fr_1fr] gap-2">
        <div class="flex flex-col gap-1">
          <label class="text-textSoft text-[11px]">å“é …åç¨±</label>
          <input
            v-model="newShoppingItem.name"
            placeholder="ä¾‹å¦‚ï¼šUNIQLO ç¾½çµ¨å¤–å¥—"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft text-[11px]">ç¶²ä¸Šåƒ¹éŒ¢</label>
          <input
            v-model="newShoppingItem.onlinePrice"
            placeholder="ä¾‹å¦‚ï¼šHK$799 / Â¥15,000"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft text-[11px]">ç•¶åœ°å¯¦ä»˜åƒ¹</label>
          <input
            v-model="newShoppingItem.localPrice"
            placeholder="ä¾‹å¦‚ï¼šÂ¥13,000"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
      </div>

      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center gap-2">
          <div class="w-14 h-14 rounded-lg bg-white border border-secondary/60 flex items-center justify-center overflow-hidden">
            <img
              v-if="newShoppingItem.imageData"
              :src="newShoppingItem.imageData"
              class="w-full h-full object-cover"
            />
            <span v-else class="text-[10px] text-textSoft px-1 text-center">
              ç„¡ç›¸ç‰‡
            </span>
          </div>
          <label
            class="text-[11px] px-2 py-1.5 rounded-full border border-secondary/70 bg-white text-textMain cursor-pointer flex items-center gap-1"
          >
            <i class="ri-image-add-line text-xs text-primary"></i>
            <span>åŒ¯å…¥ç›¸ç‰‡</span>
            <input
              type="file"
              accept="image/*"
              class="hidden"
              @change="handleShoppingImageChange($event, null)"
            />
          </label>
        </div>
        <button
          @click="addShoppingItem"
          class="px-3 py-2 rounded-lg bg-primary text-white text-xs font-semibold hover:bg-primary/90 flex items-center gap-1"
        >
          <i class="ri-add-line text-xs"></i>
          <span>åŠ å…¥æ¸…å–®</span>
        </button>
      </div>
    </div>

    <div class="mt-2 grid md:grid-cols-2 gap-3">
      <div
        v-for="(item, index) in activeTrip.shoppingItems"
        :key="'shop-' + index"
        class="rounded-xl border border-secondary/60 bg-bgLight/60 px-3 py-3 flex gap-3 text-xs"
        :class="{ 'opacity-60': item.purchased }"
      >
        <div class="w-16 h-16 rounded-lg bg-white border border-secondary/60 flex items-center justify-center overflow-hidden flex-shrink-0">
          <img
            v-if="item.imageData"
            :src="item.imageData"
            class="w-full h-full object-cover"
          />
          <span v-else class="text-[10px] text-textSoft px-1 text-center">
            ç„¡ç›¸ç‰‡
          </span>
        </div>

        <div class="flex-1 flex flex-col gap-1">
          <div class="flex items-center justify-between">
            <div class="font-semibold text-textMain text-[12px] truncate">
              {{ item.name }}
            </div>
            <button
              @click="removeShoppingItem(index)"
              class="text-textSoft hover:text-red-500"
            >
              <i class="ri-delete-bin-line text-xs"></i>
            </button>
          </div>
          <div class="text-[11px] text-textSoft">
            ç¶²ä¸Šåƒ¹éŒ¢ï¼š<span class="text-textMain">{{ item.onlinePrice || '-' }}</span>
          </div>
          <div class="text-[11px] text-textSoft">
            ç•¶åœ°å¯¦ä»˜ï¼š<span class="text-textMain">{{ item.localPrice || '-' }}</span>
          </div>
          <label class="mt-1 inline-flex items-center gap-1 text-[11px] cursor-pointer">
            <input
              type="checkbox"
              v-model="item.purchased"
              @change="toggleShoppingPurchased(index)"
              class="w-3 h-3 rounded border border-secondary"
            />
            <span>å·²è³¼è²·</span>
          </label>
        </div>
      </div>

      <div
        v-if="!activeTrip.shoppingItems || activeTrip.shoppingItems.length === 0"
        class="col-span-full text-[11px] text-textSoft text-center py-4"
      >
        æš«æœªæœ‰è³¼ç‰©é …ç›®ï¼Œå…ˆåœ¨ä¸Šæ–¹æ–°å¢ä¸€å€‹å§ã€‚
      </div>
    </div>
  </section>

  <!-- TAB: Trips / History -->
  <section
    v-if="activeTab === 'trips'"
    class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-3"
  >
    <div class="flex items-center justify-between mb-1">
      <h2 class="text-sm font-semibold text-textMain flex items-center gap-1.5">
        <i class="ri-suitcase-3-line text-primary"></i>
        <span>æ—…ç¨‹ / History</span>
      </h2>
      <button
        @click="startCreateTrip"
        class="text-[11px] px-2.5 py-1 rounded-full border border-secondary/70 text-textMain hover:bg-bgLight/80 flex items-center gap-1"
      >
        <i class="ri-add-line text-xs"></i>
        <span>æ–°å¢æ—…ç¨‹</span>
      </button>
    </div>
    <p class="text-[11px] text-textSoft mb-1">
      æ—…ç¨‹æœƒä¿å­˜åœ¨æ­¤è£ç½®çš„ç€è¦½å™¨ localStorageï¼Œä¸‹æ¬¡é–‹å•Ÿäº¦å¯æŸ¥çœ‹ã€‚
    </p>

    <div class="grid md:grid-cols-3 gap-3">
      <div
        v-for="trip in trips"
        :key="trip.id"
        class="relative group rounded-2xl overflow-hidden cursor-pointer transition transform hover:-translate-y-1 hover:shadow-lg"
        @click="switchTrip(trip.id)"
      >
        <div
          :class="[
            'absolute inset-0 bg-gradient-to-br opacity-90',
            trip.id === activeTripId
              ? 'from-primary via-sky-400 to-blue-500'
              : 'from-bgLight via-white to-bgLight'
          ]"
        ></div>

        <div class="relative px-3 py-3 flex flex-col gap-2 text-[11px] border border-secondary/60">
          <div class="flex items-start justify-between">
            <div class="flex flex-col gap-0.5">
              <div
                class="text-xs font-semibold truncate max-w-[140px]"
                :class="trip.id === activeTripId ? 'text-white' : 'text-textMain'"
              >
                {{ trip.title }}
              </div>
              <div
                class="flex items-center gap-1"
                :class="trip.id === activeTripId ? 'text-white/80' : 'text-textSoft'"
              >
                <i class="ri-map-pin-line text-[11px]"></i>
                <span class="truncate max-w-[150px]">
                  {{ trip.destination }}
                </span>
              </div>
            </div>

            <div class="flex flex-col items-end gap-1">
              <span
                v-if="trip.id === activeTripId"
                class="px-2 py-0.5 rounded-full bg-white/90 text-[10px] text-primary font-semibold shadow-sm"
              >
                ACTIVE
              </span>
              <div class="flex items-center gap-1">
                <button
                  @click.stop="startEditTrip(trip)"
                  class="text-[11px] rounded-full px-1.5 py-0.5 bg-black/5 text-textSoft hover:bg-black/10 hover:text-textMain"
                  title="ç·¨è¼¯æ—…ç¨‹"
                >
                  <i class="ri-edit-2-line text-[11px]"></i>
                </button>
                <button
                  @click.stop="deleteTrip(trip.id)"
                  class="text-[11px] rounded-full px-1.5 py-0.5"
                  :class="trip.id === activeTripId
                    ? 'bg-black/20 text-white/80 hover:text-white'
                    : 'bg-black/5 text-textSoft hover:text-red-500'"
                  title="åˆªé™¤æ—…ç¨‹"
                >
                  <i class="ri-delete-bin-line text-[11px]"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-between mt-1">
            <div
              class="flex flex-col gap-0.5"
              :class="trip.id === activeTripId ? 'text-white/80' : 'text-textSoft'"
            >
              <span class="flex items-center gap-1">
                <i class="ri-calendar-line text-[11px]"></i>
                <span>{{ trip.startDate }} â†’ {{ trip.endDate }}</span>
              </span>
              <span class="flex items-center gap-1">
                <i class="ri-money-cny-circle-line text-[11px]"></i>
                <span>{{ trip.currency }}</span>
              </span>
            </div>
            <div
              class="flex flex-col items-end gap-0.5 text-[10px]"
              :class="trip.id === activeTripId ? 'text-white/80' : 'text-textSoft'"
            >
              <span class="flex items-center gap-1">
                <i class="ri-road-map-line text-[11px]"></i>
                <span>{{ trip.itinerary?.length || 0 }} stops</span>
              </span>
              <span class="flex items-center gap-1">
                <i class="ri-shopping-bag-3-line text-[11px]"></i>
                <span>{{ trip.shoppingItems?.length || 0 }} items</span>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Trip Form -->
    <div
      v-if="creatingTrip"
      class="mt-3 rounded-xl border border-secondary/60 bg-bgLight/80 px-3 py-3 text-[11px] flex flex-col gap-2"
    >
      <div class="flex items-center justify-between">
        <span class="font-semibold text-textMain">æ–°å¢æ—…ç¨‹</span>
        <button @click="creatingTrip = false" class="text-textSoft hover:text-textMain text-xs">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="grid md:grid-cols-2 gap-2">
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">æ—…ç¨‹åç¨±</label>
          <input
            v-model="newTripForm.title"
            placeholder="Japan Winter Escape"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">ç›®çš„åœ° (åœ‹å®¶ / åŸå¸‚)</label>
          <input
            v-model="newTripForm.destination"
            placeholder="Japan Â· Tokyo"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">åŸå¸‚åç¨± (å¤©æ°£ / åœ°åœ–)</label>
          <input
            v-model="newTripForm.city"
            placeholder="Tokyo"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">ç•¶åœ°è²¨å¹£</label>
          <input
            v-model="newTripForm.currency"
            placeholder="JPY / EUR / etc."
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>

        <div class="md:col-span-2 flex items-center justify-between text-[11px] mt-1">
          <span class="text-textSoft">
            å¯ç”¨åŸå¸‚åç¨±è‡ªå‹•å–å¾—åœ°åœ–ä¸­å¿ƒç·¯åº¦ / ç¶“åº¦
          </span>
          <button
            @click="autoFillLatLng"
            type="button"
            class="px-2.5 py-1 rounded-full border border-secondary/70 text-textMain hover:bg-bgLight/80 flex items-center gap-1"
          >
            <i class="ri-compass-3-line text-xs text-primary"></i>
            <span>è‡ªå‹•å–å¾—åº§æ¨™</span>
          </button>
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-textSoft">åœ°åœ–ä¸­å¿ƒç·¯åº¦</label>
          <input
            v-model.number="newTripForm.lat"
            type="number"
            step="0.0001"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">åœ°åœ–ä¸­å¿ƒç¶“åº¦</label>
          <input
            v-model.number="newTripForm.lng"
            type="number"
            step="0.0001"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
      </div>
      <div class="mt-2 flex justify-end gap-2">
        <button
          @click="creatingTrip = false"
          class="px-3 py-1.5 rounded-lg border border-secondary/60 text-textMain hover:bg-bgLight"
        >
          å–æ¶ˆ
        </button>
        <button
          @click="createTrip"
          class="px-3 py-1.5 rounded-lg bg-primary text-white hover:bg-primary/90"
        >
          å»ºç«‹æ—…ç¨‹
        </button>
      </div>
    </div>

    <!-- Edit Trip Form -->
    <div
      v-if="editingTripId"
      class="mt-3 rounded-xl border border-secondary/60 bg-white px-3 py-3 text-[11px] flex flex-col gap-2"
    >
      <div class="flex items-center justify-between">
        <span class="font-semibold text-textMain flex items-center gap-1">
          <i class="ri-edit-2-line text-primary"></i>
          <span>ç·¨è¼¯æ—…ç¨‹</span>
        </span>
        <button @click="cancelEditTrip" class="text-textSoft hover:text-textMain text-xs">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="grid md:grid-cols-2 gap-2">
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">æ—…ç¨‹åç¨±</label>
          <input
            v-model="editTripForm.title"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-bgLight outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">ç›®çš„åœ° (åœ‹å®¶ / åŸå¸‚)</label>
          <input
            v-model="editTripForm.destination"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-bgLight outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">åŸå¸‚åç¨± (å¤©æ°£ / åœ°åœ–)</label>
          <input
            v-model="editTripForm.city"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-bgLight outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">ç•¶åœ°è²¨å¹£</label>
          <input
            v-model="editTripForm.currency"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-bgLight outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">é–‹å§‹æ—¥æœŸ</label>
          <input
            v-model="editTripForm.startDate"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-bgLight outline-none"
            placeholder="YYYY-MM-DD"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">çµæŸæ—¥æœŸ</label>
          <input
            v-model="editTripForm.endDate"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-bgLight outline-none"
            placeholder="YYYY-MM-DD"
          />
        </div>
      </div>
      <div class="mt-2 flex justify-end gap-2">
        <button
          @click="cancelEditTrip"
          class="px-3 py-1.5 rounded-lg border border-secondary/60 text-textMain hover:bg-bgLight"
        >
          å–æ¶ˆ
        </button>
        <button
          @click="saveEditedTrip"
          class="px-3 py-1.5 rounded-lg bg-primary text-white hover:bg-primary/90"
        >
          å„²å­˜ä¿®æ”¹
        </button>
      </div>
    </div>
  </section>

</div>

<script>
  // Aviationstack API keyï¼ˆè«‹å¡«å®Œæ•´ keyï¼‰
  const AVIATIONSTACK_KEY = '5b729556e3ef80e18916fcecbcfd81ba'; // Flight API[web:507][web:518][web:561]

  let leafletMap = null;
  let routePolyline = null;
  let markersLayer = null;

  const { createApp } = Vue;

  createApp({
    data() {
      return {
        tabs: [
          { id: 'info', label: 'Trip Info', icon: 'ri-information-line' },
          { id: 'itinerary', label: 'è¡Œç¨‹ / åœ°åœ–', icon: 'ri-calendar-todo-line' },
          { id: 'budget', label: 'è¨˜å¸³', icon: 'ri-wallet-3-line' },
          { id: 'shopping', label: 'æ—…ç¨‹è³¼ç‰©', icon: 'ri-shopping-bag-3-line' },
          { id: 'trips', label: 'æ—…ç¨‹ / History', icon: 'ri-suitcase-3-line' }
        ],
        activeTab: 'itinerary',

        trips: [],
        activeTripId: null,

        weather: { temp: '--', desc: 'è¼‰å…¥ä¸­...' },

        newExpense: { item: '', amount: null, payment: 'cash' },

        creatingTrip: false,
        editingTripId: null,
        newTripForm: {
          title: '',
          destination: '',
          city: '',
          currency: 'JPY',
          startDate: '',
          endDate: '',
          lat: 35.6762,
          lng: 139.6503
        },
        editTripForm: {
          title: '',
          destination: '',
          city: '',
          currency: 'JPY',
          startDate: '',
          endDate: ''
        },

        bulkPlaces: '',

        newShoppingItem: {
          name: '',
          onlinePrice: '',
          localPrice: '',
          imageData: '',
          purchased: false
        },

        daySize: 5
      };
    },
    computed: {
      activeTrip() {
        return this.trips.find(t => t.id === this.activeTripId) || null;
      },
      totalExpenseInCurrency() {
        if (!this.activeTrip) return 0;
        const totalHKD = (this.activeTrip.expenses || []).reduce((sum, e) => sum + (e.amount || 0), 0);
        return Math.round(totalHKD * (this.activeTrip.exchangeRate || 0));
      },
      groupedItinerary() {
        if (!this.activeTrip) return [];
        const groups = [];
        const items = this.activeTrip.itinerary || [];
        for (let i = 0; i < items.length; i += this.daySize) {
          groups.push(items.slice(i, i + this.daySize));
        }
        return groups;
      },
      weatherTheme() {
        const desc = (this.weather.desc || '').toLowerCase();
        if (desc.includes('rain') || desc.includes('é›¨')) return 'rainy';
        if (desc.includes('cloud') || desc.includes('é›²') || desc.includes('é™°')) return 'cloudy';
        return 'sunny';
      }
    },
    created() {
      const stored = localStorage.getItem('christine_travel_diary_trips'); // localStorage æŒä¹…åŒ–[web:373]
      if (stored) {
        try {
          this.trips = JSON.parse(stored);
        } catch (e) {
          this.trips = [];
        }
      }

      if (this.trips.length === 0) {
        const defaultTrip = {
          id: Date.now().toString(),
          title: "Japan Winter 2025",
          destination: "Japan Â· Tokyo",
          city: "Tokyo",
          currency: "JPY",
          startDate: "2025-12-24",
          endDate: "2026-01-01",
          center: { lat: 35.6762, lng: 139.6503 },
          exchangeRate: 20.04,
          travelMode: "TRANSIT",
          flights: {
            outbound: { no: "NH924", date: "2025-12-24", from: "HKG", to: "HND" },
            inbound: { no: "NH923", date: "2026-01-01", from: "HND", to: "HKG" }
          },
          itinerary: [
            {
              time: "09:00",
              activity: "æŠµé”æ±äº¬ç¾½ç”°æ©Ÿå ´",
              location: "Tokyo Haneda Airport, Japan",
              mapsUrl: "",
              bookingTime: "",
              remark: ""
            },
            {
              time: "11:00",
              activity: "é…’åº— Check-in",
              location: "Shinjuku, Tokyo",
              mapsUrl: "",
              bookingTime: "",
              remark: ""
            },
            {
              time: "14:00",
              activity: "è¡¨åƒé“ / åŸå®¿é€›è¡—",
              location: "Omotesando, Tokyo",
              mapsUrl: "",
              bookingTime: "",
              remark: ""
            },
            {
              time: "19:00",
              activity: "æ–°å®¿æ™šé¤",
              location: "Shinjuku, Tokyo",
              mapsUrl: "",
              bookingTime: "",
              remark: ""
            }
          ],
          routeSummary: null,
          expenses: [],
          tripItems: [],
          shoppingItems: [],
          savedListLink: ""
        };
        this.trips.push(defaultTrip);
      }

      this.activeTripId = this.trips[0].id;
    },
    mounted() {
      this.initLeafletMap();
      this.updateRoute();
      this.fetchWeather();
      this.fetchRate();
    },
    watch: {
      trips: {
        handler(val) {
          localStorage.setItem('christine_travel_diary_trips', JSON.stringify(val)); // æ¯æ¬¡æ”¹å‹•ä¿å­˜[web:373]
        },
        deep: true
      },
      activeTripId() {
        this.$nextTick(() => {
          if (this.activeTrip && leafletMap) {
            leafletMap.setView(this.activeTrip.center || { lat: 35.6762, lng: 139.6503 }, 12);
            this.updateRoute();
          }
        });
      }
    },
    methods: {
      handleTripManagerClick() {
        this.activeTab = 'trips';
        this.creatingTrip = true;
      },
      getGlobalIndex(dayIndex, idxInDay) {
        return dayIndex * this.daySize + idxInDay;
      },

      initLeafletMap() {
        const mapEl = document.getElementById('map');
        if (!mapEl) return;
        leafletMap = L.map('map').setView([35.6762, 139.6503], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(leafletMap); // Leaflet + OSM[web:354][web:438]
        markersLayer = L.layerGroup().addTo(leafletMap);
      },

      async fetchWeather() {
        try {
          const lat = this.activeTrip?.center?.lat || 35.6762;
          const lng = this.activeTrip?.center?.lng || 139.6503;
          const res = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`
          );
          const data = await res.json();
          this.weather = {
            temp: data.current_weather.temperature,
            desc: 'æ™´åˆ°å¤šé›²'
          };
        } catch (e) {
          this.weather = { temp: '10', desc: 'Clear' };
        }
      },

      async fetchRate() {
        try {
          const target = this.activeTrip?.currency || 'JPY';
          const res = await fetch(`https://api.exchangerate.host/latest?base=HKD&symbols=${target}`);
          const data = await res.json();
          if (this.activeTrip && data.rates && data.rates[target]) {
            this.activeTrip.exchangeRate = data.rates[target];
          }
        } catch (e) {}
      },

      async updateRoute() {
        if (!this.activeTrip || !leafletMap || !this.activeTrip.itinerary.length) return;

        markersLayer.clearLayers();
        if (routePolyline) {
          leafletMap.removeLayer(routePolyline);
          routePolyline = null;
        }

        const coords = [];
        const geocoded = [];

        for (const item of this.activeTrip.itinerary) {
          if (!item.location) continue;
          try {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              item.location
            )}`;
            const res = await fetch(url, {
              headers: { 'Accept-Language': 'zh-HK' }
            });
            const data = await res.json();
            if (data && data.length > 0) {
              const best = data[0];
              const lat = parseFloat(best.lat);
              const lng = parseFloat(best.lon);
              coords.push([lat, lng]);
              geocoded.push({ item, lat, lng });
            }
          } catch (e) {
            console.error('Geocode error for', item.location, e);
          }
        }

        if (!coords.length) return;

        geocoded.forEach(g => {
          const marker = L.marker([g.lat, g.lng]).addTo(markersLayer);
          marker.bindPopup(
            `<strong>${g.item.time || ''} ${g.item.activity || ''}</strong><br/>${g.item.location || ''}`
          );
        });

        routePolyline = L.polyline(coords, { color: '#97CBFF', weight: 4 }).addTo(leafletMap); // route polyline[web:354][web:433]
        leafletMap.fitBounds(routePolyline.getBounds(), { padding: [20, 20] });

        let totalDistance = 0;
        for (let i = 1; i < coords.length; i++) {
          const [lat1, lon1] = coords[i - 1];
          const [lat2, lon2] = coords[i];
          const R = 6371;
          const dLat = (lat2 - lat1) * Math.PI / 180;
          const dLon = (lon2 - lon1) * Math.PI / 180;
          const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) *
              Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) *
              Math.sin(dLon / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          totalDistance += R * c;
        }

        this.activeTrip.routeSummary = {
          distance: `${totalDistance.toFixed(1)} km (ç›´ç·šä¼°ç®—)`,
          duration: 'â€”',
          legs: coords.length
        };
      },

      getSingleDirectionLink(item, index) {
        if (!this.activeTrip) return '#';
        if (index === 0) {
          return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`;
        }
        const prev = this.activeTrip.itinerary[index - 1];
        const origin = encodeURIComponent(prev.location);
        const dest = encodeURIComponent(item.location);
        return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=transit`;
      },

      addItineraryItem() {
        if (!this.activeTrip) return;
        const time = prompt('æ™‚é–“ (HH:MM)');
        const activity = prompt('æ´»å‹•åç¨±');
        const location = prompt('åœ°é» / åœ°å€ (ç”¨æ–¼å°èˆª)');
        if (time && activity) {
          this.activeTrip.itinerary.push({
            time,
            activity,
            location: location || activity,
            mapsUrl: '',
            bookingTime: '',
            remark: ''
          });
          this.activeTrip.itinerary.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
          this.$nextTick(() => this.updateRoute());
        }
      },
      removeItineraryItem(index) {
        if (!this.activeTrip) return;
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) return;
        this.activeTrip.itinerary.splice(index, 1);
        this.$nextTick(() => this.updateRoute());
      },

      importBulkPlaces() {
        if (!this.activeTrip || !this.bulkPlaces.trim()) return;
        const lines = this.bulkPlaces
          .split('\n')
          .map(l => l.trim())
          .filter(Boolean);
        if (!lines.length) return;

        let baseHour = 10;
        if (this.activeTrip.itinerary.length > 0) {
          const last = this.activeTrip.itinerary[this.activeTrip.itinerary.length - 1];
          const h = parseInt((last.time || '10:00').split(':')[0], 10);
          baseHour = isNaN(h) ? 10 : h + 1;
        }

        lines.forEach((line, idx) => {
          let name = line;
          let loc = line;
          if (line.includes('-')) {
            const parts = line.split('-');
            name = parts[0].trim();
            loc = parts.slice(1).join('-').trim();
          } else if (line.includes(',')) {
            const parts = line.split(',');
            name = parts[0].trim();
            loc = parts.slice(1).join(',').trim();
          }
          const hour = (baseHour + idx).toString().padStart(2, '0');
          this.activeTrip.itinerary.push({
            time: `${hour}:00`,
            activity: name || 'æœªå‘½ååœ°é»',
            location: loc || name,
            mapsUrl: '',
            bookingTime: '',
            remark: ''
          });
        });

        this.activeTrip.itinerary.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
        this.bulkPlaces = '';
        this.$nextTick(() => this.updateRoute());
      },

      addExpense() {
        if (!this.activeTrip) return;
        if (!this.newExpense.item || !this.newExpense.amount) return;
        const d = new Date();
        this.activeTrip.expenses = this.activeTrip.expenses || [];
        this.activeTrip.expenses.unshift({
          ...this.newExpense,
          date: `${d.getMonth() + 1}/${d.getDate()}`
        });
        this.newExpense = { item: '', amount: null, payment: 'cash' };
      },

      handleShoppingImageChange(event, index) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          const result = e.target.result;
          if (index === null) {
            this.newShoppingItem.imageData = result;
          } else if (this.activeTrip) {
            this.activeTrip.shoppingItems[index].imageData = result;
          }
        };
        reader.readAsDataURL(file);
      },
      addShoppingItem() {
        if (!this.activeTrip) return;
        if (!this.newShoppingItem.name) return;
        this.activeTrip.shoppingItems = this.activeTrip.shoppingItems || [];
        this.activeTrip.shoppingItems.unshift({ ...this.newShoppingItem });
        this.newShoppingItem = {
          name: '',
          onlinePrice: '',
          localPrice: '',
          imageData: '',
          purchased: false
        };
      },
      removeShoppingItem(index) {
        if (!this.activeTrip) return;
        this.activeTrip.shoppingItems.splice(index, 1);
      },
      toggleShoppingPurchased(index) {
        if (!this.activeTrip) return;
        this.activeTrip.shoppingItems[index].purchased = !this.activeTrip.shoppingItems[index].purchased;
      },

      switchTrip(id) {
        this.activeTripId = id;
        this.activeTab = 'itinerary';
        this.$nextTick(() => this.updateRoute());
      },
      deleteTrip(id) {
        if (this.trips.length === 1) {
          alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æ—…ç¨‹');
          return;
        }
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ—…ç¨‹ï¼Ÿ')) return;
        this.trips = this.trips.filter(t => t.id !== id);
        if (!this.trips.find(t => t.id === this.activeTripId)) {
          this.activeTripId = this.trips[0]?.id || null;
        }
        this.$nextTick(() => this.updateRoute());
      },

      startCreateTrip() {
        this.creatingTrip = true;
        this.editingTripId = null;
        this.newTripForm = {
          title: '',
          destination: '',
          city: '',
          currency: 'JPY',
          startDate: '',
          endDate: '',
          lat: 35.6762,
          lng: 139.6503
        };
      },

      startEditTrip(trip) {
        this.creatingTrip = false;
        this.editingTripId = trip.id;
        this.editTripForm = {
          title: trip.title,
          destination: trip.destination,
          city: trip.city,
          currency: trip.currency,
          startDate: trip.startDate,
          endDate: trip.endDate
        };
      },
      cancelEditTrip() {
        this.editingTripId = null;
      },
      saveEditedTrip() {
        if (!this.editingTripId) return;
        const trip = this.trips.find(t => t.id === this.editingTripId);
        if (!trip) return;

        trip.title = this.editTripForm.title || trip.title;
        trip.destination = this.editTripForm.destination || trip.destination;
        trip.city = this.editTripForm.city || trip.city;
        trip.currency = this.editTripForm.currency || trip.currency;
        trip.startDate = this.editTripForm.startDate || trip.startDate;
        trip.endDate = this.editTripForm.endDate || trip.endDate;

        this.editingTripId = null;
      },

      async autoFillLatLng() {
        const query = this.newTripForm.city || this.newTripForm.destination;
        if (!query) {
          alert('è«‹å…ˆè¼¸å…¥ã€ŒåŸå¸‚åç¨±ã€æˆ–ã€Œç›®çš„åœ°ã€ã€‚');
          return;
        }

        try {
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
          const res = await fetch(url, {
            headers: { 'Accept-Language': 'zh-HK' }
          });
          const data = await res.json();

          if (!data || data.length === 0) {
            alert('æ‰¾ä¸åˆ°é€™å€‹åŸå¸‚çš„åº§æ¨™ï¼Œè©¦è©¦ã€ŒTokyo, Japanã€é€™é¡å¯«æ³•ã€‚');
            return;
          }

          const best = data[0];
          this.newTripForm.lat = parseFloat(best.lat);
          this.newTripForm.lng = parseFloat(best.lon);

          alert(`å·²æ›´æ–°åœ°åœ–ä¸­å¿ƒï¼š\nLat: ${this.newTripForm.lat}\nLng: ${this.newTripForm.lng}`);
        } catch (e) {
          console.error('Geocode error', e);
          alert('è‡ªå‹•å–å¾—åº§æ¨™æ™‚å‡ºç¾å•é¡Œï¼Œå¯ä»¥ç¨å¾Œå†è©¦ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥ç·¯åº¦ï¼ç¶“åº¦ã€‚');
        }
      },

      createTrip() {
        if (!this.newTripForm.title || !this.newTripForm.destination) {
          alert('è«‹è‡³å°‘å¡«å¯«æ—…ç¨‹åç¨±èˆ‡ç›®çš„åœ°');
          return;
        }
        const trip = {
          id: Date.now().toString(),
          title: this.newTripForm.title,
          destination: this.newTripForm.destination,
          city: this.newTripForm.city || this.newTripForm.destination,
          currency: this.newTripForm.currency || 'JPY',
          startDate: this.newTripForm.startDate || '',
          endDate: this.newTripForm.endDate || '',
          center: { lat: this.newTripForm.lat || 35.6762, lng: this.newTripForm.lng || 139.6503 },
          exchangeRate: 20.04,
          travelMode: 'TRANSIT',
          flights: {
            outbound: { no: '-', date: this.newTripForm.startDate || '-', from: 'HKG', to: 'HND' },
            inbound: { no: '-', date: this.newTripForm.endDate || '-', from: 'HND', to: 'HKG' }
          },
          itinerary: [],
          routeSummary: null,
          expenses: [],
          tripItems: [],
          shoppingItems: [],
          savedListLink: ''
        };
        this.trips.push(trip);
        this.activeTripId = trip.id;
        this.creatingTrip = false;
        this.$nextTick(() => {
          if (leafletMap) leafletMap.setView(trip.center, 12);
          this.fetchWeather();
          this.fetchRate();
          this.updateRoute();
        });
      },

      // Aviationstackï¼šè‡ªå‹•å¡«èˆªç­è³‡æ–™[web:518][web:561]
      async autoFillFlight(direction) {
        if (!this.activeTrip) return;
        const f = this.activeTrip.flights[direction];
        if (!f.no || !f.date) {
          alert('è«‹å…ˆè¼¸å…¥èˆªç­ç·¨è™Ÿå’Œæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰');
          return;
        }

        try {
          const params = new URLSearchParams({
            access_key: AVIATIONSTACK_KEY,
            flight_iata: f.no.trim(),
            flight_date: f.date.trim()
          });
          const url = `https://api.aviationstack.com/v1/flights?${params.toString()}`;
          const res = await fetch(url);
          const data = await res.json();

          if (!data || !data.data || !data.data.length) {
            alert('æ‰¾ä¸åˆ°é€™å€‹èˆªç­ï¼Œè«‹ç¢ºèªç·¨è™Ÿå’Œæ—¥æœŸæ˜¯å¦æ­£ç¢ºã€‚');
            return;
          }

          const flight = data.data[0];
          const dep = flight.departure || {};
          const arr = flight.arrival || {};

          f.from = dep.iata || dep.airport || f.from;
          f.to = arr.iata || arr.airport || f.to;

          const depTime = dep.scheduled || dep.estimated;
          const arrTime = arr.scheduled || arr.estimated;

          const fmt = iso => {
            if (!iso) return '';
            const d = new Date(iso);
            const hh = d.getHours().toString().padStart(2, '0');
            const mm = d.getMinutes().toString().padStart(2, '0');
            return `${hh}:${mm}`;
          };

          const depHHMM = fmt(depTime);
          const arrHHMM = fmt(arrTime);

          if (direction === 'outbound') {
            if (this.activeTrip.itinerary[0] && depHHMM) {
              this.activeTrip.itinerary[0].time = depHHMM;
            }
            if (this.activeTrip.itinerary[1] && arrHHMM) {
              this.activeTrip.itinerary[1].time = arrHHMM;
            }
          } else {
            const lastIdx = this.activeTrip.itinerary.length - 1;
            if (lastIdx >= 0 && arrHHMM) {
              this.activeTrip.itinerary[lastIdx].time = arrHHMM;
            }
          }

          alert('å·²å¾ Aviationstack æ›´æ–°èˆªç­åŸå¸‚èˆ‡æ™‚é–“ã€‚');

        } catch (e) {
          console.error(e);
          alert('å–å¾—èˆªç­è³‡æ–™æ™‚å‡ºç¾å•é¡Œï¼Œå¯ä»¥ç¨å¾Œå†è©¦ã€‚');
        }
      }
    }
  }).mount('#app');
</script>
</body>
</html>
