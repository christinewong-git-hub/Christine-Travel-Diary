<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Christine's Travel Diary</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue.js 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Remix Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
    rel="stylesheet"
  />
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <!-- Google Maps APIï¼šä½ çš„ API Key -->
  <script
    async
    defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjwdhovqjl-ttXg7UzIYD7x-gFPdCuu4Q&callback=initMap&libraries=geometry"
  ></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#97CBFF',
            secondary: '#C7C7E2',
            bgLight: '#ECF5FF',
            white: '#FFFFFF',
            textMain: '#4A5568',
            textSoft: '#A0AEC0'
          },
          fontFamily: {
            sans: ['"Noto Sans TC"', 'system-ui', 'sans-serif']
          }
        }
      }
    };
  </script>
  <style>
    body {
      background: radial-gradient(circle at top left, #ECF5FF 0, #FFFFFF 40%, #ECF5FF 100%);
      font-family: 'Noto Sans TC', system-ui, sans-serif;
      color: #1a202c;
    }
    .app-shell {
      max-width: 1024px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 16px;
    }
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(151, 203, 255, 0.8);
      border-radius: 999px;
    }
    #map {
      min-height: 280px;
      border-radius: 16px;
    }
  </style>
</head>
<body>
<div id="app" class="app-shell flex flex-col gap-4">

  <!-- Top Bar -->
  <header class="flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-primary flex items-center justify-center text-white text-xl shadow-md">
        <i class="ri-earth-line"></i>
      </div>
      <div>
        <div class="text-xs tracking-wide text-textSoft uppercase">
          Christine's Travel Diary
        </div>
        <div class="text-sm font-semibold text-textMain flex items-center gap-1">
          <i class="ri-sparkling-fill text-primary text-base"></i>
          <span>å¤šæ—…ç¨‹æ—…è¡Œå„€è¡¨æ¿</span>
        </div>
      </div>
    </div>
    <button
      @click="openTripManager = true"
      class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-secondary bg-white text-xs text-textMain hover:bg-bgLight/60"
    >
      <i class="ri-suitcase-3-line text-sm text-primary"></i>
      <span>æ—…ç¨‹ç®¡ç†</span>
      <span class="text-[10px] text-textSoft">({{ trips.length }})</span>
    </button>
  </header>

  <!-- Active Trip Summary -->
  <section
    v-if="activeTrip"
    class="rounded-2xl border border-secondary/60 bg-white/90 backdrop-blur-sm px-5 py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3 shadow-sm"
  >
    <div class="flex-1 flex flex-col gap-1">
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center gap-1.5 text-[11px] px-2.5 py-0.5 rounded-full bg-primary text-white shadow-sm">
          <i class="ri-book-open-line text-xs"></i>
          <span>{{ activeTrip.title }}</span>
        </span>
        <span
          class="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-bgLight text-textMain border border-secondary/40"
        >
          <i class="ri-map-pin-line text-xs text-primary"></i>
          <span>{{ activeTrip.destination }}</span>
        </span>
      </div>
      <div class="text-xs text-textSoft flex items-center gap-2 mt-1">
        <i class="ri-calendar-line text-secondary"></i>
        <span>{{ activeTrip.startDate }} â†’ {{ activeTrip.endDate }}</span>
        <span class="inline-block w-px h-3 bg-secondary/60"></span>
        <span class="flex items-center gap-1">
          <i class="ri-money-cny-circle-line text-secondary"></i>
          <span>{{ activeTrip.currency }}</span>
        </span>
      </div>

      <!-- Flights -->
      <div class="flex flex-wrap gap-2 mt-3 text-[11px]">
        <div
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl border border-secondary/60 bg-bgLight/80"
        >
          <span class="px-1.5 py-0.5 rounded-full bg-primary text-white text-[10px]">
            OUT
          </span>
          <span class="font-medium text-textMain">{{ activeTrip.flights.outbound.no }}</span>
          <span class="text-textSoft">{{ activeTrip.flights.outbound.date }}</span>
          <span class="text-textSoft">Â·</span>
          <span class="text-textSoft">
            {{ activeTrip.flights.outbound.from }} â†’ {{ activeTrip.flights.outbound.to }}
          </span>
        </div>
        <div
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl border border-secondary/60 bg-bgLight/80"
        >
          <span class="px-1.5 py-0.5 rounded-full bg-primary text-white text-[10px]">
            IN
          </span>
          <span class="font-medium text-textMain">{{ activeTrip.flights.inbound.no }}</span>
          <span class="text-textSoft">{{ activeTrip.flights.inbound.date }}</span>
          <span class="text-textSoft">Â·</span>
          <span class="text-textSoft">
            {{ activeTrip.flights.inbound.from }} â†’ {{ activeTrip.flights.inbound.to }}
          </span>
        </div>
      </div>
    </div>

    <!-- Weather + Quick Stats -->
    <div class="flex items-stretch gap-3 text-xs w-full md:w-auto">
      <div
        class="flex-1 md:flex-none w-32 rounded-xl border border-secondary/50 bg-bgLight px-3 py-2 flex flex-col justify-between"
      >
        <div class="flex items-center justify-between">
          <span class="text-[11px] text-textSoft flex items-center gap-1">
            <i class="ri-sun-cloudy-line text-primary"></i>
            <span>ä»Šæ—¥å¤©æ°£</span>
          </span>
          <button
            @click="fetchWeather"
            class="text-[10px] text-textSoft hover:text-textMain"
            title="æ›´æ–°å¤©æ°£"
          >
            <i class="ri-refresh-line"></i>
          </button>
        </div>
        <div class="flex items-end gap-1 mt-1">
          <span class="text-lg font-semibold text-textMain">{{ weather.temp }}Â°C</span>
          <span class="text-[10px] text-textSoft mb-0.5">{{ weather.desc }}</span>
        </div>
        <div class="mt-1 text-[10px] text-textSoft flex items-center gap-1">
          <i class="ri-building-2-line text-secondary"></i>
          <span>{{ activeTrip.city }}</span>
        </div>
      </div>

      <div
        class="flex-1 md:flex-none w-32 rounded-xl border border-secondary/50 bg-bgLight px-3 py-2 flex flex-col justify-between"
      >
        <div class="flex items-center justify-between">
          <span class="text-[11px] text-textSoft flex items-center gap-1">
            <i class="ri-pie-chart-2-line text-primary"></i>
            <span>é ç®—æ¦‚è¦</span>
          </span>
        </div>
        <div class="mt-1">
          <div class="text-[10px] text-textSoft mb-0.5">å·²è¨˜éŒ„æ”¯å‡º</div>
          <div class="text-sm font-semibold text-textMain">
            {{ totalExpenseInCurrency.toLocaleString() }} {{ activeTrip.currency }}
          </div>
        </div>
        <div class="mt-1 text-[10px] text-textSoft flex items-center gap-1">
          <i class="ri-exchange-dollar-line text-secondary"></i>
          <span>JPY â†’ {{ activeTrip.currency }}</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Tabs -->
  <nav
    class="rounded-2xl border border-secondary/60 bg-white/90 backdrop-blur-sm px-2 py-1 flex flex-wrap gap-1 text-[11px]"
  >
    <button
      v-for="tab in tabs"
      :key="tab.id"
      @click="activeTab = tab.id"
      :class="[
        'flex-1 min-w-[80px] flex items-center justify-center gap-1 px-2 py-1.5 rounded-xl transition',
        activeTab === tab.id
          ? 'bg-primary text-white shadow-sm'
          : 'text-textSoft hover:bg-bgLight/80'
      ]"
    >
      <i :class="tab.icon" class="text-xs"></i>
      <span>{{ tab.label }}</span>
    </button>
  </nav>

  <!-- TAB: Itinerary / Map -->
  <section v-if="activeTab === 'itinerary'" class="grid md:grid-cols-[minmax(0,2fr)_minmax(0,3fr)] gap-4">
    <!-- Itinerary List + æ‰¹æ¬¡åŒ¯å…¥ -->
    <div
      class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-3 max-h-[460px] overflow-y-auto"
    >
      <div class="flex items-center justify-between mb-1">
        <h2 class="text-sm font-semibold text-textMain flex items-center gap-1.5">
          <span class="inline-flex w-5 h-5 items-center justify-center rounded-lg bg-primary text-white text-[11px]">
            1
          </span>
          <span>è¡Œç¨‹åˆ—è¡¨</span>
        </h2>
        <button
          @click="addItineraryItem"
          class="text-[11px] px-2.5 py-1 rounded-full border border-secondary/70 text-textMain hover:bg-bgLight/80 flex items-center gap-1"
        >
          <i class="ri-add-line text-xs"></i>
          <span>æ–°å¢</span>
        </button>
      </div>

      <div v-if="activeTrip.itinerary.length === 0" class="text-[11px] text-textSoft py-4 text-center">
        å°šæœªå»ºç«‹è¡Œç¨‹ï¼Œé»æ“Šã€Œæ–°å¢ã€æˆ–ä½¿ç”¨ä¸‹æ–¹ã€Œæ‰¹æ¬¡åŒ¯å…¥åœ°é»ã€ã€‚
      </div>

      <div
        v-for="(item, index) in activeTrip.itinerary"
        :key="'it-' + index"
        class="flex gap-3 items-start rounded-xl border border-secondary/40 bg-bgLight/60 px-3 py-2.5"
      >
        <div class="flex flex-col items-center mt-0.5">
          <div
            class="w-9 h-9 rounded-xl bg-primary text-white text-[11px] flex items-center justify-center font-medium shadow-sm"
          >
            {{ item.time || 'â€”' }}
          </div>
          <div
            v-if="index < activeTrip.itinerary.length - 1"
            class="flex-1 w-px bg-secondary/70 mt-1 mb-1"
            style="min-height: 24px"
          ></div>
        </div>

        <div class="flex-1 flex flex-col gap-1">
          <input
            v-model="item.activity"
            class="text-xs font-semibold text-textMain bg-transparent outline-none"
            placeholder="æ´»å‹•åç¨±"
          />
          <input
            v-model="item.location"
            class="text-[11px] text-textSoft bg-transparent outline-none"
            placeholder="åœ°é» / åœ°å€ï¼ˆç”¨æ–¼å°èˆªï¼‰"
          />
          <div v-if="item.distance || item.duration" class="text-[11px] text-textSoft flex gap-2">
            <span v-if="item.distance">è·é›¢ {{ item.distance }}</span>
            <span v-if="item.duration">Â· {{ item.duration }}</span>
          </div>
          <div class="flex items-center gap-2 mt-1">
            <a
              :href="getSingleDirectionLink(item, index)"
              target="_blank"
              class="text-[11px] px-2 py-1 rounded-full border border-secondary/70 text-textMain hover:bg-bgLight/80 flex items-center gap-1"
            >
              <i class="ri-map-pin-line text-xs text-primary"></i>
              <span>Google Maps</span>
            </a>
            <button
              @click="removeItineraryItem(index)"
              class="ml-auto text-[11px] text-textSoft hover:text-red-500"
            >
              åˆªé™¤
            </button>
          </div>
        </div>
      </div>

      <!-- æ‰¹æ¬¡åŒ¯å…¥åœ°é» -->
      <div class="mt-2 rounded-xl border border-secondary/50 bg-bgLight/80 px-3 py-2 text-[11px]">
        <div class="flex items-center justify-between mb-1">
          <span class="flex items-center gap-1 text-textMain">
            <i class="ri-magic-line text-primary"></i>
            <span>æ‰¹æ¬¡åŒ¯å…¥åœ°é»</span>
          </span>
        </div>
        <p class="text-[10px] text-textSoft mb-1">
          å¾ Google Maps æ¸…å–®è¤‡è£½å¤šå€‹åœ°é»ï¼Œæ¯è¡Œä¸€å€‹ã€‚ä¾‹å¦‚ï¼š<br/>
          ã€ŒBlue Bottle Coffee - Shibuya, Tokyoã€æˆ–ã€ŒStarbucks Reserve, Ginza, Tokyoã€ã€‚
        </p>
        <textarea
          v-model="bulkPlaces"
          rows="4"
          placeholder="ä¸€è¡Œä¸€å€‹åœ°é»ï¼Œä¾‹å¦‚ï¼š&#10;Blue Bottle Coffee - Shibuya, Tokyo&#10;Ichiran Ramen, Shinjuku, Tokyo"
          class="w-full border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none text-[11px] text-textMain mb-2"
        ></textarea>
        <div class="flex items-center justify-between">
          <span class="text-[10px] text-textSoft">
            å°‡è‡ªå‹•ç‚ºæ¯å€‹åœ°é»å®‰æ’æ™‚é–“ï¼ˆåœ¨ç¾æœ‰è¡Œç¨‹ä¹‹å¾Œï¼‰ï¼Œä½ å¯ä¹‹å¾Œå†å¾®èª¿ã€‚
          </span>
          <button
            @click="importBulkPlaces"
            class="px-2.5 py-1 rounded-full bg-primary text-white text-[11px] font-semibold hover:bg-primary/90 flex items-center gap-1"
          >
            <i class="ri-download-2-line text-xs"></i>
            <span>åŒ¯å…¥åˆ°è¡Œç¨‹</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Map Pane + Google Maps Saved List Link -->
    <div
      class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-3 flex flex-col gap-3"
    >
      <div class="flex items-center justify-between">
        <h3 class="text-xs font-semibold text-textMain flex items-center gap-1.5">
          <span
            class="inline-flex w-5 h-5 items-center justify-center rounded-lg bg-primary text-white text-[11px]"
          >
            2
          </span>
          <span>è·¯ç·šåœ°åœ–</span>
        </h3>
        <div class="flex items-center gap-2 text-[11px]">
          <select
            v-model="activeTrip.travelMode"
            @change="updateRoute"
            class="border border-secondary/60 rounded-lg px-2 py-1 bg-bgLight text-textMain"
          >
            <option value="DRIVING">ğŸš— é–‹è»Š</option>
            <option value="WALKING">ğŸš¶ æ­¥è¡Œ</option>
            <option value="BICYCLING">ğŸš² å–®è»Š</option>
            <option value="TRANSIT">ğŸš‡ å¤§çœ¾é‹è¼¸</option>
          </select>
          <button
            @click="updateRoute"
            class="px-2 py-1 rounded-lg border border-secondary/60 text-textMain hover:bg-bgLight/80 flex items-center gap-1"
          >
            <i class="ri-refresh-line text-xs"></i>
            <span>é‡æ–°è¨ˆç®—</span>
          </button>
        </div>
      </div>

      <div id="map" class="w-full bg-bgLight"></div>

      <!-- Google Maps Saved List Import UIï¼ˆä¿å­˜ link ç”¨ï¼‰ -->
      <div class="mt-2 rounded-xl border border-secondary/50 bg-bgLight/80 px-3 py-2 text-[11px]">
        <div class="flex items-center justify-between mb-1">
          <span class="flex items-center gap-1 text-textMain">
            <i class="ri-star-smile-line text-primary"></i>
            <span>Google Maps å·²å„²å­˜æ¸…å–®é€£çµ</span>
          </span>
          <a
            v-if="activeTrip.savedListLink"
            :href="activeTrip.savedListLink"
            target="_blank"
            class="text-primary hover:underline flex items-center gap-1"
          >
            <i class="ri-external-link-line text-xs"></i>
            <span>é–‹å•Ÿæ¸…å–®</span>
          </a>
        </div>
        <p class="text-[10px] text-textSoft mb-1">
          åœ¨ Google Maps ä¸­åˆ†äº«ä½ çš„ã€Œå·²å„²å­˜æ¸…å–®ã€é€£çµï¼Œè²¼ä¸Šåˆ°é€™è£¡ï¼Œæ–¹ä¾¿ä¸€éµæ‰“é–‹æŸ¥çœ‹æ‰€æœ‰æ”¶è—åœ°é»ã€‚
        </p>
        <input
          v-model="activeTrip.savedListLink"
          placeholder="è²¼ä¸Š Google Maps å·²å„²å­˜æ¸…å–®åˆ†äº«é€£çµ"
          class="w-full border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none text-[11px] text-textMain"
        />
      </div>

      <div v-if="activeTrip.routeSummary" class="flex items-center gap-4 text-[11px] text-textSoft mt-1">
        <div class="flex items-center gap-1">
          <i class="ri-road-map-line text-secondary"></i>
          <span>{{ activeTrip.routeSummary.distance }}</span>
        </div>
        <div class="flex items-center gap-1">
          <i class="ri-time-line text-secondary"></i>
          <span>{{ activeTrip.routeSummary.duration }}</span>
        </div>
        <div class="flex items-center gap-1">
          <i class="ri-map-pin-range-line text-secondary"></i>
          <span>{{ activeTrip.itinerary.length }} stops</span>
        </div>
      </div>
    </div>
  </section>

  <!-- å…¶é¤˜ TABï¼ˆBudget / Shopping / Pre-trip / Tripsï¼‰æ²¿ç”¨ä¸Šä¸€ç‰ˆé‚è¼¯ï¼Œå¯ç¹¼çºŒä½¿ç”¨ -->

</div>

<script>
  let map, directionsService, directionsDisplay;

  function initMap() {
    const mapEl = document.getElementById('map');
    if (!mapEl) return;
    map = new google.maps.Map(mapEl, {
      zoom: 12,
      center: { lat: 35.6762, lng: 139.6503 }, // Tokyo
      mapTypeControl: false,
      fullscreenControl: false,
      streetViewControl: false,
      styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
    });
    directionsService = new google.maps.DirectionsService();
    directionsDisplay = new google.maps.DirectionsRenderer({
      map,
      suppressMarkers: false,
      polylineOptions: {
        strokeColor: '#97CBFF',
        strokeWeight: 5
      }
    });
  }

  const { createApp } = Vue;

  createApp({
    data() {
      return {
        tabs: [
          { id: 'itinerary', label: 'è¡Œç¨‹ / åœ°åœ–', icon: 'ri-calendar-todo-line' },
          { id: 'budget', label: 'è¨˜å¸³', icon: 'ri-wallet-3-line' },
          { id: 'shopping', label: 'æ—…ç¨‹è³¼ç‰©', icon: 'ri-shopping-bag-3-line' },
          { id: 'pretrip', label: 'è¡Œå‰è³¼ç‰©', icon: 'ri-clipboard-line' },
          { id: 'trips', label: 'æ—…ç¨‹ / History', icon: 'ri-suitcase-3-line' }
        ],
        activeTab: 'itinerary',

        trips: [],
        activeTripId: null,
        openTripManager: false,

        weather: { temp: '--', desc: 'è¼‰å…¥ä¸­...' },

        newExpense: { item: '', amount: null, payment: 'cash' },
        newTripItem: '',
        creatingTrip: false,
        newTripForm: {
          title: '',
          destination: '',
          city: '',
          currency: 'HKD',
          startDate: '',
          endDate: '',
          lat: 35.6762,
          lng: 139.6503
        },

        // æ–°å¢ï¼šæ‰¹æ¬¡åŒ¯å…¥ç”¨ textarea
        bulkPlaces: ''
      };
    },
    computed: {
      activeTrip() {
        return this.trips.find(t => t.id === this.activeTripId) || null;
      },
      totalExpenseInCurrency() {
        if (!this.activeTrip) return 0;
        const totalJPY = this.activeTrip.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        return Math.round(totalJPY * this.activeTrip.exchangeRate);
      }
    },
    created() {
      const stored = localStorage.getItem('christine_travel_diary_trips');
      if (stored) {
        try {
          this.trips = JSON.parse(stored);
        } catch (e) {
          this.trips = [];
        }
      }

      if (this.trips.length === 0) {
        const defaultTrip = {
          id: Date.now().toString(),
          title: "Japan Winter 2025",
          destination: "Japan Â· Tokyo",
          city: "Tokyo",
          currency: "HKD",
          startDate: "2025-12-24",
          endDate: "2026-01-01",
          center: { lat: 35.6762, lng: 139.6503 },
          exchangeRate: 0.055,
          travelMode: "TRANSIT",
          flights: {
            outbound: { no: "NH924", date: "2025-12-24", from: "HKG", to: "HND" },
            inbound: { no: "NH923", date: "2026-01-01", from: "HND", to: "HKG" }
          },
          itinerary: [
            {
              time: "09:00",
              activity: "æŠµé”æ±äº¬ç¾½ç”°æ©Ÿå ´",
              location: "Tokyo Haneda Airport, Japan"
            },
            {
              time: "11:00",
              activity: "é…’åº— Check-in",
              location: "Shinjuku, Tokyo"
            },
            {
              time: "14:00",
              activity: "è¡¨åƒé“ / åŸå®¿é€›è¡—",
              location: "Omotesando, Tokyo"
            },
            {
              time: "19:00",
              activity: "æ–°å®¿æ™šé¤",
              location: "Shinjuku, Tokyo"
            }
          ],
          routeSummary: null,
          expenses: [],
          tripItems: [],
          preTripItems: [],
          savedListLink: ""
        };
        this.trips.push(defaultTrip);
      }

      this.activeTripId = this.trips[0].id;
    },
    mounted() {
      if (typeof google !== 'undefined' && google.maps) {
        setTimeout(() => {
          initMap();
          this.updateRoute();
        }, 400);
      } else {
        window.initMap = () => {
          initMap();
          this.updateRoute();
        };
      }

      this.fetchWeather();
      this.fetchRate();
    },
    watch: {
      trips: {
        handler(val) {
          localStorage.setItem('christine_travel_diary_trips', JSON.stringify(val));
        },
        deep: true
      },
      activeTripId() {
        this.$nextTick(() => {
          if (this.activeTrip && map) {
            map.setCenter(this.activeTrip.center || { lat: 35.6762, lng: 139.6503 });
            map.setZoom(12);
            this.updateRoute();
          }
        });
      }
    },
    methods: {
      async fetchWeather() {
        try {
          const lat = this.activeTrip?.center?.lat || 35.6762;
          const lng = this.activeTrip?.center?.lng || 139.6503;
          const res = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`
          );
          const data = await res.json();
          this.weather = {
            temp: data.current_weather.temperature,
            desc: 'æ™´åˆ°å¤šé›²'
          };
        } catch (e) {
          this.weather = { temp: '10', desc: 'Clear' };
        }
      },

      async fetchRate() {
        try {
          const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
          const data = await res.json();
          if (this.activeTrip && data.rates && data.rates.HKD) {
            this.activeTrip.exchangeRate = data.rates.HKD;
          }
        } catch (e) {
          // ä¿ç•™é è¨­
        }
      },

      async updateRoute() {
        if (!this.activeTrip || !directionsService || this.activeTrip.itinerary.length < 2) return;

        const legs = this.activeTrip.itinerary;
        const waypoints = legs.slice(1, -1).map(item => ({
          location: item.location,
          stopover: true
        }));

        const request = {
          origin: legs[0].location,
          destination: legs[legs.length - 1].location,
          waypoints,
          optimizeWaypoints: true,
          travelMode: google.maps.TravelMode[this.activeTrip.travelMode || 'TRANSIT']
        };

        try {
          const result = await new Promise((resolve, reject) => {
            directionsService.route(request, (res, status) => {
              if (status === 'OK') resolve(res);
              else reject(status);
            });
          });

          directionsDisplay.setDirections(result);

          const route = result.routes[0];
          const totalDistance = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0) / 1000;
          const totalDuration = route.legs.reduce((sum, leg) => sum + leg.duration.value, 0) / 60;

          this.activeTrip.routeSummary = {
            distance: `${totalDistance.toFixed(1)} km`,
            duration: `${Math.floor(totalDuration / 60)}h ${Math.round(totalDuration % 60)}m`,
            legs: route.legs.length
          };

          this.activeTrip.itinerary.forEach((item, index) => {
            if (index > 0 && route.legs[index - 1]) {
              item.distance = route.legs[index - 1].distance.text;
              item.duration = route.legs[index - 1].duration.text;
            }
          });
        } catch (err) {
          console.error('route error', err);
        }
      },

      getSingleDirectionLink(item, index) {
        if (!this.activeTrip) return '#';
        if (index === 0) {
          return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`;
        }
        const prev = this.activeTrip.itinerary[index - 1];
        const origin = encodeURIComponent(prev.location);
        const dest = encodeURIComponent(item.location);
        return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=transit`;
      },

      addItineraryItem() {
        if (!this.activeTrip) return;
        const time = prompt('æ™‚é–“ (HH:MM)');
        const activity = prompt('æ´»å‹•åç¨±');
        const location = prompt('åœ°é» / åœ°å€ (ç”¨æ–¼å°èˆª)');
        if (time && activity) {
          this.activeTrip.itinerary.push({
            time,
            activity,
            location: location || activity
          });
          this.activeTrip.itinerary.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
          this.$nextTick(() => this.updateRoute());
        }
      },
      removeItineraryItem(index) {
        if (!this.activeTrip) return;
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
          this.activeTrip.itinerary.splice(index, 1);
          this.$nextTick(() => this.updateRoute());
        }
      },

      // æ‰¹æ¬¡åŒ¯å…¥åœ°é»
      importBulkPlaces() {
        if (!this.activeTrip || !this.bulkPlaces.trim()) return;
        const lines = this.bulkPlaces
          .split('\n')
          .map(l => l.trim())
          .filter(Boolean);
        if (!lines.length) return;

        let baseHour = 10;
        if (this.activeTrip.itinerary.length > 0) {
          const last = this.activeTrip.itinerary[this.activeTrip.itinerary.length - 1];
          const h = parseInt((last.time || '10:00').split(':')[0], 10);
          baseHour = isNaN(h) ? 10 : h + 1;
        }

        lines.forEach((line, idx) => {
          let name = line;
          let loc = line;
          if (line.includes('-')) {
            const parts = line.split('-');
            name = parts[0].trim();
            loc = parts.slice(1).join('-').trim();
          } else if (line.includes(',')) {
            const parts = line.split(',');
            name = parts[0].trim();
            loc = parts.slice(1).join(',').trim();
          }
          const hour = (baseHour + idx).toString().padStart(2, '0');
          this.activeTrip.itinerary.push({
            time: `${hour}:00`,
            activity: name || 'æœªå‘½ååœ°é»',
            location: loc || name
          });
        });

        this.activeTrip.itinerary.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
        this.bulkPlaces = '';
        this.$nextTick(() => this.updateRoute());
      },

      addExpense() {
        if (!this.activeTrip) return;
        if (!this.newExpense.item || !this.newExpense.amount) return;
        const d = new Date();
        this.activeTrip.expenses.unshift({
          ...this.newExpense,
          date: `${d.getMonth() + 1}/${d.getDate()}`
        });
        this.newExpense = { item: '', amount: null, payment: 'cash' };
      },

      addTripItem() {
        if (!this.activeTrip) return;
        if (!this.newTripItem) return;
        this.activeTrip.tripItems.push({ text: this.newTripItem, checked: false });
        this.newTripItem = '';
      },
      removeTripItem(index) {
        if (!this.activeTrip) return;
        this.activeTrip.tripItems.splice(index, 1);
      },
      toggleTripItem(index) {
        if (!this.activeTrip) return;
        this.activeTrip.tripItems[index].checked = !this.activeTrip.tripItems[index].checked;
      },

      addPreTripItem() {
        if (!this.activeTrip) return;
        this.activeTrip.preTripItems.push({
          name: '',
          image: '',
          onlinePrice: null,
          purchased: false,
          actualPrice: null
        });
      },
      removePreTripItem(index) {
        if (!this.activeTrip) return;
        this.activeTrip.preTripItems.splice(index, 1);
      },

      switchTrip(id) {
        this.activeTripId = id;
        this.activeTab = 'itinerary';
      },
      deleteTrip(id) {
        if (this.trips.length === 1) {
          alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æ—…ç¨‹');
          return;
        }
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ—…ç¨‹ï¼Ÿ')) return;
        this.trips = this.trips.filter(t => t.id !== id);
        if (!this.trips.find(t => t.id === this.activeTripId)) {
          this.activeTripId = this.trips[0]?.id || null;
        }
      },
      startCreateTrip() {
        this.creatingTrip = true;
        this.newTripForm = {
          title: '',
          destination: '',
          city: '',
          currency: 'HKD',
          startDate: '',
          endDate: '',
          lat: 35.6762,
          lng: 139.6503
        };
      },
      createTrip() {
        if (!this.newTripForm.title || !this.newTripForm.destination) {
          alert('è«‹è‡³å°‘å¡«å¯«æ—…ç¨‹åç¨±èˆ‡ç›®çš„åœ°');
          return;
        }
        const trip = {
          id: Date.now().toString(),
          title: this.newTripForm.title,
          destination: this.newTripForm.destination,
          city: this.newTripForm.city || this.newTripForm.destination,
          currency: this.newTripForm.currency || 'HKD',
          startDate: this.newTripForm.startDate || '',
          endDate: this.newTripForm.endDate || '',
          center: { lat: this.newTripForm.lat || 35.6762, lng: this.newTripForm.lng || 139.6503 },
          exchangeRate: 0.055,
          travelMode: 'TRANSIT',
          flights: {
            outbound: { no: '-', date: this.newTripForm.startDate || '-', from: '-', to: '-' },
            inbound: { no: '-', date: this.newTripForm.endDate || '-', from: '-', to: '-' }
          },
          itinerary: [],
          routeSummary: null,
          expenses: [],
          tripItems: [],
          preTripItems: [],
          savedListLink: ''
        };
        this.trips.push(trip);
        this.activeTripId = trip.id;
        this.creatingTrip = false;
        this.$nextTick(() => {
          if (map) {
            map.setCenter(trip.center);
            map.setZoom(12);
          }
          this.fetchWeather();
        });
      }
    }
  }).mount('#app');
</script>
</body>
</html>
