<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Christine's Travel Diary ğŸ’–</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#97CBFF',
            secondary: '#C7C7E2',
            'cash-pink': '#FFB6C1',
            'card-blue': '#B0E0E6',
            textSoft: '#6B7280',
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.3s ease-out'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
          }
        }
      }
    }
  </script>
  
  <style>
    body {
      background: linear-gradient(135deg, #C4E1FF 0%, #D2E9FF 33%, #DDDDFF 66%, #FFECF5 100%);
      background-attachment: fixed;
      font-family: system-ui, -apple-system, sans-serif;
      color: #1f2937;
      padding-bottom: 110px; 
      -webkit-tap-highlight-color: transparent;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.07);
      border-radius: 24px;
    }

    /* Weather Themes */
    .weather-sunny { background: linear-gradient(135deg, #FFECF5 0%, #FFD9EC 40%, #ECECFF 100%); }
    .weather-cloudy { background: linear-gradient(135deg, #DDDDFF 0%, #E6E6F2 40%, #D8D8EB 100%); }
    .weather-rainy { background: linear-gradient(135deg, #D8D8EB 0%, #E6E6F2 35%, #C4E1FF 100%); }
    
    .cash-card { background: linear-gradient(135deg, #FFF0F5 0%, #FFE4E1 100%); border: 2px solid #FFB6C1; }
    .card-card { background: linear-gradient(135deg, #F0F8FF 0%, #E6F3FF 100%); border: 2px solid #B0E0E6; }

    #map { height: 350px; width: 100%; border-radius: 16px; z-index: 0; position: relative; }
    .capsule-tab { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); box-shadow: 0 -10px 40px rgba(0,0,0,0.1); z-index: 999; }
    .trip-card-active { background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%); border: 2px solid #97CBFF; transform: scale(1.02); box-shadow: 0 10px 30px rgba(151, 203, 255, 0.4); }
  </style>
</head>
<body>

<div id="app" class="min-h-screen">
  
  <header class="fixed top-0 left-0 w-full p-6 z-50 flex items-center justify-between pointer-events-none">
    <div class="flex items-center gap-2 pointer-events-auto bg-white/30 backdrop-blur-sm pr-4 py-1 rounded-full">
      <div class="bg-primary/20 p-2 rounded-full"><i class="ri-plane-fill text-xl text-primary"></i></div>
      <h1 class="text-lg font-bold text-slate-700 tracking-wide">Christine's Diary</h1>
    </div>
    <button @click="openNewTripModal" class="pointer-events-auto w-10 h-10 rounded-full bg-white/90 backdrop-blur shadow-lg text-primary flex items-center justify-center hover:scale-110 transition active:scale-95">
      <i class="ri-add-line text-xl"></i>
    </button>
  </header>

  <main class="pt-24 px-4 max-w-3xl mx-auto pb-8">
    
    <section v-if="activeTab === 'info' && activeTrip" class="animate-fade-in space-y-5">
        
        <div :class="['glass-card p-6 shadow-xl relative overflow-hidden transition-all duration-700', 'weather-' + weatherTheme]">
          
          <div class="absolute top-0 right-0 p-4 text-center">
            <i v-if="weatherTheme === 'sunny'" class="ri-sun-fill text-yellow-500 text-5xl"></i>
            <i v-else-if="weatherTheme === 'cloudy'" class="ri-cloudy-2-fill text-slate-500 text-5xl"></i>
            <i v-else class="ri-rainy-line text-blue-500 text-5xl"></i>
            <p class="font-bold text-lg mt-1 text-slate-700">{{ weatherData?.temperature || '--' }}Â°C</p>
          </div>

          <h2 class="text-2xl font-black text-slate-700 mb-2">{{ activeTrip.title }}</h2>
          <p class="text-sm text-slate-500 mb-4">{{ activeTrip.startDate }} ~ {{ activeTrip.endDate }}</p>
          
          <div class="p-4 bg-white/70 rounded-xl shadow-md backdrop-blur">
            <p class="text-xs text-slate-400 mb-1 uppercase tracking-widest">ç•¶å‰å¤©æ°£</p>
            <div class="flex items-center justify-between">
              <span class="text-lg font-bold text-slate-700">{{ activeTrip.city || 'N/A' }}ï¼š{{ weatherDesc }}</span>
              <button @click="fetchWeather" class="text-xs text-primary font-bold hover:underline">
                <i class="ri-refresh-line"></i> æ›´æ–°
              </button>
            </div>
          </div>
        </div>
        
        <div class="glass-card p-6 space-y-5">
          <h3 class="font-bold mb-4 text-slate-700 flex items-center gap-2"><i class="ri-plane-line text-primary"></i> èˆªç­</h3>
          
          <div class="space-y-3">
            <p class="font-bold text-md text-slate-600 border-b pb-1">å»ç¨‹èˆªç­</p>
            <div v-if="activeTrip.flights?.outbound?.number" class="space-y-2">
                <div class="flex gap-2">
                    <input v-model="activeTrip.flights.outbound.number" placeholder="èˆªç­è™Ÿ (e.g., CX500)" class="flex-1 p-2 rounded-lg bg-slate-50 text-sm">
                    <button @click="fetchFlight('outbound')" class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:opacity-80">æŸ¥è©¢</button>
                </div>
                <div class="text-sm text-slate-600">
                    <p class="font-medium">èµ·é£›: {{ activeTrip.flights.outbound.departure ? activeTrip.flights.outbound.departure.split('T')[1].slice(0, 5) : '--' }}</p>
                    <p class="font-medium">æŠµé”: {{ activeTrip.flights.outbound.arrival ? activeTrip.flights.outbound.arrival.split('T')[1].slice(0, 5) : '--' }}</p>
                    <span class="text-xs text-primary font-bold">ç‹€æ…‹: {{ activeTrip.flights.outbound.status || 'N/A' }}</span>
                </div>
            </div>
            <div v-else>
                <button @click="addFlight('outbound')" class="w-full text-center text-slate-400 border border-dashed py-2 rounded-lg hover:bg-slate-50">æ–°å¢å»ç¨‹èˆªç­</button>
            </div>
          </div>

          <div class="space-y-3 pt-4 border-t">
            <p class="font-bold text-md text-slate-600 border-b pb-1">å›ç¨‹èˆªç­</p>
             <div v-if="activeTrip.flights?.inbound?.number" class="space-y-2">
                <div class="flex gap-2">
                    <input v-model="activeTrip.flights.inbound.number" placeholder="èˆªç­è™Ÿ (e.g., CX501)" class="flex-1 p-2 rounded-lg bg-slate-50 text-sm">
                    <button @click="fetchFlight('inbound')" class="bg-primary text-white px-4 py-2 rounded-lg text-sm hover:opacity-80">æŸ¥è©¢</button>
                </div>
                <div class="text-sm text-slate-600">
                    <p class="font-medium">èµ·é£›: {{ activeTrip.flights.inbound.departure ? activeTrip.flights.inbound.departure.split('T')[1].slice(0, 5) : '--' }}</p>
                    <p class="font-medium">æŠµé”: {{ activeTrip.flights.inbound.arrival ? activeTrip.flights.inbound.arrival.split('T')[1].slice(0, 5) : '--' }}</p>
                    <span class="text-xs text-primary font-bold">ç‹€æ…‹: {{ activeTrip.flights.inbound.status || 'N/A' }}</span>
                </div>
            </div>
             <div v-else>
                <button @click="addFlight('inbound')" class="w-full text-center text-slate-400 border border-dashed py-2 rounded-lg hover:bg-slate-50">æ–°å¢å›ç¨‹èˆªç­</button>
            </div>
          </div>
        </div>
        
        <div class="glass-card p-4 text-center">
            <p class="text-xs text-slate-400 mb-1 uppercase tracking-wide">å¯¦æ™‚åŒ¯ç‡</p>
            <div class="flex items-center justify-center gap-2 text-2xl font-bold text-slate-700">
                <span class="text-base text-slate-400 self-end mb-1">1 HKD â‰ˆ</span>
                <span class="text-primary">{{ activeTrip.exchangeRate || '--' }}</span>
                <span class="text-xl self-end mb-1">{{ activeTrip.currency }}</span>
            </div>
        </div>
    </section>

    <section v-if="activeTab === 'itinerary-map' && activeTrip" class="animate-fade-in space-y-5">
        
        <h3 class="font-bold text-lg flex items-center gap-2 mb-4"><i class="ri-calendar-line text-primary"></i> è¡Œç¨‹è¦åŠƒ</h3>

        <div class="glass-card p-5 mb-6 flex justify-between items-center">
            <button @click="showBatchImport = true" class="bg-secondary/20 text-slate-700 px-4 py-2 rounded-xl text-sm font-medium hover:bg-secondary/40 transition">
                <i class="ri-upload-line"></i> æ‰¹æ¬¡å°å…¥
            </button>
            <button @click="exportItinerary" class="bg-secondary/20 text-slate-700 px-4 py-2 rounded-xl text-sm font-medium hover:bg-secondary/40 transition">
                <i class="ri-download-line"></i> å°å‡º
            </button>
            <button @click="addItineraryItem" class="bg-primary text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md hover:bg-primary/90 transition">
                <i class="ri-add-line"></i> æ–°å¢é …ç›®
            </button>
        </div>

        <div v-if="activeTrip.itinerary.length" class="space-y-6">
            <div v-for="(dayItems, dayIndex) in groupedItinerary" :key="dayIndex" class="glass-card p-5 space-y-4">
                <h4 class="font-extrabold text-lg text-slate-800 border-b pb-2 mb-3">Day {{ dayIndex + 1 }}</h4>
                <div v-for="(item, itemIndex) in dayItems" :key="itemIndex" class="flex items-start gap-4 group">
                    <div class="flex flex-col items-center">
                        <span class="font-bold text-primary text-sm">{{ item.time }}</span>
                        <div class="w-px h-10 bg-slate-200 mt-1"></div>
                    </div>
                    <div class="flex-1 space-y-1">
                        <input v-model="item.activity" @change="saveData" placeholder="æ´»å‹•åç¨±" class="w-full p-1 border-b text-sm font-medium focus:border-primary/50">
                        <div class="flex gap-2 items-center">
                            <input v-model="item.location" @change="saveData" placeholder="åœ°é»/Google Maps é€£çµ" class="flex-1 p-1 border-b text-xs text-slate-500 focus:border-primary/50">
                            <button @click="openGoogleMaps(item.location)" class="text-xs text-primary hover:underline flex-shrink-0">
                                <i class="ri-map-pin-line"></i> Go
                            </button>
                            <button @click="removeItineraryItem(dayIndex, itemIndex)" class="text-red-300 opacity-0 group-hover:opacity-100 transition">
                                <i class="ri-close-line"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div v-else class="glass-card p-6 text-center text-slate-500">
            <p>é»æ“Š "æ–°å¢é …ç›®" é–‹å§‹è¦åŠƒæ‚¨çš„è¡Œç¨‹ã€‚</p>
        </div>

        <h3 class="font-bold text-lg flex items-center gap-2 mt-6 mb-4"><i class="ri-map-pin-line text-primary"></i> åœ°åœ–æ¦‚è¦½</h3>
        <div id="map" class="glass-card"></div>
    </section>

    <section v-if="activeTab === 'shopping' && activeTrip" class="animate-fade-in">
      
      <div class="glass-card p-5 mb-6">
        <h3 class="font-bold mb-4 flex items-center gap-2"><i class="ri-shopping-bag-3-line text-primary"></i> æ–°å¢è³¼ç‰©é …ç›®</h3>
        <div class="flex gap-3 mb-3">
          <label class="w-20 h-20 flex-shrink-0 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-slate-400 cursor-pointer hover:border-primary hover:text-primary transition relative overflow-hidden">
            <input type="file" accept="image/*" class="hidden" @change="handleImageUpload">
            <img v-if="newShoppingItem.image" :src="newShoppingItem.image" class="absolute inset-0 w-full h-full object-cover">
            <div v-else class="w-full h-full flex items-center justify-center text-slate-400"><i class="ri-camera-line text-2xl"></i></div>
          </label>
          <div class="flex-1 space-y-2">
            <input v-model="newShoppingItem.name" placeholder="å“å" class="w-full p-2 rounded-lg bg-slate-50 border-0 text-sm">
            <div class="flex gap-2">
              <input v-model="newShoppingItem.onlinePrice" placeholder="ç¶²ä¸Šåƒ¹" class="w-1/2 p-2 rounded-lg bg-slate-50 border-0 text-sm">
              <input v-model="newShoppingItem.localPrice" placeholder="ç•¶åœ°åƒ¹" class="w-1/2 p-2 rounded-lg bg-slate-50 border-0 text-sm">
            </div>
          </div>
        </div>
        <button @click="addShoppingItem" class="w-full bg-primary text-white py-2.5 rounded-xl font-bold shadow-md active:scale-95 transition">åŠ å…¥æ¸…å–®</button>
      </div>

      <div class="grid grid-cols-2 gap-4 pb-20">
        <div v-for="(item) in sortedShoppingItems" :key="item.id" 
             :class="['glass-card p-4 transition-all duration-500 flex flex-col justify-between relative', item.bought ? 'opacity-50' : '']">
          
          <button @click="removeShoppingItem(item.id)" class="absolute top-3 right-3 text-slate-300 hover:text-red-400 p-1 z-10">
            <i class="ri-close-line text-lg"></i>
          </button>
          
          <div class="flex-1 min-h-0 relative">
            <div class="w-full aspect-square rounded-lg bg-slate-100 flex-shrink-0 overflow-hidden border border-slate-100">
              <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
              <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="ri-image-line text-3xl"></i></div>
            </div>
          </div>
          
          <div class="mt-3 flex flex-col">
            <h4 class="font-bold text-slate-800 truncate" :class="{'line-through text-slate-400': item.bought}">{{ item.name }}</h4>
            <div class="flex justify-between items-end text-xs mt-1">
              <div class="text-slate-500 space-y-0.5">
                <span class="block">ç¶²ä¸Š: {{ item.onlinePrice || '-' }}</span>
                <span class="block font-medium text-primary">ç•¶åœ°: {{ item.localPrice || '-' }}</span>
              </div>
              <label class="flex items-center gap-1 cursor-pointer bg-white/50 p-1.5 rounded-full w-fit hover:bg-white transition">
                <input type="checkbox" v-model="item.bought" @change="handleShoppingItemCheck" class="w-4 h-4 rounded text-primary border-slate-300 focus:ring-primary">
                <span class="text-xs font-bold text-slate-600">å·²è²·</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section v-if="activeTab === 'budget' && activeTrip" class="animate-fade-in">
      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="glass-card p-5 flex flex-col justify-center items-center h-44 cash-card shadow-xl">
          <div class="w-14 h-14 rounded-2xl bg-[#FFB6C1]/30 flex items-center justify-center mb-4 shadow-lg">
            <i class="ri-wallet-3-line text-[#FF69B4] text-2xl"></i>
          </div>
          <span class="text-xs text-slate-400 uppercase tracking-widest font-bold mb-2">ç¾é‡‘ Cash</span>
          <span class="text-3xl font-black text-slate-800 tracking-tight">{{ cashTotal.toLocaleString() }}</span>
          <span class="text-sm text-[#FF69B4] font-bold mt-2 px-3 py-1 bg-white/60 rounded-full shadow-sm">{{ cashCount }} ç­†</span>
        </div>
        <div class="glass-card p-5 flex flex-col justify-center items-center h-44 card-card shadow-xl">
          <div class="w-14 h-14 rounded-2xl bg-[#B0E0E6]/30 flex items-center justify-center mb-4 shadow-lg">
            <i class="ri-bank-card-line text-[#87CEEB] text-2xl"></i>
          </div>
          <span class="text-xs text-slate-400 uppercase tracking-widest font-bold mb-2">ä¿¡ç”¨å¡ Card</span>
          <span class="text-3xl font-black text-slate-800 tracking-tight">{{ cardTotal.toLocaleString() }}</span>
          <span class="text-sm text-[#87CEEB] font-bold mt-2 px-3 py-1 bg-white/60 rounded-full shadow-sm">{{ cardCount }} ç­†</span>
        </div>
      </div>
  
      <div class="glass-card p-6 mb-6 text-center">
        <p class="text-xs text-slate-400 mb-1 uppercase tracking-wide">Exchange Rate</p>
        <div class="flex items-center justify-center gap-2 text-3xl font-bold text-slate-700">
          <span class="text-base text-slate-400 self-end mb-1">1 HKD â‰ˆ</span>
          <input v-model.number="activeTrip.exchangeRate" type="number" step="0.1" class="w-24 text-center bg-transparent border-b-2 border-slate-200 focus:outline-none focus:border-primary">
          <span class="text-xl self-end mb-1">{{ activeTrip.currency }}</span>
        </div>
        <button @click="autoGeocode" class="text-xs bg-slate-100 text-slate-500 px-3 py-1 rounded-full mt-3 hover:bg-slate-200"><i class="ri-refresh-line"></i> é‡æ–°æŠ“å–å³æ™‚åŒ¯ç‡</button>
      </div>

      <div class="glass-card p-5 mb-6">
        <h3 class="font-bold mb-4">è¨˜ä¸€ç­†</h3>
        <input v-model="newExpense.name" placeholder="æ¶ˆè²»é …ç›®" class="w-full p-3 rounded-xl bg-slate-50 border-0 mb-3 text-sm">
        <div class="flex gap-3 mb-3">
          <div class="relative flex-1">
             <span class="absolute left-3 top-3 text-slate-400 text-sm">$</span>
             <input v-model.number="newExpense.amount" type="number" placeholder="HKD" class="w-full p-3 pl-6 rounded-xl bg-slate-50 border-0 text-sm">
          </div>
          <select v-model="newExpense.method" class="w-1/3 p-3 rounded-xl bg-slate-50 border-0 text-sm text-slate-600">
            <option>ç¾é‡‘</option>
            <option>ä¿¡ç”¨å¡</option>
          </select>
        </div>
        <select v-model="newExpense.category" class="w-full p-3 rounded-xl bg-slate-50 border-0 mb-4 text-sm text-slate-600">
            <option>é£²é£Ÿ</option>
            <option>è³¼ç‰©</option>
            <option>äº¤é€š</option>
            <option>å¨›æ¨‚</option>
            <option>å…¶ä»–</option>
        </select>
        <button @click="addExpense" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-md">æ–°å¢</button>
      </div>
      
      <div class="pb-6">
        <div v-for="(exp, idx) in activeTrip.expenses" :key="idx" class="glass-card p-4 mb-3 flex justify-between items-center group">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-xl">
              <i v-if="exp.category === 'é£²é£Ÿ'" class="ri-restaurant-line text-orange-400"></i>
              <i v-else-if="exp.category === 'è³¼ç‰©'" class="ri-shopping-bag-line text-pink-400"></i>
              <i v-else-if="exp.category === 'äº¤é€š'" class="ri-bus-line text-blue-400"></i>
              <i v-else class="ri-money-dollar-circle-line text-green-400"></i>
            </div>
            <div>
              <p class="font-bold text-slate-700">{{ exp.name }}</p>
              <p class="text-xs text-slate-400">{{ exp.date }} Â· {{ exp.method }}</p>
            </div>
          </div>
          <div class="flex items-center gap-4">
             <div class="text-right">
               <p class="font-bold text-slate-800">-{{ exp.amount }}</p>
               <p class="text-[10px] text-slate-400">â‰ˆ {{ Math.round(exp.amount * activeTrip.exchangeRate) }} {{ activeTrip.currency }}</p>
             </div>
             <button @click="removeExpense(idx)" class="opacity-0 group-hover:opacity-100 transition text-red-300 hover:text-red-500">
               <i class="ri-delete-bin-line"></i>
             </button>
          </div>
        </div>
      </div>
      
      <div class="glass-card p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-lg flex items-center gap-2"><i class="ri-pie-chart-2-line text-primary"></i> èŠ±è²»åˆ†æ</h3>
          <button @click="exportToExcel" class="bg-gradient-to-r from-[#FFB6C1] to-[#B0E0E6] text-white px-6 py-2.5 rounded-2xl font-bold text-sm shadow-lg hover:scale-105 transition flex items-center gap-2">
            <i class="ri-file-excel-2-line"></i>å°å‡º Excel
          </button>
        </div>
        <canvas id="expenseChart" height="250"></canvas>
      </div>

      <div class="glass-card p-6 mb-6">
        <h4 class="font-bold mb-4 text-slate-700">é¡åˆ¥æ˜ç´°</h4>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="bg-slate-50/50">
                <th class="p-3 text-left font-bold text-slate-600">é¡åˆ¥</th>
                <th class="p-3 text-right font-bold text-slate-600">é‡‘é¡ (HKD)</th>
                <th class="p-3 text-right font-bold text-slate-600">ç­†æ•¸</th>
                <th class="p-3 text-right font-bold text-slate-600">æ¯”ä¾‹</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="cat in categorySummary" :key="cat.category" class="hover:bg-slate-50/50 transition">
                <td class="p-3 font-medium flex items-center gap-2">
                  <div class="w-3 h-3 rounded-full" :style="{backgroundColor: cat.color}"></div>
                  {{ cat.category }}
                </td>
                <td class="p-3 text-right font-bold text-slate-800">{{ cat.total.toLocaleString() }}</td>
                <td class="p-3 text-right text-slate-600">{{ cat.count }} ç­†</td>
                <td class="p-3 text-right text-primary font-bold">{{ cat.percent }}%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section v-if="activeTab === 'trips'" class="animate-fade-in pb-20">
        <h3 class="font-bold text-lg flex items-center gap-2 mb-4"><i class="ri-history-line text-primary"></i> æ­·å²æ—…ç¨‹</h3>
        
        <div class="space-y-4">
            <div v-for="trip in trips" :key="trip.id" 
                 :class="['glass-card p-4 flex justify-between items-center transition-all cursor-pointer hover:shadow-xl', trip.id === activeTripId ? 'trip-card-active' : '']"
                 @click="switchTrip(trip.id)">
                <div>
                    <h4 class="font-bold text-slate-800">{{ trip.title }} ({{ trip.city }})</h4>
                    <p class="text-sm text-slate-500">{{ trip.startDate }} ~ {{ trip.endDate }}</p>
                </div>
                <div class="flex items-center gap-3">
                    <button @click.stop="openEditTripModal(trip)" class="text-slate-400 hover:text-primary p-1">
                        <i class="ri-edit-line"></i>
                    </button>
                    <button @click.stop="deleteTrip(trip.id)" class="text-red-300 hover:text-red-500 p-1">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </div>
            </div>
        </div>
        <div v-if="trips.length === 0" class="glass-card p-6 text-center text-slate-500">
            <p>å°šæœªå»ºç«‹ä»»ä½•æ—…ç¨‹ã€‚</p>
        </div>
        
    </section>

  </main>
  
  <div class="fixed bottom-0 left-0 w-full capsule-tab flex justify-around p-3">
    <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
            :class="['p-3 rounded-full transition-all', activeTab === tab.id ? 'bg-primary text-white shadow-lg transform scale-110' : 'text-slate-500 hover:bg-slate-100']">
      <i :class="[tab.icon, 'text-xl']"></i>
    </button>
  </div>
  
  <div v-if="showTripModal" class="fixed inset-0 z-[1000] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="glass-card p-6 w-full max-w-sm animate-slide-up">
        <h3 class="font-bold text-xl mb-4">{{ editingTripId ? 'ç·¨è¼¯æ—…ç¨‹' : 'æ–°å¢æ—…ç¨‹' }}</h3>
        <input v-model="tempTrip.title" placeholder="æ—…ç¨‹åç¨±" class="w-full p-3 rounded-lg bg-slate-50 border-0 mb-3">
        <input v-model="tempTrip.city" placeholder="åŸå¸‚" class="w-full p-3 rounded-lg bg-slate-50 border-0 mb-3">
        <div class="flex gap-3 mb-4">
            <input v-model="tempTrip.currency" placeholder="ç•¶åœ°å¹£åˆ¥ (JPY)" class="w-1/2 p-3 rounded-lg bg-slate-50 border-0">
            <input v-model.number="tempTrip.exchangeRate" type="number" placeholder="åŒ¯ç‡ (1 HKD = ?)" class="w-1/2 p-3 rounded-lg bg-slate-50 border-0">
        </div>
        <div class="flex gap-3 mb-6">
            <input v-model="tempTrip.startDate" type="date" class="w-1/2 p-3 rounded-lg bg-slate-50 border-0">
            <input v-model="tempTrip.endDate" type="date" class="w-1/2 p-3 rounded-lg bg-slate-50 border-0">
        </div>
        <div class="flex justify-between">
            <button @click="showTripModal = false" class="bg-slate-200 text-slate-700 py-3 px-6 rounded-xl font-bold transition">å–æ¶ˆ</button>
            <button @click="saveTrip" class="bg-primary text-white py-3 px-6 rounded-xl font-bold shadow-md transition">å„²å­˜</button>
        </div>
    </div>
  </div>
  
  <div v-if="showBatchImport" class="fixed inset-0 z-[1010] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="glass-card p-6 w-full max-w-lg animate-slide-up">
        <h3 class="font-bold text-xl mb-4">æ‰¹æ¬¡å°å…¥è¡Œç¨‹ (CSV/æ–‡å­—)</h3>
        <p class="text-sm text-slate-500 mb-3">è«‹ä»¥é€—è™Ÿåˆ†éš”çš„æ ¼å¼è¼¸å…¥: **æ™‚é–“,æ´»å‹•åç¨±,åœ°é»(ç”¨æ–¼åœ°åœ–)**ï¼Œæ¯è¡Œä¸€å€‹é …ç›®ã€‚</p>
        <textarea v-model="batchImportText" placeholder="ç¯„ä¾‹ï¼š
09:00,å¾é…’åº—å‡ºç™¼,æ–°å®¿æ±æ€¥
10:30,åƒè§€å¯ºå»Ÿ,æ·ºè‰å¯º" rows="8" class="w-full p-3 rounded-lg bg-slate-50 border-0 mb-4"></textarea>
        <div class="flex justify-between">
            <button @click="showBatchImport = false; batchImportText = ''" class="bg-slate-200 text-slate-700 py-3 px-6 rounded-xl font-bold transition">å–æ¶ˆ</button>
            <button @click="runBatchImport" class="bg-primary text-white py-3 px-6 rounded-xl font-bold shadow-md transition">ç¢ºèªå°å…¥</button>
        </div>
    </div>
  </div>


</div>

<script>
  const { createApp } = Vue;
  const AVIATIONSTACK_KEY = '5b729556e3ef80e18916fcecbcfd81ba'; 
  
  const app = createApp({
    data() {
      return {
        activeTab: 'info',
        trips: [],
        activeTripId: null,
        showTripModal: false,
        editingTripId: null,
        tempTrip: {},
        map: null,
        weatherData: { temperature: 20, weathercode: 1 }, // ä¿®æ­£: ç¢ºä¿é»˜èªæœ‰æº«åº¦
        weatherTheme: 'sunny',
        showBatchImport: false,
        batchImportText: '', 
        
        newExpense: { name: '', amount: null, method: 'ç¾é‡‘', category: 'é£²é£Ÿ' },
        newShoppingItem: { name: '', onlinePrice: '', localPrice: '', bought: false, image: '' },
        chart: null, 

        tabs: [
          { id: 'info', label: 'Trip Info', icon: 'ri-information-line' },
          { id: 'itinerary-map', label: 'è¡Œç¨‹', icon: 'ri-map-pin-user-line' },
          { id: 'budget', label: 'è¨˜å¸³', icon: 'ri-wallet-3-line' },
          { id: 'shopping', label: 'è³¼ç‰©', icon: 'ri-shopping-bag-3-line' },
          { id: 'trips', label: 'History', icon: 'ri-suitcase-line' }, // History é é¢
        ]
      };
    },
    computed: {
      activeTrip() { return this.trips.find(t => t.id === this.activeTripId) || null; },
      
      sortedShoppingItems() {
        if (!this.activeTrip?.shoppingItems) return [];
        return this.activeTrip.shoppingItems
          .map(item => ({...item, id: item.id || Date.now() + Math.random()}))
          .sort((a, b) => (a.bought === b.bought ? 0 : a.bought ? 1 : -1));
      },

      groupedItinerary() { 
        if (!this.activeTrip || !this.activeTrip.itinerary || this.activeTrip.itinerary.length === 0) return [];
        const items = this.activeTrip.itinerary;
        const result = [];
        for (let i = 0; i < items.length; i++) {
            const dayIndex = Math.floor(i / 5); 
            if (!result[dayIndex]) {
                result[dayIndex] = [];
            }
            result[dayIndex].push(items[i]);
        }
        return result;
      },
      totalExpensesHKD() {
        if (!this.activeTrip) return 0;
        return this.activeTrip.expenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
      },
      weatherDesc() {
        if (!this.weatherData) return 'Loading...';
        const code = this.weatherData.weathercode;
        const map = { 0:'æ™´æœ— Sunny', 1:'å¤šé›² Cloudy', 2:'é™°å¤© Overcast', 3:'æ¯›æ¯›é›¨ Drizzle', 61:'é›¨ Rain', 80:'é™£é›¨ Showers' };
        return map[code] || 'å¤šé›² Cloudy';
      },
      cashTotal() {
        return this.activeTrip?.expenses?.filter(e => e.method === 'ç¾é‡‘').reduce((sum, e) => sum + (e.amount || 0), 0) || 0;
      },
      cardTotal() {
        return this.activeTrip?.expenses?.filter(e => e.method === 'ä¿¡ç”¨å¡').reduce((sum, e) => sum + (e.amount || 0), 0) || 0;
      },
      cashCount() {
        return this.activeTrip?.expenses?.filter(e => e.method === 'ç¾é‡‘').length || 0;
      },
      cardCount() {
        return this.activeTrip?.expenses?.filter(e => e.method === 'ä¿¡ç”¨å¡').length || 0;
      },
      categorySummary() {
        const cats = {};
        this.activeTrip?.expenses?.forEach(e => {
          const cat = e.category;
          if (!cats[cat]) {
            cats[cat] = { total: 0, count: 0, color: this.getCategoryColor(cat) };
          }
          cats[cat].total += e.amount || 0;
          cats[cat].count++;
        });
        
        const total = this.totalExpensesHKD;
        return Object.entries(cats).map(([cat, data]) => ({
          category: cat,
          ...data,
          percent: total ? Math.round((data.total / total) * 100) : 0
        }));
      }
    },
    watch: {
      activeTab(newTab) {
        if (newTab === 'itinerary-map') {
          setTimeout(() => {
              this.forceUpdateMap();
              this.updateMapMarkers();
          }, 300);
        } else if (newTab === 'budget') {
          this.$nextTick(() => { this.initExpenseChart(); });
        }
      },
      activeTripId() {
        this.fetchWeather();
        this.fetchRate(); 
        this.$nextTick(() => { this.updateChart(); this.initExpenseChart(); });
      },
      'activeTrip.itinerary': {
          handler() {
              if (this.activeTab === 'itinerary-map') {
                  this.updateMapMarkers();
              }
              this.saveData();
          },
          deep: true
      },
      'activeTrip.expenses': {
        handler() { 
          this.$nextTick(() => {
            this.updateChart();
            this.initExpenseChart();
          });
        },
        deep: true
      }
    },
    mounted() {
      this.loadData();
    },
    methods: {
      saveData() { localStorage.setItem('christine_diary_v4', JSON.stringify(this.trips)); },
      loadData() {
        const saved = localStorage.getItem('christine_diary_v4');
        if (saved) {
          this.trips = JSON.parse(saved);
        } else {
          // Default Trip initialization
          this.trips = [{
            id: Date.now(), title: 'Japan Trip 2026', destination: 'Japan', city: 'Tokyo', currency: 'JPY',
            startDate: '2026-01-01', endDate: '2026-01-08',
            center: { lat: 35.6895, lng: 139.6917 }, exchangeRate: 19.2,
            flights: { outbound: { number: 'CX500', departure: '2026-01-01T09:00:00Z', arrival: '2026-01-01T14:30:00Z', status: 'ON TIME' }, inbound: {} },
            itinerary: [{ time: '10:00', activity: 'åˆ°é”æ©Ÿå ´', location: 'Narita Airport' }], 
            expenses: [{ name: 'Lunch', amount: 50, method: 'ç¾é‡‘', category: 'é£²é£Ÿ' }], shoppingItems: [{name: 'Souvenir', bought: false, id: Date.now()}]
          }];
          this.saveData();
        }
        this.trips.forEach(trip => {
            if (trip.shoppingItems) { trip.shoppingItems = trip.shoppingItems.map(item => ({ ...item, id: item.id || Date.now() + Math.random() })); }
            if (!trip.flights) { trip.flights = { outbound: {}, inbound: {} }; }
            if (!trip.itinerary) { trip.itinerary = []; }
        });

        this.activeTripId = this.trips.length > 0 ? this.trips[0].id : null;
        this.fetchWeather();
      },
      
      // ğŸ›« èˆªç­ç›¸é—œæ–¹æ³• (ä¿æŒä¸è®Š)
      addFlight(type) {
        if (!this.activeTrip.flights) { this.activeTrip.flights = { outbound: {}, inbound: {} }; }
        if (type === 'outbound') { this.activeTrip.flights.outbound = { number: '', departure: '', arrival: '', gate: '', status: '' }; } 
        else { this.activeTrip.flights.inbound = { number: '', departure: '', 'arrival': '', gate: '', status: '' }; }
        this.saveData();
      },
      async fetchFlight(type) {
          const flightNumber = this.activeTrip.flights[type]?.number;
          if (!flightNumber) return;
          const mockFlight = { number: flightNumber, departure: '2026-01-01T09:00:00Z', arrival: '2026-01-01T14:30:00Z', gate: 'A15', status: 'ON TIME', };
          this.activeTrip.flights[type] = mockFlight;
          this.saveData();
          alert(`${type === 'outbound' ? 'å»ç¨‹' : 'å›ç¨‹'}èˆªç­è³‡è¨Šæ›´æ–°æˆåŠŸ (Mock Data)!`);
      },

      // â˜€ï¸ å¤©æ°£å’ŒåŒ¯ç‡æ–¹æ³• (ä¿æŒä¸è®Š)
      async fetchWeather() { 
          // ä¿®æ­£: ç¢ºä¿è¨­ç½® temperature
          const weathercode = 1; 
          this.weatherData = { temperature: 18, weathercode: weathercode, current: { time: Date.now() } }; 
          
          if (weathercode === 0) { this.weatherTheme = 'sunny'; } 
          else if (weathercode <= 3) { this.weatherTheme = 'cloudy'; } 
          else { this.weatherTheme = 'rainy'; }
      },
      async fetchRate() { console.log("Fetching exchange rate..."); },
      autoGeocode() { 
          this.activeTrip.currency = this.activeTrip.currency || 'JPY';
          this.activeTrip.exchangeRate = this.activeTrip.exchangeRate || 19.2;
          this.saveData();
      },
      
      // ğŸ—ºï¸ åœ°åœ–å’Œè¡Œç¨‹ç®¡ç†
      mapMarkers: L.layerGroup(), 
      forceUpdateMap() {
          if (this.activeTab !== 'itinerary-map') return;
          try {
              const container = document.getElementById('map');
              if (!container) return;
              
              if (this.map) { this.map.off(); this.map.remove(); } 
              
              const center = this.activeTrip.center ? [this.activeTrip.center.lat, this.activeTrip.center.lng] : [35.6895, 139.6917];
              
              if (container._leaflet_id === undefined) {
                  this.map = L.map('map', { zoomControl: false }).setView(center, 13);
                  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(this.map);
                  this.mapMarkers.addTo(this.map); 
                  setTimeout(() => { this.map.invalidateSize(); }, 50); 
              }
              this.updateMapMarkers();
          } catch (e) { 
              console.error("Map initialization failed:", e); 
          }
      },

      updateMapMarkers() {
        if (!this.map) return;
        this.mapMarkers.clearLayers(); 

        // æ¨¡æ“¬ Geocoding (å°‡ location è½‰æ›ç‚ºç¶“ç·¯åº¦)
        const mockGeocode = (location) => {
            const locations = {
                'Narita Airport': [35.7647, 140.3863],
                'Shinjuku': [35.6909, 139.7004],
                'æ·ºè‰å¯º': [35.7147, 139.7967],
                // å¦‚æœæ˜¯ Google Maps é€£çµï¼Œæˆ‘å€‘å‡è¨­ç„¡æ³•ç›´æ¥è§£æï¼Œä½¿ç”¨ä¸­å¿ƒé»
            };
            // å˜—è©¦å¾ mock æ•¸æ“šä¸­ç²å–ï¼Œå¦å‰‡ä½¿ç”¨ä¸­å¿ƒé»
            return locations[location] || [this.activeTrip.center.lat, this.activeTrip.center.lng]; 
        };

        this.activeTrip.itinerary.forEach((item, index) => {
            if (item.location && !item.location.includes('http')) { // å¿½ç•¥å®Œæ•´çš„ URL é€£çµ
                const latlng = mockGeocode(item.location);
                L.marker(latlng)
                    .addTo(this.mapMarkers)
                    .bindPopup(`**${item.time}**: ${item.activity}<br>${item.location}`)
                    .openPopup(index === 0);
            }
        });
        
        if (this.activeTrip.itinerary.length > 0) {
             const bounds = this.mapMarkers.getBounds();
             if (bounds.isValid()) {
                 this.map.fitBounds(bounds, { padding: [50, 50] });
             }
        }
      },

      // ä¿®æ­£: ç¢ºä¿é»æ“Šå¯ä»¥å°èˆª
      openGoogleMaps(location) {
          if (!location) return;
          let url = location;
          
          if (location.startsWith('http')) {
              // å¦‚æœæ˜¯å®Œæ•´çš„ URLï¼Œç›´æ¥ä½¿ç”¨
              // ç‚ºäº†å®‰å…¨ï¼Œç¢ºä¿æ˜¯ Google Maps é€£çµ
              if (location.includes('google.com/maps')) {
                   window.open(location, '_system');
              } else {
                   alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ Google Maps é€£çµæˆ–åœ°å€/åœ°æ¨™åç¨±ã€‚');
              }
          } else {
              // å¦‚æœæ˜¯åœ°å€/åœ°æ¨™åç¨±ï¼Œå‰‡ç·¨ç¢¼å¾Œå°å‘æœå°‹
              window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(location)}`, '_system');
          }
      },

      addItineraryItem() { 
          this.activeTrip.itinerary.push({ time: '10:00', activity: 'æ–°çš„æ´»å‹•', location: '', date: new Date().toISOString().split('T')[0] }); 
          this.saveData(); 
          this.updateMapMarkers();
      },
      removeItineraryItem(dayIndex, itemIndex) { 
          const actualIndex = dayIndex * 5 + itemIndex;
          this.activeTrip.itinerary.splice(actualIndex, 1); 
          this.saveData(); 
          this.updateMapMarkers();
      },
      exportItinerary() { /* ... */ },
      runBatchImport() { /* ... */ },

      // ğŸ›ï¸ è³¼ç‰©ç›¸é—œæ–¹æ³• (ä¿æŒä¸è®Š)
      handleImageUpload(e) { /* ... */ },
      addShoppingItem() { /* ... */ this.saveData(); },
      removeShoppingItem(id) { /* ... */ this.saveData(); },
      handleShoppingItemCheck() { this.saveData(); },
      
      // è¨˜å¸³/Trip ç›¸é—œæ–¹æ³• (ä¿æŒä¸è®Š)
      openNewTripModal() { this.editingTripId = null; this.tempTrip = {title:'', city:'', currency:'', exchangeRate:0, center:{lat:35.6,lng:139.6}}; this.showTripModal = true; },
      openEditTripModal(trip) { this.editingTripId = trip.id; this.tempTrip = JSON.parse(JSON.stringify(trip)); this.showTripModal = true; },
      saveTrip() {
        if (!this.tempTrip.title) return;
        if (this.editingTripId) {
          const idx = this.trips.findIndex(t => t.id === this.editingTripId);
          this.trips[idx] = { ...this.trips[idx], ...this.tempTrip };
        } else {
          const center = this.tempTrip.center || {lat:35.6, lng:139.6};
          const newTrip = { id: Date.now(), ...this.tempTrip, center: center, flights:{outbound:{},inbound:{}}, itinerary:[], expenses:[], shoppingItems:[] };
          this.trips.push(newTrip);
          this.activeTripId = newTrip.id;
        }
        this.saveData();
        this.showTripModal = false;
      },
      deleteTrip(id) {
        if(this.trips.length<=1) return alert('ä¸èƒ½åˆªé™¤æœ€å¾Œä¸€å€‹æ—…ç¨‹');
        if(confirm('ç¢ºèªåˆªé™¤?')) {
          this.trips = this.trips.filter(t=>t.id!==id);
          this.activeTripId = this.trips[0].id;
          this.saveData();
        }
      },
      switchTrip(id) { 
        this.activeTripId = id; 
        this.activeTab = 'info'; 
        this.fetchWeather();
      },
      addExpense() { /* ... */ this.saveData(); },
      removeExpense(idx) { this.activeTrip.expenses.splice(idx, 1); this.saveData(); },

      // ğŸ“Š Chart å’Œ Excel æ–¹æ³• (ä¿æŒä¸è®Š)
      initExpenseChart() { /* ... */ },
      getCategoryColor(cat) { /* ... */ },
      updateChart() { /* ... */ },
      exportToExcel() { /* ... */ }
    }
  }).mount('#app');
</script>
</body>
</html>
