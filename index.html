<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¸ éŸ“ç³»è¼•é€æ—…éŠæ—¥èªŒ (Vue + Tailwind Glassmorphism)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    
    <style>
        /* --- Custom Tailwind Theme & Global Styles (Emphasize Pastel/Glass) --- */
        
        .bg-gradient-app {
            /* æŸ”å’Œçš„ç²‰å«©è—ç´«æ¼¸å±¤ */
            background-image: linear-gradient(135deg, #E6F0FF, #F0E6FF, #FFEDF7);
        }

        .glass-card {
            /* Glassmorphism æ ¸å¿ƒæ¨£å¼ */
            background-color: rgba(255, 255, 255, 0.65); /* åŠé€æ˜ç™½è‰² */
            backdrop-filter: blur(15px); /* ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
            border: 1px solid rgba(255, 255, 255, 0.4); /* æ·ºè‰²é‚Šæ¡† */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.05); /* æŸ”å’Œé™°å½± */
            transition: all 0.3s ease;
        }
        
        /* èª¿æ•´å¡ç‰‡å…§éƒ¨èƒŒæ™¯ï¼Œä¿æŒåŠé€æ˜é¢¨æ ¼ */
        .glass-card input, .glass-card select, .glass-card textarea {
            background-color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(190, 190, 190, 0.3);
        }

        /* èª¿æ•´èˆªç­å¡ (.flight-sky) - ä½¿ç”¨æŸ”å’Œçš„è—ç´«è‰²æ¼¸å±¤ */
        .flight-sky {
            background-image: linear-gradient(135deg, #A8C0FF, #CCCCFF); /* æŸ”å’Œæ·ºè—åˆ°æ·¡ç´« */
            color: #1F2937; /* æ·±ç°æ–‡å­— */
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        /* èª¿æ•´å¤©æ°£å¡ (.weather-card) - ä½¿ç”¨ç²‰å«©è‰²èª¿ */
        .weather-card {
            transition: background-color 0.5s, background-image 0.5s;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }

        .weather-sunny {
            background-image: linear-gradient(135deg, #FFEDCC, #FFE3B3); /* æŸ”å’Œæš–é»ƒ/æ©˜ */
        }
        .weather-cloudy {
            background-image: linear-gradient(135deg, #E0F2FE, #D2E8F7); /* æŸ”å’Œæ·ºè—ç° */
        }
        .weather-rainy {
            background-image: linear-gradient(135deg, #CCCCFF, #A8C0FF); /* æŸ”å’Œæ·¡ç´«/è— */
            color: #1F2937;
        }

        /* å›ºå®š Header Style ä¹Ÿè¦åŠé€æ˜åŒ– */
        .fixed-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            /* è®“ Header å‘ˆç¾åŠé€æ˜ç»ç’ƒæ•ˆæœ */
            background-color: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(15px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        #map {
            height: 500px;
            border-radius: 0.75rem;
        }

    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // å®šç¾©éŸ“ç³»ç²‰å«©è‰²
                        'pastel-blue': '#B3D9FF',
                        'pastel-pink': '#FFD9E6',
                        'pastel-purple': '#D9C7FF',
                        'primary-indigo': '#7C3AED', // ä½¿ç”¨è¼ƒæŸ”å’Œçš„ç´«è‰²ä½œç‚ºå¼·èª¿è‰²
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-app min-h-screen p-0 m-0">

<div id="app" class="max-w-4xl mx-auto py-4 font-sans">
    
    <header class="fixed-header rounded-b-xl p-4 flex justify-between items-center mb-4">
        <div class="flex items-center">
            <i class="ri-map-2-line text-2xl text-primary-indigo mr-2"></i>
            <h1 class="text-xl font-bold text-gray-800">æ—…éŠæ—¥èªŒ: {{ activeTrip.title }}</h1>
        </div>
        <button @click="currentTab = 'TripsHistory'" class="bg-primary-indigo hover:bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
            <i class="ri-settings-4-line mr-1"></i> æ—…ç¨‹ç®¡ç†
        </button>
    </header>

    <div class="pt-20 px-4 mb-4">
        <nav class="flex space-x-2 p-2 glass-card rounded-xl shadow-inner">
            <button 
                v-for="tab in tabs" 
                :key="tab.id"
                @click="currentTab = tab.id" 
                :class="{'bg-primary-indigo text-white shadow-lg': currentTab === tab.id, 'text-gray-600 hover:bg-indigo-100/50': currentTab !== tab.id}"
                class="flex-1 py-2 px-3 text-sm font-medium rounded-lg transition duration-200">
                <i :class="tab.iconClass"></i> {{ tab.label }}
            </button>
        </nav>
    </div>

    <main class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">

        <div v-show="currentTab === 'TripInfo'" class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <div class="glass-card p-4 rounded-xl shadow-lg">
                <h3 class="text-lg font-semibold mb-3 border-b pb-2 text-primary-indigo"><i class="ri-line-chart-line mr-1"></i> æ—…ç¨‹å¿«ç…§</h3>
                <div class="space-y-2 text-sm">
                    <p>ğŸ—“ï¸ æ—¥æœŸ: **{{ activeTrip.startDate }}** ~ **{{ activeTrip.endDate }}**</p>
                    <p>ğŸ“ ç›®çš„åœ°: **{{ activeTrip.destination }}** ({{ activeTrip.city }})</p>
                    <p>ğŸ“‹ ç¸½è¡Œç¨‹ç«™æ•¸: **{{ activeTrip.itinerary.length }}** ç«™</p>
                    <p>ğŸ’° ç¸½æ”¯å‡º ({{ activeTrip.currency }}): **{{ formatCurrency(totalLocalExpense) }}**</p>
                    <p>ğŸ’± åŒ¯ç‡ (HKDâ†’{{ activeTrip.currency }}): **1.00 HKD â‰ˆ {{ activeTrip.exchangeRate.toFixed(4) }} {{ activeTrip.currency }}**</p>
                </div>
            </div>

            <div :class="['weather-card', 'rounded-xl', 'shadow-lg', 'p-4', activeTrip.weatherTheme === 'sunny' ? 'weather-sunny' : activeTrip.weatherTheme === 'cloudy' ? 'weather-cloudy' : 'weather-rainy']">
                <h3 :class="['text-lg font-semibold mb-3 border-b pb-2', 'border-gray-400/50']"><i class="ri-sun-line mr-1"></i> {{ activeTrip.city }} å³æ™‚å¤©æ°£</h3>
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-4xl font-bold">{{ activeTrip.weather.temperature }}Â°C</p>
                        <p class="text-sm mt-1">{{ activeTrip.weather.description }}</p>
                    </div>
                    <i :class="['text-6xl', activeTrip.weatherTheme === 'sunny' ? 'ri-sun-fill' : activeTrip.weatherTheme === 'cloudy' ? 'ri-cloudy-fill' : 'ri-showers-line']"></i>
                </div>
                <button @click="fetchWeather" class="mt-3 text-xs p-1 rounded bg-black/10 hover:bg-black/20 transition duration-200 text-gray-800">
                    <i class="ri-refresh-line mr-1"></i> æ›´æ–°å¤©æ°£
                </button>
            </div>

            <div class="flight-sky p-4 rounded-xl shadow-lg md:col-span-1">
                <h3 class="text-lg font-semibold mb-3 border-b pb-2 border-gray-400/50"><i class="ri-plane-line mr-1"></i> èˆªç­è©³æƒ…</h3>
                <div v-for="(flight, type) in activeTrip.flights" :key="type" class="mb-4 p-3 border border-gray-400/50 rounded-lg bg-white/40">
                    <p class="text-sm font-bold mb-1">{{ type === 'outbound' ? 'å»ç¨‹' : 'å›ç¨‹' }} ({{ flight.no }})</p>
                    <p class="text-xs">æ—¥æœŸ: {{ flight.date || 'N/A' }}</p>
                    <p class="text-xs">èˆªç·š: {{ flight.from || '?' }} â†’ {{ flight.to || '?' }}</p>
                    <input type="text" v-model="flight.no" :placeholder="type === 'outbound' ? 'å»ç¨‹èˆªç­ç·¨è™Ÿ' : 'å›ç¨‹èˆªç­ç·¨è™Ÿ'" class="w-full text-sm mt-2 p-1 rounded text-gray-800">
                    <button @click="fetchFlightDetails(type)" class="mt-2 text-xs p-1 rounded bg-white/50 hover:bg-white/70 transition duration-200 text-gray-800">
                        <i class="ri-file-text-line mr-1"></i> è‡ªå‹•å¡«å¯«
                    </button>
                </div>
            </div>
            
        </div>

        <div v-show="currentTab === 'ItineraryMap'" class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <div class="glass-card p-4 rounded-xl shadow-lg md:col-span-2">
                <h3 class="text-lg font-semibold mb-3 text-primary-indigo"><i class="ri-map-2-line mr-1"></i> è·¯ç·šåœ°åœ–</h3>
                <div id="map" class="rounded-xl shadow-inner"></div>
                <div class="mt-2 text-sm text-gray-600">
                    è·¯ç·šç¸½çµ: {{ activeTrip.routeSummary.distance }} å…¬é‡Œ (ç´„ {{ activeTrip.routeSummary.time }})
                </div>
            </div>

            <div class="glass-card p-4 rounded-xl shadow-lg md:col-span-1 max-h-[600px] overflow-y-auto">
                <h3 class="text-lg font-semibold mb-3 text-primary-indigo"><i class="ri-list-check-2 mr-1"></i> è¡Œç¨‹ç®¡ç†</h3>
                <div class="flex space-x-2 mb-4">
                    <button @click="addItineraryItem" class="flex-1 bg-primary-indigo hover:bg-indigo-500 text-white text-sm font-semibold py-2 rounded-lg shadow-md"><i class="ri-add-line mr-1"></i> æ–°å¢å–®ä¸€è¡Œç¨‹</button>
                    <button @click="showBatchImport = true" class="flex-1 bg-pastel-pink hover:bg-pink-400 text-gray-800 text-sm font-semibold py-2 rounded-lg shadow-md"><i class="ri-file-upload-line mr-1"></i> æ‰¹æ¬¡åŒ¯å…¥</button>
                </div>
                
                <div v-if="showBatchImport" class="p-3 bg-white/70 glass-card rounded-lg shadow-inner mb-4">
                    <h4 class="font-bold text-sm mb-2">æ‰¹æ¬¡åŒ¯å…¥ (åç¨± + åœ°å€, ä¸€è¡Œä¸€å€‹)</h4>
                    <textarea v-model="batchImportText" rows="4" placeholder="ä¾‹å¦‚: 1. æ±äº¬éµå¡” æ¸¯å€èŠå…¬åœ’4ä¸ç›®2-8" class="w-full text-sm p-2 border rounded-md"></textarea>
                    <div class="flex justify-end space-x-2 mt-2">
                        <button @click="batchImportItinerary" class="text-xs py-1 px-3 bg-primary-indigo text-white rounded">ç¢ºèªåŒ¯å…¥</button>
                        <button @click="showBatchImport = false; batchImportText = ''" class="text-xs py-1 px-3 bg-gray-300 rounded">å–æ¶ˆ</button>
                    </div>
                </div>

                <div v-for="(dayItems, dayIndex) in groupedItinerary" :key="dayIndex" class="mb-4">
                    <h4 class="font-bold text-md text-primary-indigo p-2 bg-pastel-blue/50 rounded-t-lg">Day {{ dayIndex + 1 }}</h4>
                    <ul class="border border-gray-300/50 rounded-b-lg p-2 bg-white/40 space-y-2">
                        <li v-for="(item, index) in dayItems" :key="index" class="p-2 border-b last:border-b-0 hover:bg-indigo-50/50 rounded-md transition duration-150">
                            <div class="w-full">
                                <input type="time" v-model="item.time" class="text-sm font-bold w-1/3 p-0.5 border rounded">
                                <input type="text" v-model="item.activity" placeholder="æ´»å‹•åç¨±" class="text-sm font-bold w-2/3 p-0.5 border rounded">
                                <input type="text" v-model="item.location" placeholder="åœ°é»/åœ°å€" class="text-xs w-full p-0.5 border rounded mt-1">
                                <button @click="openMaps(index)" class="mt-1 text-xs text-primary-indigo hover:text-indigo-700"><i class="ri-direction-fill"></i> é–‹å•Ÿåœ°åœ–</button>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'Budget'" class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <div class="glass-card p-4 rounded-xl shadow-lg md:col-span-1">
                <h3 class="text-lg font-semibold mb-3 text-primary-indigo"><i class="ri-exchange-box-line mr-1"></i> åŒ¯ç‡è¨ˆç®—</h3>
                <p class="text-2xl font-bold mb-2 text-gray-800">1,000 HKD â‰ˆ {{ formatCurrency(1000 * activeTrip.exchangeRate) }} {{ activeTrip.currency }}</p>
                <div class="text-sm mt-3">
                    <label class="block mb-1 font-medium">æ‰‹å‹•å¾®èª¿åŒ¯ç‡ (HKD â†’ {{ activeTrip.currency }})</label>
                    <input type="number" step="0.0001" v-model.number="activeTrip.exchangeRate" class="w-full p-2 border rounded-lg text-gray-700">
                    <button @click="fetchExchangeRate" class="mt-2 text-sm p-2 rounded bg-pastel-purple hover:bg-purple-400 text-gray-800 transition duration-200">
                        <i class="ri-refresh-line mr-1"></i> å¾ ExchangeRate.host æŠ“å–
                    </button>
                </div>
            </div>

            <div class="glass-card p-4 rounded-xl shadow-lg md:col-span-2">
                <h3 class="text-lg font-semibold mb-3 text-primary-indigo"><i class="ri-money-cny-box-line mr-1"></i> æ–°å¢æ”¯å‡º</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">é …ç›®åç¨±</label>
                        <input type="text" v-model="newExpense.name" placeholder="ä¾‹å¦‚: åˆé¤ (ä¸€è˜­)" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">é‡‘é¡ (HKD)</label>
                        <input type="number" v-model.number="newExpense.amountHKD" placeholder="æ¸¯å¹£é‡‘é¡" class="w-full p-2 border rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ä»˜æ¬¾æ–¹å¼</label>
                        <select v-model="newExpense.method" class="w-full p-2 border rounded-lg">
                            <option>ç¾é‡‘</option>
                            <option>ä¿¡ç”¨å¡</option>
                            <option>å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">é …ç›®åˆ†é¡</label>
                        <select v-model="newExpense.category" class="w-full p-2 border rounded-lg">
                            <option v-for="cat in expenseCategories" :key="cat">{{ cat }}</option>
                        </select>
                    </div>
                </div>
                <button @click="addExpense" class="mt-4 w-full bg-pastel-blue hover:bg-blue-400 text-gray-800 font-semibold py-2 rounded-lg shadow-md transition duration-300">
                    <i class="ri-bill-line mr-1"></i> è¨˜ä¸€ç­†
                </button>
            </div>

            <div class="glass-card p-4 rounded-xl shadow-lg md:col-span-3">
                <div class="flex justify-between items-center mb-3 border-b pb-2">
                    <h3 class="text-lg font-semibold text-primary-indigo"><i class="ri-bank-card-line mr-1"></i> æ”¯å‡ºåˆ—è¡¨ ({{ activeTrip.expenses.length }} ç­†)</h3>
                    <button @click="exportExpenses" class="text-sm py-1 px-3 bg-gray-200/50 hover:bg-gray-300/70 rounded"><i class="ri-file-excel-2-line mr-1"></i> Export Excel</button>
                </div>

                <div class="grid grid-cols-5 text-center gap-2 mb-3 text-sm font-medium bg-pastel-pink/50 p-2 rounded-lg">
                    <p v-for="(sum, cat) in categoryTotals" :key="cat" class="truncate">{{ cat }}: <span class="font-bold">{{ formatCurrency(sum) }}</span> {{ activeTrip.currency }}</p>
                </div>

                <ul class="space-y-2 max-h-96 overflow-y-auto">
                    <li v-for="expense in activeTrip.expenses" :key="expense.id" class="flex justify-between items-center p-3 bg-white/70 rounded-lg shadow-sm hover:shadow-md transition duration-150">
                        <div>
                            <p class="font-bold">{{ expense.name }}</p>
                            <p class="text-xs text-gray-500">{{ expense.date }} Â· {{ expense.category }} Â· {{ expense.method }}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-red-500">{{ formatCurrency(expense.amountLocal) }} {{ activeTrip.currency }}</p>
                            <p class="text-xs text-gray-400">({{ expense.amountHKD }} HKD)</p>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <div v-show="currentTab === 'Shopping'" class="md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
            
            <div class="glass-card p-4 rounded-xl shadow-lg md:col-span-1">
                <h3 class="text-lg font-semibold mb-3 text-primary-indigo"><i class="ri-shopping-cart-2-line mr-1"></i> æ–°å¢è³¼ç‰©é …ç›®</h3>
                <div>
                    <label class="block text-sm font-medium mb-1">å“é …åç¨±</label>
                    <input type="text" v-model="newShoppingItem.name" placeholder="ä¾‹å¦‚: æ±äº¬ Banana è›‹ç³•" class="w-full p-2 border rounded-lg mb-2">
                    <label class="block text-sm font-medium mb-1">ç¶²ä¸Šåƒ¹éŒ¢</label>
                    <input type="text" v-model="newShoppingItem.onlinePrice" placeholder="ä¾‹å¦‚: 1500 JPY" class="w-full p-2 border rounded-lg mb-2">
                    <label class="block text-sm font-medium mb-1">æœ¬åœ°å¯¦ä»˜åƒ¹</label>
                    <input type="text" v-model="newShoppingItem.localPrice" placeholder="ä¾‹å¦‚: 1450 JPY (å…ç¨…)" class="w-full p-2 border rounded-lg mb-2">
                    <label class="block text-sm font-medium mb-1">ä¸Šå‚³åœ–ç‰‡</label>
                    <input type="file" @change="handleImageUpload" accept="image/*" class="w-full p-2 border rounded-lg mb-4 bg-white/70">
                </div>
                <button @click="addShoppingItem" class="w-full bg-pastel-purple hover:bg-purple-400 text-gray-800 font-semibold py-2 rounded-lg shadow-md transition duration-300">
                    <i class="ri-add-line mr-1"></i> åŠ å…¥æ¸…å–®
                </button>
            </div>

            <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div v-for="item in activeTrip.shoppingItems" :key="item.id" 
                    :class="['glass-card', 'p-3', 'rounded-xl', 'shadow-lg', 'flex', 'space-x-3', {'opacity-50': item.purchased}]">
                    
                    <div class="w-1/4 flex-shrink-0">
                        <img v-if="item.imageData" :src="item.imageData" :alt="item.name" class="w-full h-20 object-cover rounded-lg shadow">
                        <div v-else class="w-full h-20 bg-gray-200/50 rounded-lg flex items-center justify-center text-gray-500 text-xs">No Image</div>
                    </div>
                    
                    <div class="w-3/4">
                        <div class="flex justify-between items-start">
                            <p class="font-bold truncate">{{ item.name }}</p>
                            <button @click="deleteShoppingItem(item.id)" class="text-red-500 hover:text-red-700 ml-2">
                                <i class="ri-delete-bin-line"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-600">ç¶²ä¸Š: {{ item.onlinePrice || 'N/A' }}</p>
                        <p class="text-sm font-semibold text-primary-indigo">å¯¦ä»˜: {{ item.localPrice || 'N/A' }}</p>
                        
                        <div class="flex items-center mt-2">
                            <input type="checkbox" v-model="item.purchased" @change="saveTrips" :id="'shop-' + item.id" class="h-4 w-4 text-primary-indigo border-gray-300 rounded">
                            <label :for="'shop-' + item.id" class="ml-2 text-sm font-medium text-gray-700">å·²è³¼è²·</label>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>

        <div v-show="currentTab === 'TripsHistory'" class="md:col-span-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">

            <div @click="showNewTripModal = true" class="glass-card p-4 rounded-xl shadow-lg flex flex-col items-center justify-center border-2 border-dashed border-primary-indigo/70 cursor-pointer hover:bg-pastel-blue/50 transition duration-150">
                <i class="ri-add-circle-line text-4xl text-primary-indigo"></i>
                <p class="font-bold text-primary-indigo mt-2">æ–°å¢æ—…ç¨‹</p>
            </div>
            
            <div v-for="trip in trips" :key="trip.id" 
                :class="['p-4 rounded-xl shadow-lg cursor-pointer transition duration-300 relative', activeTripId === trip.id ? 'bg-gradient-to-br from-pastel-blue to-pastel-purple text-gray-800 border border-white/70' : 'glass-card']"
                @click="setActiveTrip(trip.id)">

                <div v-if="activeTripId === trip.id" class="absolute top-2 right-2 bg-pastel-pink text-gray-800 text-xs font-bold px-2 py-0.5 rounded-full shadow-md">ACTIVE</div>
                
                <h3 class="text-xl font-bold mb-1 truncate">{{ trip.title }}</h3>
                <p class="text-sm opacity-90">{{ trip.startDate }} ~ {{ trip.endDate }}</p>
                <p class="text-xs opacity-80 mt-1"><i class="ri-map-pin-line"></i> {{ trip.destination }} ({{ trip.currency }})</p>
                
                <div :class="['mt-3 pt-3 border-t', 'border-gray-400/50']">
                    <p class="text-xs">è¡Œç¨‹ç«™æ•¸: **{{ trip.itinerary.length }}**</p>
                    <p class="text-xs">è³¼ç‰©é …ç›®: **{{ trip.shoppingItems.length }}**</p>
                </div>

                <button @click.stop="editTrip(trip)" class="absolute bottom-3 right-3 text-sm text-primary-indigo hover:opacity-70">
                    <i class="ri-edit-line"></i> ç·¨è¼¯
                </button>
                <button v-if="trips.length > 1" @click.stop="deleteTrip(trip.id)" class="absolute bottom-3 right-12 text-sm text-red-500 hover:text-red-700">
                    <i class="ri-delete-bin-line"></i>
                </button>
            </div>
            
        </div>

    </main>
    
    <div v-if="showNewTripModal || showEditTripModal" class="fixed inset-0 bg-black/30 z-50 flex items-center justify-center p-4">
        <div class="glass-card p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h3 class="text-xl font-bold mb-4 border-b pb-2 text-primary-indigo">{{ showNewTripModal ? 'æ–°å¢æ—…ç¨‹' : 'ç·¨è¼¯æ—…ç¨‹' }}</h3>
            <div class="space-y-3">
                <input type="text" v-model="modalTrip.title" placeholder="æ—…ç¨‹æ¨™é¡Œ (å¦‚: æ±äº¬è³¼ç‰©ä¹‹æ—…)" class="w-full p-2 border rounded-lg">
                <input type="text" v-model="modalTrip.destination" placeholder="ç›®çš„åœ° (å¦‚: Tokyo)" class="w-full p-2 border rounded-lg">
                <input type="text" v-model="modalTrip.city" placeholder="åŸå¸‚åç¨± (ç”¨æ–¼å¤©æ°£/å®šä½)" class="w-full p-2 border rounded-lg">
                <input type="text" v-model="modalTrip.currency" placeholder="ç•¶åœ°è²¨å¹£ (å¦‚: JPY)" class="w-full p-2 border rounded-lg uppercase">
                <input type="date" v-model="modalTrip.startDate" class="w-full p-2 border rounded-lg">
                <input type="date" v-model="modalTrip.endDate" class="w-full p-2 border rounded-lg">
            </div>
            <div class="flex justify-end space-x-3 mt-5">
                <button @click="showNewTripModal = false; showEditTripModal = false" class="py-2 px-4 bg-gray-300/70 rounded-lg hover:bg-gray-400/70">å–æ¶ˆ</button>
                <button @click="saveTripModal" class="py-2 px-4 bg-primary-indigo text-white rounded-lg hover:bg-indigo-500">
                    {{ showNewTripModal ? 'å»ºç«‹' : 'å„²å­˜' }}
                </button>
            </div>
        </div>
    </div>

</div>

<script>
    const STORAGE_KEY = 'christine_travel_diary_trips';
    const { createApp, nextTick } = Vue;

    // Haversine Formula (è¨ˆç®—çƒé¢è·é›¢)
    function haversineDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // åœ°çƒåŠå¾‘ (å…¬é‡Œ)
        const toRad = (x) => x * Math.PI / 180;
        
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // è·é›¢ (å…¬é‡Œ)
    }

    const app = createApp({
        data() {
            return {
                // UI ç‹€æ…‹
                currentTab: 'TripInfo',
                tabs: [
                    { id: 'TripInfo', label: 'æ—…ç¨‹è³‡è¨Š', iconClass: 'ri-information-line' },
                    { id: 'ItineraryMap', label: 'è¡Œç¨‹Â·åœ°åœ–', iconClass: 'ri-map-line' },
                    { id: 'Budget', label: 'è¨˜å¸³', iconClass: 'ri-wallet-3-line' },
                    { id: 'Shopping', label: 'è³¼ç‰©æ¸…å–®', iconClass: 'ri-shopping-bag-line' },
                    { id: 'TripsHistory', label: 'æ—…ç¨‹ History', iconClass: 'ri-history-line' },
                ],
                showBatchImport: false,
                batchImportText: '',
                showNewTripModal: false,
                showEditTripModal: false,
                modalTrip: null,

                // è³‡æ–™çµæ§‹
                trips: [],
                activeTripId: null,

                // New Expense ç‹€æ…‹
                newExpense: {
                    name: '',
                    amountHKD: 0,
                    method: 'ç¾é‡‘',
                    category: 'é£²é£Ÿ',
                },
                expenseCategories: ['é£²é£Ÿ', 'è³¼ç‰©', 'å¨›æ¨‚', 'äº¤é€š', 'ä½å®¿', 'å…¶ä»–'],

                // New Shopping Item ç‹€æ…‹
                newShoppingItem: {
                    name: '',
                    onlinePrice: '',
                    localPrice: '',
                    imageData: null,
                },

                // Leaflet Map å¯¦ä¾‹
                map: null,
                routingControl: null,
            }
        },

        computed: {
            activeTrip() {
                // ä½¿ç”¨ä¸€å€‹é è¨­çµæ§‹é¿å…åˆå§‹åŒ–éŒ¯èª¤
                return this.trips.find(t => t.id === this.activeTripId) || this.createDefaultTrip('Loading...', '', '', 'HKD', { lat: 0, lng: 0 });
            },
            totalLocalExpense() {
                if (!this.activeTrip || !this.activeTrip.expenses) return 0;
                return this.activeTrip.expenses.reduce((sum, exp) => sum + exp.amountLocal, 0);
            },
            categoryTotals() {
                const totals = {};
                this.expenseCategories.forEach(cat => totals[cat] = 0);

                if (!this.activeTrip || !this.activeTrip.expenses) return totals;
                
                this.activeTrip.expenses.forEach(exp => {
                    totals[exp.category] = (totals[exp.category] || 0) + exp.amountLocal;
                });
                return totals;
            },
            groupedItinerary() {
                const items = this.activeTrip.itinerary;
                const groups = [];
                const daySize = 5; // æ¯äº”é …è¡Œç¨‹ç‚ºä¸€å¤©
                for (let i = 0; i < items.length; i += daySize) {
                    groups.push(items.slice(i, i + daySize));
                }
                return groups;
            },
        },

        watch: {
            activeTripId(newId, oldId) {
                if (newId !== oldId) {
                    this.initMap();
                    this.fetchWeather();
                    this.fetchExchangeRate();
                }
            },
            trips: {
                handler() {
                    this.saveTrips();
                },
                deep: true
            },
            'activeTrip.exchangeRate'() {
                this.activeTrip.expenses.forEach(exp => {
                    exp.amountLocal = exp.amountHKD * this.activeTrip.exchangeRate;
                });
            }
        },

        methods: {
            // --- è³‡æ–™å„²å­˜/åˆå§‹åŒ– (èˆ‡åŸç¨‹å¼ç¢¼ç›¸åŒ) ---
            loadTrips() {
                const data = localStorage.getItem(STORAGE_KEY);
                if (data) {
                    this.trips = JSON.parse(data);
                    this.activeTripId = this.trips[0].id;
                } else {
                    const defaultTrip = this.createDefaultTrip('Japan Tokyo Trip', 'Tokyo', 'Tokyo', 'JPY', { lat: 35.6895, lng: 139.6917 });
                    this.trips.push(defaultTrip);
                    this.activeTripId = defaultTrip.id;
                }
            },
            saveTrips() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(this.trips));
            },
            
            createDefaultTrip(title, destination, city, currency, center) {
                const now = new Date();
                const startDate = now.toISOString().split('T')[0];
                now.setDate(now.getDate() + 7);
                const endDate = now.toISOString().split('T')[0];
                
                return {
                    id: Date.now(),
                    title,
                    destination,
                    city,
                    currency,
                    startDate,
                    endDate,
                    center: center || { lat: 0, lng: 0 },
                    exchangeRate: 15.0,
                    flights: { outbound: {}, inbound: {} },
                    itinerary: [
                        { time: '10:00', activity: 'åˆ°é”æ©Ÿå ´', location: center.lat + ',' + center.lng, mapsUrl: '', bookingTime: '', remark: 'ç¬¬ä¸€ç«™' },
                        { time: '11:00', activity: 'é…’åº— check-in', location: 'Tokyo Hotel', mapsUrl: '', bookingTime: '', remark: '' }
                    ],
                    routeSummary: { distance: 'N/A', time: 'N/A' },
                    expenses: [],
                    shoppingItems: [],
                    savedListLink: '',
                    weather: { temperature: 'N/A', description: 'N/A' },
                    weatherTheme: 'cloudy',
                };
            },

            // --- UI/Helper ---
            formatCurrency(value) {
                return Math.round(value).toLocaleString();
            },
            setActiveTrip(id) {
                this.activeTripId = id;
                this.currentTab = 'TripInfo';
            },

            // --- API èª¿ç”¨ (å¤©æ°£/åŒ¯ç‡/èˆªç­) ---
            async fetchWeather() {
                if (!this.activeTrip || !this.activeTrip.center.lat) return;
                
                const { lat, lng } = this.activeTrip.center;
                const apiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&hourly=temperature_2m,weather_code&timezone=auto`;

                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.current_weather) {
                        const temp = data.current_weather.temperature;
                        const code = data.current_weather.weather_code;
                        const desc = this.getWeatherDescription(code);

                        this.activeTrip.weather.temperature = temp;
                        this.activeTrip.weather.description = desc;
                        this.activeTrip.weatherTheme = this.getWeatherTheme(desc);
                        this.saveTrips();
                    }
                } catch (error) {
                    console.error('Fetch weather failed:', error);
                }
            },
            getWeatherDescription(code) {
                if ([0, 1].includes(code)) return 'æ™´å¤© (Sunny)';
                if ([2, 3].includes(code)) return 'å¤šé›² (Cloudy)';
                if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) return 'ä¸‹é›¨ (Rainy)';
                return 'N/A';
            },
            getWeatherTheme(desc) {
                const lowerDesc = desc.toLowerCase();
                if (lowerDesc.includes('sunny') || lowerDesc.includes('æ™´')) return 'sunny';
                if (lowerDesc.includes('rainy') || lowerDesc.includes('ä¸‹é›¨')) return 'rainy';
                return 'cloudy';
            },

            async fetchExchangeRate() {
                if (!this.activeTrip || !this.activeTrip.currency) return;
                
                const base = 'HKD';
                const symbols = this.activeTrip.currency;
                const apiUrl = `https://api.exchangerate.host/latest?base=${base}&symbols=${symbols}`;

                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();
                    
                    if (data.rates && data.rates[symbols]) {
                        this.activeTrip.exchangeRate = data.rates[symbols];
                        this.saveTrips();
                    } else {
                        console.warn(`Exchange rate for ${symbols} not found.`);
                    }
                } catch (error) {
                    console.error('Fetch exchange rate failed:', error);
                }
            },

            async fetchFlightDetails(type) {
                const flight = this.activeTrip.flights[type];
                if (!flight.no || !flight.date) {
                    alert('è«‹è¼¸å…¥èˆªç­ç·¨è™Ÿå’Œæ—¥æœŸï¼');
                    return;
                }
                
                const API_KEY = '5b729556e3ef80e18916fcecbcfd81ba';
                const apiUrl = `https://api.aviationstack.com/v1/flights?access_key=${API_KEY}&flight_iata=${flight.no}&flight_date=${flight.date}`;

                try {
                    // Mocking data due to API/CORS constraints
                    const mockData = {
                        departure: { iata: 'HKG', scheduled: '2025-12-10T10:00:00+00:00' },
                        arrival: { iata: 'NRT', scheduled: '2025-12-10T15:00:00+00:00' },
                    };

                    if (mockData && mockData.departure) {
                        flight.from = mockData.departure.iata;
                        flight.to = mockData.arrival.iata;

                        if (type === 'outbound' && this.activeTrip.itinerary.length > 0) {
                            const arrivalTime = new Date(mockData.arrival.scheduled);
                            this.activeTrip.itinerary[0].time = `${String(arrivalTime.getHours()).padStart(2, '0')}:${String(arrivalTime.getMinutes()).padStart(2, '0')}`;
                        } else if (type === 'inbound' && this.activeTrip.itinerary.length > 0) {
                            const departureTime = new Date(mockData.departure.scheduled);
                            this.activeTrip.itinerary[this.activeTrip.itinerary.length - 1].time = `${String(departureTime.getHours()).padStart(2, '0')}:${String(departureTime.getMinutes()).padStart(2, '0')}`;
                        }
                        alert(`${type === 'outbound' ? 'å»ç¨‹' : 'å›ç¨‹'}èˆªç­è©³æƒ…å·²æ›´æ–°ï¼`);
                        this.saveTrips();
                    } else {
                        alert('èˆªç­è³‡è¨ŠæŸ¥æ‰¾å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç·¨è™Ÿèˆ‡æ—¥æœŸã€‚');
                    }
                } catch (error) {
                    console.error('Fetch flight details failed:', error);
                    alert('èˆªç­è³‡è¨ŠæŸ¥æ‰¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯ API æˆ– CORS å•é¡Œã€‚');
                }
            },
            
            // --- è¨˜å¸³/è³¼ç‰©/è¡Œç¨‹ (èˆ‡åŸç¨‹å¼ç¢¼ç›¸åŒï¼Œç•¥éé‡è¤‡) ---
            addExpense() {
                if (!this.newExpense.name || this.newExpense.amountHKD <= 0) {
                    alert('è«‹å¡«å¯«æœ‰æ•ˆçš„é …ç›®åç¨±å’Œé‡‘é¡ï¼');
                    return;
                }
                
                const amountLocal = this.newExpense.amountHKD * this.activeTrip.exchangeRate;
                const now = new Date();
                const dateString = `${now.getMonth() + 1}/${now.getDate()}`;

                this.activeTrip.expenses.unshift({
                    id: Date.now(),
                    date: dateString,
                    ...this.newExpense,
                    amountLocal: amountLocal,
                });

                this.newExpense.name = '';
                this.newExpense.amountHKD = 0;
            },
            exportExpenses() {
                const headers = ['æ—¥æœŸ', 'é …ç›®åç¨±', 'åˆ†é¡', 'ä»˜æ¬¾æ–¹å¼', 'é‡‘é¡ (HKD)', `é‡‘é¡ (${this.activeTrip.currency})`];
                const rows = this.activeTrip.expenses.map(exp => [
                    exp.date, exp.name, exp.category, exp.method, exp.amountHKD, Math.round(exp.amountLocal),
                ]);

                let csvContent = headers.join(',') + '\n';
                rows.forEach(row => { csvContent += row.join(',') + '\n'; });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${this.activeTrip.title}_Expenses.csv`;
                link.click();
            },
            handleImageUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { this.newShoppingItem.imageData = e.target.result; };
                    reader.readAsDataURL(file);
                }
            },
            addShoppingItem() {
                if (!this.newShoppingItem.name) {
                    alert('è«‹å¡«å¯«å“é …åç¨±ï¼');
                    return;
                }

                this.activeTrip.shoppingItems.unshift({
                    id: Date.now(),
                    ...this.newShoppingItem,
                    purchased: false,
                });

                this.newShoppingItem = { name: '', onlinePrice: '', localPrice: '', imageData: null };
                document.querySelector('input[type="file"]').value = null;
            },
            deleteShoppingItem(id) {
                if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è³¼ç‰©é …ç›®å—ï¼Ÿ')) {
                    this.activeTrip.shoppingItems = this.activeTrip.shoppingItems.filter(item => item.id !== id);
                }
            },
            addItineraryItem() {
                const newTime = this.activeTrip.itinerary.length > 0 ? 
                    this.activeTrip.itinerary[this.activeTrip.itinerary.length - 1].time : '10:00';
                    
                this.activeTrip.itinerary.push({
                    time: newTime, activity: '', location: '', mapsUrl: '', bookingTime: '', remark: ''
                });
            },
            batchImportItinerary() {
                if (!this.batchImportText) return;
                
                const lines = this.batchImportText.split('\n').filter(line => line.trim() !== '');
                let currentTime = new Date(2000, 0, 1, 10, 0);
                
                lines.forEach(line => {
                    let [name, address] = line.split(/[.ï¼Œã€]\s*/).filter(Boolean);
                    name = name.trim().replace(/^\d+\.\s*/, '');
                    address = (address || '').trim();

                    const timeString = `${String(currentTime.getHours()).padStart(2, '0')}:${String(currentTime.getMinutes()).padStart(2, '0')}`;

                    this.activeTrip.itinerary.push({
                        time: timeString, activity: name, location: address || name, mapsUrl: '', bookingTime: '', remark: 'æ‰¹æ¬¡åŒ¯å…¥'
                    });

                    currentTime.setHours(currentTime.getHours() + 1);
                });

                this.showBatchImport = false;
                this.batchImportText = '';
            },
            openMaps(index) {
                const item = this.activeTrip.itinerary[index];
                
                if (item.mapsUrl) {
                    window.open(item.mapsUrl, '_blank');
                    return;
                }

                let origin = index > 0 ? this.activeTrip.itinerary[index - 1].location : (this.activeTrip.flights.outbound.to || '');
                const destination = item.location;
                if (!destination) { alert('è«‹å¡«å¯«åœ°é»è³‡è¨Šï¼'); return; }

                const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=driving`;
                window.open(url, '_blank');
            },

            // --- åœ°åœ–åˆå§‹åŒ–èˆ‡ç¹ªè£½ (Leaflet) ---
            async initMap() {
                await nextTick();

                if (this.map) {
                    this.map.remove();
                    this.map = null;
                }
                
                const { lat, lng } = this.activeTrip.center;
                this.map = L.map('map').setView([lat, lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(this.map);

                this.updateRoute();
            },
            
            async updateRoute() {
                if (!this.map) return;
                
                if (this.routingControl) {
                    this.map.removeControl(this.routingControl);
                    this.routingControl = null;
                }

                const waypoints = [];
                let totalDistance = 0;
                let lastCoords = null;
                
                for (const item of this.activeTrip.itinerary) {
                    try {
                        const location = item.location || item.activity;
                        if (!location) continue;
                        
                        const geoUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&format=json&limit=1`;
                        const response = await fetch(geoUrl);
                        const data = await response.json();
                        
                        if (data && data.length > 0) {
                            const coords = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                            waypoints.push(L.latLng(coords.lat, coords.lng));

                            L.marker([coords.lat, coords.lng]).addTo(this.map)
                                .bindPopup(`<b>${item.activity}</b><br>${item.time}<br>${item.location}`);

                            if (lastCoords) {
                                totalDistance += haversineDistance(lastCoords.lat, lastCoords.lng, coords.lat, coords.lng);
                            }
                            lastCoords = coords;
                        }
                    } catch (e) {
                        console.error('Geocoding error:', e);
                    }
                }

                if (waypoints.length >= 2) {
                    this.routingControl = L.Routing.control({
                        waypoints: waypoints,
                        routeWhileDragging: false,
                        show: false,
                        addWaypoints: false,
                        lineOptions: { styles: [{ color: '#7C3AED', weight: 6, opacity: 0.7 }] }, // ä½¿ç”¨ Primary Indigo è·¯ç·šè‰²
                        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' })
                    }).addTo(this.map);
                    
                    this.routingControl.on('routesfound', (e) => {
                        const route = e.routes[0];
                        this.activeTrip.routeSummary.distance = (route.summary.totalDistance / 1000).toFixed(1);
                        const hours = Math.floor(route.summary.totalTime / 3600);
                        const minutes = Math.round((route.summary.totalTime % 3600) / 60);
                        this.activeTrip.routeSummary.time = `${hours > 0 ? hours + 'h' : ''}${minutes}m`;
                        this.saveTrips();
                    });

                    this.map.fitBounds(L.latLngBounds(waypoints));

                } else if (waypoints.length === 1) {
                    this.map.setView(waypoints[0], 13);
                }
                
                if (waypoints.length < 2) {
                    this.activeTrip.routeSummary.distance = totalDistance.toFixed(1);
                    this.activeTrip.routeSummary.time = 'N/A';
                    this.saveTrips();
                }
            },

            // --- æ—…ç¨‹ç®¡ç† (Modal) ---
            editTrip(trip) {
                this.modalTrip = { ...trip };
                this.showEditTripModal = true;
            },
            async saveTripModal() {
                if (!this.modalTrip.title || !this.modalTrip.destination || !this.modalTrip.currency) {
                    alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼');
                    return;
                }

                if (this.showNewTripModal) {
                    const newTrip = this.createDefaultTrip(
                        this.modalTrip.title, this.modalTrip.destination, this.modalTrip.city, this.modalTrip.currency, { lat: 0, lng: 0 }
                    );
                    
                    try {
                        const geoUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(newTrip.city)}&format=json&limit=1`;
                        const response = await fetch(geoUrl);
                        const data = await response.json();
                        if (data && data.length > 0) {
                            newTrip.center.lat = parseFloat(data[0].lat);
                            newTrip.center.lng = parseFloat(data[0].lon);
                        }
                    } catch (e) {
                        console.error('Nominatim geocoding failed for new trip:', e);
                    }
                    
                    this.trips.push(newTrip);
                    this.activeTripId = newTrip.id;

                } else if (this.showEditTripModal) {
                    const index = this.trips.findIndex(t => t.id === this.modalTrip.id);
                    if (index !== -1) {
                        this.trips[index].title = this.modalTrip.title;
                        this.trips[index].destination = this.modalTrip.destination;
                        this.trips[index].city = this.modalTrip.city;
                        this.trips[index].currency = this.modalTrip.currency;
                        this.trips[index].startDate = this.modalTrip.startDate;
                        this.trips[index].endDate = this.modalTrip.endDate;
                    }
                }
                
                this.showNewTripModal = false;
                this.showEditTripModal = false;
            },
            deleteTrip(id) {
                if (this.trips.length <= 1) {
                    alert('æ‚¨ä¸èƒ½åˆªé™¤å”¯ä¸€çš„æ—…ç¨‹ï¼');
                    return;
                }
                if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ—…ç¨‹å—ï¼Ÿæ‰€æœ‰è³‡æ–™å°‡æœƒéºå¤±ã€‚')) {
                    this.trips = this.trips.filter(t => t.id !== id);
                    if (this.activeTripId === id) {
                        this.activeTripId = this.trips[0].id;
                    }
                }
            },
        },

        mounted() {
            this.loadTrips();
            if (this.activeTripId) {
                this.initMap();
                this.fetchWeather();
                this.fetchExchangeRate();
            }
        }
    });

    app.mount('#app');
</script>

</body>
</html>
