<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Christine's Travel Diary</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue.js 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Remix Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
    rel="stylesheet"
  />
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <!-- Leaflet CSS & JS (OpenStreetMap) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <!-- Firebase SDK (compat ç‰ˆæœ¬ï¼Œé©åˆå–®ä¸€ index.html) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#97CBFF',
            secondary: '#C7C7E2',
            bgLight: '#ECF5FF',
            white: '#FFFFFF',
            textMain: '#4A5568',
            textSoft: '#A0AEC0'
          },
          fontFamily: {
            sans: ['"Noto Sans TC"', 'system-ui', 'sans-serif']
          }
        }
      }
    };
  </script>
  <style>
    body {
      background: radial-gradient(circle at top left, #ECF5FF 0, #FFFFFF 40%, #ECF5FF 100%);
      font-family: 'Noto Sans TC', system-ui, sans-serif;
      color: #1a202c;
    }
    .app-shell {
      max-width: 1024px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 16px;
    }
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(151, 203, 255, 0.8);
      border-radius: 999px;
    }
    #map {
      min-height: 280px;
      border-radius: 16px;
    }
  </style>
</head>
<body>
<div id="app" class="app-shell flex flex-col gap-4">

  <!-- Top Bar -->
  <header class="flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-primary flex items-center justify-center text-white text-xl shadow-md">
        <i class="ri-earth-line"></i>
      </div>
      <div>
        <div class="text-xs tracking-wide text-textSoft uppercase">
          Christine's Travel Diary
        </div>
        <div class="text-sm font-semibold text-textMain flex items-center gap-1">
          <i class="ri-sparkling-fill text-primary text-base"></i>
          <span>Travel Dashboard</span>
        </div>
      </div>
    </div>

    <!-- Firebase Login Status -->
    <div class="flex items-center gap-2 text-[11px]">
      <span v-if="currentUserEmail" class="text-textSoft hidden md:inline">
        å·²ç™»å…¥ï¼š{{ currentUserEmail }}
      </span>
      <button
        v-if="!currentUserEmail"
        @click="showLogin = true"
        class="px-2 py-1 rounded-full border border-secondary bg-white text-textMain hover:bg-bgLight/60 flex items-center gap-1"
      >
        <i class="ri-user-line text-xs text-primary"></i>
        <span>ç™»å…¥ / è¨»å†Š</span>
      </button>
      <button
        v-else
        @click="logout"
        class="px-2 py-1 rounded-full border border-secondary bg-white text-textMain hover:bg-bgLight/60 flex items-center gap-1"
      >
        <i class="ri-logout-box-r-line text-xs"></i>
        <span>ç™»å‡º</span>
      </button>

      <button
        @click="handleTripManagerClick"
        class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-secondary bg-white text-xs text-textMain hover:bg-bgLight/60"
      >
        <i class="ri-suitcase-3-line text-sm text-primary"></i>
        <span>æ—…ç¨‹ç®¡ç†</span>
        <span class="text-[10px] text-textSoft">({{ trips.length }})</span>
      </button>
    </div>
  </header>

  <!-- Login Dialog -->
  <div
    v-if="showLogin"
    class="fixed inset-0 bg-black/30 flex items-center justify-center z-50"
  >
    <div class="w-80 rounded-2xl bg-white border border-secondary/70 p-4 text-[11px] shadow-lg">
      <div class="flex items-center justify-between mb-2">
        <span class="font-semibold text-textMain flex items-center gap-1">
          <i class="ri-user-star-line text-primary"></i>
          <span>ç™»å…¥ / è¨»å†Š Firebas e å¸³æˆ¶</span>
        </span>
        <button @click="showLogin = false" class="text-textSoft hover:text-textMain text-xs">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <p class="text-textSoft mb-2">
        åªæœƒç”¨æ–¼åŒæ­¥ä½ çš„æ—…ç¨‹è³‡æ–™ï¼Œä¸æœƒå…¬é–‹çµ¦å…¶ä»–äººã€‚
      </p>
      <div class="flex flex-col gap-2">
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">Email</label>
          <input
            v-model="loginForm.email"
            type="email"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-bgLight outline-none"
            placeholder="you@example.com"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">Password</label>
          <input
            v-model="loginForm.password"
            type="password"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-bgLight outline-none"
            placeholder="è‡³å°‘ 6 ä½å­—å…ƒ"
          />
        </div>
        <div class="text-[10px] text-red-500 min-h-[16px]" v-if="loginError">
          {{ loginError }}
        </div>
        <div class="flex justify-end gap-2 mt-1">
          <button
            @click="showLogin = false"
            class="px-3 py-1.5 rounded-lg border border-secondary/60 text-textMain hover:bg-bgLight"
          >
            å–æ¶ˆ
          </button>
          <button
            @click="loginOrSignup"
            class="px-3 py-1.5 rounded-lg bg-primary text-white hover:bg-primary/90"
          >
            ç™»å…¥ / è¨»å†Š
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Active Trip Summary -->
  <section
    v-if="activeTrip"
    class="rounded-2xl border border-secondary/60 bg-white/90 backdrop-blur-sm px-5 py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3 shadow-sm"
  >
    <div class="flex-1 flex flex-col gap-1">
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center gap-1.5 text-[11px] px-2.5 py-0.5 rounded-full bg-primary text-white shadow-sm">
          <i class="ri-book-open-line text-xs"></i>
          <span>{{ activeTrip.title }}</span>
        </span>
        <span
          class="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-bgLight text-textMain border border-secondary/40"
        >
          <i class="ri-map-pin-line text-xs text-primary"></i>
          <span>{{ activeTrip.destination }}</span>
        </span>
      </div>
      <div class="text-xs text-textSoft flex items-center gap-2 mt-1">
        <i class="ri-calendar-line text-secondary"></i>
        <span>{{ activeTrip.startDate }} â†’ {{ activeTrip.endDate }}</span>
        <span class="inline-block w-px h-3 bg-secondary/60"></span>
        <span class="flex items-center gap-1">
          <i class="ri-money-cny-circle-line text-secondary"></i>
          <span>{{ activeTrip.currency }}</span>
        </span>
      </div>

      <!-- Flights -->
      <div class="flex flex-wrap gap-2 mt-3 text-[11px]">
        <!-- å»ç¨‹ -->
        <div
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl border border-secondary/60 bg-bgLight/80"
        >
          <span class="px-1.5 py-0.5 rounded-full bg-primary text-white text-[10px]">
            å»ç¨‹
          </span>
          <input
            v-model="activeTrip.flights.outbound.no"
            class="w-16 text-[11px] font-semibold text-textMain bg-transparent outline-none border-b border-secondary/50"
            placeholder="Flight"
            @change="saveActiveTrip"
          />
          <input
            v-model="activeTrip.flights.outbound.date"
            class="w-24 text-[11px] text-textSoft bg-transparent outline-none border-b border-secondary/50"
            placeholder="YYYY-MM-DD"
            @change="saveActiveTrip"
          />
          <input
            v-model="activeTrip.flights.outbound.from"
            class="w-10 text-[11px] text-textSoft bg-transparent outline-none border-b border-secondary/50"
            placeholder="HKG"
            @change="saveActiveTrip"
          />
          <span class="text-textSoft">â†’</span>
          <input
            v-model="activeTrip.flights.outbound.to"
            class="w-10 text-[11px] text-textSoft bg-transparent outline-none border-b border-secondary/50"
            placeholder="HND"
            @change="saveActiveTrip"
          />
        </div>

        <!-- å›ç¨‹ -->
        <div
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl border border-secondary/60 bg-bgLight/80"
        >
          <span class="px-1.5 py-0.5 rounded-full bg-primary text-white text-[10px]">
            å›ç¨‹
          </span>
          <input
            v-model="activeTrip.flights.inbound.no"
            class="w-16 text-[11px] font-semibold text-textMain bg-transparent outline-none border-b border-secondary/50"
            placeholder="Flight"
            @change="saveActiveTrip"
          />
          <input
            v-model="activeTrip.flights.inbound.date"
            class="w-24 text-[11px] text-textSoft bg-transparent outline-none border-b border-secondary/50"
            placeholder="YYYY-MM-DD"
            @change="saveActiveTrip"
          />
          <input
            v-model="activeTrip.flights.inbound.from"
            class="w-10 text-[11px] text-textSoft bg-transparent outline-none border-b border-secondary/50"
            placeholder="HND"
            @change="saveActiveTrip"
          />
          <span class="text-textSoft">â†’</span>
          <input
            v-model="activeTrip.flights.inbound.to"
            class="w-10 text-[11px] text-textSoft bg-transparent outline-none border-b border-secondary/50"
            placeholder="HKG"
            @change="saveActiveTrip"
          />
        </div>
      </div>
    </div>

    <!-- Weather + Quick Stats -->
    <div class="flex items-stretch gap-3 text-xs w-full md:w-auto">
      <div
        class="flex-1 md:flex-none w-32 rounded-xl border border-secondary/50 bg-bgLight px-3 py-2 flex flex-col justify-between"
      >
        <div class="flex items-center justify-between">
          <span class="text-[11px] text-textSoft flex items-center gap-1">
            <i class="ri-sun-cloudy-line text-primary"></i>
            <span>ä»Šæ—¥å¤©æ°£</span>
          </span>
          <button
            @click="fetchWeather"
            class="text-[10px] text-textSoft hover:text-textMain"
            title="æ›´æ–°å¤©æ°£"
          >
            <i class="ri-refresh-line"></i>
          </button>
        </div>
        <div class="flex items-end gap-1 mt-1">
          <span class="text-lg font-semibold text-textMain">{{ weather.temp }}Â°C</span>
          <span class="text-[10px] text-textSoft mb-0.5">{{ weather.desc }}</span>
        </div>
        <div class="mt-1 text-[10px] text-textSoft flex items-center gap-1">
          <i class="ri-building-2-line text-secondary"></i>
          <span>{{ activeTrip.city }}</span>
        </div>
      </div>

      <div
        class="flex-1 md:flex-none w-32 rounded-xl border border-secondary/50 bg-bgLight px-3 py-2 flex flex-col justify-between"
      >
        <div class="flex items-center justify-between">
          <span class="text-[11px] text-textSoft flex items-center gap-1">
            <i class="ri-pie-chart-2-line text-primary"></i>
            <span>é ç®—æ¦‚è¦</span>
          </span>
        </div>
        <div class="mt-1">
          <div class="text-[10px] text-textSoft mb-0.5">å·²è¨˜éŒ„æ”¯å‡º</div>
          <div class="text-sm font-semibold text-textMain">
            {{ totalExpenseInCurrency.toLocaleString() }} {{ activeTrip.currency }}
          </div>
        </div>
        <div class="mt-1 text-[10px] text-textSoft flex items-center gap-1">
          <i class="ri-exchange-dollar-line text-secondary"></i>
          <span>HKD â†’ {{ activeTrip.currency }} (å¯¦æ™‚)</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Tabs -->
  <nav
    class="rounded-2xl border border-secondary/60 bg-white/90 backdrop-blur-sm px-2 py-1 flex flex-wrap gap-1 text-[11px]"
  >
    <button
      v-for="tab in tabs"
      :key="tab.id"
      @click="activeTab = tab.id"
      :class="[
        'flex-1 min-w-[80px] flex items-center justify-center gap-1 px-2 py-1.5 rounded-xl transition',
        activeTab === tab.id
          ? 'bg-primary text-white shadow-sm'
          : 'text-textSoft hover:bg-bgLight/80'
      ]"
    >
      <i :class="tab.icon" class="text-xs"></i>
      <span>{{ tab.label }}</span>
    </button>
  </nav>

  <!-- TAB: Itinerary / Map -->
  <section v-if="activeTab === 'itinerary'" class="grid md:grid-cols-[minmax(0,2fr)_minmax(0,3fr)] gap-4">
    <!-- Itinerary List + Batch Import -->
    <div
      class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-3 max-h-[460px] overflow-y-auto"
    >
      <div class="flex items-center justify-between mb-1">
        <h2 class="text-sm font-semibold text-textMain flex items-center gap-1.5">
          <span class="inline-flex w-5 h-5 items-center justify-center rounded-lg bg-primary text-white text-[11px]">
            1
          </span>
          <span>è¡Œç¨‹åˆ—è¡¨</span>
        </h2>
        <button
          @click="addItineraryItem"
          class="text-[11px] px-2.5 py-1 rounded-full border border-secondary/70 text-textMain hover:bg-bgLight/80 flex items-center gap-1"
        >
          <i class="ri-add-line text-xs"></i>
          <span>æ–°å¢</span>
        </button>
      </div>

      <div v-if="activeTrip.itinerary.length === 0" class="text-[11px] text-textSoft py-4 text-center">
        å°šæœªå»ºç«‹è¡Œç¨‹ï¼Œé»æ“Šã€Œæ–°å¢ã€æˆ–ä½¿ç”¨ä¸‹æ–¹ã€Œæ‰¹æ¬¡åŒ¯å…¥åœ°é»ã€ã€‚
      </div>

      <!-- è¡Œç¨‹ + Day1/Day2/Day3 -->
      <div v-for="(item, index) in activeTrip.itinerary" :key="'it-' + index">
        <!-- Day æ¨™é¡Œ -->
        <div
          v-if="shouldShowDayHeader(index)"
          class="flex items-center gap-2 mt-2 mb-1 text-[11px] text-textSoft"
        >
          <div class="w-14 h-px bg-secondary/60"></div>
          <span class="text-textMain font-semibold">
            {{ getDayLabel(index) }}
          </span>
          <div class="flex-1 h-px bg-secondary/20"></div>
        </div>

        <!-- è¡Œç¨‹å¡ç‰‡ -->
        <div
          class="flex gap-3 items-start rounded-xl border border-secondary/40 bg-bgLight/60 px-3 py-2.5"
        >
          <div class="flex flex-col items-center mt-0.5">
            <div
              class="w-9 h-9 rounded-xl bg-primary text-white text-[11px] flex items-center justify-center font-medium shadow-sm"
            >
              {{ item.time || 'â€”' }}
            </div>
            <div
              v-if="index < activeTrip.itinerary.length - 1"
              class="flex-1 w-px bg-secondary/70 mt-1 mb-1"
              style="min-height: 24px"
            ></div>
          </div>

          <div class="flex-1 flex flex-col gap-1">
            <input
              v-model="item.activity"
              class="text-xs font-semibold text-textMain bg-transparent outline-none"
              placeholder="æ´»å‹•åç¨±"
              @change="saveActiveTripAndRoute"
            />
            <input
              v-model="item.location"
              class="text-[11px] text-textSoft bg-transparent outline-none"
              placeholder="åœ°é» / åœ°å€ï¼ˆç”¨æ–¼å°èˆªï¼‰"
              @change="saveActiveTripAndRoute"
            />
            <div v-if="item.distance || item.duration" class="text-[11px] text-textSoft flex gap-2">
              <span v-if="item.distance">è·é›¢ {{ item.distance }}</span>
              <span v-if="item.duration">Â· {{ item.duration }}</span>
            </div>
            <div class="flex items-center gap-2 mt-1">
              <a
                :href="getSingleDirectionLink(item, index)"
                target="_blank"
                class="text-[11px] px-2 py-1 rounded-full border border-secondary/70 text-textMain hover:bg-bgLight/80 flex items-center gap-1"
              >
                <i class="ri-map-pin-line text-xs text-primary"></i>
                <span>Google Maps</span>
              </a>
              <button
                @click="removeItineraryItem(index)"
                class="ml-auto text-[11px] text-textSoft hover:text-red-500"
              >
                åˆªé™¤
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Batch import -->
      <div class="mt-2 rounded-xl border border-secondary/50 bg-bgLight/80 px-3 py-2 text-[11px]">
        <div class="flex items-center justify-between mb-1">
          <span class="flex items-center gap-1 text-textMain">
            <i class="ri-magic-line text-primary"></i>
            <span>æ‰¹æ¬¡åŒ¯å…¥åœ°é»</span>
          </span>
        </div>
        <p class="text-[10px] text-textSoft mb-1">
          å¾ Google Maps æ¸…å–®è¤‡è£½å¤šå€‹åœ°é»ï¼Œæ¯è¡Œä¸€å€‹ã€‚
        </p>
        <textarea
          v-model="bulkPlaces"
          rows="4"
          placeholder="ä¸€è¡Œä¸€å€‹åœ°é»ï¼Œä¾‹å¦‚ï¼š&#10;Blue Bottle Coffee - Shibuya, Tokyo&#10;Ichiran Ramen, Shinjuku, Tokyo"
          class="w-full border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none text-[11px] text-textMain mb-2"
        ></textarea>
        <div class="flex items-center justify-between">
          <span class="text-[10px] text-textSoft">
            å°‡è‡ªå‹•ç‚ºæ¯å€‹åœ°é»å®‰æ’æ™‚é–“ï¼Œä½ å¯ä¹‹å¾Œå†å¾®èª¿ã€‚
          </span>
          <button
            @click="importBulkPlaces"
            class="px-2.5 py-1 rounded-full bg-primary text-white text-[11px] font-semibold hover:bg-primary/90 flex items-center gap-1"
          >
            <i class="ri-download-2-line text-xs"></i>
            <span>åŒ¯å…¥åˆ°è¡Œç¨‹</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Map Pane + Saved List Link (Leaflet) -->
    <div
      class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-3 flex flex-col gap-3"
    >
      <div class="flex items-center justify-between">
        <h3 class="text-xs font-semibold text-textMain flex items-center gap-1.5">
          <span
            class="inline-flex w-5 h-5 items-center justify-center rounded-lg bg-primary text-white text-[11px]"
          >
            2
          </span>
          <span>è·¯ç·šåœ°åœ–</span>
        </h3>
        <div class="flex items-center gap-2 text-[11px] text-textSoft">
          <i class="ri-map-line text-primary"></i>
          <span>Leaflet + OpenStreetMapï¼ˆç´”å‰ç«¯ï¼‰</span>
        </div>
      </div>

      <div id="map" class="w-full bg-bgLight"></div>

      <div v-if="activeTrip.routeSummary" class="flex items-center gap-4 text-[11px] text-textSoft mt-1">
        <div class="flex items-center gap-1">
          <i class="ri-road-map-line text-secondary"></i>
          <span>{{ activeTrip.routeSummary.distance }}</span>
        </div>
        <div class="flex items-center gap-1">
          <i class="ri-time-line text-secondary"></i>
          <span>{{ activeTrip.routeSummary.duration }}</span>
        </div>
        <div class="flex items-center gap-1">
          <i class="ri-map-pin-range-line text-secondary"></i>
          <span>{{ activeTrip.itinerary.length }} stops</span>
        </div>
      </div>

      <div class="mt-2 rounded-xl border border-secondary/50 bg-bgLight/80 px-3 py-2 text-[11px]">
        <div class="flex items-center justify-between mb-1">
          <span class="flex items-center gap-1 text-textMain">
            <i class="ri-star-smile-line text-primary"></i>
            <span>Google Maps å·²å„²å­˜æ¸…å–®é€£çµ</span>
          </span>
          <a
            v-if="activeTrip.savedListLink"
            :href="activeTrip.savedListLink"
            target="_blank"
            class="text-primary hover:underline flex items-center gap-1"
          >
            <i class="ri-external-link-line text-xs"></i>
            <span>é–‹å•Ÿæ¸…å–®</span>
          </a>
        </div>
        <p class="text-[10px] text-textSoft mb-1">
          åœ¨ Google Maps ä¸­åˆ†äº«ä½ çš„ã€Œå·²å„²å­˜æ¸…å–®ã€é€£çµï¼Œè²¼ä¸Šåˆ°é€™è£¡ã€‚
        </p>
        <input
          v-model="activeTrip.savedListLink"
          @change="saveActiveTrip"
          placeholder="è²¼ä¸Š Google Maps å·²å„²å­˜æ¸…å–®åˆ†äº«é€£çµ"
          class="w-full border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none text-[11px] text-textMain"
        />
      </div>
    </div>
  </section>

  <!-- TAB: Budget -->
  <section
    v-if="activeTab === 'budget'"
    class="grid md:grid-cols-[minmax(0,2fr)_minmax(0,3fr)] gap-4"
  >
    <!-- FX & Add Expense -->
    <div
      class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-3"
    >
      <!-- FX -->
      <div
        class="rounded-xl border border-secondary/60 bg-primary text-white px-4 py-3 flex flex-col gap-2"
      >
        <div class="flex items-center justify-between text-[11px]">
          <span class="flex items-center gap-1">
            <i class="ri-exchange-dollar-line"></i>
            <span>å¯¦æ™‚åŒ¯ç‡ Â· HKD â†’ {{ activeTrip?.currency || 'JPY' }}</span>
          </span>
          <button
            @click="fetchRate"
            class="text-white/80 hover:text-white"
            title="æ›´æ–°åŒ¯ç‡"
          >
            <i class="ri-refresh-line text-xs"></i>
          </button>
        </div>
        <div class="flex items-baseline gap-1">
          <span class="text-xl font-semibold">1,000 HKD</span>
          <span class="text-xs text-white/80 mx-1">â‰ˆ</span>
          <span class="text-lg font-semibold">
            {{ (1000 * (activeTrip?.exchangeRate || 0)).toFixed(2) }} {{ activeTrip?.currency || 'JPY' }}
          </span>
        </div>
        <div class="flex items-center gap-2 text-[11px] mt-1">
          <span class="text-white/80">æ‰‹å‹•å¾®èª¿ï¼š</span>
          <input
            type="number"
            v-model.number="activeTrip.exchangeRate"
            @change="saveActiveTrip"
            class="w-24 px-2 py-1 rounded bg-white/90 text-xs text-textMain outline-none"
            step="0.0001"
          />
        </div>
      </div>

      <!-- Add Expense -->
      <div class="flex flex-col gap-2 text-xs">
        <h3 class="text-[11px] font-semibold text-textMain flex items-center gap-1">
          <i class="ri-wallet-3-line text-primary"></i>
          <span>æ–°å¢æ”¯å‡º</span>
        </h3>
        <div class="grid grid-cols-2 gap-2">
          <input
            v-model="newExpense.item"
            placeholder="é …ç›® (e.g. å’–å•¡)"
            class="border border-secondary/60 rounded-lg px-3 py-2 bg-bgLight outline-none text-xs"
          />
          <input
            v-model.number="newExpense.amount"
            type="number"
            placeholder="é‡‘é¡ (HKD)"
            class="border border-secondary/60 rounded-lg px-3 py-2 bg-bgLight outline-none text-xs"
          />
        </div>
        <div class="flex gap-2">
          <select
            v-model="newExpense.payment"
            class="border border-secondary/60 rounded-lg px-3 py-2 bg-bgLight outline-none flex-1 text-xs text-textMain"
          >
            <option value="cash">ğŸ’µ ç¾é‡‘</option>
            <option value="card">ğŸ’³ ä¿¡ç”¨å¡</option>
          </select>
          <button
            @click="addExpense"
            class="px-3 py-2 rounded-lg bg-primary text-white text-xs font-semibold hover:bg-primary/90"
          >
            è¨˜ä¸€ç­†
          </button>
        </div>
      </div>
    </div>

    <!-- Expense List -->
    <div
      class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-2 max-h-[460px] overflow-y-auto"
    >
      <div class="flex items-center justify-between mb-1">
        <h3 class="text-xs font-semibold text-textMain flex items-center gap-1.5">
          <span
            class="inline-flex w-5 h-5 items-center justify-center rounded-lg bg-primary text-white text-[11px]"
          >
            $
          </span>
          <span>æ”¯å‡ºåˆ—è¡¨</span>
        </h3>
        <div class="text-[11px] text-textSoft">
          å…± {{ activeTrip.expenses?.length || 0 }} ç­† Â·
          <span class="font-semibold">
            {{ totalExpenseInCurrency.toLocaleString() }} {{ activeTrip.currency }}
          </span>
        </div>
      </div>

      <div
        v-for="(exp, i) in activeTrip.expenses"
        :key="'exp-' + i"
        class="flex items-center justify-between rounded-xl border border-secondary/40 bg-bgLight/80 px-3 py-2 text-xs"
      >
        <div class="flex items-center gap-3">
          <div
            :class="exp.payment === 'card'
              ? 'bg-white text-primary border border-secondary'
              : 'bg-white text-green-500 border border-secondary'"
            class="w-8 h-8 rounded-lg flex items-center justify-center text-base"
          >
            <i :class="exp.payment === 'card' ? 'ri-bank-card-line' : 'ri-wallet-3-line'"></i>
          </div>
          <div>
            <div class="font-semibold text-textMain text-xs">
              {{ exp.item }}
            </div>
            <div class="text-[11px] text-textSoft">
              {{ exp.date }}
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-xs text-textMain">
            -HKD {{ exp.amount.toLocaleString() }}
          </div>
          <div class="text-[11px] text-textSoft">
            â‰ˆ {{ (exp.amount * (activeTrip.exchangeRate || 0)).toFixed(1) }} {{ activeTrip.currency }}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TAB: Shopping -->
  <section
    v-if="activeTab === 'shopping'"
    class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-3"
  >
    <div class="flex items-center justify-between mb-1">
      <h2 class="text-sm font-semibold text-textMain flex items-center gap-1.5">
        <i class="ri-shopping-bag-3-line text-primary"></i>
        <span>æ—…ç¨‹è³¼ç‰©æ¸…å–®</span>
      </h2>
    </div>

    <!-- æ–°å¢è³¼ç‰©é …ç›®è¡¨å–® -->
    <div class="rounded-xl border border-secondary/60 bg-bgLight/80 px-3 py-3 text-xs flex flex-col gap-2">
      <div class="grid md:grid-cols-[1.5fr_1fr_1fr] gap-2">
        <div class="flex flex-col gap-1">
          <label class="text-textSoft text-[11px]">å“é …åç¨±</label>
          <input
            v-model="newShoppingItem.name"
            placeholder="ä¾‹å¦‚ï¼šUNIQLO ç¾½çµ¨å¤–å¥—"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft text-[11px]">ç¶²ä¸Šåƒ¹éŒ¢</label>
          <input
            v-model="newShoppingItem.onlinePrice"
            placeholder="ä¾‹å¦‚ï¼šHK$799 / Â¥15,000"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft text-[11px]">ç•¶åœ°å¯¦ä»˜åƒ¹</label>
          <input
            v-model="newShoppingItem.localPrice"
            placeholder="ä¾‹å¦‚ï¼šÂ¥13,000"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
      </div>

      <div class="flex items-center justify-between mt-2">
        <div class="flex items-center gap-2">
          <div class="w-14 h-14 rounded-lg bg-white border border-secondary/60 flex items-center justify-center overflow-hidden">
            <img
              v-if="newShoppingItem.imageData"
              :src="newShoppingItem.imageData"
              class="w-full h-full object-cover"
            />
            <span v-else class="text-[10px] text-textSoft px-1 text-center">
              ç„¡ç›¸ç‰‡
            </span>
          </div>
          <label
            class="text-[11px] px-2 py-1.5 rounded-full border border-secondary/70 bg-white text-textMain cursor-pointer flex items-center gap-1"
          >
            <i class="ri-image-add-line text-xs text-primary"></i>
            <span>åŒ¯å…¥ç›¸ç‰‡</span>
            <input
              type="file"
              accept="image/*"
              class="hidden"
              @change="handleShoppingImageChange($event, null)"
            />
          </label>
        </div>
        <button
          @click="addShoppingItem"
          class="px-3 py-2 rounded-lg bg-primary text-white text-xs font-semibold hover:bg-primary/90 flex items-center gap-1"
        >
          <i class="ri-add-line text-xs"></i>
          <span>åŠ å…¥æ¸…å–®</span>
        </button>
      </div>
    </div>

    <!-- å·²åŠ å…¥çš„è³¼ç‰©é …ç›® -->
    <div class="mt-2 grid md:grid-cols-2 gap-3">
      <div
        v-for="(item, index) in activeTrip.shoppingItems"
        :key="'shop-' + index"
        class="rounded-xl border border-secondary/60 bg-bgLight/60 px-3 py-3 flex gap-3 text-xs"
        :class="{ 'opacity-60': item.purchased }"
      >
        <div class="w-16 h-16 rounded-lg bg-white border border-secondary/60 flex items-center justify-center overflow-hidden flex-shrink-0">
          <img
            v-if="item.imageData"
            :src="item.imageData"
            class="w-full h-full object-cover"
          />
          <span v-else class="text-[10px] text-textSoft px-1 text-center">
            ç„¡ç›¸ç‰‡
          </span>
        </div>

        <div class="flex-1 flex flex-col gap-1">
          <div class="flex items-center justify-between">
            <div class="font-semibold text-textMain text-[12px] truncate">
              {{ item.name }}
            </div>
            <button
              @click="removeShoppingItem(index)"
              class="text-textSoft hover:text-red-500"
            >
              <i class="ri-delete-bin-line text-xs"></i>
            </button>
          </div>
          <div class="text-[11px] text-textSoft">
            ç¶²ä¸Šåƒ¹éŒ¢ï¼š<span class="text-textMain">{{ item.onlinePrice || '-' }}</span>
          </div>
          <div class="text-[11px] text-textSoft">
            ç•¶åœ°å¯¦ä»˜ï¼š<span class="text-textMain">{{ item.localPrice || '-' }}</span>
          </div>
          <label class="mt-1 inline-flex items-center gap-1 text-[11px] cursor-pointer">
            <input
              type="checkbox"
              v-model="item.purchased"
              @change="toggleShoppingPurchased(index)"
              class="w-3 h-3 rounded border border-secondary"
            />
            <span>å·²è³¼è²·</span>
          </label>
        </div>
      </div>

      <div
        v-if="!activeTrip.shoppingItems || activeTrip.shoppingItems.length === 0"
        class="col-span-full text-[11px] text-textSoft text-center py-4"
      >
        æš«æœªæœ‰è³¼ç‰©é …ç›®ï¼Œå…ˆåœ¨ä¸Šæ–¹æ–°å¢ä¸€å€‹å§ã€‚
      </div>
    </div>
  </section>

  <!-- TAB: Trips / History -->
  <section
    v-if="activeTab === 'trips'"
    class="rounded-2xl border border-secondary/60 bg-white/95 backdrop-blur-sm p-4 flex flex-col gap-3"
  >
    <div class="flex items-center justify-between mb-1">
      <h2 class="text-sm font-semibold text-textMain flex items-center gap-1.5">
        <i class="ri-suitcase-3-line text-primary"></i>
        <span>æ—…ç¨‹ / History</span>
      </h2>
      <button
        @click="startCreateTrip"
        class="text-[11px] px-2.5 py-1 rounded-full border border-secondary/70 text-textMain hover:bg-bgLight/80 flex items-center gap-1"
      >
        <i class="ri-add-line text-xs"></i>
        <span>æ–°å¢æ—…ç¨‹</span>
      </button>
    </div>
    <p class="text-[11px] text-textSoft mb-1">
      å·²ç™»å…¥æ™‚ï¼Œæ—…ç¨‹æœƒåŒæ­¥å„²å­˜åœ¨ Firebaseï¼ˆå¤šè£ç½®å…±äº«ï¼‰ï¼›æœªç™»å…¥æ™‚å‰‡å­˜æ–¼æ­¤è£ç½®çš„ localStorageã€‚
    </p>

    <div class="grid md:grid-cols-3 gap-3">
      <div
        v-for="trip in trips"
        :key="trip.id"
        class="rounded-xl border border-secondary/60 bg-bgLight/80 px-3 py-3 flex flex-col gap-1 text-[11px] cursor-pointer hover:border-primary"
        :class="{ 'ring-1 ring-primary': trip.id === activeTripId }"
        @click="switchTrip(trip.id)"
      >
        <div class="flex items-center justify-between">
          <div class="font-semibold text-textMain text-xs truncate max-w-[120px]">
            {{ trip.title }}
          </div>
          <span
            class="px-1.5 py-0.5 rounded-full bg-primary text-white text-[10px]"
            v-if="trip.id === activeTripId"
          >
            Active
          </span>
        </div>
        <div class="text-[11px] text-textSoft flex items-center gap-1">
          <i class="ri-map-pin-line text-secondary"></i>
          <span class="truncate">{{ trip.destination }}</span>
        </div>
        <div class="text-[11px] text-textSoft">
          {{ trip.startDate }} â†’ {{ trip.endDate }}
        </div>
        <div class="mt-1 flex items-center justify-between text-[10px] text-textSoft">
          <span class="flex items-center gap-1">
            <i class="ri-wallet-3-line"></i>
            <span>{{ trip.currency }}</span>
          </span>
          <button
            @click.stop="deleteTrip(trip.id)"
            class="text-textSoft hover:text-red-500"
            title="åˆªé™¤æ—…ç¨‹"
          >
            <i class="ri-delete-bin-line text-xs"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Create Trip Form -->
    <div
      v-if="creatingTrip"
      class="mt-3 rounded-xl border border-secondary/60 bg-bgLight/80 px-3 py-3 text-[11px] flex flex-col gap-2"
    >
      <div class="flex items-center justify-between">
        <span class="font-semibold text-textMain">æ–°å¢æ—…ç¨‹</span>
        <button @click="creatingTrip = false" class="text-textSoft hover:text-textMain text-xs">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="grid md:grid-cols-2 gap-2">
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">æ—…ç¨‹åç¨±</label>
          <input
            v-model="newTripForm.title"
            placeholder="Japan Winter Escape"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">ç›®çš„åœ° (åœ‹å®¶ / åŸå¸‚)</label>
          <input
            v-model="newTripForm.destination"
            placeholder="Japan Â· Tokyo"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">åŸå¸‚åç¨± (å¤©æ°£ / åœ°åœ–)</label>
          <input
            v-model="newTripForm.city"
            placeholder="Tokyo"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">ç•¶åœ°è²¨å¹£</label>
          <input
            v-model="newTripForm.currency"
            placeholder="JPY / EUR / etc."
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>

        <!-- è‡ªå‹•å–å¾—åº§æ¨™æŒ‰éˆ• -->
        <div class="md:col-span-2 flex items-center justify-between text-[11px] mt-1">
          <span class="text-textSoft">
            å¯ç”¨åŸå¸‚åç¨±è‡ªå‹•å–å¾—åœ°åœ–ä¸­å¿ƒç·¯åº¦ / ç¶“åº¦
          </span>
          <button
            @click="autoFillLatLng"
            type="button"
            class="px-2.5 py-1 rounded-full border border-secondary/70 text-textMain hover:bg-bgLight/80 flex items-center gap-1"
          >
            <i class="ri-compass-3-line text-xs text-primary"></i>
            <span>è‡ªå‹•å–å¾—åº§æ¨™</span>
          </button>
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-textSoft">åœ°åœ–ä¸­å¿ƒç·¯åº¦</label>
          <input
            v-model.number="newTripForm.lat"
            type="number"
            step="0.0001"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-textSoft">åœ°åœ–ä¸­å¿ƒç¶“åº¦</label>
          <input
            v-model.number="newTripForm.lng"
            type="number"
            step="0.0001"
            class="border border-secondary/60 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
      </div>
      <div class="mt-2 flex justify-end gap-2">
        <button
          @click="creatingTrip = false"
          class="px-3 py-1.5 rounded-lg border border-secondary/60 text-textMain hover:bg-bgLight"
        >
          å–æ¶ˆ
        </button>
        <button
          @click="createTrip"
          class="px-3 py-1.5 rounded-lg bg-primary text-white hover:bg-primary/90"
        >
          å»ºç«‹æ—…ç¨‹
        </button>
      </div>
    </div>
  </section>

</div>

<script>
  // Firebase configï¼ˆä½¿ç”¨ä½ æä¾›çš„å°ˆæ¡ˆè¨­å®šï¼‰[web:383][web:415]
  const firebaseConfig = {
    apiKey: "AIzaSyDHfhq36jAG7ktsgEk-xK_qum6EetlaMkw",
    authDomain: "christine-s-travel-plan.firebaseapp.com",
    projectId: "christine-s-travel-plan",
    storageBucket: "christine-s-travel-plan.firebasestorage.app",
    messagingSenderId: "645802320428",
    appId: "1:645802320428:web:bd14a98f4d012684136789",
    measurementId: "G-EVQ0T4Q29W"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let leafletMap = null;
  let routePolyline = null;
  let markersLayer = null;

  const { createApp } = Vue;

  createApp({
    data() {
      return {
        tabs: [
          { id: 'itinerary', label: 'è¡Œç¨‹ / åœ°åœ–', icon: 'ri-calendar-todo-line' },
          { id: 'budget', label: 'è¨˜å¸³', icon: 'ri-wallet-3-line' },
          { id: 'shopping', label: 'æ—…ç¨‹è³¼ç‰©', icon: 'ri-shopping-bag-3-line' },
          { id: 'trips', label: 'æ—…ç¨‹ / History', icon: 'ri-suitcase-3-line' }
        ],
        activeTab: 'itinerary',

        trips: [],
        activeTripId: null,

        weather: { temp: '--', desc: 'è¼‰å…¥ä¸­...' },

        newExpense: { item: '', amount: null, payment: 'cash' },
        creatingTrip: false,
        newTripForm: {
          title: '',
          destination: '',
          city: '',
          currency: 'JPY',
          startDate: '',
          endDate: '',
          lat: 35.6762,
          lng: 139.6503
        },

        bulkPlaces: '',

        newShoppingItem: {
          name: '',
          onlinePrice: '',
          localPrice: '',
          imageData: '',
          purchased: false
        },

        daySize: 5,

        // Firebase login state
        currentUserEmail: null,
        showLogin: false,
        loginForm: { email: '', password: '' },
        loginError: ''
      };
    },
    computed: {
      activeTrip() {
        return this.trips.find(t => t.id === this.activeTripId) || null;
      },
      totalExpenseInCurrency() {
        if (!this.activeTrip) return 0;
        const totalHKD = (this.activeTrip.expenses || []).reduce((sum, e) => sum + (e.amount || 0), 0);
        return Math.round(totalHKD * (this.activeTrip.exchangeRate || 0));
      }
    },
    created() {
      // é è¨­ localStorage ç‰ˆæœ¬ï¼ˆæœªç™»å…¥æ™‚ç”¨ï¼‰
      const stored = localStorage.getItem('christine_travel_diary_trips');
      if (stored) {
        try {
          this.trips = JSON.parse(stored);
        } catch (e) {
          this.trips = [];
        }
      }

      if (this.trips.length === 0) {
        const defaultTrip = {
          id: Date.now().toString(),
          createdAt: Date.now(),
          title: "Japan Winter 2025",
          destination: "Japan Â· Tokyo",
          city: "Tokyo",
          currency: "JPY",
          startDate: "2025-12-24",
          endDate: "2026-01-01",
          center: { lat: 35.6762, lng: 139.6503 },
          exchangeRate: 20.04,
          travelMode: "TRANSIT",
          flights: {
            outbound: { no: "NH924", date: "2025-12-24", from: "HKG", to: "HND" },
            inbound: { no: "NH923", date: "2026-01-01", from: "HND", to: "HKG" }
          },
          itinerary: [
            {
              time: "09:00",
              activity: "æŠµé”æ±äº¬ç¾½ç”°æ©Ÿå ´",
              location: "Tokyo Haneda Airport, Japan"
            },
            {
              time: "11:00",
              activity: "é…’åº— Check-in",
              location: "Shinjuku, Tokyo"
            },
            {
              time: "14:00",
              activity: "è¡¨åƒé“ / åŸå®¿é€›è¡—",
              location: "Omotesando, Tokyo"
            },
            {
              time: "19:00",
              activity: "æ–°å®¿æ™šé¤",
              location: "Shinjuku, Tokyo"
            }
          ],
          routeSummary: null,
          expenses: [],
          tripItems: [],
          shoppingItems: [],
          savedListLink: ""
        };
        this.trips.push(defaultTrip);
      }

      this.activeTripId = this.trips[0].id;
    },
    mounted() {
      this.initLeafletMap();
      this.updateRoute();
      this.fetchWeather();
      this.fetchRate();

      // ç›£è½ Firebase ç™»å…¥ç‹€æ…‹ [web:383][web:410]
      auth.onAuthStateChanged(user => {
        if (user) {
          this.currentUserEmail = user.email;
          this.loadTripsFromFirestore();
        } else {
          this.currentUserEmail = null;
          // å›åˆ° localStorage ç‰ˆæœ¬
          const stored = localStorage.getItem('christine_travel_diary_trips');
          if (stored) {
            try {
              this.trips = JSON.parse(stored);
            } catch {
              this.trips = [];
            }
          }
          this.activeTripId = this.trips[0]?.id || null;
          this.$nextTick(() => this.updateRoute());
        }
      });
    },
    watch: {
      trips: {
        handler(val) {
          // ç„¡è«–æœ‰æ²’æœ‰ç™»å…¥ï¼Œéƒ½å…ˆå¯« localStorageï¼ˆç•¶ä½œæœ¬æ©Ÿå‚™ä»½ï¼‰[web:373]
          localStorage.setItem('christine_travel_diary_trips', JSON.stringify(val));
        },
        deep: true
      },
      activeTripId() {
        this.$nextTick(() => {
          if (this.activeTrip && leafletMap) {
            leafletMap.setView(this.activeTrip.center || { lat: 35.6762, lng: 139.6503 }, 12);
            this.updateRoute();
          }
        });
      }
    },
    methods: {
      handleTripManagerClick() {
        this.activeTab = 'trips';
        this.creatingTrip = true;
      },

      // Login / Signupï¼ˆEmail + Passwordï¼‰[web:383][web:410]
      async loginOrSignup() {
        this.loginError = '';
        const { email, password } = this.loginForm;
        if (!email || !password) {
          this.loginError = 'è«‹è¼¸å…¥ Email å’Œ Password';
          return;
        }
        try {
          try {
            await auth.signInWithEmailAndPassword(email, password);
          } catch (e) {
            await auth.createUserWithEmailAndPassword(email, password);
          }
          this.showLogin = false;
          this.loginForm = { email: '', password: '' };
        } catch (e) {
          console.error(e);
          this.loginError = 'ç™»å…¥ / è¨»å†Šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Email / å¯†ç¢¼æ ¼å¼ã€‚';
        }
      },
      async logout() {
        await auth.signOut();
      },

      // Firestore åŒæ­¥ [web:396][web:419]
      async loadTripsFromFirestore() {
        if (!auth.currentUser) return;
        const uid = auth.currentUser.uid;
        const snap = await db
          .collection('users')
          .doc(uid)
          .collection('trips')
          .orderBy('createdAt', 'asc')
          .get();

        const trips = [];
        snap.forEach(doc => trips.push(doc.data()));
        if (!trips.length) {
          // å¦‚æœé›²ç«¯æ²’æœ‰è³‡æ–™ï¼Œå°±æŠŠæœ¬æ©Ÿ trips ä¸Šå‚³ä¸€æ¬¡
          for (const t of this.trips) {
            await this.saveTripToFirestore(t);
          }
        } else {
          this.trips = trips;
        }
        this.activeTripId = this.trips[0]?.id || null;
        this.$nextTick(() => this.updateRoute());
      },
      async saveTripToFirestore(trip) {
        if (!auth.currentUser) return;
        const uid = auth.currentUser.uid;
        await db
          .collection('users')
          .doc(uid)
          .collection('trips')
          .doc(trip.id)
          .set({
            ...trip,
            createdAt: trip.createdAt || Date.now()
          });
      },
      async deleteTripFromFirestore(id) {
        if (!auth.currentUser) return;
        const uid = auth.currentUser.uid;
        await db
          .collection('users')
          .doc(uid)
          .collection('trips')
          .doc(id)
          .delete();
      },
      async saveActiveTrip() {
        if (this.activeTrip) {
          await this.saveTripToFirestore(this.activeTrip);
        }
      },
      async saveActiveTripAndRoute() {
        await this.saveActiveTrip();
        this.updateRoute();
      },

      // Day helpers
      getDayLabel(index) {
        const day = Math.floor(index / this.daySize) + 1;
        return 'Day ' + day;
      },
      shouldShowDayHeader(index) {
        return index === 0 || index % this.daySize === 0;
      },

      initLeafletMap() {
        const mapEl = document.getElementById('map');
        if (!mapEl) return;
        leafletMap = L.map('map').setView([35.6762, 139.6503], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(leafletMap);
        markersLayer = L.layerGroup().addTo(leafletMap);
      },

      async fetchWeather() {
        try {
          const lat = this.activeTrip?.center?.lat || 35.6762;
          const lng = this.activeTrip?.center?.lng || 139.6503;
          const res = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`
          );
          const data = await res.json();
          this.weather = {
            temp: data.current_weather.temperature,
            desc: 'æ™´åˆ°å¤šé›²'
          };
        } catch (e) {
          this.weather = { temp: '10', desc: 'Clear' };
        }
      },

      async fetchRate() {
        try {
          const target = this.activeTrip?.currency || 'JPY';
          const res = await fetch(`https://api.exchangerate.host/latest?base=HKD&symbols=${target}`);
          const data = await res.json();
          if (this.activeTrip && data.rates && data.rates[target]) {
            this.activeTrip.exchangeRate = data.rates[target];
            await this.saveActiveTrip();
          }
        } catch (e) {}
      },

      // ä½¿ç”¨ Nominatim å–å¾—åº§æ¨™ + è·¯ç·šç›´ç·š polyline [web:356][web:353]
      async updateRoute() {
        if (!this.activeTrip || !leafletMap || !this.activeTrip.itinerary.length) return;

        markersLayer.clearLayers();
        if (routePolyline) {
          leafletMap.removeLayer(routePolyline);
          routePolyline = null;
        }

        const coords = [];
        const geocoded = [];

        for (const item of this.activeTrip.itinerary) {
          if (!item.location) continue;
          try {
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
              item.location
            )}`;
            const res = await fetch(url, {
              headers: { 'Accept-Language': 'zh-HK' }
            });
            const data = await res.json();
            if (data && data.length > 0) {
              const best = data[0];
              const lat = parseFloat(best.lat);
              const lng = parseFloat(best.lon);
              coords.push([lat, lng]);
              geocoded.push({ item, lat, lng });
            }
          } catch (e) {
            console.error('Geocode error for', item.location, e);
          }
        }

        if (!coords.length) return;

        geocoded.forEach(g => {
          const marker = L.marker([g.lat, g.lng]).addTo(markersLayer);
          marker.bindPopup(
            `<strong>${g.item.time || ''} ${g.item.activity || ''}</strong><br/>${g.item.location || ''}`
          );
        });

        routePolyline = L.polyline(coords, { color: '#97CBFF', weight: 4 }).addTo(leafletMap);
        leafletMap.fitBounds(routePolyline.getBounds(), { padding: [20, 20] });

        let totalDistance = 0;
        for (let i = 1; i < coords.length; i++) {
          const [lat1, lon1] = coords[i - 1];
          const [lat2, lon2] = coords[i];
          const R = 6371;
          const dLat = (lat2 - lat1) * Math.PI / 180;
          const dLon = (lon2 - lon1) * Math.PI / 180;
          const a =
            Math.sin(dLat / 2) * Math.sin(dLat / 2) +
            Math.cos(lat1 * Math.PI / 180) *
              Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) *
              Math.sin(dLon / 2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
          totalDistance += R * c;
        }

        this.activeTrip.routeSummary = {
          distance: `${totalDistance.toFixed(1)} km (ç›´ç·šä¼°ç®—)`,
          duration: 'â€”',
          legs: coords.length
        };
      },

      getSingleDirectionLink(item, index) {
        if (!this.activeTrip) return '#';
        if (index === 0) {
          return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`;
        }
        const prev = this.activeTrip.itinerary[index - 1];
        const origin = encodeURIComponent(prev.location);
        const dest = encodeURIComponent(item.location);
        return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=transit`;
      },

      addItineraryItem() {
        if (!this.activeTrip) return;
        const time = prompt('æ™‚é–“ (HH:MM)');
        const activity = prompt('æ´»å‹•åç¨±');
        const location = prompt('åœ°é» / åœ°å€ (ç”¨æ–¼å°èˆª)');
        if (time && activity) {
          this.activeTrip.itinerary.push({
            time,
            activity,
            location: location || activity
          });
          this.activeTrip.itinerary.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
          this.saveActiveTripAndRoute();
        }
      },
      removeItineraryItem(index) {
        if (!this.activeTrip) return;
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) return;
        this.activeTrip.itinerary.splice(index, 1);
        this.saveActiveTripAndRoute();
      },

      importBulkPlaces() {
        if (!this.activeTrip || !this.bulkPlaces.trim()) return;
        const lines = this.bulkPlaces
          .split('\n')
          .map(l => l.trim())
          .filter(Boolean);
        if (!lines.length) return;

        let baseHour = 10;
        if (this.activeTrip.itinerary.length > 0) {
          const last = this.activeTrip.itinerary[this.activeTrip.itinerary.length - 1];
          const h = parseInt((last.time || '10:00').split(':')[0], 10);
          baseHour = isNaN(h) ? 10 : h + 1;
        }

        lines.forEach((line, idx) => {
          let name = line;
          let loc = line;
          if (line.includes('-')) {
            const parts = line.split('-');
            name = parts[0].trim();
            loc = parts.slice(1).join('-').trim();
          } else if (line.includes(',')) {
            const parts = line.split(',');
            name = parts[0].trim();
            loc = parts.slice(1).join(',').trim();
          }
          const hour = (baseHour + idx).toString().padStart(2, '0');
          this.activeTrip.itinerary.push({
            time: `${hour}:00`,
            activity: name || 'æœªå‘½ååœ°é»',
            location: loc || name
          });
        });

        this.activeTrip.itinerary.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
        this.bulkPlaces = '';
        this.saveActiveTripAndRoute();
      },

      addExpense() {
        if (!this.activeTrip) return;
        if (!this.newExpense.item || !this.newExpense.amount) return;
        const d = new Date();
        this.activeTrip.expenses = this.activeTrip.expenses || [];
        this.activeTrip.expenses.unshift({
          ...this.newExpense,
          date: `${d.getMonth() + 1}/${d.getDate()}`
        });
        this.newExpense = { item: '', amount: null, payment: 'cash' };
        this.saveActiveTrip();
      },

      handleShoppingImageChange(event, index) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          const result = e.target.result;
          if (index === null) {
            this.newShoppingItem.imageData = result;
          } else if (this.activeTrip) {
            this.activeTrip.shoppingItems[index].imageData = result;
          }
        };
        reader.readAsDataURL(file);
      },
      addShoppingItem() {
        if (!this.activeTrip) return;
        if (!this.newShoppingItem.name) return;
        this.activeTrip.shoppingItems = this.activeTrip.shoppingItems || [];
        this.activeTrip.shoppingItems.unshift({ ...this.newShoppingItem });
        this.newShoppingItem = {
          name: '',
          onlinePrice: '',
          localPrice: '',
          imageData: '',
          purchased: false
        };
        this.saveActiveTrip();
      },
      removeShoppingItem(index) {
        if (!this.activeTrip) return;
        this.activeTrip.shoppingItems.splice(index, 1);
        this.saveActiveTrip();
      },
      toggleShoppingPurchased(index) {
        if (!this.activeTrip) return;
        this.activeTrip.shoppingItems[index].purchased = !this.activeTrip.shoppingItems[index].purchased;
        this.saveActiveTrip();
      },

      switchTrip(id) {
        this.activeTripId = id;
        this.activeTab = 'itinerary';
        this.$nextTick(() => this.updateRoute());
      },
      async deleteTrip(id) {
        if (this.trips.length === 1) {
          alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æ—…ç¨‹');
          return;
        }
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ—…ç¨‹ï¼Ÿ')) return;
        this.trips = this.trips.filter(t => t.id !== id);
        if (!this.trips.find(t => t.id === this.activeTripId)) {
          this.activeTripId = this.trips[0]?.id || null;
        }
        if (auth.currentUser) {
          await this.deleteTripFromFirestore(id);
        }
        this.$nextTick(() => this.updateRoute());
      },
      startCreateTrip() {
        this.creatingTrip = true;
        this.newTripForm = {
          title: '',
          destination: '',
          city: '',
          currency: 'JPY',
          startDate: '',
          endDate: '',
          lat: 35.6762,
          lng: 139.6503
        };
      },

      async autoFillLatLng() {
        const query = this.newTripForm.city || this.newTripForm.destination;
        if (!query) {
          alert('è«‹å…ˆè¼¸å…¥ã€ŒåŸå¸‚åç¨±ã€æˆ–ã€Œç›®çš„åœ°ã€ã€‚');
          return;
        }

        try {
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
          const res = await fetch(url, {
            headers: {
              'Accept-Language': 'zh-HK'
            }
          });
          const data = await res.json();

          if (!data || data.length === 0) {
            alert('æ‰¾ä¸åˆ°é€™å€‹åŸå¸‚çš„åº§æ¨™ï¼Œè©¦è©¦ã€ŒTokyo, Japanã€é€™é¡å¯«æ³•ã€‚');
            return;
          }

          const best = data[0];
          this.newTripForm.lat = parseFloat(best.lat);
          this.newTripForm.lng = parseFloat(best.lon);

          alert(`å·²æ›´æ–°åœ°åœ–ä¸­å¿ƒï¼š\nLat: ${this.newTripForm.lat}\nLng: ${this.newTripForm.lng}`);
        } catch (e) {
          console.error('Geocode error', e);
          alert('è‡ªå‹•å–å¾—åº§æ¨™æ™‚å‡ºç¾å•é¡Œï¼Œå¯ä»¥ç¨å¾Œå†è©¦ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥ç·¯åº¦ï¼ç¶“åº¦ã€‚');
        }
      },

      async createTrip() {
        if (!this.newTripForm.title || !this.newTripForm.destination) {
          alert('è«‹è‡³å°‘å¡«å¯«æ—…ç¨‹åç¨±èˆ‡ç›®çš„åœ°');
          return;
        }
        const trip = {
          id: Date.now().toString(),
          createdAt: Date.now(),
          title: this.newTripForm.title,
          destination: this.newTripForm.destination,
          city: this.newTripForm.city || this.newTripForm.destination,
          currency: this.newTripForm.currency || 'JPY',
          startDate: this.newTripForm.startDate || '',
          endDate: this.newTripForm.endDate || '',
          center: { lat: this.newTripForm.lat || 35.6762, lng: this.newTripForm.lng || 139.6503 },
          exchangeRate: 20.04,
          travelMode: 'TRANSIT',
          flights: {
            outbound: { no: '-', date: this.newTripForm.startDate || '-', from: 'HKG', to: 'HND' },
            inbound: { no: '-', date: this.newTripForm.endDate || '-', from: 'HND', to: 'HKG' }
          },
          itinerary: [],
          routeSummary: null,
          expenses: [],
          tripItems: [],
          shoppingItems: [],
          savedListLink: ''
        };
        this.trips.push(trip);
        this.activeTripId = trip.id;
        this.creatingTrip = false;

        if (auth.currentUser) {
          await this.saveTripToFirestore(trip);
        }

        this.$nextTick(() => {
          if (leafletMap) {
            leafletMap.setView(trip.center, 12);
          }
          this.fetchWeather();
          this.fetchRate();
          this.updateRoute();
        });
      }
    }
  }).mount('#app');
</script>
</body>
</html>
