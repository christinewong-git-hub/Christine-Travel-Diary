<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Christine's Travel Plan - æ¥µç°¡æ‰‹æ©Ÿç‰ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // éŸ“ç³»ç²‰å«©è‰²èª¿
            primary: '#A8C0FF',    // æ·¡è—ç´« (ä¸»è‰²)
            secondary: '#FFC7D8',  // æ·ºç²‰ç´… (å‰¯è‰²/å¼·èª¿è‰²)
            pastelGreen: '#C7FFD4', // æ·ºç²‰ç¶ 
            pastelBlue: '#C4E1FF', // æ·ºè—
            textSoft: '#6B7280',
          }
        }
      }
    }
  </script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* å…¨å±€èƒŒæ™¯æ¼¸å±¤ - ç²‰å«©è—ç´« */
    body {
      background: linear-gradient(135deg, #C4E1FF 0%, #D2E9FF 33%, #DDDDFF 66%, #FFECF5 100%);
      background-attachment: fixed;
      font-family: system-ui, -apple-system, sans-serif;
      color: #1f2937;
      min-height: 100vh; /* ç¢ºä¿åœ¨æ‰‹æ©Ÿä¸Šå¡«æ»¿æ•´å€‹è¦–çª— */
    }
    
    /* è¼¸å…¥æ¡†/ä¸‹æ‹‰é¸å–®çš„ç°¡æ½”æ¨£å¼ */
    input, select, textarea {
        background-color: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(220, 220, 220, 0.7);
        padding: 0.75rem;
        border-radius: 0.75rem; /* rounded-xl */
        transition: all 0.2s ease;
    }
    
    /* å¤©æ°£å¡ç‰‡ä¸»é¡Œè‰² (æ­¤ç‚ºå°‘æ•¸ä¿ç•™èƒŒæ™¯è‰²çš„å€å¡Š) */
    .weather-card {
      border-radius: 24px;
      padding: 1.5rem;
      /* ç§»é™¤é™°å½±/é‚Šæ¡† */
    }
    .weather-sunny { background: linear-gradient(135deg, #FFECF5 0%, #FFD9EC 40%, #FFC7D8 100%); }
    .weather-cloudy { background: linear-gradient(135deg, #DDDDFF 0%, #E6E6F2 40%, #A8C0FF 100%); }
    .weather-rainy { background: linear-gradient(135deg, #A8C0FF 0%, #C4E1FF 35%, #D8D8EB 100%); }
    
    /* è† å›Šå°èˆªåˆ— (ä¿ç•™è¼•é€æ„Ÿ) */
    .capsule-tab {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
    }
    
    #map { height: 400px; border-radius: 20px; overflow: hidden; margin-top: 2rem; }
    
    /* æ´»èºæ—…ç¨‹æ¨™ç¤º (ç°¡æ½”) */
    .active-trip-item {
      background: linear-gradient(135deg, #A8C0FF, #D2E9FF);
      color: #1f2937;
      padding: 1.5rem;
      border-radius: 24px;
    }
    
    /* è¡Œç¨‹æ™‚é–“è»¸ç·š */
    .itinerary-line {
        width: 4px;
        background-color: #A8C0FF;
        margin: 0 auto;
        position: relative;
    }
    .itinerary-dot {
        width: 12px;
        height: 12px;
        background-color: #FFC7D8;
        border-radius: 50%;
        position: absolute;
        left: 50%;
        transform: translate(-50%, -50%);
        top: 0;
        border: 2px solid white;
    }
    
    /* å›ºå®šçš„Headeræ¨£å¼ (æ¥µç°¡ - åªæœ‰æ–‡å­—) */
    .fixed-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 50;
      /* æ¥µè¼•å¾®èƒŒæ™¯å’Œæ¨¡ç³Šï¼Œè®“æ–‡å­—åœ¨æ¼¸å±¤èƒŒæ™¯ä¸Šæ›´æ¸…æ™° */
      backdrop-filter: blur(8px);
      background: rgba(255, 255, 255, 0.0); /* å¹¾ä¹é€æ˜ */
      border-bottom: 1px solid rgba(255, 255, 255, 0.7);
    }
  </style>
</head>
<body>
  <div id="app">
    <header class="fixed-header p-4 flex items-center justify-between">
      <i class="ri-plane-line text-3xl text-primary"></i>
      <h1 class="text-xl font-bold text-slate-800">Christine's Travel Plan</h1>
      <button @click="activeTab = 'trips'" class="p-2 rounded-xl bg-primary/20 hover:bg-primary/30 text-primary transition-all">
        <i class="ri-suitcase-3-line text-xl"></i>
      </button>
    </header>

    <main class="pt-20 pb-28 px-4 max-w-6xl mx-auto">
      
      <section v-if="activeTab === 'info' && activeTrip" class="mx-auto max-w-3xl mb-8">
        
        <div class="bg-white/90 rounded-2xl p-6 mb-8">
             <h1 class="text-3xl font-bold text-slate-800">{{ activeTrip.title }} ({{ activeTrip.destination }})</h1>
        </div>
        
        <div class="bg-white/90 rounded-2xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3 text-primary"><i class="ri-flight-takeoff-line"></i>èˆªç­è©³æƒ…</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div>
                <h3 class="font-bold text-lg mb-4 text-slate-800 border-b border-primary/50 pb-2">å»ç¨‹ (Outbound)</h3>
                
                <label class="block text-sm font-medium mb-1 mt-4">èˆªç­ç·¨è™Ÿ</label>
                <input v-model="activeTrip.flights.outbound.no" placeholder="e.g. NH924" class="w-full mb-4 text-sm">
                
                <label class="block text-sm font-medium mb-1">æ—¥æœŸ</label>
                <input v-model="activeTrip.flights.outbound.date" type="date" class="w-full mb-4 text-sm">
                
                <div class="flex gap-2 mb-4">
                  <div class="flex-1">
                    <label class="block text-sm font-medium mb-1">å‡ºç™¼åœ°</label>
                    <input v-model="activeTrip.flights.outbound.from" placeholder="IATA" class="w-full text-sm">
                  </div>
                  <div class="flex-1">
                    <label class="block text-sm font-medium mb-1">ç›®çš„åœ°</label>
                    <input v-model="activeTrip.flights.outbound.to" placeholder="IATA" class="w-full text-sm">
                  </div>
                </div>
                
                <button @click="fetchFlight('outbound')" class="mt-2 w-full bg-primary text-white py-3 rounded-xl font-medium transition-all hover:bg-primary/80">è‡ªå‹•å¡«å¯«å»ç¨‹</button>
              </div>
              
              <div>
                <h3 class="font-bold text-lg mb-4 text-slate-800 border-b border-primary/50 pb-2">å›ç¨‹ (Inbound)</h3>
                
                <label class="block text-sm font-medium mb-1 mt-4">èˆªç­ç·¨è™Ÿ</label>
                <input v-model="activeTrip.flights.inbound.no" placeholder="e.g. NH923" class="w-full mb-4 text-sm">
                
                <label class="block text-sm font-medium mb-1">æ—¥æœŸ</label>
                <input v-model="activeTrip.flights.inbound.date" type="date" class="w-full mb-4 text-sm">
                
                <div class="flex gap-2 mb-4">
                  <div class="flex-1">
                    <label class="block text-sm font-medium mb-1">å‡ºç™¼åœ°</label>
                    <input v-model="activeTrip.flights.inbound.from" placeholder="IATA" class="w-full text-sm">
                  </div>
                  <div class="flex-1">
                    <label class="block text-sm font-medium mb-1">ç›®çš„åœ°</label>
                    <input v-model="activeTrip.flights.inbound.to" placeholder="IATA" class="w-full text-sm">
                  </div>
                </div>

                <button @click="fetchFlight('inbound')" class="mt-2 w-full bg-primary text-white py-3 rounded-xl font-medium transition-all hover:bg-primary/80">è‡ªå‹•å¡«å¯«å›ç¨‹</button>
              </div>
            </div>
        </div>
        
        <div class="grid md:grid-cols-3 gap-6">
            <div :class="['weather-card p-6 md:col-span-1', `weather-${weatherTheme}`]" v-if="weatherData">
              <h2 class="text-xl font-bold mb-3 flex items-center gap-2"><i class="ri-sun-line text-2xl"></i>ç•¶åœ°å¤©æ°£</h2>
              <p class="text-5xl font-extrabold">{{ Math.round(weatherData.temperature) }}Â°C</p>
              <p class="text-lg capitalize mt-1">{{ weatherDesc }}</p>
              <button @click="fetchWeather" class="mt-3 bg-white/40 text-slate-800 text-sm px-4 py-1 rounded-xl transition-all hover:bg-white/70">æ›´æ–°</button>
            </div>
            <div class="p-6 md:col-span-2 grid grid-cols-2 gap-4 bg-white/90 rounded-2xl">
                <div class="p-3 rounded-xl bg-pastelBlue/50 text-center">
                    <p class="text-4xl font-bold text-primary">{{ activeTrip.itinerary.length }}</p>
                    <p class="font-medium">ç¸½ç«™æ•¸</p>
                </div>
                <div class="p-3 rounded-xl bg-secondary/50 text-center">
                    <p class="text-4xl font-bold text-secondary">{{ Math.round(totalExpensesHKD * activeTrip.exchangeRate).toLocaleString() }}</p>
                    <p class="font-medium">ç¸½æ”¯å‡º ({{ activeTrip.currency }})</p>
                    <p class="text-sm text-textSoft mt-1">({{ totalExpensesHKD.toLocaleString() }} HKD)</p>
                </div>
                <div class="p-3 rounded-xl bg-pastelGreen/50 col-span-2 text-center">
                    <p class="text-3xl font-bold text-primary">1 HKD = {{ activeTrip.exchangeRate.toFixed(2) }} {{ activeTrip.currency }}</p>
                    <p class="font-medium">åŒ¯ç‡</p>
                </div>
            </div>
        </div>
      </section>

      <section v-if="activeTab === 'itinerary-map' && activeTrip" class="max-w-4xl mx-auto p-4 md:p-0">
        <div class="p-6 bg-white/90 rounded-2xl mb-8">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i class="ri-road-map-line text-primary"></i>è¡Œç¨‹ç®¡ç†</h2>
          
          <div class="flex flex-wrap gap-3 mb-4">
            <button @click="addItineraryItem" class="bg-primary text-white px-6 py-3 rounded-xl font-medium transition-all hover:bg-primary/80">æ–°å¢è¡Œç¨‹</button>
            <button @click="updateRoute" class="bg-secondary text-slate-800 px-6 py-3 rounded-xl font-medium transition-all hover:bg-secondary/80">æ›´æ–°åœ°åœ–èˆ‡è·¯ç·š</button>
          </div>

          <textarea v-model="batchImportText" placeholder="æ‰¹æ¬¡åŒ¯å…¥åœ°é»ï¼Œä¸€è¡Œä¸€å€‹ (e.g. æ±äº¬éµå¡”, æ¶‰è°·åå­—è·¯å£)" class="w-full mb-4 h-24 text-sm"></textarea>
          <button @click="batchImportItinerary" class="bg-pastelGreen text-slate-800 px-6 py-3 rounded-xl font-medium transition-all hover:bg-pastelGreen/80">æ‰¹æ¬¡åŒ¯å…¥</button>
          
          <div v-if="activeTrip.routeSummary.distance > 0" class="mt-4 p-4 bg-primary/20 rounded-xl text-primary font-medium">
            <p>ç¸½è·é›¢ç´„ **{{ activeTrip.routeSummary.distance.toFixed(1) }} km**</p>
          </div>
          
          <div v-for="(dayGroup, dayIndex) in groupedItinerary" :key="dayIndex" class="mt-8 pt-8 border-t border-slate-200">
            <h3 class="text-xl font-bold mb-4 text-primary">D{{ dayIndex + 1 }}</h3>
            <div v-for="(item, idx) in dayGroup" :key="idx" class="flex gap-4 mb-6 group">
              <div class="w-20 flex-shrink-0 relative">
                <div class="itinerary-line h-full"></div>
                <div class="itinerary-dot top-0"></div>
                <div class="text-sm font-bold text-center mt-2">{{ item.time }}</div>
              </div>
              <div class="flex-1 bg-white/90 p-4 rounded-xl">
                <input v-model="item.activity" placeholder="æ´»å‹•åç¨±" class="w-full mb-2 text-sm font-medium">
                <input v-model="item.location" placeholder="åœ°é»/åœ°å€" class="w-full mb-2 text-sm">
                <input v-model="item.mapsUrl" placeholder="Google Maps URL (å¯é¸)" class="w-full mb-2 text-xs">
                
                <div class="flex gap-2 mb-2">
                  <input v-model="item.bookingTime" placeholder="é ç´„æ™‚é–“" class="flex-1 text-xs">
                  <input v-model="item.remark" placeholder="å‚™è¨»" class="flex-1 text-xs">
                </div>
                
                <p v-if="item.bookingTime" class="text-sm font-medium mt-2 text-primary">é ç´„æ™‚é–“: **Booked ({{ item.bookingTime }})**</p>

                <div class="flex gap-2 mt-3">
                  <button @click="openItineraryMap(idx)" class="flex-1 bg-primary text-white py-2 rounded-lg text-sm transition-all hover:bg-primary/80"><i class="ri-map-pin-line"></i> é–‹å•Ÿåœ°åœ–</button>
                  <button @click="removeItineraryItem(idx)" class="bg-secondary text-slate-800 py-2 px-4 rounded-lg text-sm transition-all hover:bg-red-400">åˆªé™¤</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="map" class="bg-white/90 mx-auto max-w-4xl w-full"></div>
      </section>

      <section v-if="activeTab === 'budget' && activeTrip" class="max-w-2xl mx-auto p-4 md:p-0">
        <div class="p-8 bg-white/90 rounded-2xl mb-8">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i class="ri-money-dollar-circle-line text-primary"></i>åŒ¯ç‡è¨ˆç®—</h2>
          <p class="text-3xl font-bold mb-4">1,000 HKD â‰ˆ {{ Math.round(1000 * activeTrip.exchangeRate).toLocaleString() }} {{ activeTrip.currency }}</p>
          <label class="block text-sm font-medium mb-2">æ‰‹å‹•èª¿æ•´åŒ¯ç‡ (1 HKD = ...)</label>
          <input v-model.number="activeTrip.exchangeRate" type="number" step="0.01" class="w-full text-center text-xl">
          <button @click="fetchExchangeRate" class="mt-4 w-full bg-primary text-white py-3 rounded-xl font-medium transition-all hover:bg-primary/80">æ›´æ–°åŒ¯ç‡</button>
        </div>
        <div class="p-8 bg-white/90 rounded-2xl mb-8">
          <h3 class="text-xl font-bold mb-4">è¨˜ä¸€ç­†</h3>
          <input v-model="newExpense.name" placeholder="é …ç›®åç¨±" class="w-full mb-3 text-sm">
          <input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡ (HKD)" class="w-full mb-3 text-sm">
          <select v-model="newExpense.method" class="w-full mb-3 text-sm">
            <option>ç¾é‡‘</option>
            <option>ä¿¡ç”¨å¡</option>
            <option>å…¶ä»–</option>
          </select>
          <select v-model="newExpense.category" class="w-full mb-4 text-sm">
            <option>é£²é£Ÿ</option>
            <option>è³¼ç‰©</option>
            <option>å¨›æ¨‚</option>
            <option>äº¤é€š</option>
            <option>ä½å®¿</option>
            <option>å…¶ä»–</option>
          </select>
          <button @click="addExpense" class="w-full bg-secondary text-slate-800 py-3 rounded-xl font-medium transition-all hover:bg-secondary/80">è¨˜ä¸€ç­†</button>
        </div>
        <div class="p-6 bg-white/90 rounded-2xl">
          <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-xl font-bold">æ”¯å‡ºåˆ—è¡¨ ({{ expenses.length }} ç­†)</h3>
            <p class="text-lg font-medium">ç¸½é¡: **{{ totalExpensesHKD.toLocaleString() }} HKD**</p>
          </div>
          <div class="max-h-96 overflow-y-auto">
            <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center p-3 border-b border-slate-200/70 last:border-b-0 hover:bg-primary/5 rounded-lg transition-all">
              <div>
                <p class="font-bold">{{ exp.name }}</p>
                <p class="text-xs text-textSoft">{{ exp.date }} | {{ exp.category }} | {{ exp.method }}</p>
              </div>
              <div class="text-right">
                <p class="font-bold text-red-500">{{ exp.amount }} HKD</p>
                <p class="text-xs text-textSoft">â‰ˆ {{ Math.round(exp.amount * activeTrip.exchangeRate) }} {{ activeTrip.currency }}</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section v-if="activeTab === 'shopping' && activeTrip" class="max-w-2xl mx-auto p-4 md:p-0">
        <div class="p-8 bg-white/90 rounded-2xl mb-8">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i class="ri-shopping-bag-line text-primary"></i>æ—…ç¨‹è³¼ç‰©æ¸…å–®</h2>
          <input v-model="newShoppingItem.name" placeholder="å“é …åç¨±" class="w-full mb-3 text-sm">
          <input v-model="newShoppingItem.onlinePrice" placeholder="ç¶²ä¸Šåƒ¹éŒ¢" class="w-full mb-3 text-sm">
          <input v-model="newShoppingItem.localPrice" placeholder="æœ¬åœ°å¯¦ä»˜åƒ¹" class="w-full mb-3 text-sm">
          <input type="file" @change="handleImageUpload" accept="image/*" class="w-full mb-4 bg-white/70 text-sm">
          <img v-if="newShoppingItem.imageData" :src="newShoppingItem.imageData" class="w-24 h-24 object-cover rounded-xl mb-4">
          <button @click="addShoppingItem" class="w-full bg-pastelGreen text-slate-800 py-3 rounded-xl font-medium transition-all hover:bg-pastelGreen/80">æ–°å¢è³¼ç‰©é …ç›®</button>
        </div>
        <div v-for="(item, idx) in activeTrip.shoppingItems" :key="idx" class="p-6 mb-4 bg-white/90 rounded-2xl" :class="{ 'opacity-60': item.bought }">
          <div class="flex items-start gap-4">
            <img v-if="item.imageData" :src="item.imageData" class="w-24 h-24 object-cover rounded-xl flex-shrink-0">
            <div class="flex-1">
              <h3 class="font-bold text-lg">{{ item.name }}</h3>
              <p class="text-sm">ç¶²ä¸Šåƒ¹: {{ item.onlinePrice || 'N/A' }}</p>
              <p class="font-medium text-primary">å¯¦ä»˜: {{ item.localPrice || 'N/A' }}</p>
            </div>
            <div class="flex flex-col gap-2 items-end">
              <label class="flex items-center gap-1 text-sm font-medium">
                <input type="checkbox" v-model="item.bought" class="rounded text-primary focus:ring-primary/50">
                å·²è²·
              </label>
              <button @click="removeShoppingItem(idx)" class="text-red-400 hover:text-red-600"><i class="ri-delete-bin-line"></i></button>
            </div>
          </div>
        </div>
      </section>

      <section v-if="activeTab === 'trips'" class="max-w-2xl mx-auto p-4 md:p-0">
        <h2 class="text-3xl font-bold mb-8 text-center flex items-center justify-center gap-3"><i class="ri-suitcase-3-line text-4xl text-primary"></i>æ—…ç¨‹ç®¡ç†</h2>
        <button @click="showNewTripForm = true" class="w-full mb-6 bg-primary text-white py-4 rounded-2xl font-bold text-xl transition-all hover:bg-primary/80">+ æ–°å¢æ—…ç¨‹</button>
        
        <div v-if="showNewTripForm || editingTrip" class="p-8 bg-white/90 rounded-2xl mb-8">
          <h3 class="text-2xl font-bold mb-6 text-primary">{{ editingTrip ? 'ç·¨è¼¯æ—…ç¨‹' : 'æ–°å¢æ—…ç¨‹' }}</h3>
          <input v-model="tempTrip.title" placeholder="æ¨™é¡Œ" class="w-full mb-4 text-lg">
          <input v-model="tempTrip.destination" placeholder="ç›®çš„åœ°" class="w-full mb-4 text-lg">
          <input v-model="tempTrip.city" placeholder="åŸå¸‚ (ç”¨æ–¼å¤©æ°£/åœ°åœ–å®šä½)" class="w-full mb-4 text-lg">
          <select v-model="tempTrip.currency" class="w-full mb-4 text-lg">
            <option>JPY</option>
            <option>USD</option>
            <option>EUR</option>
            <option>THB</option>
            <option>GBP</option>
            <option>KRW</option>
            <option>OTHER</option>
          </select>
          <div class="flex gap-4">
            <input v-model="tempTrip.startDate" type="date" class="flex-1">
            <input v-model="tempTrip.endDate" type="date" class="flex-1">
          </div>
          <div class="flex gap-4 mt-6">
            <button @click="saveNewTrip" class="flex-1 bg-primary text-white py-3 rounded-xl font-bold transition-all hover:bg-primary/80">å„²å­˜</button>
            <button @click="cancelTripEdit" class="flex-1 bg-secondary text-slate-800 py-3 rounded-xl font-bold transition-all hover:bg-secondary/80">å–æ¶ˆ</button>
          </div>
        </div>
        
        <div v-for="trip in trips" :key="trip.id" @click="switchTrip(trip.id)"
             :class="['p-6 mb-6 cursor-pointer rounded-2xl transition-all border border-transparent hover:border-primary/50', activeTripId === trip.id ? 'active-trip-item' : 'bg-white/90']"
             role="button">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-2xl font-bold">{{ trip.title }}</h3>
              <p class="text-lg">{{ trip.destination }} ({{ trip.city }})</p>
              <p class="text-sm text-textSoft">{{ trip.startDate }} ï½ {{ trip.endDate }} | **{{ trip.currency }}**</p>
            </div>
            <div class="text-right">
              <p class="text-xl font-bold text-primary">{{ trip.itinerary.length }} ç«™</p>
              <p class="text-sm">{{ trip.shoppingItems.length }} è³¼ç‰©</p>
            </div>
          </div>
          <span v-if="activeTripId === trip.id" class="inline-block bg-secondary text-slate-800 px-4 py-1 rounded-full mt-3 font-medium text-sm">ACTIVE</span>
          <div class="flex gap-2 mt-4 pt-4 border-t border-slate-200/70">
            <button @click.stop="editTrip(trip)" class="flex-1 bg-pastelBlue text-slate-800 py-2 rounded-xl transition-all hover:bg-pastelBlue/80">ç·¨è¼¯</button>
            <button @click.stop="deleteTrip(trip.id)" :disabled="trips.length <= 1" class="flex-1 bg-red-400 text-white py-2 rounded-xl disabled:opacity-50 transition-all" :class="{ 'hover:bg-red-500': trips.length > 1 }">
              {{ trips.length > 1 ? 'åˆªé™¤' : 'è‡³å°‘ä¿ç•™ä¸€ç¨‹' }}
            </button>
          </div>
        </div>
      </section>
    </main>

    <nav class="fixed bottom-6 left-1/2 transform -translate-x-1/2 capsule-tab flex rounded-3xl p-2 shadow-xl w-[min(90vw,500px)] z-40">
      <button @click="activeTab = 'info'" :class="['flex-1 p-4 rounded-2xl flex flex-col items-center gap-1 font-medium transition-all', activeTab === 'info' ? 'bg-primary text-white shadow-lg' : 'text-textSoft hover:bg-slate-100/50']">
        <i class="ri-information-line text-xl"></i>
        <span class="text-xs">Trip Info</span>
      </button>
      <button @click="activeTab = 'itinerary-map'" :class="['flex-1 p-4 rounded-2xl flex flex-col items-center gap-1 font-medium transition-all', activeTab === 'itinerary-map' ? 'bg-primary text-white shadow-lg' : 'text-textSoft hover:bg-slate-100/50']">
        <i class="ri-map-pin-5-line text-xl"></i>
        <span class="text-xs">è¡Œç¨‹Â·åœ°åœ–</span>
      </button>
      <button @click="activeTab = 'budget'" :class="['flex-1 p-4 rounded-2xl flex flex-col items-center gap-1 font-medium transition-all', activeTab === 'budget' ? 'bg-primary text-white shadow-lg' : 'text-textSoft hover:bg-slate-100/50']">
        <i class="ri-wallet-line text-xl"></i>
        <span class="text-xs">è¨˜å¸³</span>
      </button>
      <button @click="activeTab = 'shopping'" :class="['flex-1 p-4 rounded-2xl flex flex-col items-center gap-1 font-medium transition-all', activeTab === 'shopping' ? 'bg-primary text-white shadow-lg' : 'text-textSoft hover:bg-slate-100/50']">
        <i class="ri-shopping-bag-3-line text-xl"></i>
        <span class="text-xs">è³¼ç‰©</span>
      </button>
      <button @click="activeTab = 'trips'" :class="['flex-1 p-4 rounded-2xl flex flex-col items-center gap-1 font-medium transition-all', activeTab === 'trips' ? 'bg-primary text-white shadow-lg' : 'text-textSoft hover:bg-slate-100/50']">
        <i class="ri-suitcase-3-line text-xl"></i>
        <span class="text-xs">History</span>
      </button>
    </nav>
  </div>

  <script>
    const { createApp, nextTick } = Vue;

    // --- Polyfill/Helper (ç”¨æ–¼å–ä»£æœªå¼•å…¥çš„ Lodash) ---
    const _ = {
        chunk: (array, size) => {
            if (!array || !array.length) return [];
            const result = [];
            for (let i = 0; i < array.length; i += size) {
                result.push(array.slice(i, i + size));
            }
            return result;
        }
    };

    // --- ä¸»è¦ Vue æ‡‰ç”¨ç¨‹å¼é‚è¼¯ (ä¿æŒä¸è®Š) ---
    createApp({
      data() {
        return {
          trips: [],
          activeTripId: null,
          activeTab: 'info', // <-- é è¨­ç™»é™¸é é¢ç‚º 'info'
          AVIATIONSTACK_KEY: '5b729556e3ef80e18916fcecbcfd81ba',
          
          batchImportText: '',
          newExpense: { name: '', amount: 0, method: 'ç¾é‡‘', category: 'é£²é£Ÿ' },
          newShoppingItem: { name: '', onlinePrice: '', localPrice: '', imageData: '', bought: false },
          tempTrip: { title: '', destination: '', city: '', currency: 'JPY', startDate: '', endDate: '' },
          showNewTripForm: false,
          editingTrip: null,
          
          map: null,
          weatherData: null,
          weatherTheme: 'sunny',
          weatherDesc: '',
        };
      },
      computed: {
        activeTrip() {
          return this.trips.find(t => t.id === this.activeTripId);
        },
        groupedItinerary() {
          if (!this.activeTrip?.itinerary) return [];
          const daySize = 5;
          return _.chunk(this.activeTrip.itinerary, daySize);
        },
        expenses() {
            return this.activeTrip?.expenses || [];
        },
        totalExpensesHKD() {
          return this.activeTrip?.expenses?.reduce((sum, e) => sum + e.amount, 0) || 0;
        },
      },
      methods: {
        saveData() {
          localStorage.setItem('christine_travel_diary_trips', JSON.stringify(this.trips));
        },
        loadData() {
          const saved = localStorage.getItem('christine_travel_diary_trips');
          if (saved) {
            this.trips = JSON.parse(saved);
          } else {
            this.addDefaultTrip();
          }
          if (this.trips.length) {
            this.activeTripId = this.trips[0].id;
          }
          this.refreshActiveTrip();
        },
        addDefaultTrip() {
          const defaultTrip = {
            id: Date.now(),
            title: 'Japan Tokyo Trip ğŸ‡¯ğŸ‡µ',
            destination: 'Tokyo',
            city: 'Tokyo',
            currency: 'JPY',
            startDate: '2025-12-24',
            endDate: '2026-01-01',
            center: { lat: 35.6895, lng: 139.6917 },
            exchangeRate: 19.2,
            flights: {
              outbound: { no: 'NH924', date: '2025-12-24', from: 'HKG', to: 'NRT' },
              inbound: { no: 'NH923', date: '2026-01-01', from: 'NRT', to: 'HKG' }
            },
            itinerary: [
                { time: '10:00', activity: 'æ©Ÿå ´å ±åˆ°', location: 'HKG', mapsUrl: '', bookingTime: '12:00', remark: '' },
                { time: '16:00', activity: 'åˆ°é”é…’åº— Check-in', location: 'Tokyo Hotel', mapsUrl: '', bookingTime: '', remark: '' },
                { time: '19:00', activity: 'æ™šé¤ - ä¸€è˜­æ‹‰éºµ', location: 'Shibuya', mapsUrl: '', bookingTime: '', remark: 'ç¬¬ä¸€å¤©' }
            ],
            routeSummary: { distance: 0 },
            expenses: [],
            shoppingItems: [],
            savedListLink: ''
          };
          this.trips = [defaultTrip];
          this.saveData();
        },
        switchTrip(id) {
          this.activeTripId = id;
          this.activeTab = 'info';
          this.refreshActiveTrip();
        },
        refreshActiveTrip() {
          if (!this.activeTrip) return;
          this.fetchExchangeRate();
          this.fetchWeather();
          if (this.activeTab === 'itinerary-map') {
            this.updateRoute();
          }
        },
        
        // Flights
        async fetchFlight(direction) {
            alert('èˆªç­ API èª¿ç”¨å·²ç¦ç”¨ï¼Œè«‹è‡ªè¡Œè¼¸å…¥è³‡æ–™ã€‚');
        },
        formatTime(isoTime) {
          if (!isoTime) return '';
          const d = new Date(isoTime);
          return d.toTimeString().slice(0,5);
        },
        // Weather
        async fetchWeather() {
          if (!this.activeTrip?.center) return;
          try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${this.activeTrip.center.lat}&longitude=${this.activeTrip.center.lng}&current_weather=true&timezone=auto`);
            const data = await res.json();
            this.weatherData = data.current_weather;
            const code = data.current_weather.weathercode;
            this.weatherTheme = this.getWeatherTheme(code);
            this.weatherDesc = this.getWeatherDesc(code);
          } catch (e) {
            console.error(e);
          }
        },
        getWeatherTheme(code) {
          if (code < 3) return 'sunny';
          if (code < 50) return 'cloudy';
          return 'rainy';
        },
        getWeatherDesc(code) {
          const maps = {0:'æ™´æœ—', 1:'å°‘é›²', 2:'å¤šé›²', 3:'å¯†é›²', 61:'å°é›¨', 63:'ä¸­é›¨', 80:'é™£é›¨'};
          return maps[code] || 'æœªçŸ¥';
        },
        // Exchange
        async fetchExchangeRate() {
          if (!this.activeTrip?.currency) return;
          try {
            const res = await fetch(`https://api.exchangerate.host/latest?base=HKD&symbols=${this.activeTrip.currency}`);
            const data = await res.json();
            if (data.rates && data.rates[this.activeTrip.currency]) {
                this.activeTrip.exchangeRate = data.rates[this.activeTrip.currency];
                this.saveData();
            } else {
                console.warn('ç„¡æ³•ç²å–åŒ¯ç‡ï¼Œä½¿ç”¨é è¨­å€¼ã€‚');
            }
          } catch (e) {
            console.error(e);
          }
        },
        // Itinerary
        addItineraryItem() {
          const activity = prompt('æ´»å‹•åç¨±');
          const location = prompt('åœ°é»/åœ°å€');
          const time = prompt('æ™‚é–“ (HH:MM)', '10:00');
          if (activity && location && time) {
            this.activeTrip.itinerary.push({ time, activity, location, mapsUrl: '', bookingTime: '', remark: '' });
            this.saveData();
          }
        },
        batchImportItinerary() {
          const lines = this.batchImportText.split('\n').map(l => l.trim()).filter(Boolean);
          let currentTime = '10:00';
          for (let loc of lines) {
            this.activeTrip.itinerary.push({
              time: currentTime,
              activity: `åƒè§€ ${loc}`,
              location: loc,
              mapsUrl: '',
              bookingTime: '',
              remark: 'æ‰¹æ¬¡åŒ¯å…¥'
            });
            
            const [h, m] = currentTime.split(':').map(Number);
            const nextHour = (h + 1) % 24;
            currentTime = `${nextHour.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
          }
          this.batchImportText = '';
          this.saveData();
          this.updateRoute();
        },
        removeItineraryItem(idx) {
          this.activeTrip.itinerary.splice(idx, 1);
          this.saveData();
          this.updateRoute();
        },
        openItineraryMap(idx) {
          const item = this.activeTrip.itinerary[idx];
          let url = item.mapsUrl;
          if (!url) {
            let origin = this.activeTrip.city;
            if (idx > 0) {
                 origin = this.activeTrip.itinerary[idx-1].location;
            } else if (this.activeTrip.flights.outbound.to) {
                 origin = this.activeTrip.flights.outbound.to + ' Airport';
            }
            url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(item.location)}&travelmode=driving`;
          }
          window.open(url, '_blank');
        },
        
        // Map & Route
        async updateRoute() {
          if (!this.activeTrip?.itinerary.length) return;
          await nextTick();
          await this.initMap();
          if (!this.map) return;
          
          this.map.eachLayer(layer => { 
            if (layer instanceof L.Polyline || layer instanceof L.Marker) {
              this.map.removeLayer(layer);
            }
          });

          const coords = [];
          let totalDist = 0;
          
          for (let i = 0; i < this.activeTrip.itinerary.length; i++) {
            const item = this.activeTrip.itinerary[i];
            const { lat, lng } = await this.geocode(item.location + ', ' + this.activeTrip.city);
            if (lat && lng) {
              coords.push([lat, lng]);
              L.marker([lat, lng]).addTo(this.map).bindPopup(`<b>${i+1}. ${item.activity}</b><br>${item.time}`);
              
              if (i > 0) {
                const dist = this.haversine(coords[i-1][0], coords[i-1][1], lat, lng);
                totalDist += dist;
              }
            }
          }
          
          if (coords.length > 1) {
            L.polyline(coords, { color: this.getComputedStyle().getPropertyValue('--tw-colors-primary'), weight: 5, opacity: 0.8 }).addTo(this.map);
            this.map.fitBounds(coords, { padding: [50, 50] });
          } else if (coords.length === 1) {
             this.map.setView(coords[0], 13);
          }
          
          this.activeTrip.routeSummary.distance = totalDist / 1000;
          this.saveData();
        },
        initMap() {
          const el = document.getElementById('map');
          if (this.map) {
             this.map.remove();
             this.map = null;
          }
          if (!el) return;

          this.map = L.map(el).setView(this.activeTrip.center || [35.6895, 139.6917], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
          }).addTo(this.map);
        },
        haversine(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI/180;
            const Ï†2 = lat2 * Math.PI/180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180;
            const Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) +
                Math.cos(Ï†1) * Math.cos(Ï†2) *
                Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        },
        async geocode(query) {
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
            const data = await res.json();
            return data[0] ? { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) } : { lat: null, lng: null };
          } catch (e) {
            return { lat: null, lng: null };
          }
        },
        // Expenses
        addExpense() {
          if (!this.newExpense.name || !this.newExpense.amount || this.newExpense.amount <= 0) return alert('è«‹å¡«å¯«æœ‰æ•ˆçš„åç¨±èˆ‡é‡‘é¡');
          const date = new Date().toLocaleDateString('zh-HK', { month: '2-digit', day: '2-digit' });
          this.activeTrip.expenses.unshift({ ...this.newExpense, id: Date.now(), date });
          this.newExpense = { name: '', amount: 0, method: 'ç¾é‡‘', category: 'é£²é£Ÿ' };
          this.saveData();
        },
        // Shopping
        handleImageUpload(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
              this.newShoppingItem.imageData = ev.target.result;
            };
            reader.readAsDataURL(file);
          }
        },
        addShoppingItem() {
          if (!this.newShoppingItem.name) return alert('è«‹å¡«å¯«åç¨±');
          this.activeTrip.shoppingItems.unshift({ ...this.newShoppingItem, id: Date.now() });
          this.newShoppingItem = { name: '', onlinePrice: '', localPrice: '', imageData: '', bought: false };
          this.saveData();
        },
        removeShoppingItem(idx) {
          this.activeTrip.shoppingItems.splice(idx, 1);
          this.saveData();
        },
        // Trips
        editTrip(trip) {
          this.editingTrip = trip;
          this.tempTrip = { ...trip };
          this.showNewTripForm = true;
        },
        async saveNewTrip() {
          if (!this.tempTrip.title || !this.tempTrip.city) return alert('è«‹å¡«å¯«æ—…ç¨‹æ¨™é¡Œå’ŒåŸå¸‚');
          
          let center = { lat: 35.6895, lng: 139.6917 };
          const { lat, lng } = await this.geocode(this.tempTrip.city);
          if (lat && lng) center = { lat, lng };

          if (this.editingTrip) {
            // Update
            Object.assign(this.editingTrip, this.tempTrip, { center });
          } else {
            // New
            const id = Date.now();
            const newTrip = {
              id,
              ...this.tempTrip,
              center,
              exchangeRate: 1,
              flights: { outbound: {}, inbound: {} },
              itinerary: [],
              routeSummary: { distance: 0 },
              expenses: [],
              shoppingItems: [],
              savedListLink: ''
            };
            this.trips.push(newTrip);
            this.activeTripId = id;
          }
          this.refreshActiveTrip();
          this.cancelTripEdit();
          this.saveData();
        },
        cancelTripEdit() {
          this.showNewTripForm = false;
          this.editingTrip = null;
          this.tempTrip = { title: '', destination: '', city: '', currency: 'JPY', startDate: '', endDate: '' };
        },
        deleteTrip(id) {
          if (this.trips.length <= 1) return alert('è‡³å°‘ä¿ç•™ä¸€ç¨‹æ—…ç¨‹');
          if (confirm('ç¢ºèªåˆªé™¤æ­¤æ—…ç¨‹ï¼Ÿ')) {
            this.trips = this.trips.filter(t => t.id !== id);
            if (this.activeTripId === id) {
              this.activeTripId = this.trips[0]?.id || null;
            }
            this.refreshActiveTrip();
            this.saveData();
          }
        },
        getComputedStyle() {
            return document.documentElement ? getComputedStyle(document.documentElement) : null;
        }
      },
      mounted() {
        this.loadData();
      },
      watch: {
        activeTripId() {
          this.refreshActiveTrip();
        },
        activeTab(newTab, oldTab) {
          if (newTab === 'itinerary-map') {
            this.$nextTick(() => this.updateRoute());
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
