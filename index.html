<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Christine's Travel Diary</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#97CBFF',
            secondary: '#C7C7E2',
            textSoft: '#6B7280',
          }
        }
      }
    }
  </script>
  <!-- Remix Icon CDN -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #C4E1FF 0%, #D2E9FF 33%, #DDDDFF 66%, #FFECF5 100%);
      background-attachment: fixed;
      font-family: system-ui, -apple-system, sans-serif;
      color: #1f2937;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 25px 45px rgba(0, 0, 0, 0.1);
      border-radius: 24px;
    }
    .flight-sky {
      background: linear-gradient(135deg, #C4E1FF 0%, #D2E9FF 50%, #DDDDFF 100%);
      position: relative;
      overflow: hidden;
    }
    .flight-sky::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.6) 0%, transparent 50%);
      opacity: 0.7;
    }
    .weather-card {
      position: relative;
      overflow: hidden;
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 18px 40px rgba(170, 170, 210, 0.55);
      backdrop-filter: blur(18px);
    }
    .weather-sunny { background: linear-gradient(135deg, #FFECF5 0%, #FFD9EC 40%, #ECECFF 100%); }
    .weather-cloudy { background: linear-gradient(135deg, #DDDDFF 0%, #E6E6F2 40%, #D8D8EB 100%); }
    .weather-rainy { background: linear-gradient(135deg, #D8D8EB 0%, #E6E6F2 35%, #C4E1FF 100%); }
    .capsule-tab {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
    }
    #map { height: 400px; border-radius: 20px; overflow: hidden; }
    .active-trip-card {
      background: linear-gradient(135deg, #C4E1FF, #D2E9FF);
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Fixed Header -->
    <header class="fixed top-6 left-1/2 transform -translate-x-1/2 glass-card p-6 w-[min(90vw,500px)] flex items-center justify-between z-50 shadow-2xl">
      <i class="ri-plane-line text-3xl text-primary"></i>
      <h1 class="text-2xl font-bold text-slate-800">Christine's Travel Diary</h1>
      <button @click="activeTab = 'trips'" class="p-2 rounded-xl bg-primary/20 hover:bg-primary/30 text-primary transition-all">
        <i class="ri-suitcase-3-line text-xl"></i>
      </button>
    </header>

    <!-- Main Content -->
    <main class="pt-28 pb-28 px-6 max-w-6xl mx-auto">
      <!-- Trip Info Tab -->
      <section v-if="activeTab === 'info' && activeTrip" class="glass-card mx-auto max-w-2xl p-8 mb-8">
        <!-- Flight Details -->
        <div class="flight-sky glass-card p-8 mb-8 relative z-10">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i class="ri-flight-takeoff-line text-primary"></i>航班詳情</h2>
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Outbound -->
            <div>
              <label>去程航班編號 (e.g. NH924)</label>
              <input v-model="activeTrip.flights.outbound.no" class="w-full p-3 rounded-xl border border-slate-200 mb-2">
              <label>日期 (YYYY-MM-DD)</label>
              <input v-model="activeTrip.flights.outbound.date" type="date" class="w-full p-3 rounded-xl border border-slate-200 mb-4">
              <input v-model="activeTrip.flights.outbound.from" placeholder="From IATA" class="w-1/2 p-3 rounded-xl border mr-2">
              <input v-model="activeTrip.flights.outbound.to" placeholder="To IATA" class="w-1/2 p-3 rounded-xl border">
              <button @click="fetchFlight('outbound')" class="mt-4 w-full bg-primary text-white py-3 rounded-xl font-medium">自動填寫去程</button>
            </div>
            <!-- Inbound -->
            <div>
              <label>回程航班編號</label>
              <input v-model="activeTrip.flights.inbound.no" class="w-full p-3 rounded-xl border border-slate-200 mb-2">
              <label>日期 (YYYY-MM-DD)</label>
              <input v-model="activeTrip.flights.inbound.date" type="date" class="w-full p-3 rounded-xl border border-slate-200 mb-4">
              <input v-model="activeTrip.flights.inbound.from" placeholder="From IATA" class="w-1/2 p-3 rounded-xl border mr-2">
              <input v-model="activeTrip.flights.inbound.to" placeholder="To IATA" class="w-1/2 p-3 rounded-xl border">
              <button @click="fetchFlight('inbound')" class="mt-4 w-full bg-primary text-white py-3 rounded-xl font-medium">自動填寫回程</button>
            </div>
          </div>
        </div>
        <!-- Weather -->
        <div :class="['weather-card p-8 mb-8', `weather-${weatherTheme}`]" v-if="weatherData">
          <h2 class="text-2xl font-bold mb-4 flex items-center gap-3"><i class="ri-sun-line text-2xl"></i>當地天氣</h2>
          <p class="text-4xl font-bold">{{ Math.round(weatherData.temperature) }}°C</p>
          <p class="text-xl capitalize">{{ weatherDesc }}</p>
          <button @click="fetchWeather" class="mt-4 bg-primary text-white px-6 py-2 rounded-xl">更新</button>
        </div>
        <!-- Quick Stats -->
        <div class="grid md:grid-cols-3 gap-6 text-center">
          <div class="glass-card p-6">
            <p class="text-3xl font-bold text-primary">{{ activeTrip.itinerary.length }}</p>
            <p>總站數</p>
          </div>
          <div class="glass-card p-6">
            <p class="text-3xl font-bold text-primary">{{ totalExpensesHKD.toLocaleString() }} HKD</p>
            <p>總支出 (HKD)</p>
            <p class="text-sm text-secondary mt-1">{{ Math.round(totalExpensesHKD * activeTrip.exchangeRate).toLocaleString() }} {{ activeTrip.currency }}</p>
          </div>
          <div class="glass-card p-6">
            <p class="text-3xl font-bold text-primary">1 HKD = {{ activeTrip.exchangeRate.toFixed(2) }} {{ activeTrip.currency }}</p>
            <p>匯率</p>
          </div>
        </div>
      </section>

      <!-- Itinerary / Map Tab -->
      <section v-if="activeTab === 'itinerary-map' && activeTrip" class="max-w-4xl mx-auto">
        <!-- Itinerary List -->
        <div class="glass-card p-8 mb-8">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i class="ri-road-map-line"></i>行程管理</h2>
          <button @click="addItineraryItem" class="mb-4 bg-primary text-white px-6 py-3 rounded-xl font-medium">新增行程</button>
          <textarea v-model="batchImportText" placeholder="批次匯入地點，一行一個 (e.g. Tokyo Tower, Shibuya Crossing)" class="w-full p-4 rounded-xl border border-slate-200 mb-4 h-24"></textarea>
          <button @click="batchImportItinerary" class="bg-secondary text-white px-6 py-3 rounded-xl mr-4">批次匯入</button>
          <button @click="updateRoute" class="bg-primary text-white px-6 py-3 rounded-xl">更新地圖與路線</button>
          <div v-if="activeTrip.routeSummary" class="mt-4 p-4 bg-secondary/30 rounded-xl">
            <p>總距離約 {{ activeTrip.routeSummary.distance.toFixed(1) }} km</p>
          </div>
          <!-- Grouped Itinerary -->
          <div v-for="(dayGroup, dayIndex) in groupedItinerary" :key="dayIndex" class="mt-8 pt-8 border-t border-slate-200">
            <h3 class="text-xl font-bold mb-4">D{{ dayIndex + 1 }}</h3>
            <div v-for="(item, idx) in dayGroup" :key="idx" class="flex gap-4 mb-6 group">
              <div class="w-20 flex-shrink-0">
                <div class="w-1 bg-primary h-12 mx-auto mb-2"></div>
                <div class="text-sm font-medium text-center">{{ item.time }}</div>
              </div>
              <div class="flex-1 glass-card p-4">
                <input v-model="item.activity" class="w-full mb-2 p-2 rounded-lg border">
                <input v-model="item.location" class="w-full mb-2 p-2 rounded-lg border">
                <input v-model="item.mapsUrl" placeholder="Google Maps URL" class="w-full mb-2 p-2 rounded-lg border">
                <input v-model="item.bookingTime" placeholder="預約時間" class="w-1/2 p-2 rounded-lg border mr-2">
                <input v-model="item.remark" placeholder="備註" class="w-1/2 p-2 rounded-lg border">
                <div class="flex gap-2 mt-3">
                  <button @click="openItineraryMap(idx)" class="flex-1 bg-primary text-white py-2 rounded-lg text-sm"><i class="ri-map-pin-line"></i> 開啟地圖</button>
                  <button @click="removeItineraryItem(idx)" class="bg-red-400 text-white py-2 px-4 rounded-lg text-sm">刪除</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Map -->
        <div id="map" class="glass-card mx-auto max-w-4xl w-full"></div>
      </section>

      <!-- Budget Tab -->
      <section v-if="activeTab === 'budget' && activeTrip" class="max-w-2xl mx-auto">
        <!-- Rate Card -->
        <div class="glass-card p-8 mb-8">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i class="ri-money-dollar-circle-line"></i>匯率</h2>
          <p class="text-3xl font-bold">1,000 HKD ≈ {{ Math.round(1000 * activeTrip.exchangeRate).toLocaleString() }} {{ activeTrip.currency }}</p>
          <input v-model.number="activeTrip.exchangeRate" type="number" step="0.01" class="mt-4 w-full p-3 rounded-xl border text-center text-2xl">
          <button @click="fetchExchangeRate" class="mt-4 w-full bg-primary text-white py-3 rounded-xl font-medium">更新匯率</button>
        </div>
        <!-- Add Expense -->
        <div class="glass-card p-8 mb-8">
          <h3 class="text-xl font-bold mb-4">記一筆</h3>
          <input v-model="newExpense.name" placeholder="項目名稱" class="w-full p-3 rounded-xl border mb-3">
          <input v-model.number="newExpense.amount" type="number" placeholder="金額 (HKD)" class="w-full p-3 rounded-xl border mb-3">
          <select v-model="newExpense.method" class="w-full p-3 rounded-xl border mb-3">
            <option>現金</option>
            <option>信用卡</option>
            <option>其他</option>
          </select>
          <select v-model="newExpense.category" class="w-full p-3 rounded-xl border mb-4">
            <option>飲食</option>
            <option>購物</option>
            <option>娛樂</option>
            <option>交通</option>
            <option>其他</option>
          </select>
          <button @click="addExpense" class="w-full bg-primary text-white py-3 rounded-xl font-medium">記一筆</button>
        </div>
        <!-- Expenses Summary -->
        <div class="glass-card p-6 mb-4">
          <p class="text-xl">總筆數: {{ expenses.length }} | 總額: {{ totalExpensesHKD.toLocaleString() }} HKD ({{ Math.round(totalExpensesHKD * activeTrip.exchangeRate).toLocaleString() }} {{ activeTrip.currency }})</p>
        </div>
        <!-- List -->
        <div class="glass-card p-6 max-h-96 overflow-y-auto">
          <div v-for="(exp, idx) in activeTrip.expenses" :key="idx" class="flex justify-between items-center p-4 border-b border-slate-200 last:border-b-0">
            <div>
              <p class="font-bold">{{ exp.name }}</p>
              <p class="text-sm text-secondary">{{ exp.date }} | {{ exp.category }} | {{ exp.method }}</p>
            </div>
            <div class="text-right">
              <p class="font-bold">{{ exp.amount }} HKD</p>
              <p class="text-sm text-secondary">≈ {{ Math.round(exp.amount * activeTrip.exchangeRate) }} {{ activeTrip.currency }}</p>
            </div>
          </div>
        </div>
      </section>

      <!-- Shopping Tab -->
      <section v-if="activeTab === 'shopping' && activeTrip" class="max-w-2xl mx-auto">
        <div class="glass-card p-8 mb-8">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i class="ri-shopping-bag-line"></i>旅程購物清單</h2>
          <input v-model="newShoppingItem.name" placeholder="品項名稱" class="w-full p-3 rounded-xl border mb-3">
          <input v-model="newShoppingItem.onlinePrice" placeholder="網上價錢" class="w-full p-3 rounded-xl border mb-3">
          <input v-model="newShoppingItem.localPrice" placeholder="本地實付價" class="w-full p-3 rounded-xl border mb-3">
          <input type="file" @change="handleImageUpload" accept="image/*" class="w-full p-3 rounded-xl border mb-4">
          <img v-if="newShoppingItem.imageData" :src="newShoppingItem.imageData" class="w-24 h-24 object-cover rounded-xl mb-4">
          <button @click="addShoppingItem" class="w-full bg-primary text-white py-3 rounded-xl font-medium">新增購物項目</button>
        </div>
        <div v-for="(item, idx) in activeTrip.shoppingItems" :key="idx" class="glass-card p-6 mb-4" :class="{ 'opacity-50': item.bought }">
          <div class="flex items-start gap-4">
            <img v-if="item.imageData" :src="item.imageData" class="w-24 h-24 object-cover rounded-xl flex-shrink-0">
            <div class="flex-1">
              <h3 class="font-bold text-lg">{{ item.name }}</h3>
              <p>網上價: {{ item.onlinePrice }}</p>
              <p>本地價: {{ item.localPrice }}</p>
            </div>
            <div class="flex gap-2">
              <label class="flex items-center gap-1">
                <input type="checkbox" v-model="item.bought">
                已買
              </label>
              <button @click="removeShoppingItem(idx)" class="text-red-500"><i class="ri-delete-bin-line"></i></button>
            </div>
          </div>
        </div>
      </section>

      <!-- Trips History Tab -->
      <section v-if="activeTab === 'trips'" class="max-w-2xl mx-auto">
        <h2 class="text-3xl font-bold mb-8 text-center flex items-center justify-center gap-3"><i class="ri-suitcase-3-line text-4xl text-primary"></i>旅程管理</h2>
        <button @click="showNewTripForm = true" class="w-full mb-6 bg-primary text-white py-4 rounded-2xl font-bold text-xl shadow-xl">+ 新增旅程</button>
        <!-- New/Edit Form -->
        <div v-if="showNewTripForm || editingTrip" class="glass-card p-8 mb-8">
          <h3 class="text-2xl font-bold mb-6">{{ editingTrip ? '編輯旅程' : '新增旅程' }}</h3>
          <input v-model="tempTrip.title" placeholder="標題" class="w-full p-4 rounded-xl border mb-4 text-lg">
          <input v-model="tempTrip.destination" placeholder="目的地" class="w-full p-4 rounded-xl border mb-4 text-lg">
          <input v-model="tempTrip.city" placeholder="城市" class="w-full p-4 rounded-xl border mb-4 text-lg">
          <select v-model="tempTrip.currency" class="w-full p-4 rounded-xl border mb-4 text-lg">
            <option>JPY</option>
            <option>USD</option>
            <option>EUR</option>
            <option>THB</option>
            <option>OTHER</option>
          </select>
          <input v-model="tempTrip.startDate" type="date" class="w-1/2 p-4 rounded-xl border mr-2">
          <input v-model="tempTrip.endDate" type="date" class="w-1/2 p-4 rounded-xl border">
          <div class="flex gap-4 mt-6">
            <button @click="saveNewTrip" class="flex-1 bg-primary text-white py-3 rounded-xl font-bold">儲存</button>
            <button @click="cancelTripEdit" class="flex-1 bg-secondary text-white py-3 rounded-xl font-bold">取消</button>
          </div>
        </div>
        <!-- Trips List -->
        <div v-for="trip in trips" :key="trip.id" @click="switchTrip(trip.id)"
             :class="['glass-card p-8 mb-6 cursor-pointer hover:shadow-2xl transition-all', { 'active-trip-card shadow-2xl ring-4 ring-primary/50': activeTripId === trip.id }]"
             role="button">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="text-2xl font-bold">{{ trip.title }}</h3>
              <p class="text-lg">{{ trip.destination }} ({{ trip.city }})</p>
              <p class="text-sm text-secondary">{{ trip.startDate }} ～ {{ trip.endDate }} | {{ trip.currency }}</p>
            </div>
            <div class="text-right">
              <p class="text-xl font-bold text-primary">{{ trip.itinerary.length }} 站</p>
              <p class="text-sm">{{ trip.shoppingItems.length }} 購物</p>
            </div>
          </div>
          <span v-if="activeTripId === trip.id" class="inline-block bg-primary text-white px-4 py-1 rounded-full mt-3 font-medium">ACTIVE</span>
          <div class="flex gap-2 mt-4 pt-4 border-t border-slate-200">
            <button @click.stop="editTrip(trip)" class="flex-1 bg-secondary text-white py-2 rounded-xl">編輯</button>
            <button @click.stop="deleteTrip(trip.id)" :disabled="trips.length <= 1" class="flex-1 bg-red-400 text-white py-2 rounded-xl disabled:opacity-50" :class="{ 'hover:bg-red-500': trips.length > 1 }">
              {{ trips.length > 1 ? '刪除' : '至少保留一程' }}
            </button>
          </div>
        </div>
      </section>
    </main>

    <!-- Bottom Tab Bar -->
    <nav class="fixed bottom-6 left-1/2 transform -translate-x-1/2 capsule-tab flex rounded-3xl p-2 shadow-2xl w-[min(90vw,500px)] z-40">
      <button @click="activeTab = 'info'" :class="['flex-1 p-4 rounded-2xl flex flex-col items-center gap-2 font-medium transition-all', activeTab === 'info' ? 'bg-primary text-white shadow-lg' : 'text-textSoft hover:bg-slate-100']">
        <i class="ri-information-line text-xl"></i>
        <span class="text-sm">Trip Info</span>
      </button>
      <button @click="activeTab = 'itinerary-map'" :class="['flex-1 p-4 rounded-2xl flex flex-col items-center gap-2 font-medium transition-all', activeTab === 'itinerary-map' ? 'bg-primary text-white shadow-lg' : 'text-textSoft hover:bg-slate-100']">
        <i class="ri-map-pin-5-line text-xl"></i>
        <span class="text-sm">行程·地圖</span>
      </button>
      <button @click="activeTab = 'budget'" :class="['flex-1 p-4 rounded-2xl flex flex-col items-center gap-2 font-medium transition-all', activeTab === 'budget' ? 'bg-primary text-white shadow-lg' : 'text-textSoft hover:bg-slate-100']">
        <i class="ri-wallet-line text-xl"></i>
        <span class="text-sm">記帳</span>
      </button>
      <button @click="activeTab = 'shopping'" :class="['flex-1 p-4 rounded-2xl flex flex-col items-center gap-2 font-medium transition-all', activeTab === 'shopping' ? 'bg-primary text-white shadow-lg' : 'text-textSoft hover:bg-slate-100']">
        <i class="ri-shopping-bag-3-line text-xl"></i>
        <span class="text-sm">購物</span>
      </button>
      <button @click="activeTab = 'trips'" :class="['flex-1 p-4 rounded-2xl flex flex-col items-center gap-2 font-medium transition-all', activeTab === 'trips' ? 'bg-primary text-white shadow-lg' : 'text-textSoft hover:bg-slate-100']">
        <i class="ri-suitcase-3-line text-xl"></i>
        <span class="text-sm">History</span>
      </button>
    </nav>
  </div>

  <script>
    const { createApp } = Vue;

    // Replace with your Aviationstack API key [web:28]
    const AVIATIONSTACK_KEY = 'your_key_here';

    createApp({
      data() {
        return {
          trips: [],
          activeTripId: null,
          activeTab: 'info',
          AVIATIONSTACK_KEY,
          // Temp forms
          batchImportText: '',
          newExpense: { name: '', amount: 0, method: '現金', category: '飲食' },
          newShoppingItem: { name: '', onlinePrice: '', localPrice: '', imageData: '', bought: false },
          tempTrip: { title: '', destination: '', city: '', currency: 'JPY', startDate: '', endDate: '' },
          showNewTripForm: false,
          editingTrip: null,
          // Map
          map: null,
          // Weather
          weatherData: null,
          weatherTheme: 'sunny',
          weatherDesc: '',
          // Computed caches
          expenses: [],
        };
      },
      computed: {
        activeTrip() {
          return this.trips.find(t => t.id === this.activeTripId);
        },
        groupedItinerary() {
          if (!this.activeTrip?.itinerary) return [];
          const daySize = 5;
          return _.chunk(this.activeTrip.itinerary, daySize);
        },
        totalExpensesHKD() {
          return this.activeTrip?.expenses?.reduce((sum, e) => sum + e.amount, 0) || 0;
        },
      },
      methods: {
        saveData() {
          localStorage.setItem('christine_travel_diary_trips', JSON.stringify(this.trips));
        },
        loadData() {
          const saved = localStorage.getItem('christine_travel_diary_trips');
          if (saved) {
            this.trips = JSON.parse(saved);
          } else {
            this.addDefaultTrip();
          }
          if (this.trips.length) this.activeTripId = this.trips[0].id;
          this.$nextTick(() => this.refreshActiveTrip());
        },
        addDefaultTrip() {
          const defaultTrip = {
            id: Date.now(),
            title: 'Japan Tokyo Trip',
            destination: 'Tokyo',
            city: 'Tokyo',
            currency: 'JPY',
            startDate: '2025-12-24',
            endDate: '2026-01-01',
            center: { lat: 35.6895, lng: 139.6917 },
            exchangeRate: 19.2,
            flights: {
              outbound: { no: 'NH924', date: '2025-12-24', from: 'HKG', to: 'NRT' },
              inbound: { no: 'NH923', date: '2026-01-01', from: 'NRT', to: 'HKG' }
            },
            itinerary: [],
            routeSummary: { distance: 0 },
            expenses: [],
            shoppingItems: [],
            savedListLink: ''
          };
          this.trips = [defaultTrip];
          this.saveData();
        },
        switchTrip(id) {
          this.activeTripId = id;
          this.refreshActiveTrip();
        },
        refreshActiveTrip() {
          if (!this.activeTrip) return;
          this.fetchExchangeRate();
          this.fetchWeather();
          this.$nextTick(() => {
            if (this.activeTab === 'itinerary-map') this.updateRoute();
          });
        },
        // Flights [web:28]
        async fetchFlight(direction) {
          const flight = this.activeTrip.flights[direction];
          if (!flight.no || !flight.date) return alert('請輸入航班編號與日期');
          try {
            const res = await fetch(`https://api.aviationstack.com/v1/flights?access_key=${AVIATIONSTACK_KEY}&flight_iata=${flight.no}&flight_date=${flight.date}`);
            const data = await res.json();
            if (data.data && data.data[0]) {
              const f = data.data[0];
              flight.from = f.departure.iata;
              flight.to = f.arrival.iata;
              // Sync itinerary times: first station outbound arr, last inbound dep
              if (this.activeTrip.itinerary.length > 0) {
                if (direction === 'outbound') {
                  this.activeTrip.itinerary[0].time = this.formatTime(f.arrival.scheduled);
                } else {
                  const lastIdx = this.activeTrip.itinerary.length - 1;
                  this.activeTrip.itinerary[lastIdx].time = this.formatTime(f.departure.scheduled);
                }
              }
              this.saveData();
              alert('航班資料已更新');
            } else {
              alert('未找到航班，請檢查編號/日期');
            }
          } catch (e) {
            alert('API錯誤，請檢查key或稍後重試');
          }
        },
        formatTime(isoTime) {
          if (!isoTime) return '';
          const d = new Date(isoTime);
          return d.toTimeString().slice(0,5);
        },
        // Weather [web:44]
        async fetchWeather() {
          if (!this.activeTrip?.center) return;
          try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${this.activeTrip.center.lat}&longitude=${this.activeTrip.center.lng}&current_weather=true&timezone=auto`);
            const data = await res.json();
            this.weatherData = data.current_weather;
            const code = data.current_weather.weathercode;
            this.weatherTheme = this.getWeatherTheme(code);
            this.weatherDesc = this.getWeatherDesc(code);
          } catch (e) {
            console.error(e);
          }
        },
        getWeatherTheme(code) {
          if (code < 3) return 'sunny'; // clear, few clouds
          if (code < 50) return 'cloudy';
          return 'rainy';
        },
        getWeatherDesc(code) {
          // Simplified map, full at open-meteo docs
          const maps = {0:'晴朗', 1:'少雲', 3:'毛毛雨', 61:'小雨'};
          return maps[code] || '未知';
        },
        // Exchange [web:33]
        async fetchExchangeRate() {
          if (!this.activeTrip?.currency) return;
          try {
            const res = await fetch(`https://api.exchangerate.host/latest?base=HKD&symbols=${this.activeTrip.currency}`);
            const data = await res.json();
            this.activeTrip.exchangeRate = data.rates[this.activeTrip.currency];
            this.saveData();
          } catch (e) {
            console.error(e);
          }
        },
        // Itinerary
        addItineraryItem() {
          const time = prompt('時間 (HH:MM)');
          const activity = prompt('活動');
          const location = prompt('地點');
          const mapsUrl = prompt('Google Maps URL (optional)');
          const bookingTime = prompt('預約時間 (optional)');
          const remark = prompt('備註 (optional)');
          if (time && activity && location) {
            this.activeTrip.itinerary.push({ time, activity, location, mapsUrl: mapsUrl || '', bookingTime: bookingTime || '', remark: remark || '' });
            this.saveData();
          }
        },
        batchImportItinerary() {
          const lines = this.batchImportText.split('\n').map(l => l.trim()).filter(Boolean);
          let currentTime = '10:00';
          for (let loc of lines) {
            this.activeTrip.itinerary.push({
              time: currentTime,
              activity: `參觀 ${loc}`,
              location: loc,
              mapsUrl: '',
              bookingTime: '',
              remark: ''
            });
            // +1 hour
            const [h, m] = currentTime.split(':').map(Number);
            const mins = h * 60 + m + 60;
            currentTime = `${Math.floor(mins / 60).toString().padStart(2,'0')}:${(mins % 60).toString().padStart(2,'0')}`;
          }
          this.batchImportText = '';
          this.saveData();
        },
        removeItineraryItem(idx) {
          this.activeTrip.itinerary.splice(idx, 1);
          this.saveData();
        },
        openItineraryMap(idx) {
          const item = this.activeTrip.itinerary[idx];
          let url = item.mapsUrl;
          if (!url) {
            const prevLoc = idx > 0 ? this.activeTrip.itinerary[idx-1].location : this.activeTrip.city;
            url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(prevLoc)}&destination=${encodeURIComponent(item.location)}&travelmode=walking`;
          }
          window.open(url, '_blank');
        },
        // Map & Route [web:42]
        async updateRoute() {
          if (!this.activeTrip?.itinerary.length) return;
          await this.initMap();
          if (!this.map) return;
          this.map.eachLayer(layer => { if (layer instanceof L.Polyline || layer instanceof L.Marker) this.map.removeLayer(layer); });

          const coords = [];
          let totalDist = 0;
          for (let i = 0; i < this.activeTrip.itinerary.length; i++) {
            const item = this.activeTrip.itinerary[i];
            const { lat, lng } = await this.geocode(item.location);
            if (lat && lng) {
              coords.push([lat, lng]);
              const marker = L.marker([lat, lng]).addTo(this.map).bindPopup(`<b>${item.time}</b><br>${item.activity}<br>${item.location}`);
              if (i > 0) {
                const dist = this.haversine(coords[i-1][0], coords[i-1][1], lat, lng);
                totalDist += dist;
              }
            }
          }
          if (coords.length > 1) {
            L.polyline(coords, { color: '#3B82F6', weight: 5, opacity: 0.8 }).addTo(this.map);
          }
          if (coords.length) this.map.fitBounds(coords);
          this.activeTrip.routeSummary.distance = totalDist / 1000; // km
          this.saveData();
        },
        initMap() {
          if (this.map) {
            this.map.remove();
          }
          const el = document.getElementById('map');
          if (!el) return;
          this.map = L.map(el).setView(this.activeTrip.center || [35.6895, 139.6917], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(this.map);
        },
        async geocode(query) {
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`);
            const data = await res.json();
            return data[0] ? { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) } : { lat: null, lng: null };
          } catch (e) {
            return { lat: null, lng: null };
          }
        },
        haversine(lat1, lon1, lat2, lon2) {
          const R = 6371e3; // meters
          const φ1 = lat1 * Math.PI/180;
          const φ2 = lat2 * Math.PI/180;
          const Δφ = (lat2-lat1) * Math.PI/180;
          const Δλ = (lon2-lon1) * Math.PI/180;
          const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          return R * c; // meters
        },
        // Expenses
        addExpense() {
          if (!this.newExpense.name || !this.newExpense.amount) return alert('請填寫名稱與金額');
          const date = new Date().toLocaleDateString('zh-HK', { month: '2-digit', day: '2-digit' });
          this.activeTrip.expenses.unshift({ ...this.newExpense, date });
          this.newExpense = { name: '', amount: 0, method: '現金', category: '飲食' };
          this.saveData();
        },
        // Shopping
        handleImageUpload(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
              this.newShoppingItem.imageData = ev.target.result;
            };
            reader.readAsDataURL(file);
          }
        },
        addShoppingItem() {
          if (!this.newShoppingItem.name) return alert('請填寫名稱');
          this.activeTrip.shoppingItems.unshift({ ...this.newShoppingItem });
          this.newShoppingItem = { name: '', onlinePrice: '', localPrice: '', imageData: '', bought: false };
          this.saveData();
        },
        removeShoppingItem(idx) {
          this.activeTrip.shoppingItems.splice(idx, 1);
          this.saveData();
        },
        // Trips
        editTrip(trip) {
          this.editingTrip = trip;
          this.tempTrip = { ...trip };
          this.showNewTripForm = true;
        },
        async saveNewTrip() {
          if (this.editingTrip) {
            // Update
            Object.assign(this.editingTrip, this.tempTrip);
            const { lat, lng } = await this.geocode(this.tempTrip.city);
            if (lat && lng) this.editingTrip.center = { lat, lng };
          } else {
            // New
            const id = Date.now();
            const { lat, lng } = await this.geocode(this.tempTrip.city);
            const newTrip = {
              id,
              ...this.tempTrip,
              center: lat && lng ? { lat, lng } : { lat: 35.6895, lng: 139.6917 },
              exchangeRate: 1,
              flights: { outbound: {}, inbound: {} },
              itinerary: [],
              routeSummary: { distance: 0 },
              expenses: [],
              shoppingItems: [],
              savedListLink: ''
            };
            this.trips.push(newTrip);
            this.activeTripId = id;
          }
          this.refreshActiveTrip();
          this.cancelTripEdit();
          this.saveData();
        },
        cancelTripEdit() {
          this.showNewTripForm = false;
          this.editingTrip = null;
          this.tempTrip = { title: '', destination: '', city: '', currency: 'JPY', startDate: '', endDate: '' };
        },
        deleteTrip(id) {
          if (this.trips.length <= 1) return alert('至少保留一程旅程');
          if (confirm('確認刪除此旅程？')) {
            this.trips = this.trips.filter(t => t.id !== id);
            if (this.activeTripId === id) {
              this.activeTripId = this.trips[0]?.id || null;
            }
            this.refreshActiveTrip();
            this.saveData();
          }
        },
      },
      mounted() {
        this.loadData();
      },
      watch: {
        activeTripId() {
          this.refreshActiveTrip();
        },
        activeTab(newTab) {
          if (newTab === 'itinerary-map') {
            this.$nextTick(() => this.initMap());
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
