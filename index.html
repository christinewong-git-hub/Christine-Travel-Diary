<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººæ—…è¡Œæ—¥è¨˜èˆ‡é ç®—è¿½è¹¤</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --primary: #97CBFF;
            --secondary: #FFD9EC;
            --accent: #C7C7E2;
            --bg-light: #f8f9fa;
            --bg-dark: #343a40;
            --text-dark: #212529;
            --text-light: #ffffff;
            --radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Microsoft JhengHei', Arial, sans-serif; }
        body { background-color: var(--bg-light); color: var(--text-dark); min-height: 100vh; }
        #app { display: flex; flex-direction: column; max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* === Header and Navigation === */
        header { background: var(--bg-dark); color: var(--text-light); border-radius: var(--radius); margin-bottom: 20px; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        header h1 { font-size: 1.5rem; margin: 0; }
        .nav-tabs { display: flex; overflow-x: auto; white-space: nowrap; background: #fff; border-radius: var(--radius); padding: 5px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .nav-tabs button { flex: 1 1 auto; background: none; border: none; padding: 10px 15px; cursor: pointer; font-weight: 600; font-size: 0.95rem; color: var(--text-dark); border-radius: 8px; transition: background-color 0.2s, color 0.2s; min-width: 80px; }
        .nav-tabs button.active { background-color: var(--primary); color: var(--text-light); }
        .nav-tabs i { margin-right: 5px; }

        /* === Content Layout === */
        .content-area { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) {
            .content-area { grid-template-columns: 2fr 1fr; }
            .info-area { grid-column: 1 / 3; } /* Info page uses full width */
        }
        .section-box { background: #fff; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); }
        h2 { font-size: 1.3rem; color: var(--primary); margin-bottom: 15px; border-bottom: 2px solid var(--secondary); padding-bottom: 5px; }

        /* === Trip Info === */
        .trip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .trip-header h2 { border-bottom: none; margin-bottom: 0; }
        .trip-details p { margin: 5px 0; font-size: 0.95rem; }
        .weather-card { text-align: center; padding: 20px; background: linear-gradient(135deg, var(--primary), var(--accent)); color: var(--text-light); border-radius: var(--radius); margin-bottom: 20px; }
        .weather-card.sunny { background: linear-gradient(135deg, #FFC700, #FFD700); }
        .weather-card.cloudy { background: linear-gradient(135deg, #B0C4DE, #778899); }
        .weather-card.rainy { background: linear-gradient(135deg, #87CEEB, #4682B4); }
        .weather-card i { font-size: 3rem; margin-bottom: 5px; }
        .flight-info { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .flight-box { padding: 15px; border: 1px solid var(--secondary); border-radius: var(--radius); }

        /* === Forms & Inputs === */
        form { display: flex; flex-direction: column; gap: 10px; }
        label { font-weight: 600; font-size: 0.9rem; margin-top: 5px; }
        input[type="text"], input[type="number"], input[type="date"], input[type="time"], select {
            padding: 10px; border: 1px solid #ccc; border-radius: 8px; width: 100%; font-size: 0.95rem;
        }
        button { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--primary); color: var(--text-light); }
        .btn-primary:hover { background-color: #6a9ce7; }
        .btn-secondary { background-color: var(--accent); color: var(--text-light); }
        .btn-secondary:hover { background-color: #a7a7c7; }
        .btn-danger { background-color: #dc3545; color: var(--text-light); }
        .btn-danger:hover { background-color: #c82333; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; }
        .flex-row { display: flex; gap: 10px; align-items: center; }
        .flex-row > * { flex: 1; }
        .flex-row .flex-2 { flex: 2; }
        .flex-row .flex-auto { flex: 0 0 auto; }

        /* === Modals === */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; padding: 30px; border-radius: var(--radius); max-width: 500px; width: 90%; max-height: 90%; overflow-y: auto; position: relative; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #aaa; }

        /* === Itinerary & Map === */
        .map-container { height: 400px; border-radius: var(--radius); margin-bottom: 20px; }
        #map { height: 100%; border-radius: var(--radius); }
        .itinerary-day-selector { display: flex; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; gap: 10px; }
        .itinerary-day-selector button { flex: 0 0 auto; min-width: 60px; }
        .itinerary-item { background: var(--bg-light); border: 1px solid #eee; padding: 15px; border-radius: var(--radius); margin-bottom: 10px; display: grid; grid-template-columns: 1fr 3fr 1fr; gap: 10px; align-items: center; font-size: 0.9rem; }
        .itinerary-item .time { font-weight: 700; color: var(--primary); }
        .itinerary-item .location { font-style: italic; color: #666; }
        .itinerary-item-controls { text-align: right; }

        /* === Budget === */
        .budget-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .budget-inputs .flex-2 { grid-column: span 2; }
        .currency-switch { display: flex; gap: 5px; align-items: center; }
        .currency-switch input[type="radio"] { margin-right: 5px; }
        
        .expense-list { max-height: 400px; overflow-y: auto; padding-right: 10px; }
        .expense-item { display: grid; grid-template-columns: 1fr 2fr 1fr 1fr 0.5fr; gap: 10px; padding: 10px 0; border-bottom: 1px dotted #eee; align-items: center; font-size: 0.9rem; }
        .expense-item.header { font-weight: bold; background: #f0f0f0; padding: 10px; border-radius: var(--radius); grid-template-columns: 1fr 4fr 0.5fr; }
        .expense-item span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .expense-item.is-header { grid-template-columns: 1fr 3fr 1fr; background: #e9ecef; font-weight: 700; margin-top: 15px; padding: 10px; border-radius: 6px; }
        .expense-item.is-header .total-amount { color: #dc3545; font-size: 1.1rem; }
        .expense-item.is-header .day-label { color: var(--primary); }
        .chart-container { height: 300px; margin-bottom: 20px; }
        .summary-box { background: #f0f8ff; padding: 15px; border-radius: var(--radius); margin-bottom: 15px; font-weight: 600; }
        .summary-box span { color: #dc3545; font-size: 1.1rem; }

        /* === Shopping === */
        .shopping-item { background: var(--bg-light); border: 1px solid #eee; padding: 15px; border-radius: var(--radius); margin-bottom: 10px; display: grid; grid-template-columns: 0.5fr 2fr 1fr 1fr 0.5fr; gap: 10px; align-items: center; font-size: 0.9rem; }
        .shopping-item.bought { opacity: 0.6; text-decoration: line-through; }
        .savings-tag { background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 0.8rem; }
        .no-savings-tag { background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px; font-weight: 700; font-size: 0.8rem; }
        .shopping-controls { display: flex; gap: 5px; align-items: center; }
        .image-preview { max-width: 50px; max-height: 50px; border-radius: 4px; object-fit: cover; }
        .shopping-form .flex-row input, .shopping-form .flex-row select { width: 100%; }
        .shopping-list-header { font-weight: bold; padding: 10px 0; border-bottom: 2px solid #ccc; margin-bottom: 10px; display: grid; grid-template-columns: 0.5fr 2fr 1fr 1fr 0.5fr; gap: 10px; }
        .shopping-summary { background: #f0f8ff; padding: 15px; border-radius: var(--radius); margin-bottom: 15px; font-weight: 600; text-align: center; }
        .shopping-summary span { color: #28a745; font-size: 1.2rem; }

        /* === Trip History === */
        .trip-card { background: var(--bg-light); padding: 15px; border-radius: var(--radius); margin-bottom: 15px; border-left: 5px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .trip-card-details h3 { color: var(--primary); margin-bottom: 5px; font-size: 1.2rem; }
        .trip-card-details p { font-size: 0.9rem; color: #666; }
        .trip-card-actions button { margin-left: 8px; }

        /* === Auth/Login === */
        .auth-container { display: flex; gap: 10px; align-items: center; }
        .auth-status { font-weight: 600; font-size: 0.9rem; margin-right: 10px; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    
    <div class="modal-overlay" v-if="showLoginModal">
        <div class="modal-content">
            <span class="close-button" @click="showLoginModal = false">Ã—</span>
            <h2>ç”¨æˆ¶ç™»å…¥ / è¨»å†Š</h2>
            <p>è«‹å…ˆç™»å…¥ä»¥åŒæ­¥æ‚¨çš„æ—…è¡Œæ•¸æ“šåˆ°é›²ç«¯ï¼Œé¿å…æ•¸æ“šä¸Ÿå¤±ã€‚</p>
            <form @submit.prevent="loginUser">
                <label>é›»å­éƒµä»¶ (Email)</label>
                <input type="text" v-model="loginEmail" required placeholder="name@example.com">
                <label>å¯†ç¢¼ (Password)</label>
                <input type="password" v-model="loginPassword" required placeholder="è‡³å°‘ 6 ä½æ•¸">
                <button type="submit" class="btn-primary">ç™»å…¥</button>
            </form>
            <p style="text-align:center; margin-top: 15px; font-size: 0.9rem;">
                å¦‚æœæ‚¨æ²’æœ‰å¸³è™Ÿï¼Œè«‹ç›´æ¥ä½¿ç”¨ä¸Šè¿°æ¬„ä½è¼¸å…¥ Email å’Œå¯†ç¢¼ï¼Œç³»çµ±æœƒè‡ªå‹•ç‚ºæ‚¨å‰µå»ºå¸³è™Ÿä¸¦ç™»å…¥ã€‚
            </p>
        </div>
    </div>
    
    <header>
        <h1><i class="ri-plane-line"></i> æ—…è¡Œæ—¥èªŒ</h1>
        <div class="auth-container">
            <span class="auth-status" v-if="currentUser">
                Logged in as: {{ currentUser.email }}
            </span>
            <button class="btn-small btn-secondary" @click="currentUser ? logoutUser() : showLoginModal = true">
                <i :class="currentUser ? 'ri-logout-box-r-line' : 'ri-login-box-line'"></i> 
                {{ currentUser ? 'ç™»å‡º' : 'ç™»å…¥/è¨»å†Š' }}
            </button>
        </div>
    </header>

    <template v-if="activeTrip">
        <h2 style="text-align: center; color: var(--text-dark); margin-bottom: 15px; font-size: 1.8rem;">
            {{ activeTrip.title }} <span style="font-size: 1rem; color: #666;">({{ activeTrip.city }}, {{ activeTrip.destination }})</span>
        </h2>
        
        <div class="nav-tabs">
            <button v-for="tab in tabs" :key="tab.id" 
                    :class="{ active: activeTab === tab.id }" 
                    @click="activeTab = tab.id">
                <i :class="tab.icon"></i> {{ tab.label }}
            </button>
        </div>

        <div class="content-area">
            
            <div class="info-area" v-if="activeTab === 'info'">
                <div class="trip-header">
                    <h2>æ—…è¡Œè³‡è¨Šæ¦‚è¦½</h2>
                    <button class="btn-small btn-secondary" @click="openEditTripModal(activeTrip)">
                        <i class="ri-edit-line"></i> ç·¨è¼¯æ—…ç¨‹
                    </button>
                </div>
                
                <div class="trip-details section-box" style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                    <div>
                        <h3>åŸºæœ¬è³‡è¨Š</h3>
                        <p><strong>ç›®çš„åœ°:</strong> {{ activeTrip.city }}, {{ activeTrip.destination }}</p>
                        <p><strong>æ—¥æœŸ:</strong> {{ activeTrip.startDate }} ~ {{ activeTrip.endDate }} (å…± {{ totalDays }} æ—¥)</p>
                        <p><strong>ç•¶åœ°è²¨å¹£:</strong> {{ activeTrip.currency }}</p>
                        <p><strong>åŒ¯ç‡:</strong> 1 HKD â‰ˆ {{ activeTrip.exchangeRate }} {{ activeTrip.currency }}</p>
                        <p><strong>ç¸½é–‹éŠ· (HKD):</strong> <span style="color: #dc3545; font-weight: bold;">HKD {{ totalExpensesHKD.toFixed(2) }}</span></p>
                    </div>

                    <div :class="['weather-card', weatherTheme]">
                        <i :class="weatherData?.weathercode < 3 ? 'ri-sun-line' : weatherData?.weathercode >= 51 ? 'ri-rainy-line' : 'ri-cloudy-line'"></i>
                        <h3>{{ activeTrip.city }} å¤©æ°£</h3>
                        <p style="font-size: 2rem; font-weight: bold;">{{ weatherData?.temperature }} Â°C</p>
                        <p>{{ weatherDesc }}</p>
                    </div>

                    <div style="grid-column: 1 / 3;">
                        <h3>èˆªç­è³‡è¨Š <i class="ri-flight-takeoff-line"></i></h3>
                        <div class="flight-info">
                            <div class="flight-box">
                                <strong>å»ç¨‹: {{ activeTrip.flights.outbound.no || 'æœªè¨­å®š' }}</strong>
                                <p>{{ activeTrip.flights.outbound.from || '---' }} <i class="ri-arrow-right-line"></i> {{ activeTrip.flights.outbound.to || '---' }}</p>
                                <p>{{ activeTrip.flights.outbound.date || '---' }} | 
                                   {{ activeTrip.flights.outbound.depTime || '---' }} ~ {{ activeTrip.flights.outbound.arrTime || '---' }}</p>
                                <button class="btn-small btn-secondary" @click="fetchFlight('outbound')">æ›´æ–°èˆªç­</button>
                            </div>
                            <div class="flight-box">
                                <strong>å›ç¨‹: {{ activeTrip.flights.inbound.no || 'æœªè¨­å®š' }}</strong>
                                <p>{{ activeTrip.flights.inbound.from || '---' }} <i class="ri-arrow-right-line"></i> {{ activeTrip.flights.inbound.to || '---' }}</p>
                                <p>{{ activeTrip.flights.inbound.date || '---' }} | 
                                   {{ activeTrip.flights.inbound.depTime || '---' }} ~ {{ activeTrip.flights.inbound.arrTime || '---' }}</p>
                                <button class="btn-small btn-secondary" @click="fetchFlight('inbound')">æ›´æ–°èˆªç­</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <template v-if="activeTab === 'itinerary-map'">
                <div class="map-section section-box" style="grid-column: 1 / 3;">
                    <h2>ç•¶æ—¥è¡Œç¨‹åœ°åœ– (Day {{ activeDay }})</h2>
                    <div class="itinerary-day-selector">
                        <button v-for="day in totalDays" :key="day" 
                                :class="{ 'btn-primary': activeDay === day, 'btn-secondary': activeDay !== day }"
                                @click="selectDay(day)">
                            Day {{ day }}
                        </button>
                    </div>
                    <div id="map" class="map-container"></div>
                </div>

                <div class="itinerary-list section-box">
                    <h2>è¡Œç¨‹ç´°ç¯€</h2>
                    <button class="btn-primary" @click="addItineraryItem(activeDay)"><i class="ri-add-line"></i> æ–°å¢è¡Œç¨‹</button>
                    <button class="btn-secondary" @click="showBatchImport = true"><i class="ri-file-list-line"></i> æ‰¹é‡åŒ¯å…¥</button>

                    <div v-for="dayData in groupedItinerary" :key="dayData.day">
                        <h3 v-if="dayData.day === activeDay" style="margin-top: 15px; color: #666;">Day {{ dayData.day }} ({{ activeTrip.startDate.substring(5) }} + {{ dayData.day - 1 }} days)</h3>
                        <div v-if="dayData.day === activeDay">
                            <div v-for="item in dayData.items" :key="item.id" class="itinerary-item">
                                <input type="time" v-model="item.time" @change="saveData">
                                <div>
                                    <input type="text" v-model="item.activity" placeholder="æ´»å‹•åç¨±" @blur="saveData">
                                    <input type="text" v-model="item.location" placeholder="åœ°é»/åœ°å€ (å¦‚: Tokyo SkyTree)" @blur="saveData">
                                </div>
                                <div class="itinerary-item-controls">
                                    <button class="btn-small btn-primary" @click="openGoogleMaps(item)"><i class="ri-map-pin-line"></i> Map</button>
                                    <button class="btn-small btn-danger" @click="removeItineraryItem(item.id)"><i class="ri-delete-bin-line"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="groupedItinerary.find(d => d.day === activeDay)?.items.length === 0" style="padding: 15px; text-align: center; color: #999;">
                        ç•¶æ—¥æ²’æœ‰è¡Œç¨‹ã€‚
                    </div>

                    <div class="modal-overlay" v-if="showBatchImport">
                        <div class="modal-content">
                            <span class="close-button" @click="showBatchImport = false">Ã—</span>
                            <h2>æ‰¹é‡åŒ¯å…¥è¡Œç¨‹</h2>
                            <p>è«‹æŒ‰æ ¼å¼è²¼ä¸Šè¡Œç¨‹ï¼š**Day, æ™‚é–“, æ´»å‹•åç¨±, åœ°é»**ã€‚æ¯è¡Œä¸€å€‹é …ç›®ã€‚</p>
                            <textarea v-model="batchImportText" rows="10" style="width: 100%; padding: 10px; margin: 10px 0;" placeholder="ç¯„ä¾‹:
1, 09:00, æ—©é¤, é£¯åº—
1, 10:30, åƒè§€æ™¯é», Asakusa Temple
2, 18:00, æ™šé¤, Shinjuku"></textarea>
                            <button class="btn-primary" @click="runBatchImport">ç¢ºèªåŒ¯å…¥</button>
                        </div>
                    </div>
                </div>
            </template>

            <template v-if="activeTab === 'budget'">
                <div class="add-expense section-box">
                    <h2><i class="ri-pencil-line"></i> è¨˜ä¸€ç­†</h2>
                    <div class="budget-inputs">
                        <div class="flex-row flex-2">
                            <label style="flex: 1;">é …ç›®:</label>
                            <input type="text" v-model="newExpense.name" placeholder="æ¶ˆè²»é …ç›® (e.g. åˆé¤)" required style="flex: 3;">
                        </div>
                        
                        <div class="flex-row">
                             <label for="currency-select" class="flex-auto">å¹£åˆ¥:</label>
                             <select id="currency-select" v-model="inputCurrency">
                                 <option value="HKD">HKD (æ¸¯å¹£)</option>
                                 <option :value="activeTrip.currency">{{ activeTrip.currency }} (å¤–å¹£)</option>
                             </select>
                        </div>
                        
                        <div class="flex-row">
                            <label for="amount-input" class="flex-auto">é‡‘é¡:</label>
                            <input id="amount-input" type="text" :value="newExpense.localAmount" 
                                   @input="cleanAmountInput" 
                                   placeholder="è¼¸å…¥é‡‘é¡" required>
                        </div>
                        
                        <div class="flex-row">
                            <label for="category-select" class="flex-auto">é¡åˆ¥:</label>
                            <select id="category-select" v-model="newExpense.category">
                                <option>é£²é£Ÿ</option>
                                <option>è³¼ç‰©</option>
                                <option>äº¤é€š</option>
                                <option>å¨›æ¨‚</option>
                                <option>ä½å®¿</option>
                                <option>æ—…è¡Œå‰</option>
                                <option>å…¶ä»–</option>
                            </select>
                        </div>
                        
                        <div class="flex-row" v-if="newExpense.category !== 'æ—…è¡Œå‰'">
                            <label for="day-select" class="flex-auto">Day:</label>
                            <select id="day-select" v-model="newExpense.day">
                                <option v-for="day in totalDays" :key="day" :value="day">Day {{ day }}</option>
                            </select>
                        </div>
                        
                        <div class="flex-row">
                             <label for="method-select" class="flex-auto">æ”¯ä»˜:</label>
                             <select id="method-select" v-model="newExpense.method">
                                 <option>ç¾é‡‘</option>
                                 <option>ä¿¡ç”¨å¡</option>
                                 <option>å…¶ä»–</option>
                             </select>
                        </div>

                    </div>
                    
                    <div class="summary-box" style="text-align: center; margin-top: 10px;">
                        æ›ç®—å¾Œæ¸¯å¹£é‡‘é¡ (HKD)ï¼š
                        <span style="font-size: 1.2rem;">{{ finalHKDAmount.toFixed(2) }} HKD</span>
                    </div>

                    <button class="btn-primary" @click="addExpense"><i class="ri-add-line"></i> æ–°å¢æ¶ˆè²»</button>
                    <button class="btn-secondary" @click="exportExpensesToCSV" style="margin-top: 5px;"><i class="ri-file-download-line"></i> åŒ¯å‡º CSV</button>
                    
                    <h3 style="margin-top: 20px;">åŒ¯ç‡è¨­å®š (1 HKD = X {{ activeTrip.currency }})</h3>
                    <div class="flex-row">
                        <input type="number" v-model="tempExchangeRate" step="0.01" @blur="updateExchangeRate">
                        <button class="btn-small btn-secondary" @click="fetchExchangeRate"><i class="ri-refresh-line"></i> å–å¾—å³æ™‚åŒ¯ç‡</button>
                    </div>
                </div>

                <div class="expense-summary section-box">
                    <h2><i class="ri-bar-chart-box-line"></i> æ”¯å‡ºç¸½è¦½</h2>
                    <div class="summary-box">
                        ç¸½é–‹æ”¯ï¼š<span style="color: #dc3545;">HKD {{ totalExpensesHKD.toFixed(2) }}</span>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="expenseChart"></canvas>
                    </div>
                    
                    <div class="payment-summary">
                        <h3>æ”¯ä»˜æ–¹å¼åˆ†ä½ˆ</h3>
                        <p>ç¾é‡‘: HKD {{ paymentSummary.ç¾é‡‘.toFixed(2) }}</p>
                        <p>ä¿¡ç”¨å¡: HKD {{ paymentSummary.ä¿¡ç”¨å¡.toFixed(2) }}</p>
                    </div>
                </div>
                
                <div class="expense-list-container section-box" style="grid-column: 1 / 3;">
                    <h2>æ‰€æœ‰è¨˜å¸³è¨˜éŒ„ (å…± {{ filteredExpenses.length }} ç­†)</h2>
                    <div class="expense-list">
                        <div class="expense-item header" style="grid-template-columns: 1fr 2fr 1fr 1fr 0.5fr;">
                            <span>Day/æ—¥æœŸ</span>
                            <span>é …ç›®/é¡åˆ¥</span>
                            <span>ç•¶åœ°é‡‘é¡({{ activeTrip.currency }})</span>
                            <span>æ¸¯å¹£é‡‘é¡(HKD)</span>
                            <span></span>
                        </div>
                        
                        <template v-for="item in groupedAndSortedExpenses" :key="item.id">
                            <div v-if="item.isHeader" class="expense-item is-header">
                                <span class="day-label">{{ item.dayLabel }}</span>
                                <span>ç¸½è¨ˆ</span>
                                <span class="total-amount">{{ item.total.toFixed(2) }} HKD</span>
                            </div>
                            <div v-else class="expense-item">
                                <span>Day {{ item.day }} ({{ item.date }})</span>
                                <div>
                                    <span style="font-weight: 600;">{{ item.name }}</span><br>
                                    <span style="color: #999; font-size: 0.8em;">{{ item.category }} / {{ item.method }}</span>
                                </div>
                                <span>{{ item.localAmount.toFixed(2) }}</span>
                                <span style="font-weight: 700;">{{ item.amount.toFixed(2) }}</span>
                                <button class="btn-small btn-danger" @click="removeExpense(item.id)"><i class="ri-delete-bin-line"></i></button>
                            </div>
                        </template>
                        
                    </div>
                </div>
            </template>

            <template v-if="activeTab === 'shopping'">
                <div class="add-shopping-item section-box">
                    <h2><i class="ri-shopping-bag-line"></i> æ–°å¢è³¼ç‰©é …ç›®</h2>
                    <div class="shopping-form">
                        <div class="flex-row">
                             <label for="shop-name">å“å:</label>
                             <input id="shop-name" type="text" v-model="newShoppingItem.name" placeholder="ä¾‹å¦‚: æŸå“ç‰Œç²¾è¯æ¶²" required>
                        </div>
                        <div class="flex-row">
                            <label>æ•¸é‡:</label>
                            <input type="number" v-model.number="newShoppingItem.quantity" min="1">
                        </div>
                        <div class="flex-row">
                             <label>ç¶²ä¸Šåƒ¹ (HKD):</label>
                             <input type="number" v-model.number="newShoppingItem.onlinePrice" placeholder="é¦™æ¸¯ç¶²åº—åƒ¹æ ¼ (HKD)" min="0" step="0.01">
                        </div>
                        <div class="flex-row">
                             <label>ç•¶åœ°åƒ¹ ({{ activeTrip.currency }}):</label>
                             <input type="number" v-model.number="newShoppingItem.localPrice" :placeholder="`ç•¶åœ°åƒ¹æ ¼ (${activeTrip.currency})`" min="0" step="0.01">
                        </div>
                        <div class="flex-row">
                            <input type="checkbox" id="bought-check" v-model="newShoppingItem.bought" style="width: auto;">
                            <label for="bought-check" style="margin-top: 0; font-weight: normal;">å·²è³¼è²·</label>
                        </div>
                        <div class="flex-row">
                            <label>åœ–ç‰‡:</label>
                            <input type="file" @change="handleImageUpload" accept="image/*">
                        </div>
                    </div>
                    <button class="btn-primary" @click="addShoppingItem" style="margin-top: 10px;"><i class="ri-add-line"></i> åŠ å…¥æ¸…å–®</button>
                </div>

                <div class="shopping-list-container section-box">
                    <h2>è³¼ç‰©æ¸…å–®</h2>
                    <div class="shopping-summary">
                        ğŸ‰ ç¸½å…±å¯ç¯€çœï¼š<span style="color: #28a745;">HKD {{ totalSavings.toFixed(2) }}</span>
                    </div>

                    <div class="shopping-list-header">
                        <span>ç‹€æ…‹</span>
                        <span>å“å/æ•¸é‡</span>
                        <span>ç¶²ä¸Šåƒ¹(HKD)</span>
                        <span>ç•¶åœ°åƒ¹(HKD)</span>
                        <span>ç¯€çœ</span>
                    </div>

                    <div v-for="item in shoppingListWithSavings" :key="item.id" :class="['shopping-item', { 'bought': item.bought }]">
                        <input type="checkbox" :checked="item.bought" @change="toggleBought(item)" style="width: auto;">
                        <div>
                            <span style="font-weight: 600;">{{ item.name }}</span> 
                            <span style="font-size: 0.8em; color: #666;">x{{ item.quantity }}</span><br>
                            <img v-if="item.image" :src="item.image" class="image-preview" alt="å•†å“é è¦½">
                        </div>
                        <span>{{ item.onlinePriceHKD.toFixed(2) }}</span>
                        <span>{{ item.localPriceHKD.toFixed(2) }}</span>
                        <span v-if="item.savingsHKD > 0" class="savings-tag">
                            +{{ item.savingsHKD.toFixed(2) }}
                        </span>
                        <span v-else class="no-savings-tag">
                            {{ item.savingsHKD.toFixed(2) }}
                        </span>
                        <button class="btn-small btn-danger" @click="removeShoppingItem(item.id)"><i class="ri-delete-bin-line"></i></button>
                    </div>
                    
                    <p v-if="shoppingListWithSavings.length === 0" style="padding: 15px; text-align: center; color: #999;">
                        è³¼ç‰©æ¸…å–®ç‚ºç©ºã€‚
                    </p>
                </div>
            </template>


            <div class="info-area" v-if="activeTab === 'trips'">
                <h2>æ—…ç¨‹è¨˜éŒ„èˆ‡åˆ‡æ›</h2>
                <button class="btn-primary" @click="openNewTripModal"><i class="ri-add-line"></i> æ–°å¢æ—…ç¨‹</button>
                
                <div v-for="trip in trips" :key="trip.id" class="trip-card" :style="{ borderLeftColor: trip.id === activeTripId ? 'var(--primary)' : '#ccc' }">
                    <div class="trip-card-details">
                        <h3>{{ trip.title }} ({{ trip.city }})</h3>
                        <p>{{ trip.startDate }} ~ {{ trip.endDate }} ({{ trip.destination }})</p>
                        <p>ç¸½é–‹éŠ·: HKD {{ calculateTripTotal(trip).toFixed(2) }}</p>
                    </div>
                    <div class="trip-card-actions">
                        <button class="btn-small" 
                                :class="trip.id === activeTripId ? 'btn-primary' : 'btn-secondary'" 
                                @click="switchTrip(trip.id)">
                            {{ trip.id === activeTripId ? 'ç•¶å‰' : 'åˆ‡æ›' }}
                        </button>
                        <button class="btn-small btn-secondary" @click="openEditTripModal(trip)">
                            <i class="ri-edit-line"></i> ç·¨è¼¯
                        </button>
                        <button class="btn-small btn-danger" @click="deleteTrip(trip.id)">
                            <i class="ri-delete-bin-line"></i> åˆªé™¤
                        </button>
                    </div>
                </div>
                <p v-if="trips.length === 0">ç›®å‰æ²’æœ‰æ—…ç¨‹è¨˜éŒ„ã€‚</p>
            </div>
            
        </div>
        
    </template>
    <div v-else class="info-area section-box">
        <h2>æ­¡è¿ä½¿ç”¨æ—…è¡Œæ—¥èªŒ</h2>
        <p>è«‹é»æ“Šä¸‹æ–¹çš„ã€Œæ–°å¢æ—…ç¨‹ã€æŒ‰éˆ•é–‹å§‹è¦åŠƒæ‚¨çš„æ—…è¡Œï¼</p>
        <button class="btn-primary" @click="openNewTripModal"><i class="ri-add-line"></i> æ–°å¢æ—…ç¨‹</button>
    </div>
    
    <div class="modal-overlay" v-if="showTripModal">
        <div class="modal-content">
            <span class="close-button" @click="showTripModal = false">Ã—</span>
            <h2>{{ editingTripId ? 'ç·¨è¼¯æ—…ç¨‹' : 'æ–°å¢æ—…ç¨‹' }}</h2>
            <form @submit.prevent="saveTrip">
                <label>æ—…ç¨‹åç¨±</label>
                <input type="text" v-model="tempTrip.title" required>
                
                <label>ç›®çš„åœ° (åŸå¸‚)</label>
                <input type="text" v-model="tempTrip.city" placeholder="ä¾‹å¦‚: Tokyo" required>

                <div class="flex-row">
                    <label style="flex: 2;">ç›®çš„åœ° (åœ‹å®¶)</label>
                    <input type="text" v-model="tempTrip.destination" placeholder="ä¾‹å¦‚: Japan" style="flex: 3;">
                    <button type="button" class="btn-small btn-secondary" @click="autoGeocode" style="flex: 1 1 auto; white-space: nowrap;">è‡ªå‹•åµæ¸¬</button>
                </div>
                
                <div class="flex-row">
                    <div>
                        <label>é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" v-model="tempTrip.startDate" required>
                    </div>
                    <div>
                        <label>çµæŸæ—¥æœŸ</label>
                        <input type="date" v-model="tempTrip.endDate" required>
                    </div>
                </div>
                
                <label>ç•¶åœ°ä¸»è¦è²¨å¹£ä»£ç¢¼ (Currency Code)</label>
                <input type="text" v-model="tempTrip.currency" placeholder="ä¾‹å¦‚: JPY">

                <label>åŒ¯ç‡ (1 HKD = X å¤–å¹£)</label>
                <input type="number" v-model.number="tempTrip.exchangeRate" step="0.01" min="0.01">

                <button type="submit" class="btn-primary" style="margin-top: 15px;">ä¿å­˜</button>
            </form>
        </div>
    </div>


</div> <script>
    // æ•ç²ä¸¦é¡¯ç¤ºåˆå§‹åŒ–éŒ¯èª¤
    try {
        const { createApp } = Vue;
        // **æ³¨æ„: è«‹å°‡æ­¤æ›¿æ›ç‚ºæ‚¨å¯¦éš›çš„ AviationStack Key**
        const AVIATIONSTACK_KEY = '5bxxxxxxxxx'; 
        
        const GeocodingCache = {};
        
        // ğŸ”¥ ã€æ‚¨çš„ Firebase é…ç½® (å·²ç¢ºèªä¸¦è²¼å…¥)ã€‘
        // ç¢ºä¿é€™è£¡ä½¿ç”¨æ‚¨æä¾›çš„çœŸå¯¦å¯†é‘°ï¼
        const firebaseConfig = {
            apiKey: "AIzaSyCeFnypnf5WdO9mIsuwLwGZIsEv123QcuM",
            authDomain: "my-travel-diary-1dbc0.firebaseapp.com",
            projectId: "my-travel-diary-1dbc0",
            storageBucket: "my-travel-diary-1dbc0.firebasestorage.app",
            messagingSenderId: "592971246262",
            appId: "1:592971246262:web:f7d0c923b697a26e199417",
            measurementId: "G-F6X3YWL2MY" 
        };

        // ğŸ”¥ Firebase åˆå§‹åŒ– (V8 å…¨åŸŸæ¨¡å¼)
        // ç”±æ–¼æ‚¨ä½¿ç”¨çš„æ˜¯ V8 CDNï¼Œæˆ‘å€‘å¿…é ˆä½¿ç”¨ V8 çš„åˆå§‹åŒ–èªæ³•
        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const db = app.firestore();


        createApp({
            data() {
            return {
                activeTab: 'info',
                trips: [],
                activeTripId: null,
                showTripModal: false,
                editingTripId: null,
                tempTrip: {},
                map: null,
                weatherData: null,
                weatherTheme: 'sunny',
                showBatchImport: false,
                batchImportText: '',
                
                chartInstance: null,
                
                newExpense: { 
                id: null, 
                name: '', 
                localAmount: null, // ç¶å®šå­—ä¸²
                amount: null,      
                method: 'ç¾é‡‘', 
                category: 'é£²é£Ÿ', 
                day: 1, 
                },
                inputCurrency: '', 
                
                newShoppingItem: { 
                    name: '', 
                    onlinePrice: null, // é è¨ˆç‚º HKD
                    localPrice: null,  // é è¨ˆç‚ºç•¶åœ°å¹£åˆ¥é‡‘é¡
                    quantity: 1,       // æ•¸é‡æ¬„ä½
                    bought: false, 
                    image: '' 
                },
                
                activeDay: 1, // è¡Œç¨‹é é¢å°ˆç”¨

                // ğŸ”¥ Firebase/Auth ç›¸é—œç‹€æ…‹è®Šæ•¸
                currentUser: null,       
                loginEmail: '',          
                loginPassword: '',       
                showLoginModal: false, 

                // ğŸ”¥ æ–°å¢æš«å­˜åŒ¯ç‡è®Šæ•¸
                tempExchangeRate: null,

                tabs: [
                { id: 'info', label: 'Trip Info', icon: 'ri-information-line' },
                { id: 'itinerary-map', label: 'è¡Œç¨‹', icon: 'ri-map-pin-user-line' },
                { id: 'budget', label: 'è¨˜å¸³', icon: 'ri-wallet-3-line' },
                { id: 'shopping', label: 'è³¼ç‰©', icon: 'ri-shopping-bag-3-line' },
                { id: 'trips', label: 'History', icon: 'ri-suitcase-line' },
                ]
            };
            },
            computed: {
            activeTrip() { return this.trips.find(t => t.id === this.activeTripId) || null; },
            
            totalDays() {
                if (!this.activeTrip || !this.activeTrip.startDate || !this.activeTrip.endDate) return 1;
                const start = new Date(this.activeTrip.startDate);
                const end = new Date(this.activeTrip.endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
                return diffDays > 0 ? diffDays : 1;
            },

            groupedItinerary() {
                if (!this.activeTrip) return [];
                
                const days = Array.from({ length: this.totalDays }, (_, i) => ({ day: i + 1, items: [] }));
                
                this.activeTrip.itinerary
                    .sort((a, b) => (a.day || 1) - (b.day || 1)) 
                    .forEach(item => {
                        const dayIndex = (item.day || 1) - 1; 
                        if (dayIndex >= 0 && dayIndex < days.length) { 
                            days[dayIndex].items.push(item);
                        }
                    });
                    
                days.forEach(day => {
                    day.items.sort((a, b) => {
                        const timeA = a.time ? a.time.replace(':', '') : '9999';
                        const timeB = b.time ? b.time.replace(':', '') : '9999';
                        return timeA - timeB;
                    });
                });
                
                return days;
            },
            
            filteredExpenses() {
                if (!this.activeTrip || !this.activeTrip.expenses) {
                    return [];
                }
                return this.activeTrip.expenses; 
            },

            totalExpensesHKD() {
                if (!this.activeTrip) return 0;
                return this.filteredExpenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
            },

            weatherDesc() {
                if (!this.weatherData) return 'Loading...';
                const code = this.weatherData.weathercode;
                const map = { 0:'æ™´æœ— Sunny', 1:'å¤šé›² Cloudy', 2:'é™°å¤© Overcast', 3:'æ¯›æ¯›é›¨ Drizzle', 45:'éœ§ Fog', 48:'éœ§æ· Rime fog', 51:'æ¯›æ¯›é›¨ Drizzle', 53:'å°é›¨ Light Rain', 55:'å¤§é›¨ Heavy Rain', 61:'é™£é›¨ Rain', 63:'ä¸­é›¨ Moderate Rain', 65:'å¤§é›¨ Heavy Rain', 80:'é™£é›¨ Showers', 81:'ä¸­åº¦é™£é›¨ Moderate Showers', 82:'å¼·çƒˆé™£é›¨ Violent Showers', 95:'é›·æš´ Thunderstorm' };
                return map[code] || 'å¤šé›² Cloudy';
            },
            
            // ğŸ”¥ é—œéµä¿®æ­£é» 1: ç¢ºä¿ localAmount è¢«å¼·åˆ¶æ¸…ç†ï¼Œä¸¦åœ¨ HKD æ™‚ç›´æ¥ä½¿ç”¨
            finalHKDAmount() {
                // ã€å¼·åˆ¶æ¸…ç†å’Œè½‰æ›ã€‘ä½¿ç”¨ä¸€å€‹æ›´åš´æ ¼çš„æ–¹æ³•ä¾†ç¢ºä¿ newExpense.localAmount æ˜¯æœ‰æ•ˆçš„æ•¸å­—
                // ç§»é™¤æ‰€æœ‰éæ•¸å­—å’Œå°æ•¸é»çš„å­—ç¬¦
                const localAmountStr = String(this.newExpense.localAmount || '').replace(/[^0-9.]/g, '');
                const amount = Number(localAmountStr);
                
                if (!this.activeTrip || isNaN(amount) || amount <= 0) {
                    return 0;
                }
                
                // ç•¶é¸æ“‡ HKD æ™‚ï¼Œç›´æ¥è¿”å›é‡‘é¡ (å³ç‚º HKD)
                if (this.inputCurrency === 'HKD') {
                    return parseFloat(amount.toFixed(2));
                }
                
                // è™•ç†å¤–å¹£è½‰æ›é‚è¼¯
                const rate = this.activeTrip.exchangeRate;
                if (!rate || rate <= 0) {
                     // å¦‚æœæ˜¯å¤–å¹£ä½†åŒ¯ç‡ç„¡æ•ˆï¼Œè¿”å› 0
                     return 0;
                }
                
                // ç¢ºä¿è¿”å›çš„é‡‘é¡ä¿ç•™å…©ä½å°æ•¸
                return parseFloat((amount / rate).toFixed(2));
            },
            
            categorySummary() {
                if (!this.activeTrip || !this.filteredExpenses) {
                    return { labels: [], data: [] };
                }
                const summary = this.filteredExpenses.reduce((acc, expense) => {
                    const category = expense.category || 'å…¶ä»–';
                    const amount = Number(expense.amount) || 0;
                    acc[category] = (acc[category] || 0) + amount;
                    return acc;
                }, {});
                
                const labels = Object.keys(summary);
                const data = Object.values(summary).map(val => parseFloat(val.toFixed(2)));
                
                return { labels, data };
            },

            paymentSummary() {
                const summary = { 'ç¾é‡‘': 0, 'ä¿¡ç”¨å¡': 0, 'å…¶ä»–': 0 };
                if (!this.activeTrip) return summary;

                this.filteredExpenses.forEach(exp => {
                    const method = exp.method || 'ç¾é‡‘'; 
                    const amount = Number(exp.amount) || 0;
                    if (summary.hasOwnProperty(method)) {
                        summary[method] += amount;
                    } else {
                        summary['å…¶ä»–'] += amount; 
                    }
                });

                summary['ç¾é‡‘'] = parseFloat(summary['ç¾é‡‘'].toFixed(2));
                summary['ä¿¡ç”¨å¡'] = parseFloat(summary['ä¿¡ç”¨å¡'].toFixed(2));
                summary['å…¶ä»–'] = parseFloat(summary['å…¶ä»–'].toFixed(2));

                return summary;
            },
            
            activeBudgetDayText() {
                return 'æ‰€æœ‰'; 
            },

            groupedAndSortedExpenses() {
                if (!this.activeTrip || !this.activeTrip.expenses || this.activeTrip.expenses.length === 0) return [];

                const expenses = this.activeTrip.expenses.slice() 
                    .sort((a, b) => (a.day === undefined ? 1 : a.day) - (b.day === undefined ? 1 : b.day));

                const result = [];
                
                const daysGrouped = expenses.reduce((acc, exp) => {
                    const day = exp.day === undefined ? 1 : exp.day;
                    if (!acc[day]) {
                        acc[day] = [];
                    }
                    acc[day].push(exp);
                    return acc;
                }, {});

                const sortedDays = Object.keys(daysGrouped).map(Number).sort((a, b) => a - b);
                
                for (const day of sortedDays) {
                    const dayExpenses = daysGrouped[day];
                    
                    const total = dayExpenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
                    
                    result.push({
                        isHeader: true,
                        day: day,
                        dayLabel: day === 0 ? 'æ—…è¡Œå‰ (Day 0)' : `Day ${day}`,
                        total: parseFloat(total.toFixed(2)),
                        id: `header-${day}`
                    });

                    result.push(...dayExpenses);
                }

                return result;
            },

            shoppingListWithSavings() {
                if (!this.activeTrip || !this.activeTrip.shoppingItems) return [];
                const rate = this.activeTrip.exchangeRate || 1; // 1 HKD = X å¤–å¹£

                const processedList = this.activeTrip.shoppingItems.map(item => {
                    // ç¢ºä¿ quantity, localPrice, onlinePrice æ˜¯æœ‰æ•ˆæ•¸å­—
                    const quantity = Math.max(1, Number(item.quantity) || 1);
                    const localPrice = Number(item.localPrice) || 0;
                    const onlinePrice = Number(item.onlinePrice) || 0;
                    
                    // 1. è¨ˆç®—ç•¶åœ°åƒ¹æ›ç®—æˆ HKD çš„ç¸½é¡ (å–®åƒ¹ / åŒ¯ç‡ * æ•¸é‡)
                    // åªæœ‰ç•¶ localPrice å’Œ rate > 0 æ™‚æ‰è¨ˆç®—
                    const localPriceHKD = (localPrice > 0 && rate > 0) 
                        ? parseFloat(((localPrice / rate) * quantity).toFixed(2)) 
                        : 0;
                    
                    // 2. è¨ˆç®—ç¶²ä¸Šåƒ¹ HKD çš„ç¸½é¡
                    const onlinePriceHKD = onlinePrice * quantity;
                    
                    // 3. è¨ˆç®—ç¸½å…±ç¯€çœçš„é‡‘é¡ (ç¶²ä¸Šåƒ¹ - ç•¶åœ°åƒ¹æ›ç®— HKD)
                    // åªæœ‰åœ¨å…©ç¨®åƒ¹æ ¼éƒ½å­˜åœ¨æ™‚æ‰è¨ˆç®—åƒ¹å·®
                    const savingsHKD = (localPriceHKD > 0 && onlinePriceHKD > 0) 
                        ? parseFloat((onlinePriceHKD - localPriceHKD).toFixed(2))
                        : 0;

                    return {
                        ...item,
                        quantity: quantity,
                        localPriceHKD: localPriceHKD, // 0.00 or actual price
                        onlinePriceHKD: parseFloat(onlinePriceHKD.toFixed(2)),
                        savingsHKD: savingsHKD,
                    };
                });
                
                // æ’åºé‚è¼¯ï¼šæœªè²·çš„åœ¨å‰ï¼Œå…¶æ¬¡æŒ‰ç¯€çœé‡‘é¡é™åº
                return processedList.sort((a, b) => {
                    if (a.bought === b.bought) {
                        return b.savingsHKD - a.savingsHKD; // æœªè²·çš„å‰‡æŒ‰ç¯€çœé‡‘é¡é™åº
                    }
                    return a.bought ? 1 : -1; // false (0) < true (1)ï¼Œæ‰€ä»¥æœªè²·çš„åœ¨å‰
                });
            },

            totalSavings() {
                return this.shoppingListWithSavings.reduce((sum, item) => sum + item.savingsHKD, 0);
            }
            },
            watch: {
            activeTab(newTab) {
                if (newTab === 'itinerary-map') {
                setTimeout(() => this.forceUpdateMap(), 500);
                } else if (newTab === 'budget') { 
                // è¼‰å…¥ tempExchangeRate
                this.tempExchangeRate = this.activeTrip?.exchangeRate || 1; 
                // ä¿®æ­£ï¼šç•¶åˆ‡æ›åˆ° Budget Tab æ™‚ï¼Œç¢ºä¿ inputCurrency è¢«è¨­ç‚º Trip çš„é è¨­å¤–å¹£
                this.inputCurrency = this.activeTrip.currency; 
                this.$nextTick(() => this.updateChart());
                }
            },
            activeTripId() {
                this.fetchWeather();
                this.activeDay = 1; 
                if (this.activeTrip) {
                    this.inputCurrency = this.activeTrip.currency; 
                    this.newExpense.day = 1; 
                    // åˆå§‹åŒ– tempExchangeRate
                    this.tempExchangeRate = this.activeTrip.exchangeRate || 1;
                }
                this.updateChart(); 
            },
            activeDay() {
                this.forceUpdateMap();
            },
            
            categorySummary: {
                handler() {
                    this.updateChart();
                },
                deep: true
            }
            },
            mounted() {
            // ç›£è½ Firebase ç™»å…¥ç‹€æ…‹
            auth.onAuthStateChanged(user => {
                    if (user) {
                        this.currentUser = user;
                        this.showLoginModal = false;
                        // ç™»å…¥æˆåŠŸå¾Œï¼Œå¾ Firestore è¼‰å…¥æ•¸æ“š
                        this.loadData(); 
                    } else {
                        this.currentUser = null;
                        // æœªç™»å…¥æ™‚ï¼Œå˜—è©¦è¼‰å…¥æœ¬åœ°æ•¸æ“šä¸¦å…è¨±ç€è¦½
                        this.loadInitialOrLocalData(false); // åƒ…å¾æœ¬åœ°è¼‰å…¥ï¼Œä¸å˜—è©¦ä¸Šå‚³
                        this.showLoginModal = false; // é è¨­éš±è—æ¨¡æ…‹æ¡†
                    }
                });

            if (this.activeTrip) {
                this.inputCurrency = this.activeTrip.currency;
                this.newExpense.day = 1;
                this.newExpense.category = 'é£²é£Ÿ'; 
            }
            },
            methods: {
            selectDay(day) {
                this.activeDay = day;
            },
            
            // ğŸ”¥ saveData æª¢æŸ¥ç™»å…¥ç‹€æ…‹
            async saveData() { 
                // 1. å„²å­˜åˆ° LocalStorage (ä½œç‚ºå‚™ä»½)
                localStorage.setItem('christine_travel_diary_v4', JSON.stringify(this.trips));
                this.updateChart(); 
                
                if (!this.currentUser) {
                    return; // æœªç™»å…¥æ™‚ï¼Œåªå„²å­˜æœ¬åœ°
                }
                
                // 2. å„²å­˜åˆ°é›²ç«¯ Firestore (åªæœ‰ç™»å…¥å¾Œæ‰åŸ·è¡Œ)
                if (this.currentUser && this.activeTrip) {
                     try {
                         const userRef = db.collection('userTrips').doc(this.currentUser.uid);
                         await userRef.set({
                             trips: JSON.parse(JSON.stringify(this.trips)), // ç¢ºä¿æ•¸æ“šæ˜¯ç´”ç²¹çš„ JSON
                             activeTripId: this.activeTripId,
                             timestamp: firebase.firestore.FieldValue.serverTimestamp() // æ–°å¢æ™‚é–“æˆ³
                         });
                         // console.log("æ•¸æ“šæˆåŠŸå„²å­˜åˆ° Firestore!");
                     } catch (e) {
                         console.error("Firestore å„²å­˜å¤±æ•—: ", e);
                         alert("æ•¸æ“šå„²å­˜åˆ°é›²ç«¯å¤±æ•—ï¼Œå·²å„²å­˜è‡³ç€è¦½å™¨æœ¬åœ°ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ– Firestore è¦å‰‡ï¼");
                     }
                }
            },
            
            // ğŸ”¥ loadData: å„ªå…ˆå¾ Firestore è¼‰å…¥
            async loadData() {
                if (!this.currentUser) {
                    this.loadInitialOrLocalData(false);
                    return;
                }

                try {
                    const docSnap = await db.collection('userTrips').doc(this.currentUser.uid).get();
                    
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        
                        if (data.trips && data.trips.length > 0) {
                            this.trips = this.sanitizeLoadedTrips(data.trips);
                            this.activeTripId = data.activeTripId || (this.trips.length > 0 ? this.trips[0].id : null);
                            localStorage.setItem('christine_travel_diary_v4', JSON.stringify(this.trips));
                        } else {
                            console.log("Firestore æ•¸æ“šç‚ºç©ºï¼Œå˜—è©¦è¼‰å…¥æœ¬åœ°æˆ–é è¨­æ•¸æ“šã€‚");
                            this.loadInitialOrLocalData(true);
                        }
                    } else {
                        console.log("Firestore æ‰¾ä¸åˆ°æ–‡ä»¶ï¼Œè¼‰å…¥æœ¬åœ°æˆ–é è¨­æ•¸æ“šã€‚");
                        this.loadInitialOrLocalData(true);
                    }
                } catch (e) {
                    console.error("Firestore è®€å–å¤±æ•—: ", e);
                    alert("æ•¸æ“šè®€å–å¤±æ•—ï¼Œå·²å˜—è©¦è¼‰å…¥æœ¬åœ°æ•¸æ“šã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ– Firestore è¦å‰‡ï¼");
                    this.loadInitialOrLocalData(false);
                }
                
                if (this.activeTripId) {
                this.fetchWeather();
                this.newExpense.day = 1;
                this.inputCurrency = this.activeTrip.currency; 
                // åˆå§‹åŒ– tempExchangeRate
                this.tempExchangeRate = this.activeTrip.exchangeRate || 1;
                }
            },
            
            // ğŸ”¥ loadInitialOrLocalData: è™•ç†é¦–æ¬¡ç™»å…¥æ™‚çš„æ•¸æ“š
            loadInitialOrLocalData(shouldUpload = false) {
                const savedLocal = localStorage.getItem('christine_travel_diary_v4');
                let parsedTrips = [];

                if (savedLocal) {
                    parsedTrips = this.sanitizeLoadedTrips(JSON.parse(savedLocal));
                    this.trips = parsedTrips;
                } else {
                    // è¼‰å…¥é è¨­æ•¸æ“š
                    const defaultItinerary = [{ id: Date.now(), day: 1, time: '10:00', activity: 'åˆ°é”æ©Ÿå ´', location: 'Narita Airport', mapLink: '' }];
                    this.trips = [{
                        id: Date.now(), title: 'Japan Trip', destination: 'Japan', city: 'Tokyo', currency: 'JPY',
                        startDate: '2025-12-24', endDate: '2025-12-28',
                        center: { lat: 35.6895, lng: 139.6917 }, exchangeRate: 19.2,
                        flights: { outbound: { no: 'CX500', date: '2025-12-24' }, inbound: { no: 'CX501', date: '2025-12-28' } },
                        itinerary: defaultItinerary, 
                        expenses: [{ id: Date.now()+1, name: 'æ©Ÿç¥¨', amount: 3500, method: 'ä¿¡ç”¨å¡', category: 'æ—…è¡Œå‰', date: '12/10', day: 0, localAmount: 67200 }], 
                        shoppingItems: [
                            { id: Date.now()+2, name: 'é˜²æ›¬éœœ', onlinePrice: 200, localPrice: 3000, quantity: 2, bought: false, image: '' },
                            { id: Date.now()+3, name: 'æ‰‹ä¿¡é¤…ä¹¾', onlinePrice: 150, localPrice: 2500, quantity: 3, bought: true, image: '' },
                        ]
                    }];
                }
                
                this.activeTripId = this.trips.length > 0 ? this.trips[0].id : null;
                
                if (shouldUpload && this.currentUser) {
                    // å¦‚æœæ˜¯é¦–æ¬¡ç™»å…¥ï¼Œå°‡æœ¬åœ°æˆ–é è¨­æ•¸æ“šä¸Šå‚³åˆ°é›²ç«¯
                    this.saveData(); 
                }

                // åˆå§‹åŒ– tempExchangeRate
                if (this.activeTrip) {
                    this.tempExchangeRate = this.activeTrip.exchangeRate || 1;
                }
            },
            
            // ğŸ”¥ æ¸…ç†è¼‰å…¥æ•¸æ“šï¼Œç¢ºä¿æ‰€æœ‰æ¬„ä½å’Œ ID å®Œæ•´
            sanitizeLoadedTrips(rawTrips) {
                return rawTrips.map(trip => {
                    if (trip.expenses) {
                        trip.expenses = trip.expenses.map(exp => ({ 
                            id: exp.id || Date.now() + Math.random(), 
                            amount: exp.amount || 0,
                            day: exp.day === undefined ? 1 : exp.day, 
                            ...exp 
                        }));
                    } else {
                        trip.expenses = [];
                    }
                    if (trip.itinerary) {
                        trip.itinerary = trip.itinerary.map(item => ({ 
                            id: item.id || Date.now() + Math.random(), 
                            day: item.day || 1, 
                            mapLink: item.mapLink || '', 
                            ...item 
                        }));
                    } else {
                        trip.itinerary = [];
                    }
                    if (trip.shoppingItems) {
                        trip.shoppingItems = trip.shoppingItems.map(item => ({
                            id: item.id || Date.now() + Math.random(),
                            quantity: item.quantity || 1, 
                            localPrice: item.localPrice || null, 
                            onlinePrice: item.onlinePrice || null, 
                            bought: item.bought || false, 
                            ...item
                        }));
                    } else {
                        trip.shoppingItems = [];
                    }
                    return trip;
                });
            },

            calculateTripTotal(trip) {
                if (!trip.expenses) return 0;
                return trip.expenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
            },
            
            calculateDayTotal(dayIndex) {
                if (!this.activeTrip || !this.activeTrip.expenses) return 0;
                const total = this.activeTrip.expenses
                            .filter(exp => (exp.day === undefined ? 1 : exp.day) === dayIndex) 
                            .reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
                return parseFloat(total.toFixed(2));
            },
            
            // ğŸ”¥ ç™»å…¥/è¨»å†Š/ç™»å‡ºæ–¹æ³•

            async loginUser() {
                if (!this.loginEmail || !this.loginPassword) return alert('è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼');
                try {
                    // **æ³¨æ„: é€™è£¡å¿…é ˆä½¿ç”¨ V8 èªæ³•**
                    await auth.signInWithEmailAndPassword(this.loginEmail, this.loginPassword); 
                    this.showLoginModal = false;
                } catch (error) {
                    // å¦‚æœç”¨æˆ¶ä¸å­˜åœ¨ï¼Œå˜—è©¦è¨»å†Š
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                         try {
                             await auth.createUserWithEmailAndPassword(this.loginEmail, this.loginPassword);
                             alert('å¸³è™Ÿå·²å‰µå»ºä¸¦æˆåŠŸç™»å…¥ï¼');
                             this.showLoginModal = false;
                         } catch (registerError) {
                             alert('ç™»å…¥/è¨»å†Šå¤±æ•—: ' + registerError.message);
                             console.error(registerError);
                         }
                    } else {
                         alert('ç™»å…¥å¤±æ•—: ' + error.message);
                         console.error(error);
                    }
                }
            },

            async logoutUser() {
                if(confirm('ç¢ºèªç™»å‡ºå—ï¼Ÿç™»å‡ºå¾Œå°‡ç„¡æ³•åŒæ­¥æ•¸æ“šã€‚')) {
                    try {
                        // **æ³¨æ„: é€™è£¡å¿…é ˆä½¿ç”¨ V8 èªæ³•**
                        await auth.signOut();
                        alert('æ‚¨å·²ç™»å‡ºã€‚');
                        this.trips = [];
                        this.activeTripId = null;
                        this.showLoginModal = false; // ç™»å‡ºå¾Œé è¨­éš±è—
                        this.loadInitialOrLocalData(false); // é‡æ–°è¼‰å…¥æœ¬åœ°æ•¸æ“š
                    } catch (error) {
                        alert('ç™»å‡ºå¤±æ•—: ' + error.message);
                    }
                }
            },
            
            // === API åŠŸèƒ½ (åŒ¯ç‡ä¿®æ­£) ===

            // ğŸ”¥ æ–°å¢å°ˆé–€ç”¨æ–¼è¨˜å¸³é é¢æŠ“å–åŒ¯ç‡çš„æ–¹æ³•
            async fetchExchangeRate() {
                if (!this.activeTrip || !this.activeTrip.currency || this.activeTrip.currency === 'HKD') {
                    return alert('è«‹å…ˆè¨­å®šç›®æ¨™åœ‹å®¶è²¨å¹£ (Currency)ï¼');
                }
                
                const currencyCode = this.activeTrip.currency;

                try {
                    const rateRes = await fetch(`https://open.er-api.com/v6/latest/HKD`);
                    const rateData = await rateRes.json();
                    
                    if (rateData?.rates && rateData.rates[currencyCode]) {
                        const newRate = parseFloat(rateData.rates[currencyCode].toFixed(3));
                        
                        // ç›´æ¥æ›´æ–° activeTrip çš„åŒ¯ç‡
                        this.activeTrip.exchangeRate = newRate;
                        
                        // åŒæ­¥æ›´æ–°æš«å­˜è®Šæ•¸
                        this.tempExchangeRate = newRate; 

                        this.saveData(); 
                        alert(`æˆåŠŸï¼1 HKD â‰ˆ ${newRate} ${currencyCode}`);
                    } else {
                        alert(`ç„¡æ³•å–å¾— ${currencyCode} çš„å³æ™‚åŒ¯ç‡ï¼Œè«‹æ‰‹å‹•è¼¸å…¥ã€‚`);
                    }
                } catch (e) { 
                console.error("Rate fetch fail", e); 
                alert('å³æ™‚åŒ¯ç‡æœå‹™å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æˆ–ç¨å¾Œå†è©¦ã€‚');
                }
            },
            
            // ğŸ”¥ åŒ¯ç‡è¼¸å…¥æ¡†çš„ blur/Enter è™•ç†æ–¹æ³•
            updateExchangeRate() {
                const rate = Number(this.tempExchangeRate);
                if (isNaN(rate) || rate <= 0) {
                    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­— (å¤§æ–¼ 0)');
                    this.tempExchangeRate = this.activeTrip.exchangeRate || 1; // æ¢å¾©èˆŠå€¼
                    return;
                }
                // æ›´æ–° activeTrip çš„å¯¦éš›å€¼
                this.activeTrip.exchangeRate = parseFloat(rate.toFixed(3));
                this.saveData();
            },

            async autoGeocode() {
                if (!this.tempTrip.city) return alert('è«‹å…ˆè¼¸å…¥åŸå¸‚åç¨± (City)');
                
                try {
                const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${this.tempTrip.city},${this.tempTrip.destination || ''}&addressdetails=1&limit=1`);
                const geoData = await geoRes.json();
                if (!geoData || geoData.length === 0) {
                    return alert('æ‰¾ä¸åˆ°è©²åŸå¸‚ï¼Œè«‹æª¢æŸ¥æ‹¼å­—ã€‚');
                }
                const location = geoData[0];
                this.tempTrip.center = { lat: parseFloat(location.lat), lng: parseFloat(location.lon) };
                if(location.address && location.address.country) {
                    this.tempTrip.destination = location.address.country;
                }
                let currencyCode = 'USD';
                const countryCode = location.address?.country_code?.toUpperCase(); 
                if (countryCode) {
                    try {
                    const countryRes = await fetch(`https://restcountries.com/v3.1/alpha/${countryCode}`);
                    const countryData = await countryRes.json();
                    if (countryData[0]?.currencies) {
                        currencyCode = Object.keys(countryData[0].currencies)[0];
                        this.tempTrip.currency = currencyCode;
                    }
                    } catch (err) { console.error("Currency fetch fail", err); }
                }
                
                try {
                    // åŒ¯ç‡æŠ“å–é‚è¼¯èˆ‡ fetchExchangeRate ç›¸åŒ
                    const rateRes = await fetch(`https://open.er-api.com/v6/latest/HKD`);
                    const rateData = await rateRes.json();
                    if (rateData?.rates && rateData.rates[currencyCode]) {
                        this.tempTrip.exchangeRate = parseFloat(rateData.rates[currencyCode].toFixed(3));
                    } else {
                        this.tempTrip.exchangeRate = 1; 
                    }
                } catch (err) { 
                    console.error("Rate fetch fail", err); 
                    this.tempTrip.exchangeRate = 1;
                }
                
                alert(`æˆåŠŸï¼\nåº§æ¨™: ${location.lat}, ${location.lon}\nåœ‹å®¶: ${this.tempTrip.destination}\nè²¨å¹£: ${currencyCode}\nåŒ¯ç‡: 1 HKD â‰ˆ ${this.tempTrip.exchangeRate.toFixed(2)} ${currencyCode}`);
                } catch (e) {
                console.error(e);
                alert('è‡ªå‹•å–å¾—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }
            },
            async fetchFlight(type) {
                if (!this.currentUser) {
                    alert("è«‹å…ˆç™»å…¥ä»¥åŒæ­¥èˆªç­è³‡æ–™ã€‚");
                    this.showLoginModal = true;
                    return;
                }

                const flight = this.activeTrip.flights[type];
                if(!flight.no || !flight.date) return alert('è«‹å…ˆè¼¸å…¥èˆªç­è™Ÿ (å¦‚ NH924) èˆ‡æ—¥æœŸ');
                if(AVIATIONSTACK_KEY === '5bxxxxxxxxx') return alert('è«‹å°‡ AVIATIONSTACK_KEY æ›¿æ›ç‚ºæ‚¨çš„æœ‰æ•ˆ Keyï¼Œç›®å‰ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šï¼');
                
                try {
                const res = await fetch(`https://api.aviationstack.com/v1/flights?access_key=${AVIATIONSTACK_KEY}&flight_iata=${flight.no}&flight_date=${flight.date}`);
                const data = await res.json();
                if (data.data && data.data.length > 0) {
                    const f = data.data[0]; 
                    flight.from = f.departure.iata;
                    flight.to = f.arrival.iata;
                    flight.depTime = f.departure.scheduled ? f.departure.scheduled.slice(11,16) : '--:--';
                    flight.arrTime = f.arrival.scheduled ? f.arrival.scheduled.slice(11,16) : '--:--';
                    this.saveData();
                    alert(`å·²æ›´æ–°èˆªç­: ${flight.from} -> ${flight.to}`);
                } else {
                    alert('æœªæ‰¾åˆ°èˆªç­è³‡æ–™ï¼Œè«‹ç¢ºèª API Keyã€èˆªç­è™Ÿèˆ‡æ—¥æœŸã€‚');
                    this.mockFlightData(type);
                }
                } catch(e) {
                console.error(e);
                alert('API è«‹æ±‚å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key æ˜¯å¦æ­£ç¢ºæˆ–ç¶²è·¯é€£ç·šã€‚ä½¿ç”¨æ¨¡æ“¬æ•¸æ“šã€‚');
                this.mockFlightData(type);
                }
            },
            mockFlightData(type) {
                const flight = this.activeTrip.flights[type];
                const isOutbound = type === 'outbound';
                flight.from = isOutbound ? 'HKG' : 'NRT';
                flight.to = isOutbound ? 'NRT' : 'HKG';
                flight.depTime = isOutbound ? '09:00' : '14:30';
                flight.arrTime = isOutbound ? '14:30' : '20:30';
                this.saveData();
            },
            async fetchWeather() {
                if(!this.activeTrip?.center) return;
                try {
                const {lat,lng} = this.activeTrip.center;
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&timezone=auto`);
                const d = await res.json();
                this.weatherData = d.current_weather;
                
                const code = d.current_weather.weathercode;
                if (code < 3) { this.weatherTheme = 'sunny'; } 
                else if (code >= 51 && code < 80) { this.weatherTheme = 'rainy'; } 
                else { this.weatherTheme = 'cloudy'; } 
                
                } catch(e){
                console.error("Weather fetch failed", e);
                this.weatherData = { temperature: 20 + Math.floor(Math.random()*5), weathercode: 1 };
                this.weatherTheme = 'sunny';
                }
            },

            // === è¨˜å¸³åŠŸèƒ½ (é‡‘é¡è¼¸å…¥è™•ç†) ===
            
            // ã€å„ªåŒ–é»ã€‘ç¢ºä¿è¼¸å…¥æ¡†åªä¿ç•™æ•¸å­—å’Œå°æ•¸é»
            cleanAmountInput(event) {
                let cleaned = event.target.value.replace(/[^0-9.]/g, '');
                
                // åªä¿ç•™ç¬¬ä¸€å€‹å°æ•¸é»
                let parts = cleaned.split('.');
                if (parts.length > 2) {
                    cleaned = parts[0] + '.' + parts.slice(1).join('');
                }
                
                this.newExpense.localAmount = cleaned;
            },
            
            // ğŸ”¥ é—œéµä¿®æ­£é» 2: å¼·åŒ– addExpense çš„é©—è­‰é‚è¼¯
            addExpense() {
                if (!this.currentUser) {
                    alert("è«‹å…ˆç™»å…¥ä»¥åŒæ­¥æ‚¨çš„è¨˜å¸³è¨˜éŒ„ã€‚");
                    this.showLoginModal = true;
                    return;
                }

                // æ­¥é©Ÿ 1: å¼·åˆ¶æ¸…ç†ä¸¦è½‰æ› localAmount
                const localAmountStr = String(this.newExpense.localAmount || '').replace(/[^0-9.]/g, '');
                const localAmount = Number(localAmountStr);
                
                // æ­¥é©Ÿ 2: å–å¾—æœ€çµ‚æ¸¯å¹£é‡‘é¡ (è¨ˆç®—å±¬æ€§ finalHKDAmount å·²åŒ…å«æ¸…ç†é‚è¼¯)
                const finalHKD = this.finalHKDAmount;
                
                // æ­¥é©Ÿ 3: åŸ·è¡Œé©—è­‰
                let isValid = true;
                if (!this.newExpense.name || isNaN(localAmount) || localAmount <= 0) {
                    isValid = false; // é …ç›®åç¨±æˆ–ç•¶åœ°é‡‘é¡ç„¡æ•ˆ
                }
                
                // å¦‚æœä¸æ˜¯ HKDï¼Œå‰‡å¿…é ˆç¢ºä¿æ›ç®—å¾Œçš„ HKD é‡‘é¡å¤§æ–¼ 0
                if (this.inputCurrency !== 'HKD' && (isNaN(finalHKD) || finalHKD <= 0)) {
                    isValid = false; // å¤–å¹£è½‰æ›å¤±æ•—æˆ–çµæœç‚º 0
                }
                
                if (!isValid) {
                    // å¦‚æœé©—è­‰å¤±æ•—ï¼Œè¼¸å‡ºè©³ç´°éŒ¯èª¤è¨Šæ¯åˆ° Console ä¾›é™¤éŒ¯ç”¨
                    console.error("Validation Failed:", {
                        name: this.newExpense.name,
                        localAmount: localAmount,
                        finalHKD: finalHKD,
                        inputCurrency: this.inputCurrency,
                        isHKD: this.inputCurrency === 'HKD'
                    });
                    return alert('è«‹è¼¸å…¥æ¶ˆè²»é …ç›®å’Œæœ‰æ•ˆçš„é‡‘é¡ (è«‹ç¢ºä¿é‡‘é¡æ˜¯æ•¸å­—ä¸”å¤§æ–¼é›¶)');
                }
                
                // ã€æ–°å¢æª¢æŸ¥ã€‘ç¢ºä¿è²¨å¹£é¸æ“‡æ­£ç¢º
                if (!this.inputCurrency) {
                    return alert('è«‹é¸æ“‡æœ‰æ•ˆçš„å¹£åˆ¥ (HKD æˆ–å¤–å¹£)ã€‚');
                }

                // æ­¥é©Ÿ 4: è™•ç†æ—…è¡Œå‰ Day 0 é‚è¼¯
                if (this.newExpense.category === 'æ—…è¡Œå‰') {
                    this.newExpense.day = 0; 
                } else if (!this.newExpense.day || this.newExpense.day === 0) {
                    if (this.newExpense.category !== 'æ—…è¡Œå‰') {
                        this.newExpense.day = 1;
                    }
                }

                const d = new Date();
                
                // æ­¥é©Ÿ 5: æ–°å¢ expense
                this.newExpense.amount = finalHKD; 

                this.activeTrip.expenses.unshift({ 
                    id: Date.now() + Math.random(), 
                    name: this.newExpense.name,
                    amount: this.newExpense.amount,
                    method: this.newExpense.method,
                    category: this.newExpense.category,
                    localAmount: localAmount, 
                    date: `${d.getMonth()+1}/${d.getDate()}`,
                    day: this.newExpense.day, 
                });
                
                // æ­¥é©Ÿ 6: é‡ç½®
                this.newExpense = { 
                    name:'', 
                    localAmount:null, 
                    amount:null, 
                    method:'ç¾é‡‘', 
                    category:'é£²é£Ÿ', 
                    day: 1
                };
                // é‡ç½® inputCurrency ç‚º Trip é è¨­å¤–å¹£
                this.inputCurrency = this.activeTrip.currency; 
                this.saveData();
            },
            removeExpense(expenseId) {
                if (!this.currentUser) {
                    alert("è«‹å…ˆç™»å…¥ä»¥åŒæ­¥æ‚¨çš„è¨˜å¸³è¨˜éŒ„ã€‚");
                    this.showLoginModal = true;
                    return;
                }
                if(confirm('ç¢ºèªåˆªé™¤é€™ç­†æ¶ˆè²»å—ï¼Ÿ')) {
                    const index = this.activeTrip.expenses.findIndex(exp => exp.id === expenseId);
                    if (index !== -1) {
                        this.activeTrip.expenses.splice(index, 1);
                        this.saveData();
                    }
                }
            },

            exportExpensesToCSV() {
                if (!this.activeTrip || !this.activeTrip.expenses.length) {
                    return alert('ç›®å‰æ²’æœ‰æ¶ˆè²»è¨˜éŒ„å¯ä»¥åŒ¯å‡ºï¼');
                }
                
                const trip = this.activeTrip;
                
                const expensesToExport = this.activeTrip.expenses
                    .slice() 
                    .sort((a, b) => (a.day === undefined ? 1 : a.day) - (b.day === undefined ? 1 : b.day)); 

                if (expensesToExport.length === 0) {
                    return alert(`æš«ç„¡æ¶ˆè²»è¨˜éŒ„å¯ä»¥åŒ¯å‡ºï¼`);
                }

                const headers = [
                    "Day", "æ—¥æœŸ", "é …ç›®", "é¡åˆ¥", "æ”¯ä»˜æ–¹å¼", 
                    `ç•¶åœ°é‡‘é¡ (${trip.currency})`, "åŒ¯ç‡ (1 HKD = X)", 
                    "æ¸¯å¹£é‡‘é¡ (HKD)"
                ];
                
                const rows = expensesToExport.map(exp => [
                    exp.day === 0 ? 'æ—…è¡Œå‰' : exp.day || 1, 
                    exp.date || '',
                    exp.name || '',
                    exp.category || '',
                    exp.method || '',
                    (exp.localAmount || 0).toFixed(2),
                    (trip.exchangeRate || 1).toFixed(2),
                    (exp.amount || 0).toFixed(2) 
                ]);
                
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');
                
                const encodedUri = encodeURI("data:text/csv;charset=utf-8,\uFEFF" + csvContent);
                const link = document.createElement("a");
                
                const fileName = `${trip.title}_All_Expenses_${new Date().toISOString().split('T')[0]}.csv`;
                
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`ã€Œ${fileName}ã€åŒ¯å‡ºæˆåŠŸï¼`);
            },

            updateChart() {
                if (this.activeTab !== 'budget') return;
                
                const summary = this.categorySummary;
                const ctx = document.getElementById('expenseChart');
                
                if (!ctx) return;

                const categoryColors = {
                    'é£²é£Ÿ': '#FFD9EC', 
                    'è³¼ç‰©': '#C7C7E2', 
                    'äº¤é€š': '#97CBFF',
                    'å¨›æ¨‚': '#A4D8B9', 
                    'å…¶ä»–': '#F5E6CC',
                    'æ—…è¡Œå‰': '#8A2BE2', 
                };
                
                const backgroundColors = summary.labels.map(label => 
                    categoryColors[label] || '#97CBFF'
                );


                const chartData = {
                    labels: summary.labels,
                    datasets: [{
                        data: summary.data,
                        backgroundColor: backgroundColors,
                        hoverOffset: 10,
                        borderWidth: 0,
                    }]
                };

                if (this.chartInstance) {
                    this.chartInstance.data = chartData;
                    this.chartInstance.update();
                } else {
                    this.chartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        usePointStyle: true,
                                        boxWidth: 8,
                                        padding: 15,
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => {
                                            let label = context.label || '';
                                            if (label) { label += ': '; }
                                            if (context.parsed !== null) {
                                                const total = summary.data.reduce((a, b) => a + b, 0);
                                                const percentage = (context.parsed * 100 / total).toFixed(1);
                                                label += `${context.parsed.toFixed(2)} HKD (${percentage}%)`;
                                            }
                                            return label;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            },
            
            // === è³¼ç‰©åŠŸèƒ½ (åŠ å…¥ç™»å…¥æª¢æŸ¥) ===
            handleImageUpload(e) {
                if (!this.currentUser) {
                    alert("è«‹å…ˆç™»å…¥ä»¥åŒæ­¥æ‚¨çš„åœ–ç‰‡è³‡æ–™ã€‚");
                    this.showLoginModal = true;
                    return;
                }
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 1024 * 1024) return alert('åœ–ç‰‡è«‹å°æ–¼ 1MB');
                const reader = new FileReader();
                reader.onload = (evt) => { this.newShoppingItem.image = evt.target.result; };
                reader.readAsDataURL(file);
            },
            addShoppingItem() {
                if (!this.currentUser) {
                    alert("è«‹å…ˆç™»å…¥ä»¥åŒæ­¥æ‚¨çš„è³¼ç‰©æ¸…å–®ã€‚");
                    this.showLoginModal = true;
                    return;
                }

                if(!this.newShoppingItem.name) return alert('è«‹è¼¸å…¥å“å');
                
                // å…è¨±åƒ¹æ ¼ç‚ºç©º
                const onlinePrice = Number(this.newShoppingItem.onlinePrice);
                const localPrice = Number(this.newShoppingItem.localPrice);

                this.activeTrip.shoppingItems.unshift({ 
                    id: Date.now() + Math.random(), 
                    onlinePrice: isNaN(onlinePrice) ? null : onlinePrice,
                    localPrice: isNaN(localPrice) ? null : localPrice,
                    quantity: Math.max(1, Number(this.newShoppingItem.quantity) || 1),
                    bought: this.newShoppingItem.bought, 
                    name: this.newShoppingItem.name,
                    image: this.newShoppingItem.image
                }); 
                
                // é‡ç½®æ¬„ä½
                this.newShoppingItem = { name: '', onlinePrice: null, localPrice: null, quantity: 1, bought: false, image: '' };
                this.saveData();
            },
            
            // **é—œéµä¿®å¾© V4: æ¡ç”¨ Vue éŸ¿æ‡‰å¼æœ€ä½³å¯¦è¸ (splice æ›¿æ›æ–°ç‰©ä»¶) ä»¥ç¢ºä¿ç•«é¢æ›´æ–°**
            toggleBought(item) {
                if (!this.currentUser) {
                    alert("è«‹å…ˆç™»å…¥ä»¥åŒæ­¥æ‚¨çš„è³¼ç‰©æ¸…å–®ã€‚");
                    this.showLoginModal = true;
                    return;
                }
                if (!item || !this.activeTrip) return;

                // 1. æ‰¾åˆ°è©² item åœ¨ shoppingItems é™£åˆ—ä¸­çš„ç¢ºåˆ‡ç´¢å¼•
                const index = this.activeTrip.shoppingItems.findIndex(i => i.id === item.id);
                
                if (index !== -1) {
                    // 2. æ›´æ”¹ bought ç‹€æ…‹
                    const newBoughtState = !item.bought;

                    // 3. å‰µå»ºä¸€å€‹æ–°çš„ç‰©ä»¶ä¾†æ›¿æ›èˆŠçš„ï¼Œç¢ºä¿ Vue åµæ¸¬åˆ°è®ŠåŒ–
                    const newItem = { ...item, bought: newBoughtState };
                    
                    // 4. ä½¿ç”¨ splice æ›¿æ›èˆŠç‰©ä»¶
                    this.activeTrip.shoppingItems.splice(index, 1, newItem);
                    
                    this.saveData(); 
                    
                    // 5. ç¢ºä¿ç¸½è¦½é é¢ç­‰ä¾è³´ä¹Ÿè¢«è§¸ç™¼ (éå¿…è¦ï¼Œä½†èƒ½æé«˜ç©©å®šæ€§)
                    this.trips = [...this.trips]; 
                }
            },
            removeShoppingItem(itemId) {
                if (!this.currentUser) {
                    alert("è«‹å…ˆç™»å…¥ä»¥åŒæ­¥æ‚¨çš„è³¼ç‰©æ¸…å–®ã€‚");
                    this.showLoginModal = true;
                    return;
                }
                if(confirm('ç¢ºèªåˆªé™¤æ­¤è³¼ç‰©é …ç›®å—ï¼Ÿ')) {
                    const index = this.activeTrip.shoppingItems.findIndex(item => item.id === itemId);
                    if (index !== -1) {
                        this.activeTrip.shoppingItems.splice(index, 1);
                        this.saveData();
                    }
                }
            },

            // === åœ°åœ–/è¡Œç¨‹åŠŸèƒ½ (åŠ å…¥ç™»å…¥æª¢æŸ¥) ===
            openGoogleMaps(item) { 
                if (item.mapLink && item.mapLink.trim()) {
                    const url = item.mapLink.trim();
                    if (url.startsWith('http')) {
                        window.open(url, '_blank');
                    } else {
                        this.searchGoogleMaps(url);
                    }
                } 
                else if (item.location && item.location.trim()) {
                    this.searchGoogleMaps(item.location);
                } else {
                    alert('è«‹è¼¸å…¥åœ°é»åç¨±æˆ–è²¼ä¸Š Google Map é€£çµã€‚');
                }
            },
            
            searchGoogleMaps(query) {
                const finalQuery = encodeURIComponent(query + ', ' + this.activeTrip.city);
                window.open(`https://www.google.com/maps/search/?api=1&query=${finalQuery}`, '_blank'); 
            },

            mapMarkers: L.layerGroup(),
            mapPolyline: null, 
            
            forceUpdateMap() {
                if (this.activeTab !== 'itinerary-map') return;
                try {
                const container = document.getElementById('map');
                // æª¢æŸ¥çˆ¶ç´šå…ƒç´ æ˜¯å¦å¯è¦‹ï¼Œé¿å…åœ¨éç•¶å‰ Tab æ¸²æŸ“æ™‚å¤±æ•—
                if (!container || container.offsetParent === null) {
                    console.log("Map container not visible, skipping init.");
                    return; 
                }
                if (this.map) { this.map.off(); this.map.remove(); }
                
                const center = this.activeTrip.center ? [this.activeTrip.center.lat, this.activeTrip.center.lng] : [35.6895, 139.6917];
                
                this.map = L.map('map', { zoomControl: false }).setView(center, 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(this.map);
                this.mapMarkers.clearLayers();
                this.mapMarkers.addTo(this.map);
                this.mapPolyline = L.polyline([], {color: '#97CBFF', weight: 4, opacity: 0.8, dashArray: '5, 10'}).addTo(this.map);
                
                this.updateMapMarkers(); 
                setTimeout(() => { this.map.invalidateSize(); }, 100);
                } catch (e) { console.error("Map init fail", e); }
            },
            
            async geocodeLocation(location) {
                if (GeocodingCache[location]) return GeocodingCache[location];
                
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`);
                    const data = await res.json();
                    if (data && data.length > 0) {
                        const coords = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                        GeocodingCache[location] = coords;
                        return coords;
                    }
                } catch (e) {
                    console.warn(`Geocoding failed for: ${location}. Error: ${e}. Route may not be drawn.`);
                }
                
                if (this.activeTrip.center) {
                    // éš¨æ©Ÿåç§»ï¼Œæ¨¡æ“¬åœ°åœ–ä¸­å¿ƒé™„è¿‘
                    return {
                        lat: this.activeTrip.center.lat + (Math.random() - 0.5) * 0.005,
                        lng: this.activeTrip.center.lng + (Math.random() - 0.5) * 0.005,
                    };
                }
                return null; 
            },

            async updateMapMarkers() {
                if (!this.map || !this.activeTrip?.itinerary) return;
                this.mapMarkers.clearLayers();
                
                const currentDayItems = this.activeTrip.itinerary
                    .filter(item => (item.day || 1) === this.activeDay && item.location) 
                    .sort((a, b) => {
                        const timeA = a.time ? a.time.replace(':', '') : '9999';
                        const timeB = b.time ? b.time.replace(':', '') : '9999';
                        return timeA - timeB;
                    });
                
                let lineCoords = [];
                let markers = [];
                
                for (let index = 0; index < currentDayItems.length; index++) {
                    const item = currentDayItems[index];
                    const fullLocation = item.location + ', ' + this.activeTrip.city + ', ' + this.activeTrip.destination; 
                    const coords = await this.geocodeLocation(fullLocation);

                    if (coords) {
                        lineCoords.push([coords.lat, coords.lng]); 

                        const marker = L.marker([coords.lat, coords.lng], {
                            icon: L.divIcon({
                                className: 'custom-div-icon',
                                html: `<div style="background-color:#97CBFF; color:white; border-radius:50%; width:24px; height:24px; line-height:24px; text-align:center; font-weight:bold;">${index + 1}</div>`,
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            })
                        }).bindPopup(`<b>Day ${item.day || 1} - ${item.location}</b><br>${item.activity}`);
                        markers.push(marker);
                    }
                }

                markers.forEach(marker => this.mapMarkers.addLayer(marker));
                
                if (this.mapPolyline) {
                    this.mapPolyline.setLatLngs(lineCoords);
                }
                
                if (this.mapMarkers.getLayers().length > 0) {
                    this.map.fitBounds(this.mapMarkers.getBounds(), { padding: [50, 50] });
                } else if (this.activeTrip.center) {
                    this.map.setView([this.activeTrip.center.lat, this.activeTrip.center.lng], 13);
                }
            },
            
            addItineraryItem(day) { 
                if (!this.currentUser) {
                    alert("è«‹å…ˆç™»å…¥ä»¥åŒæ­¥æ‚¨çš„è¡Œç¨‹ã€‚");
                    this.showLoginModal = true;
                    return;
                }
                this.activeTrip.itinerary.push({ 
                    id: Date.now() + Math.random(), 
                    day: day, 
                    time: '10:00', 
                    activity: '', 
                    location: '',
                    mapLink: '' 
                }); 
                this.saveData(); 
                this.forceUpdateMap();
            },
            
            removeItineraryItem(itemId) { 
                if (!this.currentUser) {
                    alert("è«‹å…ˆç™»å…¥ä»¥åŒæ­¥æ‚¨çš„è¡Œç¨‹ã€‚");
                    this.showLoginModal = true;
                    return;
                }
                if(confirm('ç¢ºèªåˆªé™¤æ­¤è¡Œç¨‹é …ç›®å—ï¼Ÿ')) {
                    const index = this.activeTrip.itinerary.findIndex(item => item.id === itemId);
                    if(index !== -1) {
                        this.activeTrip.itinerary.splice(index, 1);
                        this.saveData(); 
                        this.forceUpdateMap();
                    }
                }
            },
            
            runBatchImport() {
                if (!this.currentUser) {
                    alert("è«‹å…ˆç™»å…¥ä»¥åŒæ­¥æ‚¨çš„è¡Œç¨‹ã€‚");
                    this.showLoginModal = true;
                    return;
                }

                if(!this.batchImportText) return alert('è«‹è²¼ä¸Šå…§å®¹');
                const lines = this.batchImportText.split('\n').filter(line => line.trim() !== '');
                
                const newItems = lines.map(line => {
                    const parts = line.split(',');
                    const dayNum = parseInt(parts[0]) || 1; 
                    return {
                        id: Date.now() + Math.random(), 
                        day: dayNum > this.totalDays ? this.totalDays : dayNum,
                        time: parts[1] ? parts[1].trim() : 'N/A',
                        mapLink: '', 
                        activity: parts[2] ? parts[2].trim() : 'æ´»å‹•',
                        location: parts[3] ? parts[3].trim() : ''
                    };
                });
                
                this.activeTrip.itinerary.push(...newItems);
                this.saveData();
                this.showBatchImport = false;
                this.batchImportText = '';
                this.forceUpdateMap(); 
                alert(`æˆåŠŸåŒ¯å…¥ ${newItems.length} æ¢è¡Œç¨‹ï¼`);
            },


            // === æ—…ç¨‹ç®¡ç†åŠŸèƒ½ (åŠ å…¥ç™»å…¥æª¢æŸ¥) ===
            openNewTripModal() { 
                // å…è¨±æœªç™»å…¥æ™‚æ–°å¢æ—…ç¨‹åˆ°æœ¬åœ°
                this.editingTripId = null; 
                this.tempTrip = {
                    title:'', city:'', destination:'', currency:'JPY', exchangeRate:19.2, 
                    center:{lat:35.6,lng:139.6}, 
                    startDate: new Date().toISOString().split('T')[0], 
                    endDate: new Date().toISOString().split('T')[0]
                }; 
                this.showTripModal = true; 
            },
            openEditTripModal(trip) { 
                // å…è¨±æœªç™»å…¥æ™‚ç·¨è¼¯æ—…ç¨‹
                this.editingTripId = trip.id; this.tempTrip = JSON.parse(JSON.stringify(trip)); this.showTripModal = true; 
            },
            saveTrip() {
                // ä¸è«–æ˜¯å¦ç™»å…¥ï¼Œéƒ½å…è¨±ä¿å­˜æ—…ç¨‹åˆ°æœ¬åœ°
                if (!this.tempTrip.title) return;
                if (this.editingTripId) {
                const idx = this.trips.findIndex(t => t.id === this.editingTripId);
                this.trips[idx] = { ...this.trips[idx], ...this.tempTrip };
                } else {
                const center = this.tempTrip.center || {lat:35.6, lng:139.6};
                const newTrip = { 
                    id: Date.now(), 
                    ...this.tempTrip, 
                    center: center, 
                    flights:{outbound:{},inbound:{}}, 
                    itinerary:[], 
                    expenses:[], 
                    shoppingItems:[] 
                };
                this.trips.unshift(newTrip); 
                this.activeTripId = newTrip.id;
                }
                this.saveData();
                this.showTripModal = false;
                
                this.$nextTick(() => {
                    this.activeDay = 1;
                    this.newExpense.day = 1; 
                    this.newExpense.category = 'é£²é£Ÿ'; 
                    if (this.activeTrip) {
                        this.inputCurrency = this.activeTrip.currency;
                        // åŒæ­¥ tempExchangeRate
                        this.tempExchangeRate = this.activeTrip.exchangeRate; 
                    }
                    this.updateChart();
                });
            },
            deleteTrip(id) {
                // ä¸è«–æ˜¯å¦ç™»å…¥ï¼Œéƒ½å…è¨±åˆªé™¤æ—…ç¨‹
                if(this.trips.length<=1) return alert('ä¸èƒ½åˆªé™¤æœ€å¾Œä¸€å€‹æ—…ç¨‹');
                if(confirm('ç¢ºèªåˆªé™¤?')) {
                this.trips = this.trips.filter(t=>t.id!==id);
                this.activeTripId = this.trips[0].id;
                this.saveData();
                }
            },
            switchTrip(id) { 
                this.activeTripId = id; 
                this.activeTab = 'info'; 
                this.$nextTick(() => {
                    this.activeDay = 1;
                    this.newExpense.day = 1; 
                    this.newExpense.category = 'é£²é£Ÿ'; 
                    if (this.activeTrip) {
                        this.inputCurrency = this.activeTrip.currency;
                        // åŒæ­¥ tempExchangeRate
                        this.tempExchangeRate = this.activeTrip.exchangeRate; 
                    }
                    this.updateChart();
                });
            },
            }
        }).mount('#app');

    } catch (e) {
        // å¦‚æœ Vue.js æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•å¤±æ•—ï¼Œå°‡éŒ¯èª¤è¨Šæ¯å¯«å…¥ HTML é é¢
        document.body.innerHTML = `
            <div style="padding: 20px; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 5px; margin: 20px; font-size: 1.1em;">
                <h2>ğŸš¨ æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•å¤±æ•— (é é¢ç©ºç™½éŒ¯èª¤)</h2>
                <p>é€™é€šå¸¸æ˜¯ JavaScript èªæ³•éŒ¯èª¤æˆ– Firebase é…ç½®å•é¡Œå°è‡´çš„ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨çš„æ§åˆ¶å° (Console) ä»¥ç²å–è©³ç´°è³‡è¨Šã€‚</p>
                <h4 style="margin-top: 10px;">éŒ¯èª¤è©³æƒ…:</h4>
                <pre style="white-space: pre-wrap; word-break: break-all; color: #721c24; background: #f5c6cb; padding: 10px; border-radius: 3px;">${e.stack || e.message}</pre>
                <p style="margin-top: 15px;">**å»ºè­°æ‚¨ï¼š** æŒ‰ F12 æ‰“é–‹æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰é—œæ–¼ **Firebase** æˆ– **Vue** çš„éŒ¯èª¤è¨Šæ¯ã€‚</p>
            </div>
        `;
        console.error("Critical Application Startup Failure:", e);
    }
</script>

</body>
</html>
