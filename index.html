l<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Christine's Travel Diary</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#97CBFF',
            secondary: '#C7C7E2',
            textSoft: '#6B7280',
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.3s ease-out'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0', }, '100%': { translateY: '0', opacity: '1' } }
          }
        }
      }
    }
  </script>
  
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script> 

  <style>
    body {
      background: linear-gradient(135deg, #C4E1FF 0%, #D2E9FF 33%, #DDDDFF 66%, #FFECF5 100%);
      background-attachment: fixed;
      font-family: system-ui, -apple-system, sans-serif;
      color: #1f2937;
      padding-bottom: 110px; 
      -webkit-tap-highlight-color: transparent;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.07);
      border-radius: 24px;
    }
    
    /* 購物卡片 (已勾選狀態) - 確保半透明生效 */
    .shopping-card-bought {
        opacity: 0.6 !important; /* 強制設定整體半透明 */
        background: rgba(230, 230, 230, 0.5) !important; /* 淺灰色透明底，比純白色更柔和 */
        border: 1px dashed #b7c0ce !important; /* 虛線邊框提示已買 */
        box-shadow: none !important; /* 移除陰影 */
    }

    .flight-sky { 
      background: linear-gradient(180deg, #C4E1FF 0%, #D6EFFF 100%); 
      position: relative;
      overflow: hidden;
    }

    #map { 
      height: 350px; 
      width: 100%; 
      border-radius: 16px; 
      z-index: 0; 
      position: relative;
    }

    .capsule-tab {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
      z-index: 999; 
    }
    
    .trip-card-active {
      background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%);
      border: 2px solid #97CBFF;
      transform: scale(1.02);
      box-shadow: 0 10px 30px rgba(151, 203, 255, 0.4);
    }
    
    /* Weather Themes */
    .weather-sunny { background: linear-gradient(135deg, #FFECF5 0%, #FFD9EC 40%, #ECECFF 100%); }
    .weather-cloudy { background: linear-gradient(135deg, #DDDDFF 0%, #E6E6F2 40%, #D8D8EB 100%); }
    .weather-rainy { background: linear-gradient(135deg, #D8D8EB 0%, #E6E6F2 35%, #C4E1FF 100%); }

    /* For scrollbar-hide in Tailwind v2/v3 */
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    /* Day Scrollbar Styling */
    .day-selector-scroll {
        scrollbar-width: none; 
        -ms-overflow-style: none; 
    }
    .day-selector-scroll::-webkit-scrollbar {
        display: none; 
    }
    
    /* Shopping Card Image Aspect Ratio */
    .aspect-square {
        aspect-ratio: 1 / 1;
    }
    
    /* 勾選圖示樣式優化 */
    .tick-icon-white {
        color: white; 
        background-color: transparent; 
    }
  </style>
</head>
<body>

<div id="app" class="min-h-screen">
  
  <header class="fixed top-0 left-0 w-full p-6 z-50 flex items-center justify-between pointer-events-none">
    <div class="flex items-center gap-2 pointer-events-auto bg-white/30 backdrop-blur-sm pr-4 py-1 rounded-full">
      <div class="bg-primary/20 p-2 rounded-full"><i class="ri-plane-fill text-xl text-primary"></i></div>
      <h1 class="text-lg font-bold text-slate-700 tracking-wide">Christine's Travel Diary</h1>
    </div>
    <button @click="openNewTripModal" class="pointer-events-auto w-10 h-10 rounded-full bg-white/90 backdrop-blur shadow-lg text-primary flex items-center justify-center hover:scale-110 transition active:scale-95">
      <i class="ri-add-line text-xl"></i>
    </button>
  </header>

  <main class="pt-24 px-4 max-w-3xl mx-auto pb-8">
    
    <section v-if="activeTab === 'info' && activeTrip" class="animate-fade-in space-y-5">
      
      <div class="glass-card overflow-hidden shadow-lg border-0">
        <div class="flight-sky p-6 relative">
          <i class="ri-cloud-fill absolute top-4 right-8 text-white/60 text-5xl opacity-80"></i>
          <i class="ri-cloud-fill absolute bottom-6 left-6 text-white/40 text-3xl opacity-60"></i>
          
          <h2 class="text-slate-700 font-bold text-lg mb-5 flex items-center gap-2 relative z-10">
            <span class="bg-white/50 p-1.5 rounded-full"><i class="ri-flight-takeoff-line"></i></span> 
            航班資訊
          </h2>
          
          <div class="bg-white/60 backdrop-blur-md rounded-2xl p-4 mb-3 relative z-10 shadow-sm">
            <div class="flex justify-between items-center mb-2">
              <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider bg-white/50 px-2 py-0.5 rounded-full">去程 Outbound</span>
              <button @click="fetchFlight('outbound')" class="text-[10px] bg-white px-3 py-1 rounded-full text-primary font-bold shadow-sm active:scale-95 transition">自動填寫</button>
            </div>
            <div class="flex gap-2 mb-3">
               <input v-model="activeTrip.flights.outbound.no" placeholder="航班號 (e.g. NH924)" class="w-1/2 p-2 rounded-xl text-sm bg-white/50 border-0 text-center font-mono placeholder:text-slate-400 focus:bg-white transition">
               <input v-model="activeTrip.flights.outbound.date" type="date" class="w-1/2 p-2 rounded-xl text-sm bg-white/50 border-0 focus:bg-white transition">
            </div>
            <div class="flex justify-between text-sm font-bold text-slate-800 px-4 py-1">
               <div class="text-center">
                 <div class="text-2xl font-black text-slate-700">{{ activeTrip.flights.outbound.from || 'HKG' }}</div>
                 <div class="text-xs text-slate-500 mt-1">{{ activeTrip.flights.outbound.depTime || '--:--' }}</div>
               </div>
               <i class="ri-flight-takeoff-line text-slate-400 text-xl self-center mx-2"></i>
               <div class="text-center">
                 <div class="text-2xl font-black text-slate-700">{{ activeTrip.flights.outbound.to || 'NRT' }}</div>
                 <div class="text-xs text-slate-500 mt-1">{{ activeTrip.flights.outbound.arrTime || '--:--' }}</div>
               </div>
            </div>
          </div>

          <div class="bg-white/60 backdrop-blur-md rounded-2xl p-4 relative z-10 shadow-sm">
            <div class="flex justify-between items-center mb-2">
              <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider bg-white/50 px-2 py-0.5 rounded-full">回程 Inbound</span>
              <button @click="fetchFlight('inbound')" class="text-[10px] bg-white px-3 py-1 rounded-full text-primary font-bold shadow-sm active:scale-95 transition">自動填寫</button>
            </div>
            <div class="flex gap-2 mb-3">
               <input v-model="activeTrip.flights.inbound.no" placeholder="航班號 (e.g. NH923)" class="w-1/2 p-2 rounded-xl text-sm bg-white/50 border-0 text-center font-mono placeholder:text-slate-400 focus:bg-white transition">
               <input v-model="activeTrip.flights.inbound.date" type="date" class="w-1/2 p-2 rounded-xl text-sm bg-white/50 border-0 focus:bg-white transition">
            </div>
             <div class="flex justify-between text-sm font-bold text-slate-800 px-4 py-1">
               <div class="text-center">
                 <div class="text-2xl font-black text-slate-700">{{ activeTrip.flights.inbound.from || 'NRT' }}</div>
                 <div class="text-xs text-slate-500 mt-1">{{ activeTrip.flights.inbound.arrTime || '--:--' }}</div>
               </div>
               <i class="ri-flight-land-line text-slate-400 text-xl self-center mx-2"></i>
               <div class="text-center">
                 <div class="text-2xl font-black text-slate-700">{{ activeTrip.flights.inbound.to || 'HKG' }}</div>
                 <div class="text-xs text-slate-500 mt-1">{{ activeTrip.flights.inbound.arrTime || '--:--' }}</div>
               </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div :class="['glass-card p-5 flex flex-col justify-between relative overflow-hidden h-40', `weather-${weatherTheme}`]">
          <div class="relative z-10 h-full flex flex-col justify-between">
            <div class="flex justify-between items-start">
              <div>
                <span class="text-xs font-bold text-slate-500 block mb-1">{{ activeTrip.city || 'Location' }}</span>
                <i class="ri-sun-cloudy-line text-2xl text-slate-700"></i>
              </div>
              <button @click="fetchWeather" class="bg-white/40 rounded-full p-1.5 hover:bg-white/60 transition"><i class="ri-refresh-line text-xs"></i></button>
            </div>
            <div>
              <span class="text-4xl font-black text-slate-800 tracking-tight">{{ weatherData ? Math.round(weatherData.temperature) : '--' }}°</span>
              <p class="text-xs text-slate-600 font-medium mt-1">{{ weatherDesc }}</p>
            </div>
          </div>
        </div>
        
        <div class="glass-card p-5 flex flex-col justify-center items-center h-40">
          <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center mb-2">
            <i class="ri-wallet-3-line text-primary text-xl"></i>
          </div>
          <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">總花費 (HKD)</span>
          <span class="text-2xl font-black text-slate-800 mt-1">{{ calculateTripTotal(activeTrip).toLocaleString() }}</span>
          <div class="text-[10px] text-slate-400 mt-2 bg-slate-50 px-3 py-1 rounded-full">
            1 HKD ≈ {{ (activeTrip.exchangeRate || 1).toFixed(2) }} {{ activeTrip.currency }}
          </div>
        </div>
      </div>
    </section>

    <section v-if="activeTab === 'itinerary-map' && activeTrip" class="animate-fade-in">
      
      <div class="day-selector-scroll flex gap-3 mb-5 overflow-x-auto pb-2">
        <button 
          v-for="dayIndex in totalDays" :key="dayIndex"
          @click="selectDay(dayIndex)"
          :class="['flex-shrink-0 px-5 py-3 rounded-2xl text-sm font-bold shadow-md transition-opacity duration-300 active:scale-95', 
                  activeDay === dayIndex 
                    ? 'bg-primary text-white shadow-blue-200' 
                    : 'bg-white text-slate-600 opacity-50 hover:opacity-100 border border-slate-100']">
          Day {{ dayIndex }}
        </button>
      </div>

      <div class="flex gap-3 mb-5 overflow-x-auto pb-2 scrollbar-hide">
        <button @click="addItineraryItem(activeDay)" class="flex-shrink-0 bg-slate-100 text-slate-600 px-5 py-3 rounded-2xl text-sm font-bold shadow-sm hover:shadow-md transition active:scale-95 flex items-center gap-2 border border-slate-200">
          <i class="ri-add-circle-fill text-lg text-primary"></i>新增 Day {{ activeDay }} 行程
        </button>
        <button @click="showBatchImport = !showBatchImport" class="flex-shrink-0 bg-white text-slate-600 px-5 py-3 rounded-2xl text-sm font-bold shadow-sm border border-slate-100 flex items-center gap-2">
          <i class="ri-file-list-3-line text-lg"></i>批次匯入
        </button>
      </div>

      <div v-if="showBatchImport" class="glass-card p-4 mb-4 animate-slide-up">
        <textarea v-model="batchImportText" placeholder="貼上地點清單 (格式: Day,時間,活動,地點)... 例如: 1,10:00,午餐,築地市場" class="w-full h-32 p-3 rounded-xl bg-slate-50 border-0 text-sm mb-3 focus:ring-2 ring-primary/50"></textarea>
        <button @click="runBatchImport" class="w-full bg-secondary text-white py-2 rounded-xl font-medium">開始匯入</button>
      </div>

      <div class="pb-8 space-y-8">
        <div v-for="(group, dayIndex) in groupedItinerary" :key="dayIndex" 
             v-show="group.day === activeDay" 
             class="glass-card p-1 animate-fade-in">

             <div class="bg-slate-50/50 p-4 rounded-t-[22px] flex justify-between items-center">
                 <span class="text-sm font-bold text-slate-700">Day {{ activeDay }} 行程</span>
                 <span class="text-xs text-slate-400 font-bold tracking-wider">{{ group.items.length }} 個景點</span>
             </div>
          
             <div class="p-4 space-y-6">
                <div v-if="group.items.length === 0" class="text-center py-4 bg-slate-50 rounded-xl border border-dashed border-slate-200">
                    <p class="text-sm text-slate-400 mb-3">此日暫無行程</p>
                    <button @click="addItineraryItem(activeDay)" class="text-xs font-bold text-slate-600 bg-slate-100 border border-slate-200 px-3 py-1 rounded-full hover:bg-slate-200 transition">
                        <i class="ri-add-line text-primary"></i> 新增 Day {{ activeDay }} 第一站
                    </button>
                </div>

                <div v-for="(item, idx) in group.items" :key="item.id" class="relative pl-6 border-l-2 border-slate-200">
                  <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-white border-4 border-slate-300"></div>
                  <div class="flex justify-between items-start mb-1">
                    <input v-model="item.time" type="time" @change="saveData" class="bg-transparent font-bold text-xl text-slate-700 w-24 p-0 border-0 focus:ring-0">
                    <button @click="removeItineraryItem(item.id)" class="text-slate-300 hover:text-red-400"><i class="ri-close-circle-fill text-xl"></i></button>
                  </div>
                  <input v-model="item.location" @change="saveData(); updateMapMarkers();" placeholder="地點名稱" class="w-full font-bold text-lg text-slate-800 bg-transparent mb-1 border-0 border-b border-transparent focus:border-primary focus:ring-0 placeholder-slate-300 p-0 transition">
                  <input v-model="item.activity" @change="saveData" placeholder="備註 / 活動" class="w-full text-sm text-slate-500 bg-transparent mb-3 border-0 focus:ring-0 p-0">
                  
                  <input v-model="item.mapLink" @change="saveData" placeholder="貼上 Google Map URL (可選)" class="w-full text-xs text-slate-500 bg-slate-50 border-0 p-2 rounded-lg mb-2 focus:ring-1 ring-primary/50">

                  <div class="flex gap-2">
                    <button @click="openGoogleMaps(item)" class="flex-1 bg-primary/10 py-2 rounded-xl text-xs font-bold text-primary hover:bg-primary/20 transition flex items-center justify-center gap-1">
                      <i class="ri-map-pin-line text-lg"></i> 前往地圖 (Map / Route)
                    </button>
                  </div>
                </div>
            </div>
        </div>
      </div>
      <div class="glass-card p-2 mb-8 shadow-md relative z-0">
        <button @click="forceUpdateMap" class="absolute top-4 right-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-slate-600 shadow-sm z-[400] border border-slate-200 hover:bg-white transition">
            <i class="ri-refresh-line text-sm mr-1"></i>刷新地圖
        </button>
        <div id="map"></div>
        <div class="absolute top-4 left-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-slate-700 shadow-sm z-[400] border border-slate-200">
          <i class="ri-map-pin-range-line text-primary mr-1"></i>行程地圖
        </div>
        <div class="absolute bottom-4 right-4 bg-white/90 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-slate-600 shadow-sm z-[400]">
          當前 Day {{ activeDay }} 顯示
        </div>
      </div>

    </section>

    <section v-if="activeTab === 'budget' && activeTrip" class="animate-fade-in space-y-6">
      
      <div class="glass-card p-6 border border-primary/20">
          <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
              <i class="ri-wallet-3-line text-primary text-xl"></i>
              總花費 (HKD) 總計
          </h3>
          
          <div class="flex justify-between items-end border-b border-dashed border-slate-200 pb-3 mb-3">
              <span class="text-sm font-bold text-slate-500 uppercase">總計</span>
              <span class="text-4xl font-black text-primary">{{ totalExpensesHKD.toLocaleString() }}</span>
          </div>

          <div class="flex justify-between text-sm text-slate-600 font-medium">
              <div class="flex items-center gap-2">
                  <i class="ri-bank-card-line text-lg text-red-400"></i>
                  信用卡
              </div>
              <span class="font-bold">{{ paymentSummary.信用卡.toLocaleString() }} HKD</span>
          </div>
          <div class="flex justify-between text-sm text-slate-600 font-medium mt-1">
              <div class="flex items-center gap-2">
                  <i class="ri-money-cny-box-line text-lg text-green-400"></i>
                  現金
              </div>
              <span class="font-bold">{{ paymentSummary.現金.toLocaleString() }} HKD</span>
          </div>
          <div v-if="paymentSummary.其他 > 0" class="flex justify-between text-sm text-slate-600 font-medium mt-1">
              <div class="flex items-center gap-2">
                  <i class="ri-safe-line text-lg text-purple-400"></i>
                  其他
              </div>
              <span class="font-bold">{{ paymentSummary.其他.toLocaleString() }} HKD</span>
          </div>
      </div>
      
      <div class="glass-card p-6 text-center">
         <p class="text-xs text-slate-400 mb-1 uppercase tracking-wide">Exchange Rate</p>
         <div class="flex items-center justify-center gap-2 text-3xl font-bold text-slate-700">
           <span class="text-base text-slate-400 self-end mb-1">1 HKD ≈</span>
           <input v-model.number="activeTrip.exchangeRate" type="number" step="0.1" @change="saveData" class="w-24 text-center bg-transparent border-b-2 border-slate-200 focus:outline-none focus:border-primary">
           <span class="text-xl self-end mb-1">{{ activeTrip.currency }}</span>
         </div>
         <button @click="autoGeocode" class="text-xs bg-slate-100 text-slate-500 px-3 py-1 rounded-full mt-3 hover:bg-slate-200"><i class="ri-refresh-line"></i> 重新抓取即時匯率</button>
      </div>
      
      <div class="glass-card p-5">
        <h3 class="font-bold mb-4 flex items-center gap-2"><i class="ri-edit-line text-secondary"></i>記一筆</h3>
        
        <select v-model.number="newExpense.day" class="w-full p-3 rounded-xl bg-slate-50 border-0 mb-3 text-sm text-slate-600 font-bold text-center">
            <option v-for="day in totalDays" :value="day" :key="'new_exp_day_' + day">
                Day {{ day }}
            </option>
            <option :value="0">旅行前</option> 
        </select>

        <input v-model="newExpense.name" placeholder="消費項目" class="w-full p-3 rounded-xl bg-slate-50 border-0 mb-3 text-sm">
        
        <div class="flex gap-3 mb-3">
            <select v-model="inputCurrency" class="w-1/4 p-3 rounded-xl bg-slate-50 border-0 text-sm text-slate-600 font-bold text-center">
                <option :value="activeTrip.currency">{{ activeTrip.currency }}</option>
                <option value="HKD">HKD</option>
            </select>
            
            <div class="relative flex-1">
               <input v-model.number="newExpense.localAmount" type="number" placeholder="金額" class="w-full p-3 rounded-xl bg-slate-50 border-0 text-sm">
            </div>

            <select v-model="newExpense.method" class="w-1/3 p-3 rounded-xl bg-slate-50 border-0 text-sm text-slate-600">
              <option>現金</option>
              <option>信用卡</option>
              <option>其他</option> 
            </select>
        </div>
        
        <div v-if="finalHKDAmount > 0" class="text-sm text-slate-500 bg-blue-50/70 p-3 rounded-xl mb-3 flex justify-between items-center animate-fade-in border border-blue-100">
            <span class="font-bold text-slate-700">最終港幣 (HKD):</span>
            <span class="font-black text-lg text-primary">{{ finalHKDAmount.toFixed(2) }}</span>
        </div>

        <select v-model="newExpense.category" class="w-full p-3 rounded-xl bg-slate-50 border-0 mb-4 text-sm text-slate-600">
            <option>飲食</option>
            <option>購物</option>
            <option>交通</option>
            <option>娛樂</option>
            <option>其他</option>
            <option>旅行前</option> 
        </select>
        <button @click="addExpense" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-md">新增</button>
      </div>
      
      <div v-if="categorySummary.data && categorySummary.data.length > 0" class="glass-card p-5 animate-fade-in">
          <h3 class="font-bold mb-4 flex items-center gap-2 text-primary"><i class="ri-pie-chart-line"></i> 消費類別分析 (HKD)</h3>
          <div style="height: 250px;"> 
              <canvas id="expenseChart"></canvas>
          </div>
          <div class="mt-4 pt-4 border-t border-slate-100 flex justify-between items-center">
              <span class="text-xs text-slate-400 font-bold uppercase">總花費</span>
              <span class="text-xl font-black text-slate-800">{{ totalExpensesHKD.toLocaleString() }} HKD</span>
          </div>
      </div>
      
      <div class="pb-20">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                <i class="ri-list-check-2-line text-secondary"></i>
                每筆記帳記錄
            </h3>
            <button @click="exportExpensesToCSV" class="bg-primary text-white py-2 px-4 rounded-xl text-sm font-bold shadow-md hover:bg-primary/90 transition active:scale-95 flex items-center gap-2">
                <i class="ri-file-excel-2-line"></i> 下載 CSV
            </button>
        </div>

        <div v-if="groupedAndSortedExpenses.length === 0" class="text-center py-8 bg-white/70 rounded-2xl text-slate-400">
            <i class="ri-money-dollar-circle-line text-4xl mb-2"></i>
            <p class="text-sm font-medium">目前暫無消費記錄。</p>
        </div>

        <div v-for="(item, index) in groupedAndSortedExpenses" :key="item.id || index" class="animate-fade-in">
            <div v-if="item.isHeader" class="glass-card bg-primary/20 p-4 mb-3 mt-4 flex justify-between items-center border border-primary font-black shadow-lg">
                <span class="text-sm text-primary">{{ item.dayLabel }} 總計</span>
                <span class="text-lg text-primary">{{ item.total.toLocaleString() }} HKD</span>
            </div>
            
            <div v-else class="glass-card p-4 mb-3 flex justify-between items-center border border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-xl">
                        <i v-if="item.category === '旅行前'" class="ri-luggage-cart-line text-purple-400"></i>
                        <i v-else-if="item.category === '飲食'" class="ri-restaurant-line text-orange-400"></i>
                        <i v-else-if="item.category === '購物'" class="ri-shopping-bag-line text-pink-400"></i>
                        <i v-else-if="item.category === '交通'" class="ri-bus-line text-blue-400"></i>
                        <i v-else class="ri-money-dollar-circle-line text-green-400"></i>
                    </div>
                    <div>
                        <p class="font-bold text-slate-700">{{ item.name }}</p>
                        <p class="text-xs text-slate-400">{{ item.day === 0 ? '旅行前' : `Day ${item.day || 1}` }} · {{ item.method }}</p> 
                    </div>
                </div>
                <div class="text-right flex items-center gap-3">
                    <div>
                        <p class="font-bold text-slate-800">-{{ item.amount.toFixed(2) }} HKD</p>
                        <p class="text-[10px] text-slate-400">≈ {{ Math.round(item.localAmount) }} {{ activeTrip.currency }}</p>
                    </div>
                    <button @click="removeExpense(item.id)" class="text-slate-300 hover:text-red-500 p-1 active:scale-90 transition">
                        <i class="ri-delete-bin-line text-lg"></i>
                    </button>
                </div>
            </div>
        </div>

        <div v-if="totalExpensesHKD > 0" class="glass-card bg-primary/20 p-4 mb-3 mt-4 flex justify-between items-center border border-primary font-black shadow-lg">
            <span class="text-sm text-primary">旅程總花費</span>
            <span class="text-xl text-primary">{{ totalExpensesHKD.toLocaleString() }} HKD</span>
        </div>
      </div>
      
    </section>

    <section v-if="activeTab === 'shopping' && activeTrip" class="animate-fade-in">
      
      <div class="glass-card p-5 mb-6 text-center border border-green-200 bg-green-50/70">
        <h3 class="font-bold mb-2 flex items-center justify-center gap-2 text-green-600">
            <i class="ri-money-cny-box-line text-2xl"></i>
            總共節省了 (HKD)
        </h3>
        <span class="text-4xl font-black text-green-700">{{ totalSavings.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }}</span>
      </div>

      <div class="glass-card p-5 mb-6">
        <h3 class="font-bold mb-4 flex items-center gap-2"><i class="ri-heart-3-line text-primary"></i> 願望清單 (Wish List)</h3>
        
        <div class="flex gap-3 mb-3">
          <label class="w-20 h-20 flex-shrink-0 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-slate-400 cursor-pointer hover:border-primary hover:text-primary transition relative overflow-hidden aspect-square">
            <input type="file" accept="image/*" class="hidden" @change="handleImageUpload">
            <img v-if="newShoppingItem.image" :src="newShoppingItem.image" class="absolute inset-0 w-full h-full object-cover">
            <div v-else class="flex flex-col items-center">
                <i class="ri-camera-line text-2xl"></i>
                <span class="text-[10px] mt-1">上傳圖片</span>
            </div>
          </label>
          
          <div class="flex-1 space-y-2">
            <input v-model="newShoppingItem.name" placeholder="品名" class="w-full p-2 rounded-lg bg-slate-50 border-0 text-sm focus:ring-1 ring-primary/50">
            
            <div class="flex gap-2">
              <input v-model.number="newShoppingItem.quantity" type="number" min="1" placeholder="數量 (Qty)" class="w-1/3 p-2 rounded-lg bg-slate-50 border-0 text-sm text-center focus:ring-1 ring-primary/50">
              <div class="flex-1 text-xs text-slate-500 bg-slate-50 p-2 rounded-lg flex items-center gap-1">
                  <i class="ri-currency-line"></i> 
                  <span class="font-bold text-slate-700">{{ activeTrip.currency }}</span>
                  <span class="ml-auto">1 HKD ≈ {{ (activeTrip.exchangeRate || 1).toFixed(2) }} {{ activeTrip.currency }}</span>
              </div>
            </div>

            <div class="flex gap-2 text-sm">
                <div class="relative w-1/2">
                    <input v-model.number="newShoppingItem.onlinePrice" type="number" placeholder="網上價 (HKD, 可選)" class="w-full p-2 rounded-lg bg-slate-50 border-0 pl-16 focus:ring-1 ring-primary/50">
                    <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs font-bold text-slate-500">HKD</span>
                </div>
                <div class="relative w-1/2">
                    <input v-model.number="newShoppingItem.localPrice" type="number" placeholder="當地價 ({{ activeTrip.currency }}, 可選)" class="w-full p-2 rounded-lg bg-slate-50 border-0 pl-16 focus:ring-1 ring-primary/50">
                    <span class="absolute left-2 top-1/2 -translate-y-1/2 text-xs font-bold text-slate-500">{{ activeTrip.currency }}</span>
                </div>
            </div>
          </div>
        </div>
        
        <button @click="addShoppingItem" class="w-full bg-primary text-white py-2.5 rounded-xl font-bold shadow-md active:scale-95 transition">加入願望清單</button>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 pb-20">
        <div v-for="(item, idx) in shoppingListWithSavings" :key="item.id" 
             :class="['glass-card p-3 shadow-lg transition-all duration-300 relative overflow-hidden', 
                      item.bought ? 'shopping-card-bought' : '']"> 
          
          <div class="aspect-square w-full bg-slate-100 rounded-xl overflow-hidden border mb-2 relative">
             <img v-if="item.image" :src="item.image" class="absolute inset-0 w-full h-full object-cover transition-transform duration-300">
             <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="ri-image-line text-4xl"></i></div>
             
             <button @click="removeShoppingItem(item.id)" 
                     class="absolute top-2 right-2 w-7 h-7 bg-white/50 backdrop-blur rounded-full text-slate-400 hover:text-red-500 transition flex items-center justify-center">
                 <i class="ri-delete-bin-line text-base"></i>
             </button>
          </div>
          
          <div class="relative px-1 pb-1">
             <h4 class="font-bold text-slate-800 text-base mb-1 leading-tight" 
                 :class="{'line-through !text-slate-500': item.bought}"> 
                 {{ item.name }} (x{{ item.quantity }})
             </h4>

             <div class="flex justify-between items-center pt-2 border-t border-slate-100">
                 
                 <div class="text-left w-2/3">
                     <span class="text-xs font-medium text-slate-500 block">當地價 (HKD)</span>
                     <span class="text-lg font-black" 
                           :class="item.bought ? '!text-slate-500' : 'text-primary'"> 
                         {{ item.localPriceHKD.toFixed(2) }}
                     </span>
                 </div>
                 
                 <button @click="toggleBought(item)" 
                         class="w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-200 tick-icon-container"
                         :class="item.bought ? 'bg-green-500 text-white shadow-green-300/50' : 'bg-slate-100 text-slate-400 border border-slate-200 hover:bg-white'">
                     <i v-if="item.bought" class="ri-check-line text-xl tick-icon-white"></i>
                     <i v-else class="ri-check-line text-xl"></i>
                 </button>
             </div>
          </div>
          
        </div>
      </div>
    </section>

    <section v-if="activeTab === 'trips'" class="animate-fade-in pb-20">
      <div class="space-y-6">
        <div v-for="trip in trips" :key="trip.id" 
             @click="switchTrip(trip.id)"
             :class="['glass-card p-6 cursor-pointer transition-all duration-300', activeTripId === trip.id ? 'trip-card-active' : 'opacity-80 hover:opacity-100']">
          <div class="flex justify-between items-start mb-4">
             <div>
               <div class="flex items-center gap-2 mb-1">
                 <h3 class="text-2xl font-black text-slate-800">{{ trip.title }}</h3>
                 <span v-if="activeTripId === trip.id" class="px-2 py-0.5 bg-blue-500 text-white text-[9px] font-bold rounded-full tracking-wider shadow-sm">CURRENT</span>
               </div>
               <div class="flex items-center gap-1 text-sm font-medium text-slate-500">
                 <i class="ri-map-pin-2-fill text-primary"></i> {{ trip.city }}, {{ trip.destination }}
               </div>
             </div>
             <div class="text-right">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Currency</div>
                <div class="text-lg font-black text-slate-700">{{ trip.currency }}</div>
             </div>
          </div>
          <div class="flex gap-4 text-xs text-slate-500 mb-5 bg-slate-50/50 p-3 rounded-xl">
             <div class="flex items-center gap-1"><i class="ri-calendar-line"></i> {{ trip.startDate }}</div>
             <div class="flex items-center gap-1"><i class="ri-arrow-right-line"></i></div>
             <div class="flex items-center gap-1"><i class="ri-calendar-check-line"></i> {{ trip.endDate }}</div>
          </div>
          <div class="pt-4 border-t border-slate-100 flex justify-between items-center">
            <span class="text-xs text-slate-400 font-bold uppercase">總花費 (HKD)</span>
            <span class="text-xl font-black text-slate-800">{{ calculateTripTotal(trip).toLocaleString() }}</span>
          </div>
          <div class="mt-3 flex gap-3">
            <button @click.stop="openEditTripModal(trip)" class="flex-1 bg-white border border-slate-200 text-slate-600 py-2.5 rounded-xl text-xs font-bold hover:bg-slate-50 transition shadow-sm">
              <i class="ri-edit-line mr-1"></i>編輯
            </button>
            <button @click.stop="deleteTrip(trip.id)" class="px-4 bg-red-50 text-red-400 rounded-xl hover:bg-red-100 transition">
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <div v-if="showTripModal" class="fixed inset-0 z-[200] flex items-end sm:items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" @click="showTripModal = false"></div>
    <div class="bg-white w-full sm:w-[400px] p-6 rounded-t-3xl sm:rounded-3xl relative z-10 animate-slide-up pb-10">
      <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
      <h3 class="text-xl font-bold mb-6 text-center text-slate-800">{{ editingTripId ? '編輯旅程' : '新增旅程' }}</h3>
      <div class="space-y-4">
        <input v-model="tempTrip.title" placeholder="旅程標題 (e.g. 畢業旅行)" class="w-full p-4 rounded-2xl bg-slate-50 border-0 font-bold focus:ring-2 ring-primary/20">
        
        <div class="flex gap-3">
          <input v-model="tempTrip.city" placeholder="城市 (e.g. Tokyo)" class="flex-1 p-4 rounded-2xl bg-slate-50 border-0 text-sm">
          <input v-model="tempTrip.destination" placeholder="國家 (可選)" class="flex-1 p-4 rounded-2xl bg-slate-50 border-0 text-sm">
        </div>
        
        <button @click="autoGeocode" type="button" class="w-full py-3 rounded-xl bg-blue-50 text-primary text-xs font-bold hover:bg-blue-100 transition flex items-center justify-center gap-2 border border-blue-100">
          <i class="ri-magic-line text-lg"></i>
          自動取得座標 + 貨幣 + 匯率 (One-Click)
        </button>

        <div class="flex gap-3">
          <input v-model="tempTrip.startDate" type="date" class="flex-1 p-4 rounded-2xl bg-slate-50 border-0 text-sm">
          <input v-model="tempTrip.endDate" type="date" class="flex-1 p-4 rounded-2xl bg-slate-50 border-0 text-sm">
        </div>
        <div class="flex gap-3">
          <input v-model="tempTrip.currency" placeholder="幣別" class="w-1/3 p-4 rounded-2xl bg-slate-50 border-0 uppercase text-center font-bold tracking-widest text-slate-600">
           <div class="flex-1 p-4 rounded-2xl bg-slate-50 border-0 text-sm flex items-center text-slate-500">
             <span class="mr-2">Rate:</span>
             <span class="font-bold text-slate-700">{{ tempTrip.exchangeRate ? tempTrip.exchangeRate.toFixed(2) : '?' }}</span>
           </div>
        </div>
        
        <button @click="saveTrip" class="w-full bg-primary text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-primary/30 mt-2 hover:scale-[1.02] transition">儲存</button>
      </div>
    </div>
  </div>

  <nav class="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[85%] max-w-sm capsule-tab rounded-full p-2 flex justify-between items-center z-[100]">
    <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
            class="w-14 h-14 rounded-full flex flex-col items-center justify-center transition-all duration-300 relative"
            :class="activeTab === tab.id ? 'bg-primary text-white shadow-lg -translate-y-2' : 'text-slate-400'">
      <i :class="[tab.icon, 'text-xl']"></i>
      <span v-if="activeTab === tab.id" class="text-[9px] font-bold mt-0.5 absolute -bottom-5 text-primary bg-white/80 px-2 py-0.5 rounded-full shadow-sm whitespace-nowrap">{{ tab.label }}</span>
    </button>
  </nav>

</div>

<script>
  const { createApp } = Vue;
  // **注意: 請將此替換為您實際的 AviationStack Key**
  const AVIATIONSTACK_KEY = '5bxxxxxxxxx'; 
  
  const GeocodingCache = {};

  createApp({
    data() {
      return {
        activeTab: 'info',
        trips: [],
        activeTripId: null,
        showTripModal: false,
        editingTripId: null,
        tempTrip: {},
        map: null,
        weatherData: null,
        weatherTheme: 'sunny',
        showBatchImport: false,
        batchImportText: '',
        
        chartInstance: null,
        
        newExpense: { 
          id: null, 
          name: '', 
          localAmount: null, 
          amount: null,      
          method: '現金', 
          category: '飲食', 
          day: 1, 
        },
        inputCurrency: '', 
        
        newShoppingItem: { 
            name: '', 
            onlinePrice: null, // 預計為 HKD
            localPrice: null,  // 預計為當地幣別金額
            quantity: 1,       // 數量欄位
            bought: false, 
            image: '' 
        },
        
        activeDay: 1, // 行程頁面專用

        tabs: [
          { id: 'info', label: 'Trip Info', icon: 'ri-information-line' },
          { id: 'itinerary-map', label: '行程', icon: 'ri-map-pin-user-line' },
          { id: 'budget', label: '記帳', icon: 'ri-wallet-3-line' },
          { id: 'shopping', label: '購物', icon: 'ri-shopping-bag-3-line' },
          { id: 'trips', label: 'History', icon: 'ri-suitcase-line' },
        ]
      };
    },
    computed: {
      activeTrip() { return this.trips.find(t => t.id === this.activeTripId) || null; },
      
      totalDays() {
          if (!this.activeTrip || !this.activeTrip.startDate || !this.activeTrip.endDate) return 1;
          const start = new Date(this.activeTrip.startDate);
          const end = new Date(this.activeTrip.endDate);
          const diffTime = Math.abs(end - start);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
          return diffDays > 0 ? diffDays : 1;
      },

      groupedItinerary() {
        if (!this.activeTrip) return [];
        
        const days = Array.from({ length: this.totalDays }, (_, i) => ({ day: i + 1, items: [] }));
        
        this.activeTrip.itinerary
            .sort((a, b) => (a.day || 1) - (b.day || 1)) 
            .forEach(item => {
                const dayIndex = (item.day || 1) - 1; 
                if (dayIndex >= 0 && dayIndex < days.length) { 
                    days[dayIndex].items.push(item);
                }
            });
            
        days.forEach(day => {
             day.items.sort((a, b) => {
                 const timeA = a.time ? a.time.replace(':', '') : '9999';
                 const timeB = b.time ? b.time.replace(':', '') : '9999';
                 return timeA - timeB;
             });
        });
        
        return days;
      },
      
      filteredExpenses() {
          if (!this.activeTrip || !this.activeTrip.expenses) {
              return [];
          }
          return this.activeTrip.expenses; 
      },

      totalExpensesHKD() {
        if (!this.activeTrip) return 0;
        return this.filteredExpenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
      },

      weatherDesc() {
        if (!this.weatherData) return 'Loading...';
        const code = this.weatherData.weathercode;
        const map = { 0:'晴朗 Sunny', 1:'多雲 Cloudy', 2:'陰天 Overcast', 3:'毛毛雨 Drizzle', 45:'霧 Fog', 48:'霧淞 Rime fog', 51:'毛毛雨 Drizzle', 53:'小雨 Light Rain', 55:'大雨 Heavy Rain', 61:'陣雨 Rain', 63:'中雨 Moderate Rain', 65:'大雨 Heavy Rain', 80:'陣雨 Showers', 81:'中度陣雨 Moderate Showers', 82:'強烈陣雨 Violent Showers', 95:'雷暴 Thunderstorm' };
        return map[code] || '多雲 Cloudy';
      },
      
      finalHKDAmount() {
          const amount = this.newExpense.localAmount;
          if (!this.activeTrip || !amount || amount <= 0) {
              return 0;
          }
          
          if (this.inputCurrency === 'HKD') {
              return amount;
          }
          
          const rate = this.activeTrip.exchangeRate;
          if (!rate || rate <= 0) return 0;
          
          return (amount / rate);
      },
      
      categorySummary() {
          if (!this.activeTrip || !this.filteredExpenses) {
              return { labels: [], data: [] };
          }
          const summary = this.filteredExpenses.reduce((acc, expense) => {
              const category = expense.category || '其他';
              const amount = Number(expense.amount) || 0;
              acc[category] = (acc[category] || 0) + amount;
              return acc;
          }, {});
          
          const labels = Object.keys(summary);
          const data = Object.values(summary).map(val => parseFloat(val.toFixed(2)));
          
          return { labels, data };
      },

      paymentSummary() {
          const summary = { '現金': 0, '信用卡': 0, '其他': 0 };
          if (!this.activeTrip) return summary;

          this.filteredExpenses.forEach(exp => {
              const method = exp.method || '現金'; 
              const amount = Number(exp.amount) || 0;
              if (summary.hasOwnProperty(method)) {
                  summary[method] += amount;
              } else {
                  summary['其他'] += amount; 
              }
          });

          summary['現金'] = parseFloat(summary['現金'].toFixed(2));
          summary['信用卡'] = parseFloat(summary['信用卡'].toFixed(2));
          summary['其他'] = parseFloat(summary['其他'].toFixed(2));

          return summary;
      },
      
      activeBudgetDayText() {
          return '所有'; 
      },

      groupedAndSortedExpenses() {
          if (!this.activeTrip || !this.activeTrip.expenses || this.activeTrip.expenses.length === 0) return [];

          const expenses = this.activeTrip.expenses.slice() 
              .sort((a, b) => (a.day === undefined ? 1 : a.day) - (b.day === undefined ? 1 : b.day));

          const result = [];
          
          const daysGrouped = expenses.reduce((acc, exp) => {
              const day = exp.day === undefined ? 1 : exp.day;
              if (!acc[day]) {
                  acc[day] = [];
              }
              acc[day].push(exp);
              return acc;
          }, {});

          const sortedDays = Object.keys(daysGrouped).map(Number).sort((a, b) => a - b);
          
          for (const day of sortedDays) {
              const dayExpenses = daysGrouped[day];
              
              const total = dayExpenses.reduce((sum, exp) => sum + (Number(exp.amount) || 0), 0);
              
              result.push({
                  isHeader: true,
                  day: day,
                  dayLabel: day === 0 ? '旅行前 (Day 0)' : `Day ${day}`,
                  total: parseFloat(total.toFixed(2)),
                  id: `header-${day}`
              });

              result.push(...dayExpenses);
          }

          return result;
      },

      shoppingListWithSavings() {
          if (!this.activeTrip || !this.activeTrip.shoppingItems) return [];
          const rate = this.activeTrip.exchangeRate || 1; // 1 HKD = X 外幣

          const processedList = this.activeTrip.shoppingItems.map(item => {
              // 確保 quantity, localPrice, onlinePrice 是有效數字
              const quantity = Math.max(1, Number(item.quantity) || 1);
              const localPrice = Number(item.localPrice) || 0;
              const onlinePrice = Number(item.onlinePrice) || 0;
              
              // 1. 計算當地價換算成 HKD 的總額 (單價 / 匯率 * 數量)
              // 只有當 localPrice 和 rate > 0 時才計算
              const localPriceHKD = (localPrice > 0 && rate > 0) 
                  ? parseFloat(((localPrice / rate) * quantity).toFixed(2)) 
                  : 0;
              
              // 2. 計算網上價 HKD 的總額
              const onlinePriceHKD = onlinePrice * quantity;
              
              // 3. 計算總共節省的金額 (網上價 - 當地價換算 HKD)
              // 只有在兩種價格都存在時才計算價差
              const savingsHKD = (localPriceHKD > 0 && onlinePriceHKD > 0) 
                  ? parseFloat((onlinePriceHKD - localPriceHKD).toFixed(2))
                  : 0;

              return {
                  ...item,
                  quantity: quantity,
                  localPriceHKD: localPriceHKD, // 0.00 or actual price
                  onlinePriceHKD: parseFloat(onlinePriceHKD.toFixed(2)),
                  savingsHKD: savingsHKD,
              };
          });
          
          // 排序邏輯：未買的在前，其次按節省金額降序
          return processedList.sort((a, b) => {
              if (a.bought === b.bought) {
                  return b.savingsHKD - a.savingsHKD; // 未買的則按節省金額降序
              }
              return a.bought ? 1 : -1; // false (0) < true (1)，所以未買的在前
          });
      },

      totalSavings() {
          return this.shoppingListWithSavings.reduce((sum, item) => sum + item.savingsHKD, 0);
      }
    },
    watch: {
      activeTab(newTab) {
        if (newTab === 'itinerary-map') {
          setTimeout(() => this.forceUpdateMap(), 500);
        } else if (newTab === 'budget') { 
          this.$nextTick(() => this.updateChart());
        }
      },
      activeTripId() {
        this.fetchWeather();
        this.activeDay = 1; 
        if (this.activeTrip) {
            this.inputCurrency = this.activeTrip.currency; 
            this.newExpense.day = 1; 
            this.newExpense.category = '飲食'; 
        }
        this.updateChart(); 
      },
      activeDay() {
        this.forceUpdateMap();
      },
      
      categorySummary: {
          handler() {
              this.updateChart();
          },
          deep: true
      }
    },
    mounted() {
      this.loadData();
      if (this.activeTrip) {
          this.inputCurrency = this.activeTrip.currency;
          this.newExpense.day = 1;
          this.newExpense.category = '飲食'; 
      }
    },
    methods: {
      selectDay(day) {
          this.activeDay = day;
      },
      
      saveData() { 
          localStorage.setItem('christine_travel_diary_v4', JSON.stringify(this.trips)); 
          this.updateChart(); 
      },
      loadData() {
        const saved = localStorage.getItem('christine_travel_diary_v4');
        if (saved) {
          const parsedTrips = JSON.parse(saved).map(trip => {
              // ... (Expenses and Itinerary loading logic remains the same)
              if (trip.expenses) {
                  trip.expenses = trip.expenses.map(exp => ({ 
                      id: exp.id || Date.now() + Math.random(), 
                      amount: exp.amount || 0,
                      day: exp.day === undefined ? 1 : exp.day, 
                      ...exp 
                  }));
              } else {
                  trip.expenses = [];
              }
              if (trip.itinerary) {
                  trip.itinerary = trip.itinerary.map(item => ({ 
                      id: item.id || Date.now() + Math.random(), 
                      day: item.day || 1, 
                      mapLink: item.mapLink || '', 
                      ...item 
                  }));
              } else {
                  trip.itinerary = [];
              }
              
              // **更新**: 確保 shoppingItems 欄位存在，且包含新欄位
              if (trip.shoppingItems) {
                  trip.shoppingItems = trip.shoppingItems.map(item => ({
                      id: item.id || Date.now() + Math.random(),
                      quantity: item.quantity || 1, 
                      localPrice: item.localPrice || null, 
                      onlinePrice: item.onlinePrice || null, 
                      bought: item.bought || false, // 確保 bought 欄位存在
                      ...item
                  }));
              } else {
                  trip.shoppingItems = [];
              }

              return trip;
          });
          this.trips = parsedTrips;
        } else {
          // 初始數據
          const defaultItinerary = [{ id: Date.now(), day: 1, time: '10:00', activity: '到達機場', location: 'Narita Airport', mapLink: '' }];
          this.trips = [{
            id: Date.now(), title: 'Japan Trip', destination: 'Japan', city: 'Tokyo', currency: 'JPY',
            startDate: '2025-12-24', endDate: '2025-12-28',
            center: { lat: 35.6895, lng: 139.6917 }, exchangeRate: 19.2,
            flights: { outbound: { no: 'CX500', date: '2025-12-24' }, inbound: { no: 'CX501', date: '2025-12-28' } },
            itinerary: defaultItinerary, 
            expenses: [{ id: Date.now()+1, name: '機票', amount: 3500, method: '信用卡', category: '旅行前', date: '12/10', day: 0, localAmount: 67200 }], 
            shoppingItems: [
                { id: Date.now()+2, name: '防曬霜', onlinePrice: 200, localPrice: 3000, quantity: 2, bought: false, image: '' },
                { id: Date.now()+3, name: '手信餅乾', onlinePrice: 150, localPrice: 2500, quantity: 3, bought: true, image: '' },
            ]
          }];
          this.saveData();
        }
        this.activeTripId = this.trips.length > 0 ? this.trips[0].id : null;
        if (this.activeTripId) {
          this.fetchWeather();
          this.newExpense.day = 1;
          this.inputCurrency = this.activeTrip.currency; 
        }
      },
      
      calculateTripTotal(trip) {
        if (!trip.expenses) return 0;
        return trip.expenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
      },
      
      calculateDayTotal(dayIndex) {
          if (!this.activeTrip || !this.activeTrip.expenses) return 0;
          const total = this.activeTrip.expenses
                     .filter(exp => (exp.day === undefined ? 1 : exp.day) === dayIndex) 
                     .reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
          return parseFloat(total.toFixed(2));
      },
      
      // === API 功能 (保持不變) ===
      async autoGeocode() {
        if (!this.tempTrip.city) return alert('請先輸入城市名稱 (City)');
        
        try {
          const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${this.tempTrip.city},${this.tempTrip.destination || ''}&addressdetails=1&limit=1`);
          const geoData = await geoRes.json();
          if (!geoData || geoData.length === 0) {
            return alert('找不到該城市，請檢查拼字。');
          }
          const location = geoData[0];
          this.tempTrip.center = { lat: parseFloat(location.lat), lng: parseFloat(location.lon) };
          if(location.address && location.address.country) {
             this.tempTrip.destination = location.address.country;
          }
          let currencyCode = 'USD';
          const countryCode = location.address?.country_code?.toUpperCase(); 
          if (countryCode) {
            try {
              const countryRes = await fetch(`https://restcountries.com/v3.1/alpha/${countryCode}`);
              const countryData = await countryRes.json();
              if (countryData[0]?.currencies) {
                currencyCode = Object.keys(countryData[0].currencies)[0];
                this.tempTrip.currency = currencyCode;
              }
            } catch (err) { console.error("Currency fetch fail", err); }
          }
          try {
             const rateRes = await fetch(`https://open.er-api.com/v6/latest/HKD`);
             const rateData = await rateRes.rates;
             if (rateData && rateData[currencyCode]) {
                this.tempTrip.exchangeRate = rateData[currencyCode];
             }
          } catch (err) { console.error("Rate fetch fail", err); }
          alert(`成功！\n座標: ${location.lat}, ${location.lon}\n國家: ${this.tempTrip.destination}\n貨幣: ${currencyCode}\n匯率: 1 HKD ≈ ${this.tempTrip.exchangeRate.toFixed(2)} ${currencyCode}`);
        } catch (e) {
          console.error(e);
          alert('自動取得失敗，請稍後再試。');
        }
      },
      async fetchFlight(type) {
        const flight = this.activeTrip.flights[type];
        if(!flight.no || !flight.date) return alert('請先輸入航班號 (如 NH924) 與日期');
        if(AVIATIONSTACK_KEY === '5b729556e3ef80e18916fcecbcfd81ba') return alert('請將 AVIATIONSTACK_KEY 替換為您的有效 Key，目前使用模擬數據！');
        
        try {
          const res = await fetch(`https://api.aviationstack.com/v1/flights?access_key=${AVIATIONSTACK_KEY}&flight_iata=${flight.no}&flight_date=${flight.date}`);
          const data = await res.json();
          if (data.data && data.data.length > 0) {
            const f = data.data[0]; 
            flight.from = f.departure.iata;
            flight.to = f.arrival.iata;
            flight.depTime = f.departure.scheduled ? f.departure.scheduled.slice(11,16) : '--:--';
            flight.arrTime = f.arrival.scheduled ? f.arrival.scheduled.slice(11,16) : '--:--';
            this.saveData();
            alert(`已更新航班: ${flight.from} -> ${flight.to}`);
          } else {
            alert('未找到航班資料，請確認 API Key、航班號與日期。');
             this.mockFlightData(type);
          }
        } catch(e) {
          console.error(e);
          alert('API 請求失敗，請檢查 Key 是否正確或網路連線。使用模擬數據。');
          this.mockFlightData(type);
        }
      },
      mockFlightData(type) {
          const flight = this.activeTrip.flights[type];
          const isOutbound = type === 'outbound';
          flight.from = isOutbound ? 'HKG' : 'NRT';
          flight.to = isOutbound ? 'NRT' : 'HKG';
          flight.depTime = isOutbound ? '09:00' : '14:30';
          flight.arrTime = isOutbound ? '14:30' : '20:30';
          this.saveData();
      },
      async fetchWeather() {
        if(!this.activeTrip?.center) return;
        try {
          const {lat,lng} = this.activeTrip.center;
          const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&timezone=auto`);
          const d = await res.json();
          this.weatherData = d.current_weather;
          
          const code = d.current_weather.weathercode;
          if (code < 3) { this.weatherTheme = 'sunny'; } 
          else if (code >= 51 && code < 80) { this.weatherTheme = 'rainy'; } 
          else { this.weatherTheme = 'cloudy'; } 
          
        } catch(e){
          console.error("Weather fetch failed", e);
          this.weatherData = { temperature: 20 + Math.floor(Math.random()*5), weathercode: 1 };
          this.weatherTheme = 'sunny';
        }
      },

      // === 記帳功能 (保持不變) ===
      addExpense() {
        if(!this.newExpense.name || !this.newExpense.localAmount || this.finalHKDAmount === 0) {
            return alert('請輸入消費項目和有效的金額');
        }
        
        if (this.newExpense.category === '旅行前') {
            this.newExpense.day = 0; 
        } else if (!this.newExpense.day || this.newExpense.day === 0) {
             if (this.newExpense.category !== '旅行前') {
                 this.newExpense.day = 1;
             }
        }

        const d = new Date();
        
        this.newExpense.amount = this.finalHKDAmount; 

        this.activeTrip.expenses.unshift({ 
            id: Date.now() + Math.random(), 
            name: this.newExpense.name,
            amount: this.newExpense.amount,
            method: this.newExpense.method,
            category: this.newExpense.category,
            localAmount: this.newExpense.localAmount, 
            date: `${d.getMonth()+1}/${d.getDate()}`,
            day: this.newExpense.day, 
        });
        
        this.newExpense = { 
            name:'', 
            localAmount:null, 
            amount:null, 
            method:'現金', 
            category:'飲食', 
            day: 1
        };
        this.inputCurrency = this.activeTrip.currency; 
        this.saveData();
      },
      removeExpense(expenseId) {
        if(confirm('確認刪除這筆消費嗎？')) {
            const index = this.activeTrip.expenses.findIndex(exp => exp.id === expenseId);
            if (index !== -1) {
                this.activeTrip.expenses.splice(index, 1);
                this.saveData();
            }
        }
      },

      exportExpensesToCSV() {
          if (!this.activeTrip || !this.activeTrip.expenses.length) {
              return alert('目前沒有消費記錄可以匯出！');
          }
          
          const trip = this.activeTrip;
          
          const expensesToExport = this.activeTrip.expenses
              .slice() 
              .sort((a, b) => (a.day === undefined ? 1 : a.day) - (b.day === undefined ? 1 : b.day)); 

          if (expensesToExport.length === 0) {
              return alert(`暫無消費記錄可以匯出！`);
          }

          const headers = [
              "Day", "日期", "項目", "類別", "支付方式", 
              `當地金額 (${trip.currency})`, "匯率 (1 HKD = X)", 
              "港幣金額 (HKD)"
          ];
          
          const rows = expensesToExport.map(exp => [
              exp.day === 0 ? '旅行前' : exp.day || 1, 
              exp.date || '',
              exp.name || '',
              exp.category || '',
              exp.method || '',
              (exp.localAmount || 0).toFixed(2),
              (trip.exchangeRate || 1).toFixed(2),
              (exp.amount || 0).toFixed(2) 
          ]);
          
          const csvContent = [
              headers.join(','),
              ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
          ].join('\n');
          
          const encodedUri = encodeURI("data:text/csv;charset=utf-8,\uFEFF" + csvContent);
          const link = document.createElement("a");
          
          const fileName = `${trip.title}_All_Expenses_${new Date().toISOString().split('T')[0]}.csv`;
          
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", fileName);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          alert(`「${fileName}」匯出成功！`);
      },

      updateChart() {
          if (this.activeTab !== 'budget') return;
          
          const summary = this.categorySummary;
          const ctx = document.getElementById('expenseChart');
          
          if (!ctx) return;

          const categoryColors = {
              '飲食': '#FFD9EC', 
              '購物': '#C7C7E2', 
              '交通': '#97CBFF',
              '娛樂': '#A4D8B9', 
              '其他': '#F5E6CC',
              '旅行前': '#8A2BE2', 
          };
          
          const backgroundColors = summary.labels.map(label => 
              categoryColors[label] || '#97CBFF'
          );


          const chartData = {
              labels: summary.labels,
              datasets: [{
                  data: summary.data,
                  backgroundColor: backgroundColors,
                  hoverOffset: 10,
                  borderWidth: 0,
              }]
          };

          if (this.chartInstance) {
              this.chartInstance.data = chartData;
              this.chartInstance.update();
          } else {
              this.chartInstance = new Chart(ctx, {
                  type: 'doughnut',
                  data: chartData,
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                          legend: {
                              position: 'bottom',
                              labels: {
                                  usePointStyle: true,
                                  boxWidth: 8,
                                  padding: 15,
                              }
                          },
                          tooltip: {
                              callbacks: {
                                  label: (context) => {
                                      let label = context.label || '';
                                      if (label) { label += ': '; }
                                      if (context.parsed !== null) {
                                          const total = summary.data.reduce((a, b) => a + b, 0);
                                          const percentage = (context.parsed * 100 / total).toFixed(1);
                                          label += `${context.parsed.toFixed(2)} HKD (${percentage}%)`;
                                      }
                                      return label;
                                  }
                              }
                          }
                      }
                  }
              });
          }
      },
      
      // === 購物功能 ===
      handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 1024 * 1024) return alert('圖片請小於 1MB');
        const reader = new FileReader();
        reader.onload = (evt) => { this.newShoppingItem.image = evt.target.result; };
        reader.readAsDataURL(file);
      },
      addShoppingItem() {
        if(!this.newShoppingItem.name) return alert('請輸入品名');
        
        // 允許價格為空
        const onlinePrice = Number(this.newShoppingItem.onlinePrice);
        const localPrice = Number(this.newShoppingItem.localPrice);

        this.activeTrip.shoppingItems.unshift({ 
            id: Date.now() + Math.random(), 
            onlinePrice: isNaN(onlinePrice) ? null : onlinePrice,
            localPrice: isNaN(localPrice) ? null : localPrice,
            quantity: Math.max(1, Number(this.newShoppingItem.quantity) || 1),
            bought: this.newShoppingItem.bought, 
            name: this.newShoppingItem.name,
            image: this.newShoppingItem.image
        }); 
        
        // 重置欄位
        this.newShoppingItem = { name: '', onlinePrice: null, localPrice: null, quantity: 1, bought: false, image: '' };
        this.saveData();
      },
      
      // **關鍵修復 V4: 採用 Vue 響應式最佳實踐 (splice 替換新物件) 以確保畫面更新**
      toggleBought(item) {
          if (!item || !this.activeTrip) return;

          // 1. 找到該 item 在 shoppingItems 陣列中的確切索引
          const index = this.activeTrip.shoppingItems.findIndex(i => i.id === item.id);
          
          if (index !== -1) {
              // 2. 更改 bought 狀態
              const newBoughtState = !item.bought;

              // 3. 創建一個新的物件來替換舊的，確保 Vue 偵測到變化
              const newItem = { ...item, bought: newBoughtState };
              
              // 4. 使用 splice 替換舊物件
              this.activeTrip.shoppingItems.splice(index, 1, newItem);
              
              this.saveData(); 
              
              // 5. 確保總覽頁面等依賴也被觸發 (非必要，但能提高穩定性)
              this.trips = [...this.trips]; 
          }
      },
      removeShoppingItem(itemId) {
        if(confirm('確認刪除此購物項目嗎？')) {
            const index = this.activeTrip.shoppingItems.findIndex(item => item.id === itemId);
            if (index !== -1) {
                this.activeTrip.shoppingItems.splice(index, 1);
                this.saveData();
            }
        }
      },

      // === 地圖/行程功能 (保持不變) ===
      openGoogleMaps(item) { 
          if (item.mapLink && item.mapLink.trim()) {
              const url = item.mapLink.trim();
              if (url.startsWith('http')) {
                  window.open(url, '_blank');
              } else {
                  this.searchGoogleMaps(url);
              }
          } 
          else if (item.location && item.location.trim()) {
              this.searchGoogleMaps(item.location);
          } else {
              alert('請輸入地點名稱或貼上 Google Map 連結。');
          }
      },
      
      searchGoogleMaps(query) {
          window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank'); 
      },

      mapMarkers: L.layerGroup(),
      mapPolyline: null, 
      
      forceUpdateMap() {
        if (this.activeTab !== 'itinerary-map') return;
        try {
          const container = document.getElementById('map');
          if (!container) return;
          if (this.map) { this.map.off(); this.map.remove(); }
          
          const center = this.activeTrip.center ? [this.activeTrip.center.lat, this.activeTrip.center.lng] : [35.6895, 139.6917];
          
          this.map = L.map('map', { zoomControl: false }).setView(center, 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(this.map);
          this.mapMarkers.clearLayers();
          this.mapMarkers.addTo(this.map);
          this.mapPolyline = L.polyline([], {color: '#97CBFF', weight: 4, opacity: 0.8, dashArray: '5, 10'}).addTo(this.map);
          
          this.updateMapMarkers(); 
          setTimeout(() => { this.map.invalidateSize(); }, 100);
        } catch (e) { console.error("Map init fail", e); }
      },
      
      async geocodeLocation(location) {
          if (GeocodingCache[location]) return GeocodingCache[location];
          
          try {
              const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`);
              const data = await res.json();
              if (data && data.length > 0) {
                  const coords = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                  GeocodingCache[location] = coords;
                  return coords;
              }
          } catch (e) {
              console.warn(`Geocoding failed for: ${location}. Error: ${e}. Route may not be drawn.`);
          }
          
          if (this.activeTrip.center) {
              return {
                  lat: this.activeTrip.center.lat + (Math.random() - 0.5) * 0.005,
                  lng: this.activeTrip.center.lng + (Math.random() - 0.5) * 0.005,
              };
          }
          return null; 
      },

      async updateMapMarkers() {
          if (!this.map || !this.activeTrip?.itinerary) return;
          this.mapMarkers.clearLayers();
          
          const currentDayItems = this.activeTrip.itinerary
              .filter(item => (item.day || 1) === this.activeDay && item.location) 
              .sort((a, b) => {
                  const timeA = a.time ? a.time.replace(':', '') : '9999';
                  const timeB = b.time ? b.time.replace(':', '') : '9999';
                  return timeA - timeB;
              });
          
          let lineCoords = [];
          let markers = [];
          
          for (let index = 0; index < currentDayItems.length; index++) {
              const item = currentDayItems[index];
              const fullLocation = item.location + ', ' + this.activeTrip.city + ', ' + this.activeTrip.destination; 
              const coords = await this.geocodeLocation(fullLocation);

              if (coords) {
                  lineCoords.push([coords.lat, coords.lng]); 

                  const marker = L.marker([coords.lat, coords.lng], {
                      icon: L.divIcon({
                          className: 'custom-div-icon',
                          html: `<div style="background-color:#97CBFF; color:white; border-radius:50%; width:24px; height:24px; line-height:24px; text-align:center; font-weight:bold;">${index + 1}</div>`,
                          iconSize: [24, 24],
                          iconAnchor: [12, 12]
                      })
                  }).bindPopup(`<b>Day ${item.day || 1} - ${item.location}</b><br>${item.activity}`);
                  markers.push(marker);
              }
          }

          markers.forEach(marker => this.mapMarkers.addLayer(marker));
          
          if (this.mapPolyline) {
              this.mapPolyline.setLatLngs(lineCoords);
          }
          
          if (this.mapMarkers.getLayers().length > 0) {
            this.map.fitBounds(this.mapMarkers.getBounds(), { padding: [50, 50] });
          } else if (this.activeTrip.center) {
             this.map.setView([this.activeTrip.center.lat, this.activeTrip.center.lng], 13);
          }
      },
      
      addItineraryItem(day) { 
          this.activeTrip.itinerary.push({ 
              id: Date.now() + Math.random(), 
              day: day, 
              time: '10:00', 
              activity: '', 
              location: '',
              mapLink: '' 
          }); 
          this.saveData(); 
          this.forceUpdateMap();
      },
      
      removeItineraryItem(itemId) { 
          if(confirm('確認刪除此行程項目嗎？')) {
              const index = this.activeTrip.itinerary.findIndex(item => item.id === itemId);
              if(index !== -1) {
                  this.activeTrip.itinerary.splice(index, 1);
                  this.saveData(); 
                  this.forceUpdateMap();
              }
          }
      },
      
      runBatchImport() {
        if(!this.batchImportText) return alert('請貼上內容');
        const lines = this.batchImportText.split('\n').filter(line => line.trim() !== '');
        
        const newItems = lines.map(line => {
            const parts = line.split(',');
            const dayNum = parseInt(parts[0]) || 1; 
            return {
                id: Date.now() + Math.random(), 
                day: dayNum > this.totalDays ? this.totalDays : dayNum,
                time: parts[1] ? parts[1].trim() : 'N/A',
                mapLink: '', 
                activity: parts[2] ? parts[2].trim() : '活動',
                location: parts[3] ? parts[3].trim() : ''
            };
        });
        
        this.activeTrip.itinerary.push(...newItems);
        this.saveData();
        this.showBatchImport = false;
        this.batchImportText = '';
        this.forceUpdateMap(); 
        alert(`成功匯入 ${newItems.length} 條行程！`);
      },


      // === 旅程管理功能 (保持不變) ===
      openNewTripModal() { 
        this.editingTripId = null; 
        this.tempTrip = {
            title:'', city:'', destination:'', currency:'JPY', exchangeRate:19.2, 
            center:{lat:35.6,lng:139.6}, 
            startDate: new Date().toISOString().split('T')[0], 
            endDate: new Date().toISOString().split('T')[0]
        }; 
        this.showTripModal = true; 
      },
      openEditTripModal(trip) { this.editingTripId = trip.id; this.tempTrip = JSON.parse(JSON.stringify(trip)); this.showTripModal = true; },
      saveTrip() {
        if (!this.tempTrip.title) return;
        if (this.editingTripId) {
          const idx = this.trips.findIndex(t => t.id === this.editingTripId);
          this.trips[idx] = { ...this.trips[idx], ...this.tempTrip };
        } else {
          const center = this.tempTrip.center || {lat:35.6, lng:139.6};
          const newTrip = { 
            id: Date.now(), 
            ...this.tempTrip, 
            center: center, 
            flights:{outbound:{},inbound:{}}, 
            itinerary:[], 
            expenses:[], 
            shoppingItems:[] 
          };
          this.trips.unshift(newTrip); 
          this.activeTripId = newTrip.id;
        }
        this.saveData();
        this.showTripModal = false;
        
        this.$nextTick(() => {
            this.activeDay = 1;
            this.newExpense.day = 1; 
            this.newExpense.category = '飲食'; 
            this.inputCurrency = this.activeTrip.currency;
            this.updateChart();
        });
      },
      deleteTrip(id) {
        if(this.trips.length<=1) return alert('不能刪除最後一個旅程');
        if(confirm('確認刪除?')) {
          this.trips = this.trips.filter(t=>t.id!==id);
          this.activeTripId = this.trips[0].id;
          this.saveData();
        }
      },
      switchTrip(id) { 
        this.activeTripId = id; 
        this.activeTab = 'info'; 
        this.$nextTick(() => {
            this.activeDay = 1;
            this.newExpense.day = 1; 
            this.newExpense.category = '飲食'; 
            this.inputCurrency = this.activeTrip.currency;
            this.updateChart();
        });
      },
    }
  }).mount('#app');
</script>
</body>
</html>
