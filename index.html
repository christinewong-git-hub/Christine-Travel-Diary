<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Christine's Travel Diary</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#97CBFF',
            secondary: '#C7C7E2',
            textSoft: '#6B7280',
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-out',
            'slide-up': 'slideUp 0.3s ease-out'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
          }
        }
      }
    }
  </script>
  
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
   integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
   crossorigin=""/>
  
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
   integrity="sha256-20n6ef7Xz+I4/I7o8kI5h7x9+8K1qj+Y9rK1jS7S+g="
   crossorigin=""></script>

  <style>
    body {
      background: linear-gradient(135deg, #C4E1FF 0%, #D2E9FF 33%, #DDDDFF 66%, #FFECF5 100%);
      background-attachment: fixed;
      font-family: system-ui, -apple-system, sans-serif;
      color: #1f2937;
      padding-bottom: 110px; 
      -webkit-tap-highlight-color: transparent;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.07);
      border-radius: 24px;
    }

    /* ç²‰æ·ºè—å¤©èƒŒæ™¯ - Flight Details */
    .flight-sky { 
      background: linear-gradient(180deg, #C4E1FF 0%, #D6EFFF 100%); 
      position: relative;
      overflow: hidden;
    }
    
    /* ç§»é™¤ #map çš„å›ºå®šæ¨£å¼ï¼Œå› ç‚ºåœ°åœ–ç¾åœ¨åœ¨å¡ç‰‡å…§ */
    /* #map { height: 350px; width: 100%; border-radius: 16px; z-index: 0; position: relative; } */

    .capsule-tab {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
      z-index: 999; 
    }
    
    /* å¤§å¡ç‰‡ Trips */
    .trip-card-active {
      background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%);
      border: 2px solid #97CBFF;
      transform: scale(1.02);
      box-shadow: 0 10px 30px rgba(151, 203, 255, 0.4);
    }
    
    /* Weather Themes */
    .weather-sunny { background: linear-gradient(135deg, #FFECF5 0%, #FFD9EC 40%, #ECECFF 100%); }
    .weather-cloudy { background: linear-gradient(135deg, #DDDDFF 0%, #E6E6F2 40%, #D8D8EB 100%); }
    .weather-rainy { background: linear-gradient(135deg, #D8D8EB 0%, #E6E6F2 35%, #C4E1FF 100%); }
  </style>
</head>
<body>

<div id="app" class="min-h-screen">
  
  <header class="fixed top-0 left-0 w-full p-6 z-50 flex items-center justify-between pointer-events-none">
    <div class="flex items-center gap-2 pointer-events-auto bg-white/30 backdrop-blur-sm pr-4 py-1 rounded-full">
      <div class="bg-primary/20 p-2 rounded-full"><i class="ri-plane-fill text-xl text-primary"></i></div>
      <h1 class="text-lg font-bold text-slate-700 tracking-wide">Christine's Diary</h1>
    </div>
    <button @click="openNewTripModal" class="pointer-events-auto w-10 h-10 rounded-full bg-white/90 backdrop-blur shadow-lg text-primary flex items-center justify-center hover:scale-110 transition active:scale-95">
      <i class="ri-add-line text-xl"></i>
    </button>
  </header>

  <main class="pt-24 px-4 max-w-3xl mx-auto pb-8">
    
    <section v-if="activeTab === 'info' && activeTrip" class="animate-fade-in space-y-5">
      
      <div class="glass-card overflow-hidden shadow-lg border-0">
        <div class="flight-sky p-6 relative">
          <i class="ri-cloud-fill absolute top-4 right-8 text-white/60 text-5xl opacity-80"></i>
          <i class="ri-cloud-fill absolute bottom-6 left-6 text-white/40 text-3xl opacity-60"></i>
          
          <h2 class="text-slate-700 font-bold text-lg mb-5 flex items-center gap-2 relative z-10">
            <span class="bg-white/50 p-1.5 rounded-full"><i class="ri-flight-takeoff-line"></i></span> 
            èˆªç­è³‡è¨Š
          </h2>
          
          <div class="bg-white/60 backdrop-blur-md rounded-2xl p-4 mb-3 relative z-10 shadow-sm">
            <div class="flex justify-between items-center mb-2">
              <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider bg-white/50 px-2 py-0.5 rounded-full">å»ç¨‹ Outbound</span>
              <button @click="fetchFlight('outbound')" class="text-[10px] bg-white px-3 py-1 rounded-full text-primary font-bold shadow-sm active:scale-95 transition">è‡ªå‹•å¡«å¯«</button>
            </div>
            <div class="flex gap-2 mb-3">
               <input v-model="activeTrip.flights.outbound.no" placeholder="èˆªç­è™Ÿ (e.g. NH924)" class="w-1/2 p-2 rounded-xl text-sm bg-white/50 border-0 text-center font-mono placeholder:text-slate-400 focus:bg-white transition">
               <input v-model="activeTrip.flights.outbound.date" type="date" class="w-1/2 p-2 rounded-xl text-sm bg-white/50 border-0 focus:bg-white transition">
            </div>
            <div class="flex justify-between text-sm font-bold text-slate-800 px-4 py-1">
               <div class="text-center">
                 <div class="text-2xl font-black text-slate-700">{{ activeTrip.flights.outbound.from || 'HKG' }}</div>
                 <div class="text-xs text-slate-500 mt-1">{{ activeTrip.flights.outbound.depTime || '--:--' }}</div>
               </div>
               <i class="ri-flight-takeoff-line text-slate-400 text-xl self-center mx-2"></i>
               <div class="text-center">
                 <div class="text-2xl font-black text-slate-700">{{ activeTrip.flights.outbound.to || 'NRT' }}</div>
                 <div class="text-xs text-slate-500 mt-1">{{ activeTrip.flights.outbound.arrTime || '--:--' }}</div>
               </div>
            </div>
          </div>

          <div class="bg-white/60 backdrop-blur-md rounded-2xl p-4 relative z-10 shadow-sm">
            <div class="flex justify-between items-center mb-2">
              <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider bg-white/50 px-2 py-0.5 rounded-full">å›ç¨‹ Inbound</span>
              <button @click="fetchFlight('inbound')" class="text-[10px] bg-white px-3 py-1 rounded-full text-primary font-bold shadow-sm active:scale-95 transition">è‡ªå‹•å¡«å¯«</button>
            </div>
            <div class="flex gap-2 mb-3">
               <input v-model="activeTrip.flights.inbound.no" placeholder="èˆªç­è™Ÿ (e.g. NH923)" class="w-1/2 p-2 rounded-xl text-sm bg-white/50 border-0 text-center font-mono placeholder:text-slate-400 focus:bg-white transition">
               <input v-model="activeTrip.flights.inbound.date" type="date" class="w-1/2 p-2 rounded-xl text-sm bg-white/50 border-0 focus:bg-white transition">
            </div>
             <div class="flex justify-between text-sm font-bold text-slate-800 px-4 py-1">
               <div class="text-center">
                 <div class="text-2xl font-black text-slate-700">{{ activeTrip.flights.inbound.from || 'NRT' }}</div>
                 <div class="text-xs text-slate-500 mt-1">{{ activeTrip.flights.inbound.depTime || '--:--' }}</div>
               </div>
               <i class="ri-flight-land-line text-slate-400 text-xl self-center mx-2"></i>
               <div class="text-center">
                 <div class="text-2xl font-black text-slate-700">{{ activeTrip.flights.inbound.to || 'HKG' }}</div>
                 <div class="text-xs text-slate-500 mt-1">{{ activeTrip.flights.inbound.arrTime || '--:--' }}</div>
               </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div :class="['glass-card p-5 flex flex-col justify-between relative overflow-hidden h-40', `weather-${weatherTheme}`]">
          <div class="relative z-10 h-full flex flex-col justify-between">
            <div class="flex justify-between items-start">
              <div>
                <span class="text-xs font-bold text-slate-500 block mb-1">{{ activeTrip.city || 'Location' }}</span>
                <i class="ri-sun-cloudy-line text-2xl text-slate-700"></i>
              </div>
              <button @click="fetchWeather" class="bg-white/40 rounded-full p-1.5 hover:bg-white/60 transition"><i class="ri-refresh-line text-xs"></i></button>
            </div>
            <div>
              <span class="text-4xl font-black text-slate-800 tracking-tight">{{ weatherData ? Math.round(weatherData.temperature) : '--' }}Â°</span>
              <p class="text-xs text-slate-600 font-medium mt-1">{{ weatherDesc }}</p>
            </div>
          </div>
        </div>
        
        <div class="glass-card p-5 flex flex-col justify-center items-center h-40">
          <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center mb-2">
            <i class="ri-wallet-3-line text-primary text-xl"></i>
          </div>
          <span class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">ç¸½èŠ±è²» (HKD)</span>
          <span class="text-2xl font-black text-slate-800 mt-1">{{ totalExpensesHKD.toLocaleString() }}</span>
          <div class="text-[10px] text-slate-400 mt-2 bg-slate-50 px-3 py-1 rounded-full">
            1 HKD â‰ˆ {{ (activeTrip.exchangeRate || 1).toFixed(2) }} {{ activeTrip.currency }}
          </div>
        </div>
      </div>
    </section>

    <section v-if="activeTab === 'itinerary-map' && activeTrip" class="animate-fade-in">
      
      <div class="sticky top-0 bg-white/95 backdrop-blur-sm z-10 p-4 -mx-4">
        <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide">
          <button @click="addItineraryItem" class="flex-shrink-0 bg-primary text-white px-5 py-3 rounded-2xl text-sm font-bold shadow-lg shadow-blue-200 hover:shadow-xl transition active:scale-95 flex items-center gap-2">
            <i class="ri-add-circle-fill text-lg"></i>æ–°å¢è¡Œç¨‹é …ç›®
          </button>
          <button @click="showBatchImport = !showBatchImport" class="flex-shrink-0 bg-white text-slate-600 px-5 py-3 rounded-2xl text-sm font-bold shadow-sm border border-slate-100 flex items-center gap-2">
            <i class="ri-file-list-3-line text-lg"></i>æ‰¹æ¬¡åŒ¯å…¥
          </button>
          <button @click="drawAllDayRoutes" class="flex-shrink-0 bg-white text-slate-600 px-5 py-3 rounded-2xl text-sm font-bold shadow-sm border border-slate-100 flex items-center gap-2">
            <i class="ri-route-line text-lg"></i>é‡ç¹ªè·¯ç·š
          </button>
        </div>
      </div>

      <div v-if="showBatchImport" class="glass-card p-4 mb-4 animate-slide-up">
        <textarea v-model="batchImportText" placeholder="è²¼ä¸Šåœ°é»æ¸…å–® (æ ¼å¼: æ™‚é–“, æ´»å‹•, åœ°é») ..." class="w-full h-32 p-3 rounded-xl bg-slate-50 border-0 text-sm mb-3 focus:ring-2 ring-primary/50"></textarea>
        <button @click="runBatchImport" class="w-full bg-secondary text-white py-2 rounded-xl font-medium">é–‹å§‹åŒ¯å…¥</button>
      </div>

      <div class="pb-24 space-y-8 mt-4">
        <div v-for="(group, dayIdx) in groupedItinerary" :key="dayIdx" class="glass-card p-1">
          <div class="bg-slate-50/50 p-4 rounded-t-[22px] border-b border-slate-100 flex justify-between items-center">
             <span class="bg-primary text-white px-4 py-1.5 rounded-full text-sm font-bold shadow-md shadow-primary/30">Day {{ dayIdx + 1 }}</span>
             <span class="text-xs text-slate-400 font-bold tracking-wider">{{ group.length }} å€‹æ™¯é»</span>
          </div>
          <div class="p-4 space-y-6">
            <div v-for="(item, idx) in group" :key="idx" class="relative pl-6 border-l-2 border-slate-200">
              <div class="absolute -left-[9px] top-1 w-4 h-4 rounded-full bg-white border-4 border-slate-300"></div>
              
              <div class="flex justify-between items-start mb-1">
                <input v-model="item.time" type="time" class="bg-transparent font-bold text-lg text-slate-700 w-24 p-0 border-0 focus:ring-0">
                <button @click="removeItineraryItem(dayIdx, idx)" class="text-slate-300 hover:text-red-400"><i class="ri-close-circle-fill text-xl"></i></button>
              </div>
              
              <input v-model="item.activity" placeholder="è¡Œç¨‹æ¦‚è¦ / å‚™è¨»" class="w-full font-bold text-lg text-slate-800 bg-transparent mb-1 border-0 border-b border-transparent focus:border-primary focus:ring-0 placeholder-slate-300 p-0 transition">
              
              <div class="flex items-center gap-2 mb-3">
                <i class="ri-map-pin-line text-primary flex-shrink-0"></i>
                <input v-model="item.location" placeholder="åœ°é»åç¨± (ç”¨æ–¼åœ°åœ–æ¨™è¨˜)" class="w-full text-sm text-slate-500 bg-transparent border-0 focus:ring-0 p-0">
              </div>
              
              <input v-model="item.mapLink" placeholder="è²¼ä¸Šåœ°åœ–é€£çµ URL (å¯é¸)" class="w-full text-[10px] text-slate-500 bg-slate-50 p-2 rounded-lg mb-3 border-0 focus:ring-1 ring-primary/50">

              <div v-if="idx === 0" :id="mapId(item, dayIdx, idx)" class="w-full h-40 mt-3 rounded-lg bg-slate-100 shadow-inner"></div>
              
              <div class="flex gap-2 mt-3">
                <button @click="openMapLink(item)" class="flex-1 bg-white border border-slate-200 py-2 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-50 transition flex items-center justify-center gap-1">
                  <i class="ri-external-link-line"></i> Open Link
                </button>
                
                <button @click="openDirections(dayIdx, idx)" class="flex-1 bg-primary/10 py-2 rounded-xl text-xs font-bold text-primary hover:bg-primary/20 transition flex items-center justify-center gap-1">
                  <i class="ri-direction-fill"></i> Route
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section v-if="activeTab === 'shopping' && activeTrip" class="animate-fade-in">
      <div class="glass-card p-5 mb-6">
        <h3 class="font-bold mb-4 flex items-center gap-2"><i class="ri-shopping-bag-3-line text-primary"></i> æ–°å¢è³¼ç‰©é …ç›®</h3>
        <div class="flex gap-3 mb-3">
          <label class="w-20 h-20 flex-shrink-0 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 flex flex-col items-center justify-center text-slate-400 cursor-pointer hover:border-primary hover:text-primary transition relative overflow-hidden">
            <input type="file" accept="image/*" class="hidden" @change="handleImageUpload">
            <img v-if="newShoppingItem.image" :src="newShoppingItem.image" class="absolute inset-0 w-full h-full object-cover">
            <div v-else class="text-center">
                <i class="ri-camera-line text-2xl"></i>
                <span class="text-[10px] block">Add Image</span>
            </div>
          </label>
          <div class="flex-1 space-y-2">
            <input v-model="newShoppingItem.name" placeholder="å“å" class="w-full p-2 rounded-lg bg-slate-50 border-0 text-sm">
            <div class="flex gap-2">
              <input v-model="newShoppingItem.onlinePrice" placeholder="ç¶²ä¸Šåƒ¹" class="w-1/2 p-2 rounded-lg bg-slate-50 border-0 text-sm">
              <input v-model="newShoppingItem.localPrice" placeholder="ç•¶åœ°åƒ¹" class="w-1/2 p-2 rounded-lg bg-slate-50 border-0 text-sm">
            </div>
          </div>
        </div>
        <button @click="addShoppingItem" class="w-full bg-primary text-white py-2.5 rounded-xl font-bold shadow-md active:scale-95 transition">åŠ å…¥æ¸…å–®</button>
      </div>

      <div class="grid grid-cols-1 gap-4 pb-20">
        <div v-for="(item, idx) in activeTrip.shoppingItems" :key="idx" :class="['glass-card p-4 transition-all', item.bought ? 'opacity-60 bg-slate-50' : '']">
          <div class="flex gap-4">
            <div class="w-20 h-20 rounded-xl bg-slate-100 flex-shrink-0 overflow-hidden border border-slate-100">
              <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
              <div v-else class="w-full h-full flex items-center justify-center text-slate-300"><i class="ri-image-line text-2xl"></i></div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-start">
                <h4 class="font-bold text-slate-800 truncate pr-2" :class="{'line-through text-slate-400': item.bought}">{{ item.name }}</h4>
                <button @click="removeShoppingItem(idx)" class="text-slate-300 hover:text-red-400 p-1"><i class="ri-close-line"></i></button>
              </div>
              <div class="text-xs text-slate-500 mt-1 space-y-0.5">
                <div class="flex justify-between"><span>ç¶²ä¸Š:</span> <span>{{ item.onlinePrice || '-' }}</span></div>
                <div class="flex justify-between font-medium text-primary"><span>ç•¶åœ°:</span> <span>{{ item.localPrice || '-' }}</span></div>
              </div>
              <label class="flex items-center gap-2 mt-2 cursor-pointer bg-white/50 p-1.5 rounded-lg w-fit hover:bg-white transition">
                <input type="checkbox" v-model="item.bought" @change="saveData" class="w-4 h-4 rounded text-primary border-slate-300 focus:ring-primary">
                <span class="text-xs font-bold text-slate-600">å·²è²·</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section v-if="activeTab === 'budget' && activeTrip" class="animate-fade-in">
       <div class="glass-card p-6 mb-6 text-center">
         <p class="text-xs text-slate-400 mb-1 uppercase tracking-wide">Exchange Rate</p>
         <div class="flex items-center justify-center gap-2 text-3xl font-bold text-slate-700">
           <span class="text-base text-slate-400 self-end mb-1">1 HKD â‰ˆ</span>
           <input v-model.number="activeTrip.exchangeRate" type="number" step="0.1" @change="saveData" class="w-24 text-center bg-transparent border-b-2 border-slate-200 focus:outline-none focus:border-primary">
           <span class="text-xl self-end mb-1">{{ activeTrip.currency }}</span>
         </div>
         <button @click="autoGeocode" class="text-xs bg-slate-100 text-slate-500 px-3 py-1 rounded-full mt-3 hover:bg-slate-200"><i class="ri-refresh-line"></i> é‡æ–°æŠ“å–å³æ™‚åŒ¯ç‡</button>
      </div>
      
      <div class="glass-card p-5 mb-6">
        <h3 class="font-bold mb-4">è¨˜ä¸€ç­†</h3>
        <input v-model="newExpense.name" placeholder="æ¶ˆè²»é …ç›®" class="w-full p-3 rounded-xl bg-slate-50 border-0 mb-3 text-sm">
        <div class="flex gap-3 mb-3">
          <div class="relative flex-1">
             <span class="absolute left-3 top-3 text-slate-400 text-sm">$</span>
             <input v-model.number="newExpense.amount" type="number" placeholder="HKD" class="w-full p-3 pl-6 rounded-xl bg-slate-50 border-0 text-sm">
          </div>
          <select v-model="newExpense.method" class="w-1/3 p-3 rounded-xl bg-slate-50 border-0 text-sm text-slate-600">
            <option>ç¾é‡‘</option>
            <option>ä¿¡ç”¨å¡</option>
          </select>
        </div>
        <select v-model="newExpense.category" class="w-full p-3 rounded-xl bg-slate-50 border-0 mb-4 text-sm text-slate-600">
            <option>é£²é£Ÿ</option>
            <option>è³¼ç‰©</option>
            <option>äº¤é€š</option>
            <option>å¨›æ¨‚</option>
            <option>å…¶ä»–</option>
        </select>
        <button @click="addExpense" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-md">æ–°å¢</button>
      </div>
      
      <div class="pb-20">
        <div v-for="(exp, idx) in activeTrip.expenses" :key="idx" class="glass-card p-4 mb-3 flex justify-between items-center">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-xl">
              <i v-if="exp.category === 'é£²é£Ÿ'" class="ri-restaurant-line text-orange-400"></i>
              <i v-else-if="exp.category === 'è³¼ç‰©'" class="ri-shopping-bag-line text-pink-400"></i>
              <i v-else-if="exp.category === 'äº¤é€š'" class="ri-bus-line text-blue-400"></i>
              <i v-else class="ri-money-dollar-circle-line text-green-400"></i>
            </div>
            <div>
              <p class="font-bold text-slate-700">{{ exp.name }}</p>
              <p class="text-xs text-slate-400">{{ exp.date }} Â· {{ exp.method }}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="font-bold text-slate-800">-{{ exp.amount }}</p>
            <p class="text-[10px] text-slate-400">â‰ˆ {{ Math.round(exp.amount * activeTrip.exchangeRate) }} {{ activeTrip.currency }}</p>
          </div>
        </div>
      </div>
    </section>

    <section v-if="activeTab === 'trips'" class="animate-fade-in pb-20">
      <div class="space-y-6">
        <div v-for="trip in trips" :key="trip.id" 
             @click="switchTrip(trip.id)"
             :class="['glass-card p-6 cursor-pointer transition-all duration-300', activeTripId === trip.id ? 'trip-card-active' : 'opacity-80 hover:opacity-100']">
          <div class="flex justify-between items-start mb-4">
             <div>
               <div class="flex items-center gap-2 mb-1">
                 <h3 class="text-2xl font-black text-slate-800">{{ trip.title }}</h3>
                 <span v-if="activeTripId === trip.id" class="px-2 py-0.5 bg-blue-500 text-white text-[9px] font-bold rounded-full tracking-wider shadow-sm">CURRENT</span>
               </div>
               <div class="flex items-center gap-1 text-sm font-medium text-slate-500">
                 <i class="ri-map-pin-2-fill text-primary"></i> {{ trip.city }}, {{ trip.destination }}
               </div>
             </div>
             <div class="text-right">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Currency</div>
                <div class="text-lg font-black text-slate-700">{{ trip.currency }}</div>
             </div>
          </div>
          <div class="flex gap-4 text-xs text-slate-500 mb-5 bg-slate-50/50 p-3 rounded-xl">
             <div class="flex items-center gap-1"><i class="ri-calendar-line"></i> {{ trip.startDate }}</div>
             <div class="flex items-center gap-1"><i class="ri-arrow-right-line"></i></div>
             <div class="flex items-center gap-1"><i class="ri-calendar-check-line"></i> {{ trip.endDate }}</div>
          </div>
          <div class="pt-4 border-t border-slate-100 flex gap-3">
            <button @click.stop="openEditTripModal(trip)" class="flex-1 bg-white border border-slate-200 text-slate-600 py-2.5 rounded-xl text-xs font-bold hover:bg-slate-50 transition shadow-sm">
              <i class="ri-edit-line mr-1"></i>ç·¨è¼¯
            </button>
            <button @click.stop="deleteTrip(trip.id)" class="px-4 bg-red-50 text-red-400 rounded-xl hover:bg-red-100 transition">
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <div v-if="showTripModal" class="fixed inset-0 z-[200] flex items-end sm:items-center justify-center">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" @click="showTripModal = false"></div>
    <div class="bg-white w-full sm:w-[400px] p-6 rounded-t-3xl sm:rounded-3xl relative z-10 animate-slide-up pb-10">
      <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6"></div>
      <h3 class="text-xl font-bold mb-6 text-center text-slate-800">{{ editingTripId ? 'ç·¨è¼¯æ—…ç¨‹' : 'æ–°å¢æ—…ç¨‹' }}</h3>
      <div class="space-y-4">
        <input v-model="tempTrip.title" placeholder="æ—…ç¨‹æ¨™é¡Œ (e.g. ç•¢æ¥­æ—…è¡Œ)" class="w-full p-4 rounded-2xl bg-slate-50 border-0 font-bold focus:ring-2 ring-primary/20">
        
        <div class="flex gap-3">
          <input v-model="tempTrip.city" placeholder="åŸå¸‚ (e.g. Tokyo)" class="flex-1 p-4 rounded-2xl bg-slate-50 border-0 text-sm">
          <input v-model="tempTrip.destination" placeholder="åœ‹å®¶ (å¯é¸)" class="flex-1 p-4 rounded-2xl bg-slate-50 border-0 text-sm">
        </div>
        
        <button @click="autoGeocode" type="button" class="w-full py-3 rounded-xl bg-blue-50 text-primary text-xs font-bold hover:bg-blue-100 transition flex items-center justify-center gap-2 border border-blue-100">
          <i class="ri-magic-line text-lg"></i>
          è‡ªå‹•å–å¾—åº§æ¨™ + è²¨å¹£ + åŒ¯ç‡ (One-Click)
        </button>

        <div class="flex gap-3">
          <input v-model="tempTrip.startDate" type="date" class="flex-1 p-4 rounded-2xl bg-slate-50 border-0 text-sm">
          <input v-model="tempTrip.endDate" type="date" class="flex-1 p-4 rounded-2xl bg-slate-50 border-0 text-sm">
        </div>
        <div class="flex gap-3">
          <input v-model="tempTrip.currency" placeholder="å¹£åˆ¥" class="w-1/3 p-4 rounded-2xl bg-slate-50 border-0 uppercase text-center font-bold tracking-widest text-slate-600">
           <div class="flex-1 p-4 rounded-2xl bg-slate-50 border-0 text-sm flex items-center text-slate-500">
             <span class="mr-2">Rate:</span>
             <span class="font-bold text-slate-700">{{ tempTrip.exchangeRate ? tempTrip.exchangeRate.toFixed(2) : '?' }}</span>
           </div>
        </div>
        
        <button @click="saveTrip" class="w-full bg-primary text-white py-4 rounded-2xl font-bold text-lg shadow-lg shadow-primary/30 mt-2 hover:scale-[1.02] transition">å„²å­˜</button>
      </div>
    </div>
  </div>

  <nav class="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[85%] max-w-sm capsule-tab rounded-full p-2 flex justify-between items-center z-[100]">
    <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
            class="w-14 h-14 rounded-full flex flex-col items-center justify-center transition-all duration-300 relative"
            :class="activeTab === tab.id ? 'bg-primary text-white shadow-lg -translate-y-2' : 'text-slate-400'">
      <i :class="[tab.icon, 'text-xl']"></i>
      <span v-if="activeTab === tab.id" class="text-[9px] font-bold mt-0.5 absolute -bottom-5 text-primary bg-white/80 px-2 py-0.5 rounded-full shadow-sm whitespace-nowrap">{{ tab.label }}</span>
    </button>
  </nav>

</div>

<script>
  const { createApp } = Vue;
  // **æ³¨æ„: è«‹å°‡æ­¤æ›¿æ›ç‚ºæ‚¨å¯¦éš›çš„ AviationStack Key**
  const AVIATIONSTACK_KEY = '5bxxxxxxxxx'; 

  createApp({
    data() {
      return {
        activeTab: 'info',
        trips: [],
        activeTripId: null,
        showTripModal: false,
        editingTripId: null,
        tempTrip: {},
        weatherData: null,
        weatherTheme: 'sunny',
        showBatchImport: false,
        batchImportText: '',
        
        newExpense: { name: '', amount: null, method: 'ç¾é‡‘', category: 'é£²é£Ÿ' },
        newShoppingItem: { name: '', onlinePrice: '', localPrice: '', bought: false, image: '' },

        tabs: [
          { id: 'info', label: 'Trip Info', icon: 'ri-information-line' },
          { id: 'itinerary-map', label: 'è¡Œç¨‹', icon: 'ri-map-pin-user-line' },
          { id: 'budget', label: 'è¨˜å¸³', icon: 'ri-wallet-3-line' },
          { id: 'shopping', label: 'è³¼ç‰©', icon: 'ri-shopping-bag-3-line' },
          { id: 'trips', label: 'History', icon: 'ri-suitcase-line' },
        ],
        
        // ğŸ¯ æ–°å¢çš„åœ°åœ–ç›¸é—œæ•¸æ“š
        polylineColors: [
          '#4299e1', // è—è‰² (Day 1)
          '#48bb78', // ç¶ è‰² (Day 2)
          '#f6ad55', // æ©™è‰² (Day 3)
          '#fc8181', // ç´…è‰² (Day 4)
          '#9f7aea', // ç´«è‰² (Day 5)
          '#ed8936', // æ·±æ©™ (Day 6)
        ],
        dayMaps: {},       // å„²å­˜ Leaflet åœ°åœ–å¯¦ä¾‹
        dayPolylines: {},  // å„²å­˜å·²ç¹ªè£½çš„ Polyline ç‰©ä»¶
        dayMarkers: {},    // å„²å­˜ Marker ç‰©ä»¶
      };
    },
    computed: {
      activeTrip() { return this.trips.find(t => t.id === this.activeTripId) || null; },
      groupedItinerary() {
        if (!this.activeTrip) return [];
        // ç¢ºä¿æ¯å€‹ item éƒ½æœ‰ mapLink æ¬„ä½
        this.activeTrip.itinerary.forEach(item => {
            if (item.mapLink === undefined) item.mapLink = '';
            if (item.activity === undefined) item.activity = ''; // ç¢ºä¿ activity å­˜åœ¨
        });
        
        const size = 4; // èª¿æ•´ç‚ºæ¯å¤© 4 å€‹é»æ–¹ä¾¿æ¸¬è©¦
        const result = [];
        for (let i = 0; i < this.activeTrip.itinerary.length; i += size) {
          result.push(this.activeTrip.itinerary.slice(i, i + size));
        }
        return result;
      },
      totalExpensesHKD() {
        if (!this.activeTrip) return 0;
        return this.activeTrip.expenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
      },
      weatherDesc() {
        if (!this.weatherData) return 'Loading...';
        const code = this.weatherData.weathercode;
        const map = { 0:'æ™´æœ— Sunny', 1:'å¤šé›² Cloudy', 2:'é™°å¤© Overcast', 3:'æ¯›æ¯›é›¨ Drizzle', 45:'éœ§ Fog', 48:'éœ§æ· Rime fog', 51:'æ¯›æ¯›é›¨ Drizzle', 53:'å°é›¨ Light Rain', 55:'å¤§é›¨ Heavy Rain', 61:'é™£é›¨ Rain', 63:'ä¸­é›¨ Moderate Rain', 65:'å¤§é›¨ Heavy Rain', 80:'é™£é›¨ Showers', 81:'ä¸­åº¦é™£é›¨ Moderate Showers', 82:'å¼·çƒˆé™£é›¨ Violent Showers', 95:'é›·æš´ Thunderstorm' };
        return map[code] || 'å¤šé›² Cloudy';
      }
    },
    watch: {
      activeTab(newTab) {
        if (newTab === 'itinerary-map') {
            this.$nextTick(() => { 
                this.drawAllDayRoutes(); // åˆ‡æ›åˆ°è¡Œç¨‹é æ™‚ç¹ªåœ–
            });
        }
      },
      activeTripId() {
        this.fetchWeather();
      },
      // ğŸ¯ ç›£è½è¡Œç¨‹è®Šå‹•ï¼Œé‡æ–°ç¹ªè£½è·¯ç·š
      groupedItinerary: {
        handler() {
            this.$nextTick(() => {
                if (this.activeTab === 'itinerary-map') {
                    this.drawAllDayRoutes(); 
                }
            });
        },
        deep: true,
      }
    },
    mounted() {
      this.loadData();
    },
    methods: {
      // === æ ¸å¿ƒæ–¹æ³•ï¼šåœ°åœ–ç›¸é—œ ===
      mapId(item, dayIdx, idx) { return `map-${dayIdx}-${idx}`; },

      async geocodeAddress(address) {
        if (!address) return null;
        const nominatimUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`;
        
        try {
            const response = await fetch(nominatimUrl);
            const data = await response.json();
            
            if (data.length > 0) {
                return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
            }
            return null;
        } catch (error) {
            console.error('Nominatim Geocoding Error:', error);
            return null;
        }
      },

      async geocodeAndDrawRoute(dayIdx, items) {
        if (!items || items.length < 2) return;

        const mapElementId = this.mapId(items[0], dayIdx, 0); 
        const mapElement = document.getElementById(mapElementId);
        
        if (!mapElement) return;

        // 1. åŸ·è¡Œ Geocoding
        const geocodePromises = items.map(item => this.geocodeAddress(item.location));
        const routeCoordinates = (await Promise.all(geocodePromises))
            .filter(coord => coord !== null)
            .map(coord => [coord.lat, coord.lng]); // Leaflet æ ¼å¼ [lat, lng]

        if (routeCoordinates.length < 2) return;

        // 2. åœ°åœ–åˆå§‹åŒ–æˆ–å–å¾—å¯¦ä¾‹
        let map = this.dayMaps[dayIdx];
        if (!map) {
            map = L.map(mapElementId, { zoomControl: false, scrollWheelZoom: 'center' })
                    .setView(routeCoordinates[0], 12);
            
            // è¼‰å…¥ OpenStreetMap åœ–å±¤
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19,
            }).addTo(map);

            this.dayMaps[dayIdx] = map;
        } else {
             map.invalidateSize(); // ç¢ºä¿å¤§å°æ­£ç¢º
        }

        // 3. æ¸…é™¤èˆŠçš„è·¯ç·šå’Œæ¨™è¨˜
        if (this.dayPolylines[dayIdx]) { map.removeLayer(this.dayPolylines[dayIdx]); }
        if (this.dayMarkers[dayIdx]) { this.dayMarkers[dayIdx].forEach(marker => map.removeLayer(marker)); }
        this.dayMarkers[dayIdx] = [];


        // 4. ç¹ªè£½ Polyline (è·¯ç·š)
        const lineColor = this.polylineColors[dayIdx % this.polylineColors.length];
        const polyline = L.polyline(routeCoordinates, {
            color: lineColor,
            weight: 4,
            opacity: 0.8,
        }).addTo(map);

        this.dayPolylines[dayIdx] = polyline;
        
        // 5. æ–°å¢ Marker å’Œ Popup
        routeCoordinates.forEach((coords, index) => {
            const item = items[index];
            L.marker(coords).addTo(map)
                .bindPopup(`<b>${item.location}</b><br>${item.activity || 'ç„¡å‚™è¨»'}`);
        });

        // 6. èª¿æ•´åœ°åœ–è¦–è§’ä»¥é¡¯ç¤ºæ‰€æœ‰é»
        map.fitBounds(polyline.getBounds());
      },
      
      drawAllDayRoutes() {
          // æ¸…é™¤æ‰€æœ‰èˆŠåœ°åœ–å¯¦ä¾‹ä»¥é‡‹æ”¾è¨˜æ†¶é«”
          Object.values(this.dayMaps).forEach(map => {
              if (map) { map.off(); map.remove(); }
          });
          this.dayMaps = {};
          this.dayPolylines = {};
          this.dayMarkers = {};
          
          this.groupedItinerary.forEach((group, dayIdx) => {
              if (group.length > 0) {
                  this.geocodeAndDrawRoute(dayIdx, group);
              }
          });
      },
      
      openMapLink(item) {
        if (item.mapLink && item.mapLink.startsWith('http')) {
            window.open(item.mapLink, '_blank');
        } else if (item.location) {
            // ä½¿ç”¨ OpenStreetMap æœç´¢
            window.open(`https://www.openstreetmap.org/search?query=${encodeURIComponent(item.location)}`, '_blank');
        } else {
            alert('è«‹å…ˆå¡«å¯«åœ°é»åç¨±æˆ–è²¼ä¸Šåœ°åœ– URLã€‚');
        }
      },
      
      // ç§»é™¤åŸæœ‰çš„ forceUpdateMap, updateMapMarkers é‚è¼¯
      forceUpdateMap() { this.drawAllDayRoutes(); }, 
      updateMapMarkers() { /* èˆŠé‚è¼¯å·²æ•´åˆåˆ° drawAllDayRoutes */ },
      
      // === å…¶ä»–æ ¸å¿ƒåŠŸèƒ½ (ä¿æŒåŸæœ‰ï¼Œä½†æ–°å¢ mapLink) ===
      saveData() { localStorage.setItem('christine_diary_v4', JSON.stringify(this.trips)); },
      loadData() {
        const saved = localStorage.getItem('christine_diary_v4');
        if (saved) {
          this.trips = JSON.parse(saved);
        } else {
          // åˆå§‹åŒ–ç¯„ä¾‹æ•¸æ“šï¼Œç¢ºä¿ itinerary é …ç›®æœ‰ mapLink æ¬„ä½
          this.trips = [{
            id: Date.now(), title: 'Japan Trip', destination: 'Japan', city: 'Tokyo', currency: 'JPY',
            startDate: '2025-12-24', endDate: '2026-01-01',
            center: { lat: 35.6895, lng: 139.6917 }, exchangeRate: 19.2,
            flights: { outbound: { no: 'CX500', date: '2025-12-24' }, inbound: { no: 'CX501', date: '2026-01-01' } },
            itinerary: [
              { time: '10:00', activity: 'åˆ°é”æ©Ÿå ´', location: 'Narita Airport, Tokyo', mapLink: '' },
              { time: '14:00', activity: 'Check-in é£¯åº—', location: 'Shinjuku Gyoen National Garden', mapLink: '' },
              { time: '18:00', activity: 'æ™šé¤', location: 'Shibuya Crossing, Tokyo', mapLink: '' },
              { time: '09:00', activity: 'Day 2 èµ·é»', location: 'Osaka Castle, Japan', mapLink: '' }, 
              { time: '12:00', activity: 'æ°´æ—é¤¨', location: 'Kaiyukan Aquarium, Osaka', mapLink: '' }, 
            ], 
            expenses: [], shoppingItems: []
          }];
          this.saveData();
        }
        this.activeTripId = this.trips.length > 0 ? this.trips[0].id : null;
        if (this.activeTripId) {
          this.fetchWeather();
        }
      },
      
      async autoGeocode() { /* ä¿æŒä¸è®Š */ },
      async fetchFlight(type) { /* ä¿æŒä¸è®Š */ },
      mockFlightData(type) { /* ä¿æŒä¸è®Š */ },
      async fetchWeather() { /* ä¿æŒä¸è®Š */ },
      fetchRate() { /* ä¿æŒä¸è®Š */ },
      openDirections(dIdx, idx) { /* ä¿æŒä¸è®Š */ },
      handleImageUpload(e) { /* ä¿æŒä¸è®Š */ },
      addShoppingItem() { /* ä¿æŒä¸è®Š */ },
      removeShoppingItem(idx) { /* ä¿æŒä¸è®Š */ },

      // è¡Œç¨‹ (æ–°å¢ mapLink)
      addItineraryItem() { 
          this.activeTrip.itinerary.push({ time: '10:00', activity: '', location: '', mapLink: '' }); 
          this.saveData(); 
      },
      removeItineraryItem(dIdx, idx) { 
          // ä¿®æ­£ç´¢å¼•è¨ˆç®—ï¼Œå› ç‚º groupedItinerary æ˜¯è¨ˆç®—å¾Œçš„çµæœ
          const flatIndex = this.groupedItinerary.slice(0, dIdx).flat().length + idx;
          this.activeTrip.itinerary.splice(flatIndex, 1); 
          this.saveData(); 
      },
      
      runBatchImport() {
        if(!this.batchImportText) return alert('è«‹è²¼ä¸Šå…§å®¹');
        const lines = this.batchImportText.split('\n').filter(line => line.trim() !== '');
        
        const newItems = lines.map(line => {
            const parts = line.split(',');
            return {
                time: parts[0] ? parts[0].trim() : 'N/A',
                activity: parts[1] ? parts[1].trim() : 'æ´»å‹•',
                location: parts[2] ? parts[2].trim() : '',
                mapLink: '' // ç¢ºä¿æ‰¹æ¬¡åŒ¯å…¥ä¹Ÿæœ‰ mapLink æ¬„ä½
            };
        });
        
        this.activeTrip.itinerary.push(...newItems);
        this.saveData();
        this.showBatchImport = false;
        this.batchImportText = '';
        alert(`æˆåŠŸåŒ¯å…¥ ${newItems.length} æ¢è¡Œç¨‹ï¼`);
      },

      // æ—…ç¨‹ (ä¿æŒä¸è®Š)
      openNewTripModal() { 
          this.editingTripId = null; 
          this.tempTrip = {title:'', city:'', destination:'', currency:'JPY', exchangeRate:19.2, center:{lat:35.6,lng:139.6}, startDate: new Date().toISOString().split('T')[0], endDate: new Date().toISOString().split('T')[0]}; 
          this.showTripModal = true; 
      },
      openEditTripModal(trip) { this.editingTripId = trip.id; this.tempTrip = JSON.parse(JSON.stringify(trip)); this.showTripModal = true; },
      saveTrip() { /* ä¿æŒä¸è®Š */ },
      deleteTrip(id) { /* ä¿æŒä¸è®Š */ },
      switchTrip(id) { this.activeTripId = id; this.activeTab = 'info'; },
      
      // è¨˜å¸³ (ä¿æŒä¸è®Š)
      addExpense() { /* ä¿æŒä¸è®Š */ },
    }
  }).mount('#app');
</script>
</body>
</html>
