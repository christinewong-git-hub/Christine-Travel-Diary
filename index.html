<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Travel Studio Â· Trip Dashboard</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue.js 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Remix Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
    rel="stylesheet"
  />
  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <!-- Google Maps APIï¼šå·²æ›¿æ›ç‚ºä½ çš„ API Key -->
  <script
    async
    defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDjwdhovqjl-ttXg7UzIYD7x-gFPdCuu4Q&callback=initMap&libraries=geometry"
  ></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2F5FFF',
            accent: '#FF7E67',
            slate: {
              950: '#020617'
            },
            surface: '#F5F7FB',
            borderSoft: '#E2E8F0'
          },
          fontFamily: {
            sans: ['"Noto Sans TC"', 'system-ui', 'sans-serif']
          }
        }
      }
    };
  </script>
  <style>
    body {
      background: radial-gradient(circle at top left, #e0ecff 0, #f7f8fc 40%, #f9fafb 100%);
      font-family: 'Noto Sans TC', system-ui, sans-serif;
      color: #111827;
    }
    .app-shell {
      max-width: 1024px;
      margin: 0 auto;
      min-height: 100vh;
      padding: 16px;
    }
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.6);
      border-radius: 999px;
    }
    #map {
      min-height: 280px;
      border-radius: 16px;
    }
  </style>
</head>
<body>
<div id="app" class="app-shell flex flex-col gap-4">

  <!-- Top Bar -->
  <header class="flex items-center justify-between gap-3">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-2xl bg-slate-950 flex items-center justify-center text-white text-xl">
        <span>TS</span>
      </div>
      <div>
        <div class="text-xs tracking-wide text-slate-500 uppercase">Travel Studio</div>
        <div class="text-sm font-semibold text-slate-900">
          å¤šæ—…ç¨‹æ—…è¡Œå„€è¡¨æ¿
        </div>
      </div>
    </div>
    <button
      @click="openTripManager = true"
      class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-slate-200 bg-white text-xs text-slate-700 hover:bg-slate-50"
    >
      <i class="ri-suitcase-line text-sm"></i>
      <span>æ—…ç¨‹ç®¡ç†</span>
      <span class="text-[10px] text-slate-400">({{ trips.length }})</span>
    </button>
  </header>

  <!-- Active Trip Summary -->
  <section
    v-if="activeTrip"
    class="rounded-2xl border border-slate-200/70 bg-white/80 backdrop-blur-sm px-5 py-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3"
  >
    <div class="flex-1 flex flex-col gap-1">
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center gap-1.5 text-[11px] px-2 py-0.5 rounded-full bg-slate-900 text-white">
          <i class="ri-compass-3-line text-xs"></i>
          <span>{{ activeTrip.title }}</span>
        </span>
        <span
          class="inline-flex items-center gap-1 text-[11px] px-2 py-0.5 rounded-full bg-slate-100 text-slate-500"
        >
          <i class="ri-map-pin-line text-xs"></i>
          <span>{{ activeTrip.destination }}</span>
        </span>
      </div>
      <div class="text-xs text-slate-500 flex items-center gap-2 mt-1">
        <i class="ri-calendar-line text-slate-400"></i>
        <span>{{ activeTrip.startDate }} â†’ {{ activeTrip.endDate }}</span>
        <span class="inline-block w-px h-3 bg-slate-200"></span>
        <span class="flex items-center gap-1">
          <i class="ri-money-dollar-circle-line text-slate-400"></i>
          <span>{{ activeTrip.currency }}</span>
        </span>
      </div>

      <!-- Flights -->
      <div class="flex flex-wrap gap-2 mt-3 text-[11px]">
        <div
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl border border-slate-200 bg-slate-50/80"
        >
          <span class="px-1.5 py-0.5 rounded-full bg-slate-900 text-white text-[10px]">
            OUT
          </span>
          <span class="font-medium text-slate-800">{{ activeTrip.flights.outbound.no }}</span>
          <span class="text-slate-400">{{ activeTrip.flights.outbound.date }}</span>
          <span class="text-slate-400">Â·</span>
          <span class="text-slate-500">
            {{ activeTrip.flights.outbound.from }} â†’ {{ activeTrip.flights.outbound.to }}
          </span>
        </div>
        <div
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-xl border border-slate-200 bg-slate-50/80"
        >
          <span class="px-1.5 py-0.5 rounded-full bg-slate-900 text-white text-[10px]">
            IN
          </span>
          <span class="font-medium text-slate-800">{{ activeTrip.flights.inbound.no }}</span>
          <span class="text-slate-400">{{ activeTrip.flights.inbound.date }}</span>
          <span class="text-slate-400">Â·</span>
          <span class="text-slate-500">
            {{ activeTrip.flights.inbound.from }} â†’ {{ activeTrip.flights.inbound.to }}
          </span>
        </div>
      </div>
    </div>

    <!-- Weather + Quick Stats -->
    <div class="flex items-stretch gap-3 text-xs w-full md:w-auto">
      <div
        class="flex-1 md:flex-none w-32 rounded-xl border border-slate-200 bg-slate-50/80 px-3 py-2 flex flex-col justify-between"
      >
        <div class="flex items-center justify-between">
          <span class="text-[11px] text-slate-500">ä»Šæ—¥å¤©æ°£</span>
          <button
            @click="fetchWeather"
            class="text-[10px] text-slate-400 hover:text-slate-600"
            title="æ›´æ–°å¤©æ°£"
          >
            <i class="ri-refresh-line"></i>
          </button>
        </div>
        <div class="flex items-end gap-1 mt-1">
          <span class="text-lg font-semibold text-slate-900">{{ weather.temp }}Â°C</span>
          <span class="text-[10px] text-slate-500 mb-0.5">{{ weather.desc }}</span>
        </div>
        <div class="mt-1 text-[10px] text-slate-400 flex items-center gap-1">
          <i class="ri-map-pin-2-line"></i>
          <span>{{ activeTrip.city }}</span>
        </div>
      </div>

      <div
        class="flex-1 md:flex-none w-32 rounded-xl border border-slate-200 bg-slate-50/80 px-3 py-2 flex flex-col justify-between"
      >
        <div class="flex items-center justify-between">
          <span class="text-[11px] text-slate-500">é ç®—æ¦‚è¦</span>
        </div>
        <div class="mt-1">
          <div class="text-[10px] text-slate-400 mb-0.5">å·²è¨˜éŒ„æ”¯å‡º</div>
          <div class="text-sm font-semibold text-slate-900">
            {{ totalExpenseInCurrency.toLocaleString() }} {{ activeTrip.currency }}
          </div>
        </div>
        <div class="mt-1 text-[10px] text-slate-400 flex items-center gap-1">
          <i class="ri-exchange-dollar-line"></i>
          <span>KRW â†’ {{ activeTrip.currency }}</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Tabs -->
  <nav
    class="rounded-2xl border border-slate-200/70 bg-white/90 backdrop-blur-sm px-2 py-1 flex flex-wrap gap-1 text-[11px]"
  >
    <button
      v-for="tab in tabs"
      :key="tab.id"
      @click="activeTab = tab.id"
      :class="[
        'flex-1 min-w-[80px] flex items-center justify-center gap-1 px-2 py-1.5 rounded-xl transition',
        activeTab === tab.id
          ? 'bg-slate-900 text-white'
          : 'text-slate-500 hover:bg-slate-50'
      ]"
    >
      <i :class="tab.icon" class="text-xs"></i>
      <span>{{ tab.label }}</span>
    </button>
  </nav>

  <!-- TAB: Itinerary -->
  <section v-if="activeTab === 'itinerary'" class="grid md:grid-cols-[minmax(0,2fr)_minmax(0,3fr)] gap-4">
    <!-- Itinerary List -->
    <div
      class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm p-4 flex flex-col gap-3 max-h-[460px] overflow-y-auto"
    >
      <div class="flex items-center justify-between mb-1">
        <h2 class="text-sm font-semibold text-slate-900 flex items-center gap-1.5">
          <span class="inline-flex w-5 h-5 items-center justify-center rounded-lg bg-slate-900 text-white text-[11px]">
            1
          </span>
          <span>è¡Œç¨‹åˆ—è¡¨</span>
        </h2>
        <button
          @click="addItineraryItem"
          class="text-[11px] px-2.5 py-1 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50 flex items-center gap-1"
        >
          <i class="ri-add-line text-xs"></i>
          <span>æ–°å¢</span>
        </button>
      </div>

      <div v-if="activeTrip.itinerary.length === 0" class="text-[11px] text-slate-400 py-6 text-center">
        å°šæœªå»ºç«‹è¡Œç¨‹ï¼Œé»æ“Šã€Œæ–°å¢ã€é–‹å§‹ã€‚
      </div>

      <div
        v-for="(item, index) in activeTrip.itinerary"
        :key="'it-' + index"
        class="flex gap-3 items-start rounded-xl border border-slate-100 bg-slate-50/60 px-3 py-2.5"
      >
        <div class="flex flex-col items-center mt-0.5">
          <div
            class="w-8 h-8 rounded-xl bg-slate-900 text-white text-[11px] flex items-center justify-center font-medium"
          >
            {{ item.time || 'â€”' }}
          </div>
          <div
            v-if="index < activeTrip.itinerary.length - 1"
            class="flex-1 w-px bg-slate-200 mt-1 mb-1"
            style="min-height: 24px"
          ></div>
        </div>

        <div class="flex-1 flex flex-col gap-1">
          <input
            v-model="item.activity"
            class="text-xs font-semibold text-slate-900 bg-transparent outline-none"
            placeholder="æ´»å‹•åç¨±"
          />
          <input
            v-model="item.location"
            class="text-[11px] text-slate-500 bg-transparent outline-none"
            placeholder="åœ°é» / åœ°å€ï¼ˆç”¨æ–¼å°èˆªï¼‰"
          />
          <div v-if="item.distance || item.duration" class="text-[11px] text-slate-400 flex gap-2">
            <span v-if="item.distance">è·é›¢ {{ item.distance }}</span>
            <span v-if="item.duration">Â· {{ item.duration }}</span>
          </div>
          <div class="flex items-center gap-2 mt-1">
            <a
              :href="getSingleDirectionLink(item, index)"
              target="_blank"
              class="text-[11px] px-2 py-1 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50 flex items-center gap-1"
            >
              <i class="ri-map-pin-line text-xs"></i>
              <span>Google Maps</span>
            </a>
            <button
              @click="removeItineraryItem(index)"
              class="ml-auto text-[11px] text-slate-400 hover:text-red-500"
            >
              åˆªé™¤
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Pane -->
    <div
      class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm p-3 flex flex-col gap-3"
    >
      <div class="flex items-center justify-between">
        <h3 class="text-xs font-semibold text-slate-900 flex items-center gap-1.5">
          <span
            class="inline-flex w-5 h-5 items-center justify-center rounded-lg bg-slate-900 text-white text-[11px]"
          >
            2
          </span>
          <span>è·¯ç·šåœ°åœ–</span>
        </h3>
        <div class="flex items-center gap-2 text-[11px]">
          <select
            v-model="activeTrip.travelMode"
            @change="updateRoute"
            class="border border-slate-200 rounded-lg px-2 py-1 bg-white text-slate-600"
          >
            <option value="DRIVING">ğŸš— é–‹è»Š</option>
            <option value="WALKING">ğŸš¶ æ­¥è¡Œ</option>
            <option value="BICYCLING">ğŸš² å–®è»Š</option>
            <option value="TRANSIT">ğŸš‡ å¤§çœ¾é‹è¼¸</option>
          </select>
          <button
            @click="updateRoute"
            class="px-2 py-1 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 flex items-center gap-1"
          >
            <i class="ri-refresh-line text-xs"></i>
            <span>é‡æ–°è¨ˆç®—</span>
          </button>
        </div>
      </div>

      <div id="map" class="w-full bg-slate-100"></div>

      <div v-if="activeTrip.routeSummary" class="flex items-center gap-4 text-[11px] text-slate-500 mt-1">
        <div class="flex items-center gap-1">
          <i class="ri-road-map-line text-slate-400"></i>
          <span>{{ activeTrip.routeSummary.distance }}</span>
        </div>
        <div class="flex items-center gap-1">
          <i class="ri-time-line text-slate-400"></i>
          <span>{{ activeTrip.routeSummary.duration }}</span>
        </div>
        <div class="flex items-center gap-1">
          <i class="ri-map-pin-range-line text-slate-400"></i>
          <span>{{ activeTrip.itinerary.length }} stops</span>
        </div>
      </div>
    </div>
  </section>

  <!-- TAB: Budget -->
  <section
    v-if="activeTab === 'budget'"
    class="grid md:grid-cols-[minmax(0,2fr)_minmax(0,3fr)] gap-4"
  >
    <!-- FX & Add Expense -->
    <div
      class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm p-4 flex flex-col gap-3"
    >
      <!-- FX -->
      <div
        class="rounded-xl border border-slate-200 bg-slate-950 text-slate-50 px-4 py-3 flex flex-col gap-2"
      >
        <div class="flex items-center justify-between text-[11px]">
          <span class="flex items-center gap-1">
            <i class="ri-exchange-dollar-line"></i>
            <span>åŒ¯ç‡ Â· KRW â†’ {{ activeTrip.currency }}</span>
          </span>
          <button
            @click="fetchRate"
            class="text-slate-400 hover:text-slate-200"
            title="æ›´æ–°åŒ¯ç‡"
          >
            <i class="ri-refresh-line text-xs"></i>
          </button>
        </div>
        <div class="flex items-baseline gap-1">
          <span class="text-xl font-semibold">1,000â‚©</span>
          <span class="text-xs text-slate-400 mx-1">â‰ˆ</span>
          <span class="text-lg font-semibold">
            {{ (1000 * activeTrip.exchangeRate).toFixed(2) }} {{ activeTrip.currency }}
          </span>
        </div>
        <div class="flex items-center gap-2 text-[11px] mt-1">
          <span class="text-slate-400">æ‰‹å‹•å¾®èª¿ï¼š</span>
          <input
            type="number"
            v-model.number="activeTrip.exchangeRate"
            class="w-20 px-2 py-1 rounded bg-slate-800 border border-slate-600 text-xs outline-none"
            step="0.0001"
          />
        </div>
      </div>

      <!-- Add Expense -->
      <div class="flex flex-col gap-2 text-xs">
        <h3 class="text-[11px] font-semibold text-slate-800 flex items-center gap-1">
          <i class="ri-wallet-3-line text-slate-500"></i>
          <span>æ–°å¢æ”¯å‡º</span>
        </h3>
        <div class="grid grid-cols-2 gap-2">
          <input
            v-model="newExpense.item"
            placeholder="é …ç›® (e.g. å’–å•¡)"
            class="border border-slate-200 rounded-lg px-3 py-2 bg-slate-50 outline-none text-xs"
          />
          <input
            v-model.number="newExpense.amount"
            type="number"
            placeholder="é‡‘é¡ (â‚©)"
            class="border border-slate-200 rounded-lg px-3 py-2 bg-slate-50 outline-none text-xs"
          />
        </div>
        <div class="flex gap-2">
          <select
            v-model="newExpense.payment"
            class="border border-slate-200 rounded-lg px-3 py-2 bg-slate-50 outline-none flex-1 text-xs text-slate-600"
          >
            <option value="cash">ğŸ’µ ç¾é‡‘</option>
            <option value="card">ğŸ’³ ä¿¡ç”¨å¡</option>
          </select>
          <button
            @click="addExpense"
            class="px-3 py-2 rounded-lg bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800"
          >
            è¨˜ä¸€ç­†
          </button>
        </div>
      </div>
    </div>

    <!-- Expense List -->
    <div
      class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm p-4 flex flex-col gap-2 max-h-[460px] overflow-y-auto"
    >
      <div class="flex items-center justify-between mb-1">
        <h3 class="text-xs font-semibold text-slate-900 flex items-center gap-1.5">
          <span
            class="inline-flex w-5 h-5 items-center justify-center rounded-lg bg-slate-900 text-white text-[11px]"
          >
            $
          </span>
          <span>æ”¯å‡ºåˆ—è¡¨</span>
        </h3>
        <div class="text-[11px] text-slate-500">
          å…± {{ activeTrip.expenses.length }} ç­† Â·
          <span class="font-semibold">
            {{ totalExpenseInCurrency.toLocaleString() }} {{ activeTrip.currency }}
          </span>
        </div>
      </div>

      <div
        v-for="(exp, i) in activeTrip.expenses"
        :key="'exp-' + i"
        class="flex items-center justify-between rounded-xl border border-slate-100 bg-slate-50/70 px-3 py-2 text-xs"
      >
        <div class="flex items-center gap-3">
          <div
            :class="exp.payment === 'card'
              ? 'bg-indigo-100 text-indigo-600'
              : 'bg-emerald-100 text-emerald-600'"
            class="w-8 h-8 rounded-lg flex items-center justify-center text-base"
          >
            <i :class="exp.payment === 'card' ? 'ri-bank-card-line' : 'ri-wallet-3-line'"></i>
          </div>
          <div>
            <div class="font-semibold text-slate-900 text-xs">
              {{ exp.item }}
            </div>
            <div class="text-[11px] text-slate-400">
              {{ exp.date }}
            </div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-xs text-slate-800">
            -â‚©{{ exp.amount.toLocaleString() }}
          </div>
          <div class="text-[11px] text-slate-400">
            â‰ˆ {{ (exp.amount * activeTrip.exchangeRate).toFixed(1) }} {{ activeTrip.currency }}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TAB: In-trip Shopping -->
  <section
    v-if="activeTab === 'shopping'"
    class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm p-4 flex flex-col gap-3"
  >
    <div class="flex items-center justify-between mb-1">
      <h2 class="text-sm font-semibold text-slate-900 flex items-center gap-1.5">
        <i class="ri-shopping-bag-3-line text-slate-500"></i>
        <span>æ—…ç¨‹ä¸­è³¼ç‰©æ¸…å–®</span>
      </h2>
    </div>

    <div class="flex gap-2 text-xs">
      <input
        v-model="newTripItem"
        @keyup.enter="addTripItem"
        placeholder="æƒ³è²·ä»€éº¼...(æ—…ç¨‹ä¸­)"
        class="flex-1 border border-slate-200 rounded-lg px-3 py-2 bg-slate-50 outline-none"
      />
      <button
        @click="addTripItem"
        class="w-9 h-9 rounded-lg bg-slate-900 text-white flex items-center justify-center text-sm"
      >
        <i class="ri-add-line"></i>
      </button>
    </div>

    <div class="mt-2 space-y-1.5">
      <div
        v-for="(item, index) in activeTrip.tripItems"
        :key="'ti-' + index"
        class="flex items-center gap-2 rounded-xl border border-slate-100 bg-slate-50/70 px-3 py-2 text-xs"
        :class="{ 'opacity-55': item.checked }"
      >
        <button
          @click="toggleTripItem(index)"
          class="w-4 h-4 rounded border border-slate-300 flex items-center justify-center text-[10px] bg-white"
        >
          <i v-if="item.checked" class="ri-check-line text-slate-900"></i>
        </button>
        <span class="flex-1 text-slate-800" :class="{ 'line-through': item.checked }">
          {{ item.text }}
        </span>
        <button @click="removeTripItem(index)" class="text-slate-300 hover:text-red-500">
          <i class="ri-delete-bin-line text-xs"></i>
        </button>
      </div>
    </div>
  </section>

  <!-- TAB: Pre-trip Shopping -->
  <section
    v-if="activeTab === 'pretrip'"
    class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm p-4 flex flex-col gap-3"
  >
    <div class="flex items-center justify-between mb-1">
      <h2 class="text-sm font-semibold text-slate-900 flex items-center gap-1.5">
        <i class="ri-clipboard-line text-slate-500"></i>
        <span>è¡Œå‰è³¼ç‰©æ¸…å–®</span>
      </h2>
      <button
        @click="addPreTripItem"
        class="text-[11px] px-2.5 py-1 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50 flex items-center gap-1"
      >
        <i class="ri-add-line text-xs"></i>
        <span>æ–°å¢é …ç›®</span>
      </button>
    </div>
    <p class="text-[11px] text-slate-500 mb-1">
      è¨˜éŒ„å‡ºç™¼å‰è¦è²·çš„æ±è¥¿ï¼šå¯ä»¥è²¼åœ–ç‰‡é€£çµã€ç¶²ä¸Šåƒ¹éŒ¢ï¼Œä»¥åŠå¯¦éš›è³¼è²·åƒ¹å’Œå‹¾é¸å®Œæˆã€‚
    </p>

    <div class="grid md:grid-cols-2 gap-3">
      <div
        v-for="(item, index) in activeTrip.preTripItems"
        :key="'pt-' + index"
        class="rounded-xl border border-slate-100 bg-slate-50/80 px-3 py-3 flex gap-3 text-[11px]"
      >
        <div class="w-16 h-16 rounded-lg bg-slate-100 overflow-hidden flex items-center justify-center">
          <img
            v-if="item.image"
            :src="item.image"
            alt=""
            class="w-full h-full object-cover"
            onerror="this.style.display='none'"
          />
          <span v-else class="text-[10px] text-slate-400 px-1 text-center">No Image</span>
        </div>
        <div class="flex-1 flex flex-col gap-1">
          <input
            v-model="item.name"
            class="w-full bg-transparent outline-none text-[11px] font-semibold text-slate-900 border-b border-slate-200 pb-0.5"
            placeholder="å•†å“åç¨±"
          />
          <div class="flex items-center gap-1">
            <span class="text-slate-400 shrink-0">ç¶²ä¸Šåƒ¹</span>
            <input
              v-model.number="item.onlinePrice"
              type="number"
              class="w-20 px-1 py-0.5 rounded bg-white border border-slate-200 text-right outline-none"
              placeholder="0"
            />
            <span class="text-slate-400 text-[10px]">{{ activeTrip.currency }}</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-slate-400 shrink-0">åœ–ç‰‡</span>
            <input
              v-model="item.image"
              class="flex-1 px-1 py-0.5 rounded bg-white border border-slate-200 outline-none"
              placeholder="è²¼ä¸Šåœ–ç‰‡ç¶²å€"
            />
          </div>
          <div class="flex items-center justify-between mt-1">
            <label class="flex items-center gap-1 text-slate-700">
              <input
                type="checkbox"
                v-model="item.purchased"
                class="w-3.5 h-3.5 rounded border-slate-300"
              />
              <span>å·²è³¼è²·</span>
            </label>
            <div class="flex items-center gap-1">
              <span class="text-slate-400">å¯¦éš›åƒ¹</span>
              <input
                v-model.number="item.actualPrice"
                type="number"
                class="w-20 px-1 py-0.5 rounded bg-white border border-slate-200 text-right outline-none"
                placeholder="0"
              />
              <span class="text-slate-400 text-[10px]">{{ activeTrip.currency }}</span>
            </div>
          </div>
        </div>
        <button
          @click="removePreTripItem(index)"
          class="text-slate-300 hover:text-red-500 mt-1"
          title="åˆªé™¤"
        >
          <i class="ri-delete-bin-line text-xs"></i>
        </button>
      </div>
    </div>
  </section>

  <!-- TAB: Trips / History -->
  <section
    v-if="activeTab === 'trips'"
    class="rounded-2xl border border-slate-200 bg-white/90 backdrop-blur-sm p-4 flex flex-col gap-3"
  >
    <div class="flex items-center justify-between mb-1">
      <h2 class="text-sm font-semibold text-slate-900 flex items-center gap-1.5">
        <i class="ri-suitcase-3-line text-slate-500"></i>
        <span>æ‰€æœ‰æ—…ç¨‹</span>
      </h2>
      <button
        @click="startCreateTrip"
        class="text-[11px] px-2.5 py-1 rounded-full border border-slate-200 text-slate-600 hover:bg-slate-50 flex items-center gap-1"
      >
        <i class="ri-add-line text-xs"></i>
        <span>æ–°å¢æ—…ç¨‹</span>
      </button>
    </div>
    <p class="text-[11px] text-slate-500 mb-1">
      æ—…ç¨‹æœƒä¿å­˜åœ¨æ­¤è£ç½®çš„ç€è¦½å™¨ localStorageï¼Œä¸‹æ¬¡é–‹å•Ÿäº¦å¯æŸ¥çœ‹ã€‚
    </p>

    <div class="grid md:grid-cols-3 gap-3">
      <div
        v-for="trip in trips"
        :key="trip.id"
        class="rounded-xl border border-slate-200 bg-slate-50/80 px-3 py-3 flex flex-col gap-1 text-[11px] cursor-pointer hover:border-slate-400"
        :class="{ 'ring-1 ring-slate-900': trip.id === activeTripId }"
        @click="switchTrip(trip.id)"
      >
        <div class="flex items-center justify-between">
          <div class="font-semibold text-slate-900 text-xs truncate max-w-[120px]">
            {{ trip.title }}
          </div>
          <span
            class="px-1.5 py-0.5 rounded-full bg-slate-900 text-white text-[10px]"
            v-if="trip.id === activeTripId"
          >
            Active
          </span>
        </div>
        <div class="text-[11px] text-slate-500 flex items-center gap-1">
          <i class="ri-map-pin-line text-slate-400"></i>
          <span class="truncate">{{ trip.destination }}</span>
        </div>
        <div class="text-[11px] text-slate-400">
          {{ trip.startDate }} â†’ {{ trip.endDate }}
        </div>
        <div class="mt-1 flex items-center justify-between text-[10px] text-slate-400">
          <span class="flex items-center gap-1">
            <i class="ri-wallet-3-line"></i>
            <span>{{ trip.currency }}</span>
          </span>
          <button
            @click.stop="deleteTrip(trip.id)"
            class="text-slate-300 hover:text-red-500"
            title="åˆªé™¤æ—…ç¨‹"
          >
            <i class="ri-delete-bin-line text-xs"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Create Trip Form (inline, simple) -->
    <div
      v-if="creatingTrip"
      class="mt-3 rounded-xl border border-slate-200 bg-slate-50/80 px-3 py-3 text-[11px] flex flex-col gap-2"
    >
      <div class="flex items-center justify-between">
        <span class="font-semibold text-slate-900">æ–°å¢æ—…ç¨‹</span>
        <button @click="creatingTrip = false" class="text-slate-400 hover:text-slate-600 text-xs">
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="grid md:grid-cols-2 gap-2">
        <div class="flex flex-col gap-1">
          <label class="text-slate-500">æ—…ç¨‹åç¨±</label>
          <input
            v-model="newTripForm.title"
            placeholder="Japan Winter Escape"
            class="border border-slate-200 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-slate-500">ç›®çš„åœ° (åœ‹å®¶ / åŸå¸‚)</label>
          <input
            v-model="newTripForm.destination"
            placeholder="Japan Â· Tokyo"
            class="border border-slate-200 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-slate-500">åŸå¸‚åç¨± (å¤©æ°£ / åœ°åœ–)</label>
          <input
            v-model="newTripForm.city"
            placeholder="Tokyo"
            class="border border-slate-200 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-slate-500">ç•¶åœ°è²¨å¹£</label>
          <input
            v-model="newTripForm.currency"
            placeholder="HKD / JPY / EUR"
            class="border border-slate-200 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-slate-500">é–‹å§‹æ—¥æœŸ</label>
          <input
            v-model="newTripForm.startDate"
            type="date"
            class="border border-slate-200 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-slate-500">çµæŸæ—¥æœŸ</label>
          <input
            v-model="newTripForm.endDate"
            type="date"
            class="border border-slate-200 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-slate-500">åœ°åœ–ä¸­å¿ƒç·¯åº¦</label>
          <input
            v-model.number="newTripForm.lat"
            type="number"
            step="0.0001"
            class="border border-slate-200 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
        <div class="flex flex-col gap-1">
          <label class="text-slate-500">åœ°åœ–ä¸­å¿ƒç¶“åº¦</label>
          <input
            v-model.number="newTripForm.lng"
            type="number"
            step="0.0001"
            class="border border-slate-200 rounded-lg px-2 py-1.5 bg-white outline-none"
          />
        </div>
      </div>
      <div class="mt-2 flex justify-end gap-2">
        <button
          @click="creatingTrip = false"
          class="px-3 py-1.5 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50"
        >
          å–æ¶ˆ
        </button>
        <button
          @click="createTrip"
          class="px-3 py-1.5 rounded-lg bg-slate-900 text-white hover:bg-slate-800"
        >
          å»ºç«‹æ—…ç¨‹
        </button>
      </div>
    </div>
  </section>

  <!-- æ—…ç¨‹ç®¡ç† Modal (ç°¡åŒ–ç‰ˆæœ¬ï¼Œåªåšè¦–è¦ºå®¹å™¨ï¼Œå¯é¸æ“‡åŠè·³å» trips åˆ†é ) -->
  <div
    v-if="openTripManager"
    class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50"
  >
    <div class="w-full max-w-md rounded-2xl bg-white shadow-xl border border-slate-200 p-4 text-[11px]">
      <div class="flex items-center justify-between mb-2">
        <div class="flex items-center gap-2">
          <span class="text-xs font-semibold text-slate-900">æ—…ç¨‹ç®¡ç†</span>
          <span class="text-[10px] text-slate-400">å…± {{ trips.length }} å€‹</span>
        </div>
        <button
          @click="openTripManager = false"
          class="text-slate-400 hover:text-slate-600 text-xs"
        >
          <i class="ri-close-line"></i>
        </button>
      </div>
      <div class="space-y-1.5 max-h-64 overflow-y-auto">
        <div
          v-for="trip in trips"
          :key="'mgr-' + trip.id"
          class="flex items-center justify-between px-2 py-1.5 rounded-lg cursor-pointer hover:bg-slate-50"
          :class="{ 'bg-slate-900 text-white hover:bg-slate-900': trip.id === activeTripId }"
          @click="switchTrip(trip.id); openTripManager = false"
        >
          <div class="flex flex-col">
            <span class="font-semibold text-[11px] truncate max-w-[180px]">
              {{ trip.title }}
            </span>
            <span class="text-[10px]" :class="trip.id === activeTripId ? 'text-slate-200' : 'text-slate-400'">
              {{ trip.destination }} Â· {{ trip.startDate }} â†’ {{ trip.endDate }}
            </span>
          </div>
          <span
            class="text-[10px] px-1.5 py-0.5 rounded-full border"
            :class="trip.id === activeTripId
              ? 'border-white text-white/90'
              : 'border-slate-200 text-slate-400'"
          >
            æŸ¥çœ‹
          </span>
        </div>
      </div>
      <div class="mt-3 flex justify-between items-center">
        <button
          @click="activeTab = 'trips'; openTripManager = false; startCreateTrip()"
          class="text-[11px] text-slate-600 flex items-center gap-1"
        >
          <i class="ri-add-line text-xs"></i>
          <span>æ–°å¢æ—…ç¨‹</span>
        </button>
        <button
          @click="openTripManager = false"
          class="text-[11px] text-slate-500 hover:text-slate-700"
        >
          é—œé–‰
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let map, directionsService, directionsDisplay;

  function initMap() {
    const mapEl = document.getElementById('map');
    if (!mapEl) return;
    map = new google.maps.Map(mapEl, {
      zoom: 12,
      center: { lat: 35.6762, lng: 139.6503 }, // default Tokyo
      mapTypeControl: false,
      fullscreenControl: false,
      streetViewControl: false,
      styles: [{ featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] }]
    });
    directionsService = new google.maps.DirectionsService();
    directionsDisplay = new google.maps.DirectionsRenderer({
      map,
      suppressMarkers: false,
      polylineOptions: {
        strokeColor: '#2F5FFF',
        strokeWeight: 5
      }
    });
  }

  const { createApp } = Vue;

  createApp({
    data() {
      return {
        tabs: [
          { id: 'itinerary', label: 'è¡Œç¨‹ / åœ°åœ–', icon: 'ri-calendar-todo-line' },
          { id: 'budget', label: 'è¨˜å¸³', icon: 'ri-wallet-3-line' },
          { id: 'shopping', label: 'æ—…ç¨‹è³¼ç‰©', icon: 'ri-shopping-bag-3-line' },
          { id: 'pretrip', label: 'è¡Œå‰è³¼ç‰©', icon: 'ri-clipboard-line' },
          { id: 'trips', label: 'æ—…ç¨‹ / History', icon: 'ri-suitcase-3-line' }
        ],
        activeTab: 'itinerary',

        trips: [],
        activeTripId: null,
        openTripManager: false,

        weather: { temp: '--', desc: 'è¼‰å…¥ä¸­...' },

        newExpense: { item: '', amount: null, payment: 'cash' },
        newTripItem: '',
        creatingTrip: false,
        newTripForm: {
          title: '',
          destination: '',
          city: '',
          currency: 'HKD',
          startDate: '',
          endDate: '',
          lat: 35.6762,
          lng: 139.6503
        }
      };
    },
    computed: {
      activeTrip() {
        return this.trips.find(t => t.id === this.activeTripId) || null;
      },
      totalExpenseInCurrency() {
        if (!this.activeTrip) return 0;
        const totalKRW = this.activeTrip.expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        return Math.round(totalKRW * this.activeTrip.exchangeRate);
      }
    },
    created() {
      // load from localStorage
      const stored = localStorage.getItem('travel_studio_trips');
      if (stored) {
        try {
          this.trips = JSON.parse(stored);
        } catch (e) {
          this.trips = [];
        }
      }

      if (this.trips.length === 0) {
        // åˆå§‹å»ºç«‹ä¸€å€‹ã€ŒJapan Winterã€æ—…ç¨‹ï¼ˆä½ ç¾åœ¨é€™æ¬¡ï¼‰[web:118][web:98]
        const defaultTrip = {
          id: Date.now().toString(),
          title: 'Japan Winter 2025',
          destination: 'Japan Â· Tokyo',
          city: 'Tokyo',
          currency: 'HKD',
          startDate: '2025-12-24',
          endDate: '2026-01-01',
          center: { lat: 35.6762, lng: 139.6503 },
          exchangeRate: 0.0058,
          travelMode: 'TRANSIT',
          flights: {
            outbound: { no: 'NH924', date: '2025-12-24', from: 'HKG / CAN', to: 'HND' },
            inbound: { no: 'NH923', date: '2026-01-01', from: 'HND', to: 'HKG / CAN' }
          },
          itinerary: [
            {
              time: '09:00',
              activity: 'æŠµé”æ±äº¬ç¾½ç”°æ©Ÿå ´',
              location: 'Tokyo Haneda Airport, Japan'
            },
            {
              time: '11:00',
              activity: 'é…’åº— Check-in',
              location: 'Shinjuku, Tokyo'
            },
            {
              time: '14:00',
              activity: 'è¡¨åƒé“ / åŸå®¿é€›è¡—',
              location: 'Omotesando, Tokyo'
            },
            {
              time: '19:00',
              activity: 'æ–°å®¿æ™šé¤',
              location: 'Shinjuku, Tokyo'
            }
          ],
          routeSummary: null,
          expenses: [],
          tripItems: [],
          preTripItems: []
        };
        this.trips.push(defaultTrip);
      }

      this.activeTripId = this.trips[0].id;
    },
    mounted() {
      // init map + route when ready
      if (typeof google !== 'undefined' && google.maps) {
        setTimeout(() => {
          initMap();
          this.updateRoute();
        }, 400);
      } else {
        window.initMap = () => {
          initMap();
          this.updateRoute();
        };
      }

      this.fetchWeather();
      this.fetchRate();
    },
    watch: {
      trips: {
        handler(val) {
          localStorage.setItem('travel_studio_trips', JSON.stringify(val));
        },
        deep: true
      },
      activeTripId() {
        // ç•¶åˆ‡æ›æ—…ç¨‹æ™‚ï¼Œæ›´æ–°åœ°åœ– center + route
        this.$nextTick(() => {
          if (this.activeTrip && map) {
            map.setCenter(this.activeTrip.center || { lat: 35.6762, lng: 139.6503 });
            map.setZoom(12);
            this.updateRoute();
          }
        });
      }
    },
    methods: {
      // å¤©æ°£ï¼šç”¨åŸå¸‚åº§æ¨™æ™‚å¯å†é€²ä¸€æ­¥æ“´å±•ï¼Œé€™è£å…ˆä»¥æ±äº¬ç‚ºä¾‹ [web:29]
      async fetchWeather() {
        try {
          const lat = this.activeTrip?.center?.lat || 35.6762;
          const lng = this.activeTrip?.center?.lng || 139.6503;
          const res = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`
          );
          const data = await res.json();
          this.weather = {
            temp: data.current_weather.temperature,
            desc: 'æ™´åˆ°å¤šé›²'
          };
        } catch (e) {
          this.weather = { temp: '10', desc: 'Clear' };
        }
      },

      // åŒ¯ç‡ï¼šç¤ºä¾‹ä»ç”¨ KRWâ†’HKDï¼Œä½ å¯ä»¥ä¹‹å¾Œæ”¹æˆå°ç•¶åœ°å¹£åˆ¥ [web:12][web:20]
      async fetchRate() {
        try {
          const res = await fetch('https://api.frankfurter.app/latest?from=KRW&to=HKD');
          const data = await res.json();
          if (this.activeTrip) this.activeTrip.exchangeRate = data.rates.HKD;
        } catch (e) {
          // ä¿ç•™é è¨­
        }
      },

      // Google Maps route
      async updateRoute() {
        if (!this.activeTrip || !directionsService || this.activeTrip.itinerary.length < 2) return;

        const legs = this.activeTrip.itinerary;
        const waypoints = legs.slice(1, -1).map(item => ({
          location: item.location,
          stopover: true
        }));

        const request = {
          origin: legs[0].location,
          destination: legs[legs.length - 1].location,
          waypoints,
          optimizeWaypoints: true,
          travelMode: google.maps.TravelMode[this.activeTrip.travelMode || 'TRANSIT']
        };

        try {
          const result = await new Promise((resolve, reject) => {
            directionsService.route(request, (res, status) => {
              if (status === 'OK') resolve(res);
              else reject(status);
            });
          });

          directionsDisplay.setDirections(result);

          const route = result.routes[0];
          const totalDistance = route.legs.reduce((sum, leg) => sum + leg.distance.value, 0) / 1000;
          const totalDuration = route.legs.reduce((sum, leg) => sum + leg.duration.value, 0) / 60;

          this.activeTrip.routeSummary = {
            distance: `${totalDistance.toFixed(1)} km`,
            duration: `${Math.floor(totalDuration / 60)}h ${Math.round(totalDuration % 60)}m`,
            legs: route.legs.length
          };

          // æ›´æ–°æ¯ä¸€æ®µè¡Œç¨‹çš„è·é›¢/æ™‚é–“
          this.activeTrip.itinerary.forEach((item, index) => {
            if (index > 0 && route.legs[index - 1]) {
              item.distance = route.legs[index - 1].distance.text;
              item.duration = route.legs[index - 1].duration.text;
            }
          });
        } catch (err) {
          console.error('route error', err);
        }
      },

      getSingleDirectionLink(item, index) {
        if (index === 0) {
          return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.location)}`;
        }
        const prev = this.activeTrip.itinerary[index - 1];
        const origin = encodeURIComponent(prev.location);
        const dest = encodeURIComponent(item.location);
        return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=transit`;
      },

      addItineraryItem() {
        if (!this.activeTrip) return;
        const time = prompt('æ™‚é–“ (HH:MM)');
        const activity = prompt('æ´»å‹•åç¨±');
        const location = prompt('åœ°é» / åœ°å€ (ç”¨æ–¼å°èˆª)');
        if (time && activity) {
          this.activeTrip.itinerary.push({
            time,
            activity,
            location: location || activity
          });
          this.activeTrip.itinerary.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
          this.$nextTick(() => this.updateRoute());
        }
      },
      removeItineraryItem(index) {
        if (!this.activeTrip) return;
        if (confirm('ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) {
          this.activeTrip.itinerary.splice(index, 1);
          this.$nextTick(() => this.updateRoute());
        }
      },

      // è¨˜å¸³
      addExpense() {
        if (!this.activeTrip) return;
        if (!this.newExpense.item || !this.newExpense.amount) return;
        const d = new Date();
        this.activeTrip.expenses.unshift({
          ...this.newExpense,
          date: `${d.getMonth() + 1}/${d.getDate()}`
        });
        this.newExpense = { item: '', amount: null, payment: 'cash' };
      },

      // æ—…ç¨‹ä¸­è³¼ç‰©
      addTripItem() {
        if (!this.activeTrip) return;
        if (!this.newTripItem) return;
        this.activeTrip.tripItems.push({ text: this.newTripItem, checked: false });
        this.newTripItem = '';
      },
      removeTripItem(index) {
        if (!this.activeTrip) return;
        this.activeTrip.tripItems.splice(index, 1);
      },
      toggleTripItem(index) {
        if (!this.activeTrip) return;
        this.activeTrip.tripItems[index].checked = !this.activeTrip.tripItems[index].checked;
      },

      // è¡Œå‰è³¼ç‰©
      addPreTripItem() {
        if (!this.activeTrip) return;
        this.activeTrip.preTripItems.push({
          name: '',
          image: '',
          onlinePrice: null,
          purchased: false,
          actualPrice: null
        });
      },
      removePreTripItem(index) {
        if (!this.activeTrip) return;
        this.activeTrip.preTripItems.splice(index, 1);
      },

      // Trips / History
      switchTrip(id) {
        this.activeTripId = id;
        this.activeTab = 'itinerary';
      },
      deleteTrip(id) {
        if (this.trips.length === 1) {
          alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æ—…ç¨‹');
          return;
        }
        if (!confirm('ç¢ºå®šåˆªé™¤æ­¤æ—…ç¨‹ï¼Ÿ')) return;
        this.trips = this.trips.filter(t => t.id !== id);
        if (!this.trips.find(t => t.id === this.activeTripId)) {
          this.activeTripId = this.trips[0]?.id || null;
        }
      },
      startCreateTrip() {
        this.creatingTrip = true;
        this.newTripForm = {
          title: '',
          destination: '',
          city: '',
          currency: 'HKD',
          startDate: '',
          endDate: '',
          lat: 35.6762,
          lng: 139.6503
        };
      },
      createTrip() {
        if (!this.newTripForm.title || !this.newTripForm.destination) {
          alert('è«‹è‡³å°‘å¡«å¯«æ—…ç¨‹åç¨±èˆ‡ç›®çš„åœ°');
          return;
        }
        const trip = {
          id: Date.now().toString(),
          title: this.newTripForm.title,
          destination: this.newTripForm.destination,
          city: this.newTripForm.city || this.newTripForm.destination,
          currency: this.newTripForm.currency || 'HKD',
          startDate: this.newTripForm.startDate || '',
          endDate: this.newTripForm.endDate || '',
          center: { lat: this.newTripForm.lat || 35.6762, lng: this.newTripForm.lng || 139.6503 },
          exchangeRate: 0.0058,
          travelMode: 'TRANSIT',
          flights: {
            outbound: { no: '-', date: this.newTripForm.startDate || '-', from: '-', to: '-' },
            inbound: { no: '-', date: this.newTripForm.endDate || '-', from: '-', to: '-' }
          },
          itinerary: [],
          routeSummary: null,
          expenses: [],
          tripItems: [],
          preTripItems: []
        };
        this.trips.push(trip);
        this.activeTripId = trip.id;
        this.creatingTrip = false;
        this.$nextTick(() => {
          if (map) {
            map.setCenter(trip.center);
            map.setZoom(12);
          }
          this.fetchWeather();
        });
      }
    }
  }).mount('#app');
</script>
</body>
</html>
