<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Travel Diary - 旅遊日記</title>
  
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Remix Icon -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  
  <style>
    body {
      background: linear-gradient(135deg, #C4E1FF 0%, #D2E9FF 25%, #DDDDFF 50%, #FFECF5 100%);
      min-height: 100vh;
      font-family: system-ui, -apple-system, sans-serif;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }
    
    .flight-sky {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .weather-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    
    .weather-sunny {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
    }
    
    .weather-cloudy {
      background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
    }
    
    .weather-rainy {
      background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
      color: white;
    }
    
    .tab-active {
      background: white;
      color: #667eea;
      font-weight: 600;
    }
    
    .trip-card-active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    #map {
      height: 500px;
      border-radius: 1rem;
    }
    
    .timeline-dot {
      width: 12px;
      height: 12px;
      background: #667eea;
      border-radius: 50%;
      position: absolute;
      left: -6px;
      top: 8px;
    }
    
    .timeline-line {
      position: absolute;
      left: -1px;
      top: 20px;
      bottom: -20px;
      width: 2px;
      background: #ddd;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header class="glass-card sticky top-0 z-50 mb-6">
      <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <i class="ri-flight-takeoff-line text-3xl text-purple-600"></i>
          <h1 class="text-2xl font-bold text-gray-800">Travel Diary</h1>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-600">{{ activeTrip.title }}</span>
          <button @click="currentTab = 'trips'" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
            <i class="ri-list-check-2"></i> 旅程管理
          </button>
        </div>
      </div>
    </header>

    <div class="max-w-7xl mx-auto px-4 pb-8">
      <!-- Tab Navigation -->
      <div class="glass-card rounded-2xl p-2 mb-6 flex gap-2 overflow-x-auto">
        <button @click="currentTab = 'info'" :class="{'tab-active': currentTab === 'info'}" 
          class="px-6 py-3 rounded-xl transition whitespace-nowrap flex items-center gap-2">
          <i class="ri-information-line"></i> Trip Info
        </button>
        <button @click="currentTab = 'itinerary'" :class="{'tab-active': currentTab === 'itinerary'}" 
          class="px-6 py-3 rounded-xl transition whitespace-nowrap flex items-center gap-2">
          <i class="ri-map-pin-line"></i> 行程·地圖
        </button>
        <button @click="currentTab = 'budget'" :class="{'tab-active': currentTab === 'budget'}" 
          class="px-6 py-3 rounded-xl transition whitespace-nowrap flex items-center gap-2">
          <i class="ri-wallet-line"></i> 記帳
        </button>
        <button @click="currentTab = 'shopping'" :class="{'tab-active': currentTab === 'shopping'}" 
          class="px-6 py-3 rounded-xl transition whitespace-nowrap flex items-center gap-2">
          <i class="ri-shopping-cart-line"></i> 購物
        </button>
        <button @click="currentTab = 'trips'" :class="{'tab-active': currentTab === 'trips'}" 
          class="px-6 py-3 rounded-xl transition whitespace-nowrap flex items-center gap-2">
          <i class="ri-time-line"></i> History
        </button>
      </div>

      <!-- Trip Info Tab -->
      <div v-if="currentTab === 'info'" class="space-y-6">
        <!-- Flight Details -->
        <div class="glass-card rounded-2xl p-6">
          <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
            <i class="ri-flight-takeoff-fill text-purple-600"></i> Flight Details
          </h2>
          
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Outbound Flight -->
            <div class="flight-sky rounded-xl p-5">
              <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                <i class="ri-plane-fill"></i> 去程 Outbound
              </h3>
              <div class="space-y-2">
                <input v-model="activeTrip.flights.outbound.no" placeholder="航班號 (e.g. CX123)" 
                  class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70">
                <input v-model="activeTrip.flights.outbound.date" type="date" 
                  class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                <input v-model="activeTrip.flights.outbound.from" placeholder="出發機場 IATA" 
                  class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70">
                <input v-model="activeTrip.flights.outbound.to" placeholder="到達機場 IATA" 
                  class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70">
                <button @click="autoFillFlight('outbound')" 
                  class="w-full px-4 py-2 bg-white/30 hover:bg-white/40 rounded-lg transition">
                  <i class="ri-magic-line"></i> 自動填寫
                </button>
              </div>
            </div>

            <!-- Inbound Flight -->
            <div class="flight-sky rounded-xl p-5">
              <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                <i class="ri-plane-fill" style="transform: scaleX(-1)"></i> 回程 Inbound
              </h3>
              <div class="space-y-2">
                <input v-model="activeTrip.flights.inbound.no" placeholder="航班號 (e.g. CX456)" 
                  class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70">
                <input v-model="activeTrip.flights.inbound.date" type="date" 
                  class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                <input v-model="activeTrip.flights.inbound.from" placeholder="出發機場 IATA" 
                  class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70">
                <input v-model="activeTrip.flights.inbound.to" placeholder="到達機場 IATA" 
                  class="w-full px-3 py-2 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/70">
                <button @click="autoFillFlight('inbound')" 
                  class="w-full px-4 py-2 bg-white/30 hover:bg-white/40 rounded-lg transition">
                  <i class="ri-magic-line"></i> 自動填寫
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Weather Card -->
        <div :class="['rounded-2xl p-6', weatherTheme]">
          <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
            <i class="ri-sun-line"></i> Weather
          </h2>
          <div v-if="weather">
            <p class="text-3xl font-bold">{{ weather.temperature }}°C</p>
            <p class="text-lg mt-2">{{ weather.description }}</p>
            <p class="text-sm mt-1 opacity-80">{{ activeTrip.destination }} · {{ activeTrip.city }}</p>
          </div>
          <button @click="fetchWeather" class="mt-4 px-4 py-2 bg-white/30 hover:bg-white/40 rounded-lg transition">
            <i class="ri-refresh-line"></i> 更新天氣
          </button>
        </div>

        <!-- Quick Stats -->
        <div class="grid md:grid-cols-3 gap-4">
          <div class="glass-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <i class="ri-map-pin-2-fill text-3xl text-purple-600"></i>
              <div>
                <p class="text-sm text-gray-600">總行程站數</p>
                <p class="text-2xl font-bold">{{ activeTrip.itinerary.length }}</p>
              </div>
            </div>
          </div>
          <div class="glass-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <i class="ri-money-dollar-circle-fill text-3xl text-green-600"></i>
              <div>
                <p class="text-sm text-gray-600">總支出</p>
                <p class="text-2xl font-bold">{{ totalExpenseLocal }} {{ activeTrip.currency }}</p>
              </div>
            </div>
          </div>
          <div class="glass-card rounded-xl p-5">
            <div class="flex items-center gap-3">
              <i class="ri-exchange-line text-3xl text-orange-600"></i>
              <div>
                <p class="text-sm text-gray-600">匯率 (HKD)</p>
                <p class="text-xl font-bold">1 : {{ activeTrip.exchangeRate }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Itinerary & Map Tab -->
      <div v-if="currentTab === 'itinerary'" class="space-y-6">
        <!-- Itinerary Management -->
        <div class="glass-card rounded-2xl p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold flex items-center gap-2">
              <i class="ri-calendar-check-line text-purple-600"></i> 行程管理
            </h2>
            <div class="flex gap-2">
              <button @click="showBatchImport = !showBatchImport" 
                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                <i class="ri-file-list-line"></i> 批次匯入
              </button>
              <button @click="addItinerary" 
                class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                <i class="ri-add-line"></i> 新增行程
              </button>
            </div>
          </div>

          <!-- Batch Import -->
          <div v-if="showBatchImport" class="mb-6 p-4 bg-blue-50 rounded-xl">
            <p class="text-sm mb-2 text-gray-700">每行一個地點，格式：地點名稱 | 詳細地址</p>
            <textarea v-model="batchImportText" 
              class="w-full px-3 py-2 border rounded-lg mb-2 h-32" 
              placeholder="東京鐵塔 | 東京都港區芝公園4-2-8&#10;淺草寺 | 東京都台東區淺草2-3-1"></textarea>
            <button @click="importBatch" 
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
              <i class="ri-download-line"></i> 確認匯入
            </button>
          </div>

          <!-- Itinerary List by Days -->
          <div class="space-y-6">
            <div v-for="(day, index) in groupedItinerary" :key="index" class="glass-card rounded-xl p-5">
              <h3 class="text-lg font-bold mb-4 text-purple-600">Day {{ index + 1 }}</h3>
              <div class="space-y-4">
                <div v-for="(item, idx) in day" :key="idx" class="relative pl-6">
                  <div class="timeline-dot"></div>
                  <div v-if="idx < day.length - 1" class="timeline-line"></div>
                  
                  <div class="bg-white rounded-lg p-4 shadow-sm">
                    <div class="grid md:grid-cols-6 gap-3">
                      <input v-model="item.time" type="time" class="px-3 py-2 border rounded-lg">
                      <input v-model="item.activity" placeholder="活動" class="px-3 py-2 border rounded-lg md:col-span-2">
                      <input v-model="item.location" placeholder="地點" class="px-3 py-2 border rounded-lg md:col-span-2">
                      <div class="flex gap-2">
                        <button @click="openMaps(item, idx)" 
                          class="flex-1 px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm">
                          <i class="ri-map-pin-line"></i>
                        </button>
                        <button @click="deleteItinerary(activeTrip.itinerary.indexOf(item))" 
                          class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">
                          <i class="ri-delete-bin-line"></i>
                        </button>
                      </div>
                    </div>
                    <div class="mt-2 grid md:grid-cols-2 gap-3">
                      <input v-model="item.mapsUrl" placeholder="Google Maps URL" class="px-3 py-2 border rounded-lg text-sm">
                      <input v-model="item.bookingTime" placeholder="預訂時間" class="px-3 py-2 border rounded-lg text-sm">
                    </div>
                    <input v-model="item.remark" placeholder="備註" class="w-full mt-2 px-3 py-2 border rounded-lg text-sm">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Map -->
        <div class="glass-card rounded-2xl p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold flex items-center gap-2">
              <i class="ri-map-2-line text-purple-600"></i> 地圖與路線
            </h2>
            <button @click="updateRoute" 
              class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
              <i class="ri-refresh-line"></i> 更新路線
            </button>
          </div>
          <div id="map"></div>
          <div v-if="activeTrip.routeSummary" class="mt-4 p-4 bg-purple-50 rounded-lg">
            <p class="text-sm text-gray-700">
              <i class="ri-route-line"></i> 總距離：約 <strong>{{ activeTrip.routeSummary.distance }}</strong> 公里
              <span v-if="activeTrip.routeSummary.time" class="ml-4">
                <i class="ri-time-line"></i> 預計時間：{{ activeTrip.routeSummary.time }}
              </span>
            </p>
          </div>
        </div>
      </div>

      <!-- Budget Tab -->
      <div v-if="currentTab === 'budget'" class="space-y-6">
        <!-- Exchange Rate -->
        <div class="glass-card rounded-2xl p-6">
          <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
            <i class="ri-exchange-dollar-line text-purple-600"></i> 匯率
          </h2>
          <div class="flex items-center gap-4 mb-4">
            <button @click="fetchExchangeRate" 
              class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
              <i class="ri-refresh-line"></i> 取得匯率
            </button>
            <span class="text-lg">HKD → {{ activeTrip.currency }}</span>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="p-4 bg-purple-50 rounded-xl">
              <p class="text-sm text-gray-600 mb-1">當前匯率</p>
              <p class="text-2xl font-bold">1 HKD = {{ activeTrip.exchangeRate }} {{ activeTrip.currency }}</p>
              <p class="text-sm text-gray-600 mt-2">1,000 HKD ≈ {{ (1000 * activeTrip.exchangeRate).toFixed(2) }} {{ activeTrip.currency }}</p>
            </div>
            <div>
              <label class="text-sm text-gray-600">手動調整匯率</label>
              <input v-model.number="activeTrip.exchangeRate" type="number" step="0.0001" 
                class="w-full px-3 py-2 border rounded-lg mt-1">
            </div>
          </div>
        </div>

        <!-- Add Expense -->
        <div class="glass-card rounded-2xl p-6">
          <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
            <i class="ri-add-circle-line text-purple-600"></i> 新增支出
          </h2>
          <div class="grid md:grid-cols-2 gap-4">
            <input v-model="newExpense.item" placeholder="項目名稱" class="px-3 py-2 border rounded-lg">
            <input v-model.number="newExpense.amount" type="number" placeholder="金額 (HKD)" class="px-3 py-2 border rounded-lg">
            <select v-model="newExpense.method" class="px-3 py-2 border rounded-lg">
              <option value="現金">現金</option>
              <option value="信用卡">信用卡</option>
              <option value="其他">其他</option>
            </select>
            <select v-model="newExpense.category" class="px-3 py-2 border rounded-lg">
              <option value="飲食">飲食</option>
              <option value="購物">購物</option>
              <option value="娛樂">娛樂</option>
              <option value="交通">交通</option>
              <option value="其他">其他</option>
            </select>
          </div>
          <button @click="addExpense" 
            class="mt-4 px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
            <i class="ri-save-line"></i> 記一筆
          </button>
        </div>

        <!-- Expense Summary -->
        <div class="glass-card rounded-2xl p-6">
          <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
            <i class="ri-pie-chart-line text-purple-600"></i> 支出摘要
          </h2>
          <div class="grid md:grid-cols-2 gap-4 mb-6">
            <div class="p-4 bg-green-50 rounded-xl">
              <p class="text-sm text-gray-600">總筆數</p>
              <p class="text-3xl font-bold text-green-600">{{ activeTrip.expenses.length }}</p>
            </div>
            <div class="p-4 bg-blue-50 rounded-xl">
              <p class="text-sm text-gray-600">總支出</p>
              <p class="text-2xl font-bold text-blue-600">{{ totalExpenseHKD }} HKD</p>
              <p class="text-lg text-gray-700">≈ {{ totalExpenseLocal }} {{ activeTrip.currency }}</p>
            </div>
          </div>

          <!-- Expense List -->
          <div class="space-y-2 max-h-96 overflow-y-auto">
            <div v-for="(exp, index) in activeTrip.expenses" :key="index" 
              class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm">
              <div class="flex-1">
                <p class="font-semibold">{{ exp.item }}</p>
                <p class="text-sm text-gray-600">{{ exp.date }} · {{ exp.method }} · {{ exp.category }}</p>
              </div>
              <div class="text-right">
                <p class="font-bold text-lg">${{ exp.amount }} HKD</p>
                <p class="text-sm text-gray-600">≈ {{ (exp.amount * activeTrip.exchangeRate).toFixed(2) }} {{ activeTrip.currency }}</p>
              </div>
              <button @click="deleteExpense(index)" class="ml-3 text-red-500 hover:text-red-700">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Shopping Tab -->
      <div v-if="currentTab === 'shopping'" class="space-y-6">
        <!-- Add Shopping Item -->
        <div class="glass-card rounded-2xl p-6">
          <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
            <i class="ri-shopping-bag-line text-purple-600"></i> 新增購物項目
          </h2>
          <div class="space-y-3">
            <input v-model="newShoppingItem.name" placeholder="品項名稱" class="w-full px-3 py-2 border rounded-lg">
            <input v-model="newShoppingItem.onlinePrice" placeholder="網上價錢" class="w-full px-3 py-2 border rounded-lg">
            <input v-model="newShoppingItem.localPrice" placeholder="本地實付價" class="w-full px-3 py-2 border rounded-lg">
            <div>
              <label class="block text-sm text-gray-600 mb-1">上傳圖片</label>
              <input type="file" accept="image/*" @change="handleImageUpload" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <button @click="addShoppingItem" 
              class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
              <i class="ri-add-line"></i> 加入購物清單
            </button>
          </div>
        </div>

        <!-- Shopping List -->
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div v-for="(item, index) in activeTrip.shoppingItems" :key="index" 
            :class="['glass-card rounded-xl p-4', item.purchased ? 'opacity-60' : '']">
            <img v-if="item.imageData" :src="item.imageData" class="w-full h-48 object-cover rounded-lg mb-3">
            <div v-else class="w-full h-48 bg-gray-200 rounded-lg mb-3 flex items-center justify-center">
              <i class="ri-image-line text-4xl text-gray-400"></i>
            </div>
            <h3 class="font-bold text-lg mb-2">{{ item.name }}</h3>
            <div class="text-sm space-y-1 mb-3">
              <p class="text-gray-600">網上價：<span class="font-semibold">{{ item.onlinePrice }}</span></p>
              <p class="text-gray-600">本地價：<span class="font-semibold text-green-600">{{ item.localPrice }}</span></p>
            </div>
            <div class="flex items-center justify-between">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" v-model="item.purchased" class="w-5 h-5">
                <span class="text-sm">已購買</span>
              </label>
              <button @click="deleteShoppingItem(index)" 
                class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition text-sm">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Trips History Tab -->
      <div v-if="currentTab === 'trips'" class="space-y-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold flex items-center gap-2">
            <i class="ri-time-line text-purple-600"></i> 所有旅程
          </h2>
          <button @click="createNewTrip" 
            class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
            <i class="ri-add-line"></i> 新增旅程
          </button>
        </div>

        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div v-for="trip in trips" :key="trip.id" 
            @click="switchTrip(trip.id)"
            :class="['rounded-xl p-6 cursor-pointer transition hover:scale-105', 
                     trip.id === activeTripId ? 'trip-card-active' : 'glass-card']">
            <div v-if="trip.id === activeTripId" class="inline-block px-3 py-1 bg-white/30 rounded-full text-xs font-bold mb-3">
              ACTIVE
            </div>
            <h3 class="text-2xl font-bold mb-2">{{ trip.title }}</h3>
            <p class="text-sm opacity-90 mb-4">
              <i class="ri-map-pin-line"></i> {{ trip.destination }} · {{ trip.city }}
            </p>
            <div class="space-y-2 text-sm opacity-90">
              <p><i class="ri-calendar-line"></i> {{ trip.startDate }} ~ {{ trip.endDate }}</p>
              <p><i class="ri-money-dollar-circle-line"></i> {{ trip.currency }}</p>
              <p><i class="ri-route-line"></i> {{ trip.itinerary.length }} 個行程</p>
              <p><i class="ri-shopping-bag-line"></i> {{ trip.shoppingItems.length }} 個購物項目</p>
            </div>
            <div class="mt-4 flex gap-2">
              <button @click.stop="editTrip(trip)" 
                class="flex-1 px-3 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition text-sm">
                <i class="ri-edit-line"></i> 編輯
              </button>
              <button @click.stop="deleteTrip(trip.id)" 
                class="px-3 py-2 bg-red-500/80 hover:bg-red-600 rounded-lg transition text-sm">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          currentTab: 'info',
          activeTripId: null,
          trips: [],
          weather: null,
          map: null,
          markers: [],
          polyline: null,
          showBatchImport: false,
          batchImportText: '',
          newExpense: {
            item: '',
            amount: 0,
            method: '現金',
            category: '飲食'
          },
          newShoppingItem: {
            name: '',
            onlinePrice: '',
            localPrice: '',
            imageData: null
          }
        };
      },
      computed: {
        activeTrip() {
          return this.trips.find(t => t.id === this.activeTripId) || this.trips[0];
        },
        weatherTheme() {
          if (!this.weather) return 'weather-card';
          const desc = this.weather.description.toLowerCase();
          if (desc.includes('sun') || desc.includes('clear') || desc.includes('晴')) {
            return 'weather-sunny';
          } else if (desc.includes('cloud') || desc.includes('陰') || desc.includes('霧')) {
            return 'weather-cloudy';
          } else if (desc.includes('rain') || desc.includes('雨') || desc.includes('storm')) {
            return 'weather-rainy';
          }
          return 'weather-card';
        },
        groupedItinerary() {
          const daySize = 5;
          const groups = [];
          for (let i = 0; i < this.activeTrip.itinerary.length; i += daySize) {
            groups.push(this.activeTrip.itinerary.slice(i, i + daySize));
          }
          return groups;
        },
        totalExpenseHKD() {
          return this.activeTrip.expenses.reduce((sum, exp) => sum + exp.amount, 0).toFixed(2);
        },
        totalExpenseLocal() {
          return (this.totalExpenseHKD * this.activeTrip.exchangeRate).toFixed(2);
        }
      },
      mounted() {
        this.loadTrips();
        this.initMap();
        this.fetchWeather();
      },
      watch: {
        activeTripId() {
          this.saveTrips();
          this.fetchWeather();
          if (this.map) {
            this.map.setView([this.activeTrip.center.lat, this.activeTrip.center.lng], 13);
          }
        },
        trips: {
          deep: true,
          handler() {
            this.saveTrips();
          }
        }
      },
      methods: {
        loadTrips() {
          const saved = localStorage.getItem('christine_travel_diary_trips');
          if (saved) {
            this.trips = JSON.parse(saved);
          } else {
            this.trips = [{
              id: Date.now(),
              title: 'Japan Tokyo 2025',
              destination: 'Japan',
              city: 'Tokyo',
              currency: 'JPY',
              startDate: '2025-03-15',
              endDate: '2025-03-20',
              center: { lat: 35.6762, lng: 139.6503 },
              exchangeRate: 16.5,
              flights: {
                outbound: { no: '', date: '', from: 'HKG', to: 'NRT' },
                inbound: { no: '', date: '', from: 'NRT', to: 'HKG' }
              },
              itinerary: [],
              routeSummary: { distance: 0, time: '' },
              expenses: [],
              shoppingItems: [],
              savedListLink: ''
            }];
          }
          this.activeTripId = this.trips[0].id;
        },
        saveTrips() {
          localStorage.setItem('christine_travel_diary_trips', JSON.stringify(this.trips));
        },
        initMap() {
          this.$nextTick(() => {
            this.map = L.map('map').setView([this.activeTrip.center.lat, this.activeTrip.center.lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '© OpenStreetMap contributors'
            }).addTo(this.map);
          });
        },
        async fetchWeather() {
          try {
            const { lat, lng } = this.activeTrip.center;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`;
            const response = await fetch(url);
            const data = await response.json();
            this.weather = {
              temperature: data.current_weather.temperature,
              description: this.getWeatherDescription(data.current_weather.weathercode)
            };
          } catch (error) {
            console.error('Weather fetch error:', error);
            this.weather = { temperature: 'N/A', description: 'Unable to fetch' };
          }
        },
        getWeatherDescription(code) {
          const descriptions = {
            0: 'Clear sky 晴天',
            1: 'Mainly clear 大致晴朗',
            2: 'Partly cloudy 部分多雲',
            3: 'Overcast 陰天',
            45: 'Foggy 有霧',
            48: 'Foggy 有霧',
            51: 'Light drizzle 小雨',
            61: 'Light rain 小雨',
            80: 'Rain showers 陣雨',
            95: 'Thunderstorm 雷暴'
          };
          return descriptions[code] || 'Unknown';
        },
        async fetchExchangeRate() {
          try {
            const url = `https://api.exchangerate.host/latest?base=HKD&symbols=${this.activeTrip.currency}`;
            const response = await fetch(url);
            const data = await response.json();
            this.activeTrip.exchangeRate = data.rates[this.activeTrip.currency].toFixed(4);
          } catch (error) {
            console.error('Exchange rate fetch error:', error);
            alert('無法取得匯率，請手動輸入');
          }
        },
        async autoFillFlight(direction) {
          const flight = this.activeTrip.flights[direction];
          if (!flight.no || !flight.date) {
            alert('請先填寫航班號和日期');
            return;
          }
          
          try {
            // Note: Aviationstack requires API key, this is a placeholder
            const apiKey = '5b729556e3ef80e18916fcecbcfd81ba';
            const url = `http://api.aviationstack.com/v1/flights?access_key=${apiKey}&flight_iata=${flight.no}&flight_date=${flight.date}`;
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.data && data.data.length > 0) {
              const flightData = data.data[0];
              flight.from = flightData.departure.iata;
              flight.to = flightData.arrival.iata;
              alert('航班資料已自動填寫');
            } else {
              alert('找不到航班資料，請手動填寫');
            }
          } catch (error) {
            console.error('Flight fetch error:', error);
            alert('無法取得航班資料（需要 API Key），請手動填寫');
          }
        },
        addItinerary() {
          const activity = prompt('輸入活動名稱：');
          if (activity) {
            this.activeTrip.itinerary.push({
              time: '10:00',
              activity: activity,
              location: '',
              mapsUrl: '',
              bookingTime: '',
              remark: ''
            });
          }
        },
        deleteItinerary(index) {
          if (confirm('確定刪除此行程？')) {
            this.activeTrip.itinerary.splice(index, 1);
          }
        },
        importBatch() {
          const lines = this.batchImportText.trim().split('\n');
          let startHour = 10;
          
          lines.forEach(line => {
            const parts = line.split('|').map(p => p.trim());
            const name = parts[0] || '';
            const address = parts[1] || '';
            
            this.activeTrip.itinerary.push({
              time: `${String(startHour).padStart(2, '0')}:00`,
              activity: name,
              location: address,
              mapsUrl: '',
              bookingTime: '',
              remark: ''
            });
            
            startHour++;
          });
          
          this.batchImportText = '';
          this.showBatchImport = false;
          alert(`已匯入 ${lines.length} 個行程`);
        },
        openMaps(item, index) {
          if (item.mapsUrl) {
            window.open(item.mapsUrl, '_blank');
          } else if (item.location) {
            const prevItem = this.activeTrip.itinerary[index - 1];
            const origin = prevItem ? encodeURIComponent(prevItem.location) : '';
            const destination = encodeURIComponent(item.location);
            const url = `https://www.google.com/maps/dir/${origin}/${destination}`;
            window.open(url, '_blank');
          } else {
            alert('請先填寫地點資訊');
          }
        },
        async updateRoute() {
          if (!this.map || this.activeTrip.itinerary.length === 0) return;
          
          // Clear existing markers and polyline
          this.markers.forEach(m => this.map.removeLayer(m));
          if (this.polyline) this.map.removeLayer(this.polyline);
          this.markers = [];
          
          const coords = [];
          let totalDistance = 0;
          
          for (let i = 0; i < this.activeTrip.itinerary.length; i++) {
            const item = this.activeTrip.itinerary[i];
            if (!item.location) continue;
            
            try {
              const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(item.location)}`;
              const response = await fetch(url);
              const data = await response.json();
              
              if (data && data.length > 0) {
                const lat = parseFloat(data[0].lat);
                const lng = parseFloat(data[0].lon);
                coords.push([lat, lng]);
                
                const marker = L.marker([lat, lng]).addTo(this.map)
                  .bindPopup(`<b>${item.time}</b><br>${item.activity}<br>${item.location}`);
                this.markers.push(marker);
                
                if (i > 0) {
                  const prevCoord = coords[coords.length - 2];
                  totalDistance += this.calculateDistance(prevCoord[0], prevCoord[1], lat, lng);
                }
              }
            } catch (error) {
              console.error('Geocoding error:', error);
            }
            
            await new Promise(resolve => setTimeout(resolve, 1000)); // Rate limiting
          }
          
          if (coords.length > 0) {
            this.polyline = L.polyline(coords, { color: '#667eea', weight: 4 }).addTo(this.map);
            this.map.fitBounds(this.polyline.getBounds());
            this.activeTrip.routeSummary.distance = totalDistance.toFixed(2);
          }
        },
        calculateDistance(lat1, lon1, lat2, lon2) {
          const R = 6371; // Earth radius in km
          const dLat = (lat2 - lat1) * Math.PI / 180;
          const dLon = (lon2 - lon1) * Math.PI / 180;
          const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          return R * c;
        },
        addExpense() {
          if (!this.newExpense.item || this.newExpense.amount <= 0) {
            alert('請填寫項目和金額');
            return;
          }
          
          const today = new Date();
          const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
          
          this.activeTrip.expenses.unshift({
            date: dateStr,
            item: this.newExpense.item,
            amount: this.newExpense.amount,
            method: this.newExpense.method,
            category: this.newExpense.category
          });
          
          this.newExpense = { item: '', amount: 0, method: '現金', category: '飲食' };
        },
        deleteExpense(index) {
          if (confirm('確定刪除此支出？')) {
            this.activeTrip.expenses.splice(index, 1);
          }
        },
        handleImageUpload(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
              this.newShoppingItem.imageData = e.target.result;
            };
            reader.readAsDataURL(file);
          }
        },
        addShoppingItem() {
          if (!this.newShoppingItem.name) {
            alert('請填寫品項名稱');
            return;
          }
          
          this.activeTrip.shoppingItems.unshift({
            name: this.newShoppingItem.name,
            onlinePrice: this.newShoppingItem.onlinePrice,
            localPrice: this.newShoppingItem.localPrice,
            imageData: this.newShoppingItem.imageData,
            purchased: false
          });
          
          this.newShoppingItem = { name: '', onlinePrice: '', localPrice: '', imageData: null };
        },
        deleteShoppingItem(index) {
          if (confirm('確定刪除此購物項目？')) {
            this.activeTrip.shoppingItems.splice(index, 1);
          }
        },
        switchTrip(tripId) {
          this.activeTripId = tripId;
          this.currentTab = 'info';
        },
        async createNewTrip() {
          const title = prompt('旅程標題：');
          if (!title) return;
          
          const destination = prompt('目的地國家：');
          const city = prompt('城市：');
          const currency = prompt('貨幣代碼 (e.g. JPY, USD)：');
          
          let lat = 35.6762, lng = 139.6503; // Default Tokyo
          
          if (city) {
            try {
              const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
              const response = await fetch(url);
              const data = await response.json();
              if (data && data.length > 0) {
                lat = parseFloat(data[0].lat);
                lng = parseFloat(data[0].lon);
              }
            } catch (error) {
              console.error('Geocoding error:', error);
            }
          }
          
          const newTrip = {
            id: Date.now(),
            title: title,
            destination: destination || 'Unknown',
            city: city || 'Unknown',
            currency: currency || 'USD',
            startDate: new Date().toISOString().split('T')[0],
            endDate: new Date().toISOString().split('T')[0],
            center: { lat, lng },
            exchangeRate: 1,
            flights: {
              outbound: { no: '', date: '', from: '', to: '' },
              inbound: { no: '', date: '', from: '', to: '' }
            },
            itinerary: [],
            routeSummary: { distance: 0, time: '' },
            expenses: [],
            shoppingItems: [],
            savedListLink: ''
          };
          
          this.trips.push(newTrip);
          this.activeTripId = newTrip.id;
        },
        editTrip(trip) {
          const title = prompt('標題：', trip.title);
          if (title) trip.title = title;
          
          const destination = prompt('目的地：', trip.destination);
          if (destination) trip.destination = destination;
          
          const city = prompt('城市：', trip.city);
          if (city) trip.city = city;
          
          const currency = prompt('貨幣：', trip.currency);
          if (currency) trip.currency = currency;
          
          const startDate = prompt('開始日期 (YYYY-MM-DD)：', trip.startDate);
          if (startDate) trip.startDate = startDate;
          
          const endDate = prompt('結束日期 (YYYY-MM-DD)：', trip.endDate);
          if (endDate) trip.endDate = endDate;
        },
        deleteTrip(tripId) {
          if (this.trips.length <= 1) {
            alert('至少需要保留一個旅程');
            return;
          }
          
          if (confirm('確定刪除此旅程？所有相關資料將永久刪除。')) {
            this.trips = this.trips.filter(t => t.id !== tripId);
            if (this.activeTripId === tripId) {
              this.activeTripId = this.trips[0].id;
            }
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
