<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Christine's Travel Diary</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#97CBFF',
            secondary: '#C7C7E2',
            textSoft: '#6B7280',
          }
        }
      }
    }
  </script>
  
  <!-- Remix Icon -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.3.0/fonts/remixicon.css" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #C4E1FF 0%, #D2E9FF 33%, #DDDDFF 66%, #FFECF5 100%);
      background-attachment: fixed;
      font-family: system-ui, -apple-system, sans-serif;
      color: #1f2937;
      padding-bottom: 100px; /* 預留底部 Tab 空間 */
    }
    
    /* 玻璃擬態卡片 */
    .glass-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
      border-radius: 20px;
    }

    /* 天氣與航班背景 */
    .flight-sky {
      background: linear-gradient(135deg, #C4E1FF 0%, #D2E9FF 50%, #DDDDFF 100%);
    }
    .weather-card {
      color: #4B5563;
      transition: all 0.3s ease;
    }
    .weather-sunny { background: linear-gradient(135deg, #FFECF5 0%, #FFD9EC 40%, #ECECFF 100%); }
    .weather-cloudy { background: linear-gradient(135deg, #DDDDFF 0%, #E6E6F2 40%, #D8D8EB 100%); }
    .weather-rainy { background: linear-gradient(135deg, #D8D8EB 0%, #E6E6F2 35%, #C4E1FF 100%); }

    /* 地圖容器 */
    #map { 
      height: 400px; 
      width: 100%; 
      border-radius: 20px; 
      z-index: 10; 
    }

    /* 底部導航 */
    .capsule-tab {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    }
    
    /* Active Trip Highlight */
    .active-trip-card {
      border: 2px solid #97CBFF;
      background: rgba(255, 255, 255, 0.95);
    }
  </style>
</head>
<body>

<div id="app">
  
  <!-- 1. Header: 純文字左上角 (已移除膠囊樣式) -->
  <header class="fixed top-0 left-0 w-full p-6 z-50 flex items-center justify-between pointer-events-none">
    <div class="flex items-center gap-2 pointer-events-auto">
      <i class="ri-plane-fill text-2xl text-primary drop-shadow-sm"></i>
      <h1 class="text-xl font-bold text-slate-700 tracking-wide drop-shadow-sm">Christine's Travel Diary</h1>
    </div>
    <!-- 右上角快捷按鈕：新增旅程 -->
    <button @click="openNewTripModal" class="pointer-events-auto w-10 h-10 rounded-full bg-white/80 backdrop-blur shadow text-primary flex items-center justify-center hover:bg-white transition">
      <i class="ri-add-line text-xl"></i>
    </button>
  </header>

  <!-- Main Content Area -->
  <main class="pt-24 px-4 max-w-3xl mx-auto">
    
    <!-- === Tab 1: Trip Info === -->
    <section v-if="activeTab === 'info' && activeTrip">
      
      <!-- Flight Card -->
      <div class="glass-card overflow-hidden mb-6">
        <div class="flight-sky p-6">
          <h2 class="text-white font-bold text-lg mb-4 flex items-center gap-2">
            <i class="ri-flight-takeoff-line"></i> 航班資訊
          </h2>
          <!-- Outbound -->
          <div class="bg-white/30 backdrop-blur-md rounded-xl p-4 mb-3">
            <div class="flex justify-between items-center mb-2">
              <span class="text-xs font-bold text-slate-700 uppercase">Outbound (去程)</span>
              <button @click="fetchFlight('outbound')" class="text-xs bg-white/50 px-2 py-1 rounded text-slate-700">自動填寫</button>
            </div>
            <div class="flex gap-2 mb-2">
               <input v-model="activeTrip.flights.outbound.no" placeholder="航班 (e.g. NH924)" class="w-1/2 p-2 rounded-lg text-sm bg-white/60 border-0 focus:ring-2 ring-primary/50">
               <input v-model="activeTrip.flights.outbound.date" type="date" class="w-1/2 p-2 rounded-lg text-sm bg-white/60 border-0">
            </div>
            <div class="flex justify-between text-sm font-bold text-slate-800 px-1">
               <span>{{ activeTrip.flights.outbound.from || 'HKG' }}</span>
               <i class="ri-arrow-right-line text-white/80"></i>
               <span>{{ activeTrip.flights.outbound.to || 'NRT' }}</span>
            </div>
          </div>
          <!-- Inbound -->
          <div class="bg-white/30 backdrop-blur-md rounded-xl p-4">
            <div class="flex justify-between items-center mb-2">
              <span class="text-xs font-bold text-slate-700 uppercase">Inbound (回程)</span>
              <button @click="fetchFlight('inbound')" class="text-xs bg-white/50 px-2 py-1 rounded text-slate-700">自動填寫</button>
            </div>
            <div class="flex gap-2 mb-2">
               <input v-model="activeTrip.flights.inbound.no" placeholder="航班 (e.g. NH923)" class="w-1/2 p-2 rounded-lg text-sm bg-white/60 border-0 focus:ring-2 ring-primary/50">
               <input v-model="activeTrip.flights.inbound.date" type="date" class="w-1/2 p-2 rounded-lg text-sm bg-white/60 border-0">
            </div>
             <div class="flex justify-between text-sm font-bold text-slate-800 px-1">
               <span>{{ activeTrip.flights.inbound.from || 'NRT' }}</span>
               <i class="ri-arrow-right-line text-white/80"></i>
               <span>{{ activeTrip.flights.inbound.to || 'HKG' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Weather Card -->
      <div :class="['glass-card p-6 mb-6 weather-card', `weather-${weatherTheme}`]">
        <div class="flex justify-between items-start">
          <div>
            <h2 class="font-bold text-lg mb-1 flex items-center gap-2">
              <i class="ri-sun-cloudy-line"></i> 當地天氣 ({{ activeTrip.city }})
            </h2>
            <p class="text-3xl font-bold mt-2">{{ weatherData ? Math.round(weatherData.temperature) : '--' }}°C</p>
            <p class="text-sm opacity-70">{{ weatherDesc }}</p>
          </div>
          <button @click="fetchWeather" class="bg-white/40 p-2 rounded-full hover:bg-white/60 transition"><i class="ri-refresh-line"></i></button>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-2 gap-4">
        <div class="glass-card p-4 flex flex-col items-center justify-center">
          <span class="text-3xl font-bold text-primary">{{ activeTrip.itinerary.length }}</span>
          <span class="text-xs text-secondary uppercase">行程站數</span>
        </div>
        <div class="glass-card p-4 flex flex-col items-center justify-center">
          <span class="text-xl font-bold text-primary">{{ totalExpensesHKD.toLocaleString() }}</span>
          <span class="text-xs text-secondary uppercase">總支出 (HKD)</span>
        </div>
      </div>
    </section>

    <!-- === Tab 2: 行程 / 地圖 (修復地圖顯示問題) === -->
    <section v-if="activeTab === 'itinerary-map' && activeTrip">
      <!-- Actions -->
      <div class="glass-card p-4 mb-6 flex gap-2 overflow-x-auto">
        <button @click="addItineraryItem" class="flex-shrink-0 bg-primary text-white px-4 py-2 rounded-xl text-sm font-medium shadow-sm hover:opacity-90">+ 新增行程</button>
        <button @click="toggleBatchImport" class="flex-shrink-0 bg-secondary text-white px-4 py-2 rounded-xl text-sm font-medium shadow-sm">批次匯入</button>
        <button @click="forceUpdateMap" class="flex-shrink-0 bg-white text-primary border border-primary px-4 py-2 rounded-xl text-sm font-medium shadow-sm">刷新地圖</button>
      </div>

      <!-- Batch Import Area -->
      <div v-if="showBatchImport" class="glass-card p-4 mb-6 animate-fade-in">
        <textarea v-model="batchImportText" placeholder="貼上地點清單 (一行一個)..." class="w-full h-32 p-3 rounded-xl border border-slate-200 text-sm mb-3 focus:outline-none focus:border-primary"></textarea>
        <button @click="runBatchImport" class="w-full bg-primary text-white py-2 rounded-xl font-medium">確認匯入</button>
      </div>

      <!-- Map Container -->
      <div class="glass-card p-1 mb-6">
        <div id="map"></div>
        <div class="p-2 text-center text-xs text-slate-400 bg-white/50 rounded-b-xl">
          總距離: {{ (activeTrip.routeSummary?.distance || 0).toFixed(1) }} km
        </div>
      </div>

      <!-- Itinerary List -->
      <div v-for="(group, dayIdx) in groupedItinerary" :key="dayIdx" class="mb-8">
        <div class="flex items-center gap-4 mb-4">
          <h3 class="text-xl font-bold text-slate-700 bg-white/50 px-4 py-1 rounded-full backdrop-blur-sm">Day {{ dayIdx + 1 }}</h3>
          <div class="h-px bg-slate-300 flex-1"></div>
        </div>
        
        <div class="relative pl-4 border-l-2 border-primary/30 ml-2 space-y-6">
          <div v-for="(item, idx) in group" :key="idx" class="relative">
            <!-- Timeline dot -->
            <div class="absolute -left-[21px] top-4 w-3 h-3 rounded-full bg-primary ring-4 ring-white"></div>
            
            <div class="glass-card p-4 ml-4">
              <div class="flex justify-between items-start mb-2">
                <input v-model="item.time" type="time" class="bg-transparent font-bold text-primary text-lg border-b border-transparent hover:border-primary/30 focus:outline-none w-24">
                <button @click="removeItineraryItem(dayIdx, idx)" class="text-slate-300 hover:text-red-400"><i class="ri-close-circle-line"></i></button>
              </div>
              
              <input v-model="item.location" placeholder="地點" class="w-full font-bold text-slate-700 bg-transparent mb-1 border-b border-transparent focus:border-primary/30 focus:outline-none">
              <input v-model="item.activity" placeholder="活動內容" class="w-full text-sm text-slate-500 bg-transparent mb-3 border-b border-transparent focus:border-primary/30 focus:outline-none">
              
              <div class="flex gap-2">
                <button @click="openGoogleMaps(item.location)" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 py-2 rounded-lg text-xs font-medium transition flex items-center justify-center gap-1">
                  <i class="ri-google-fill"></i> Google Maps
                </button>
                <button @click="openDirections(dayIdx, idx)" class="flex-1 bg-primary/10 hover:bg-primary/20 text-primary py-2 rounded-lg text-xs font-medium transition flex items-center justify-center gap-1">
                  <i class="ri-direction-line"></i> 路線
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- === Tab 3: Budget === -->
    <section v-if="activeTab === 'budget' && activeTrip">
      <div class="glass-card p-6 mb-6 text-center">
         <p class="text-sm text-slate-500 mb-1">即時匯率</p>
         <div class="flex items-center justify-center gap-2 text-2xl font-bold text-slate-700">
           <span>1 HKD ≈ </span>
           <input v-model.number="activeTrip.exchangeRate" type="number" step="0.1" class="w-20 text-center bg-transparent border-b border-slate-300 focus:outline-none focus:border-primary">
           <span>{{ activeTrip.currency }}</span>
         </div>
         <button @click="fetchRate" class="text-xs text-primary mt-2 flex items-center justify-center gap-1 mx-auto"><i class="ri-refresh-line"></i> 更新匯率</button>
      </div>

      <div class="glass-card p-6 mb-6">
        <h3 class="font-bold mb-4">記一筆</h3>
        <div class="space-y-3">
          <input v-model="newExpense.name" placeholder="項目名稱" class="w-full p-3 rounded-xl bg-slate-50 border-0">
          <div class="flex gap-2">
            <input v-model.number="newExpense.amount" type="number" placeholder="HKD" class="flex-1 p-3 rounded-xl bg-slate-50 border-0">
            <select v-model="newExpense.method" class="w-1/3 p-3 rounded-xl bg-slate-50 border-0 text-sm">
              <option>現金</option>
              <option>信用卡</option>
            </select>
          </div>
          <select v-model="newExpense.category" class="w-full p-3 rounded-xl bg-slate-50 border-0">
            <option>飲食</option>
            <option>購物</option>
            <option>交通</option>
            <option>娛樂</option>
            <option>其他</option>
          </select>
          <button @click="addExpense" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-md hover:shadow-lg transition">新增支出</button>
        </div>
      </div>

      <div class="glass-card p-4">
        <div v-for="(exp, idx) in activeTrip.expenses" :key="idx" class="flex justify-between items-center py-3 border-b border-slate-100 last:border-0">
          <div>
            <p class="font-bold text-slate-700">{{ exp.name }}</p>
            <p class="text-xs text-slate-400">{{ exp.date }} · {{ exp.category }} · {{ exp.method }}</p>
          </div>
          <div class="text-right">
            <p class="font-bold text-slate-700">${{ exp.amount }}</p>
            <p class="text-xs text-slate-400">≈ {{ Math.round(exp.amount * activeTrip.exchangeRate) }} {{ activeTrip.currency }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- === Tab 4: Shopping === -->
    <section v-if="activeTab === 'shopping' && activeTrip">
      <div class="glass-card p-6 mb-6">
        <h3 class="font-bold mb-4">新增購物清單</h3>
        <input v-model="newShoppingItem.name" placeholder="品名" class="w-full p-3 rounded-xl bg-slate-50 border-0 mb-3">
        <div class="flex gap-2 mb-3">
          <input v-model="newShoppingItem.onlinePrice" placeholder="網上價" class="w-1/2 p-3 rounded-xl bg-slate-50 border-0">
          <input v-model="newShoppingItem.localPrice" placeholder="當地價" class="w-1/2 p-3 rounded-xl bg-slate-50 border-0">
        </div>
        <button @click="addShoppingItem" class="w-full bg-primary text-white py-3 rounded-xl font-bold shadow-md">加入清單</button>
      </div>

      <div class="grid gap-4">
        <div v-for="(item, idx) in activeTrip.shoppingItems" :key="idx" :class="['glass-card p-4 transition', item.bought ? 'opacity-50' : '']">
          <div class="flex justify-between items-start">
            <div>
              <h4 class="font-bold text-lg" :class="{'line-through': item.bought}">{{ item.name }}</h4>
              <div class="text-sm text-slate-500 mt-1">
                <span class="block">網上: {{ item.onlinePrice }}</span>
                <span class="block text-primary font-medium">當地: {{ item.localPrice }}</span>
              </div>
            </div>
            <div class="flex flex-col items-end gap-2">
              <label class="flex items-center gap-2 text-sm text-slate-600 bg-white/50 px-3 py-1 rounded-full">
                <input type="checkbox" v-model="item.bought" @change="saveData" class="rounded text-primary focus:ring-primary">
                已買
              </label>
              <button @click="removeShoppingItem(idx)" class="text-red-400 text-sm p-1"><i class="ri-delete-bin-line"></i></button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- === Tab 5: History / Trips (修復編輯功能) === -->
    <section v-if="activeTab === 'trips'">
      <div class="grid gap-6">
        <div v-for="trip in trips" :key="trip.id" 
             @click="switchTrip(trip.id)"
             :class="['glass-card p-6 cursor-pointer relative transition hover:scale-[1.01]', activeTripId === trip.id ? 'active-trip-card' : '']">
          
          <div class="flex justify-between items-start mb-2">
            <div>
              <h3 class="text-xl font-bold text-slate-800">{{ trip.title }}</h3>
              <p class="text-sm text-slate-500 flex items-center gap-1">
                <i class="ri-map-pin-line"></i> {{ trip.destination }}
              </p>
            </div>
            <span v-if="activeTripId === trip.id" class="bg-primary/20 text-primary text-xs px-2 py-1 rounded-full font-bold">CURRENT</span>
          </div>

          <div class="flex gap-4 text-sm text-slate-600 mt-4 pt-4 border-t border-slate-100">
            <span><i class="ri-calendar-line"></i> {{ trip.startDate }}</span>
            <span><i class="ri-money-dollar-circle-line"></i> {{ trip.currency }}</span>
          </div>

          <!-- 操作按鈕 -->
          <div class="flex gap-2 mt-4">
            <!-- 這裡修正了 click.stop，確保不會觸發切換旅程，而是打開編輯 -->
            <button @click.stop="openEditTripModal(trip)" class="flex-1 bg-secondary/20 hover:bg-secondary/30 text-slate-600 py-2 rounded-lg text-sm transition">編輯</button>
            <button @click.stop="deleteTrip(trip.id)" class="px-4 bg-red-50 text-red-400 hover:bg-red-100 rounded-lg text-sm transition"><i class="ri-delete-bin-line"></i></button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Trip Form Modal (新增/編輯共用) -->
  <div v-if="showTripModal" class="fixed inset-0 z-[60] flex items-end sm:items-center justify-center pointer-events-none">
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm pointer-events-auto" @click="showTripModal = false"></div>
    <div class="bg-white w-full sm:w-[400px] p-6 rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 pointer-events-auto animate-slide-up">
      <h3 class="text-xl font-bold mb-6 text-center">{{ editingTripId ? '編輯旅程' : '新增旅程' }}</h3>
      
      <div class="space-y-4">
        <input v-model="tempTrip.title" placeholder="旅程標題 (e.g. 日本東京行)" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-100">
        <input v-model="tempTrip.destination" placeholder="國家/地區" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-100">
        <div class="flex gap-2">
          <input v-model="tempTrip.city" placeholder="主要城市 (地圖中心)" class="flex-1 p-3 rounded-xl bg-slate-50 border border-slate-100">
          <input v-model="tempTrip.currency" placeholder="貨幣 (e.g. JPY)" class="w-1/3 p-3 rounded-xl bg-slate-50 border border-slate-100 uppercase">
        </div>
        <div class="flex gap-2">
          <input v-model="tempTrip.startDate" type="date" class="w-1/2 p-3 rounded-xl bg-slate-50 border border-slate-100">
          <input v-model="tempTrip.endDate" type="date" class="w-1/2 p-3 rounded-xl bg-slate-50 border border-slate-100">
        </div>
        
        <button @click="saveTrip" class="w-full bg-primary text-white py-3 rounded-xl font-bold text-lg shadow-lg mt-4">儲存</button>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[90%] max-w-md capsule-tab rounded-full p-2 flex justify-between items-center z-40">
    <button v-for="tab in tabs" :key="tab.id" @click="activeTab = tab.id"
            :class="['p-3 rounded-full transition-all duration-300 flex flex-col items-center justify-center w-16 h-16', activeTab === tab.id ? 'bg-primary text-white shadow-lg -translate-y-2' : 'text-slate-400 hover:text-slate-600']">
      <i :class="[tab.icon, 'text-xl']"></i>
      <span class="text-[10px] font-medium mt-0.5">{{ tab.label }}</span>
    </button>
  </nav>

</div>

<script>
  const { createApp } = Vue;

  // 
  const AVIATIONSTACK_KEY = '5b729556e3ef80e18916fcecbcfd81ba'; 

  createApp({
    data() {
      return {
        activeTab: 'info',
        trips: [],
        activeTripId: null,
        
        // Modal State
        showTripModal: false,
        editingTripId: null,
        tempTrip: {},

        // Maps
        map: null,
        
        // Weather
        weatherData: null,
        weatherTheme: 'sunny',
        
        // Batch Import
        showBatchImport: false,
        batchImportText: '',

        // Inputs
        newExpense: { name: '', amount: null, method: '現金', category: '飲食' },
        newShoppingItem: { name: '', onlinePrice: '', localPrice: '', bought: false },

        tabs: [
          { id: 'info', label: 'Info', icon: 'ri-information-line' },
          { id: 'itinerary-map', label: '行程', icon: 'ri-map-pin-user-line' },
          { id: 'budget', label: '記帳', icon: 'ri-wallet-3-line' },
          { id: 'shopping', label: '購物', icon: 'ri-shopping-bag-3-line' },
          { id: 'trips', label: 'History', icon: 'ri-suitcase-line' },
        ]
      };
    },
    computed: {
      activeTrip() {
        return this.trips.find(t => t.id === this.activeTripId) || null;
      },
      groupedItinerary() {
        if (!this.activeTrip) return [];
        // 每 5 個行程分一組當作一天 (簡易邏輯)
        const size = 5;
        const result = [];
        for (let i = 0; i < this.activeTrip.itinerary.length; i += size) {
          result.push(this.activeTrip.itinerary.slice(i, i + size));
        }
        return result;
      },
      totalExpensesHKD() {
        if (!this.activeTrip) return 0;
        return this.activeTrip.expenses.reduce((sum, item) => sum + (Number(item.amount) || 0), 0);
      },
      weatherDesc() {
        if (!this.weatherData) return '載入中...';
        const code = this.weatherData.weathercode;
        const map = { 0:'晴朗', 1:'多雲', 2:'陰天', 3:'毛毛雨', 45:'霧', 61:'小雨', 63:'雨', 80:'陣雨' };
        return map[code] || '多雲';
      }
    },
    watch: {
      activeTab(newTab) {
        if (newTab === 'itinerary-map') {
          // 確保 DOM 渲染完畢後再初始化地圖
          this.$nextTick(() => {
            setTimeout(() => this.forceUpdateMap(), 100); 
          });
        }
      },
      activeTripId() {
        this.fetchWeather();
        this.fetchRate();
      }
    },
    mounted() {
      this.loadData();
    },
    methods: {
      // --- Data Persistence ---
      saveData() {
        localStorage.setItem('christine_travel_diary_trips', JSON.stringify(this.trips));
      },
      loadData() {
        const saved = localStorage.getItem('christine_travel_diary_trips');
        if (saved) {
          this.trips = JSON.parse(saved);
        } else {
          // 預設旅程
          this.trips = [{
            id: Date.now(),
            title: 'Japan Trip 2025',
            destination: 'Japan',
            city: 'Tokyo',
            currency: 'JPY',
            startDate: '2025-12-24',
            endDate: '2026-01-01',
            center: { lat: 35.6895, lng: 139.6917 },
            exchangeRate: 19.2,
            flights: { outbound: {}, inbound: {} },
            itinerary: [],
            routeSummary: { distance: 0 },
            expenses: [],
            shoppingItems: []
          }];
          this.saveData();
        }
        this.activeTripId = this.trips[0].id;
        this.fetchWeather();
        this.fetchRate();
      },

      // --- Trip CRUD (Fix History Edit) ---
      openNewTripModal() {
        this.editingTripId = null;
        this.tempTrip = { title: '', destination: '', city: '', currency: 'JPY', startDate: '', endDate: '' };
        this.showTripModal = true;
      },
      openEditTripModal(trip) {
        // 深拷貝以避免直接修改
        this.editingTripId = trip.id;
        this.tempTrip = JSON.parse(JSON.stringify(trip));
        this.showTripModal = true;
      },
      async saveTrip() {
        if (!this.tempTrip.title) return alert('請輸入標題');
        
        // 嘗試抓取城市座標
        let center = { lat: 35.6895, lng: 139.6917 }; // 預設東京
        if (this.tempTrip.city) {
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${this.tempTrip.city}`);
            const data = await res.json();
            if (data[0]) center = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
          } catch(e) { console.log('Geo fail'); }
        }

        if (this.editingTripId) {
          // 編輯模式：更新現有旅程
          const index = this.trips.findIndex(t => t.id === this.editingTripId);
          if (index !== -1) {
            // 保留原本的資料 (行程、記帳等)，只更新基本資訊
            this.trips[index] = { 
              ...this.trips[index], 
              ...this.tempTrip,
              center: center // 更新中心點
            };
          }
        } else {
          // 新增模式
          const newTrip = {
            id: Date.now(),
            ...this.tempTrip,
            center,
            exchangeRate: 1,
            flights: { outbound: {}, inbound: {} },
            itinerary: [],
            expenses: [],
            shoppingItems: []
          };
          this.trips.push(newTrip);
          this.activeTripId = newTrip.id;
        }
        
        this.saveData();
        this.showTripModal = false;
        // 如果是編輯當前旅程，刷新天氣
        if (this.activeTripId === this.editingTripId) {
            this.fetchWeather();
        }
      },
      switchTrip(id) {
        this.activeTripId = id;
        this.activeTab = 'info'; // 切換後回到首頁
      },
      deleteTrip(id) {
        if (this.trips.length <= 1) return alert('至少保留一個旅程');
        if (confirm('確定刪除此旅程？無法復原。')) {
          this.trips = this.trips.filter(t => t.id !== id);
          if (this.activeTripId === id) this.activeTripId = this.trips[0].id;
          this.saveData();
        }
      },

      // --- Map & Itinerary (Fix Map Display) ---
      forceUpdateMap() {
        if (this.activeTab !== 'itinerary-map') return;
        
        // 1. 初始化地圖容器
        const mapContainer = document.getElementById('map');
        if (!mapContainer) return;
        
        // 2. 如果地圖已存在但容器大小改變，invalidateSize
        if (this.map) {
          this.map.remove(); // 徹底移除舊地圖實例以防衝突
          this.map = null;
        }

        // 3. 建立新地圖
        const center = this.activeTrip.center || [35.6895, 139.6917];
        this.map = L.map('map').setView(center, 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OSM'
        }).addTo(this.map);

        // 4. 畫路線
        this.drawRoute();
      },
      async drawRoute() {
        if (!this.activeTrip.itinerary.length) return;
        
        const coords = [];
        let totalDist = 0;

        for (let item of this.activeTrip.itinerary) {
          // 如果行程已有座標 (這裡簡化，實作上通常要先 geocode 存起來，避免每次重畫都 fetch API)
          // 這裡示範即時查 (量大會慢，建議之後優化存入 itinerary object)
          const pos = await this.getCoords(item.location);
          if (pos) {
            coords.push(pos);
            L.marker(pos).addTo(this.map)
             .bindPopup(`<b>${item.time}</b><br>${item.activity}`);
          }
        }

        if (coords.length > 1) {
          // 畫線
          L.polyline(coords, { color: '#97CBFF', weight: 5 }).addTo(this.map);
          this.map.fitBounds(coords); // 自動縮放
          
          // 計算距離
          for(let i=0; i<coords.length-1; i++) {
            totalDist += this.map.distance(coords[i], coords[i+1]);
          }
          if (!this.activeTrip.routeSummary) this.activeTrip.routeSummary = {};
          this.activeTrip.routeSummary.distance = totalDist / 1000;
          this.saveData();
        }
      },
      async getCoords(query) {
        if (!query) return null;
        try {
          // 簡單 cache 避免重複請求
          const cacheKey = `geo_${query}`;
          const cached = localStorage.getItem(cacheKey);
          if (cached) return JSON.parse(cached);

          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`);
          const data = await res.json();
          if (data[0]) {
            const pos = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
            localStorage.setItem(cacheKey, JSON.stringify(pos));
            return pos;
          }
        } catch(e) {}
        return null;
      },
      addItineraryItem() {
        this.activeTrip.itinerary.push({ 
          time: '10:00', activity: '', location: '', mapsUrl: '' 
        });
        this.saveData();
      },
      removeItineraryItem(dayIdx, idx) {
        // 計算實際 index
        const realIdx = dayIdx * 5 + idx;
        this.activeTrip.itinerary.splice(realIdx, 1);
        this.saveData();
      },
      toggleBatchImport() {
        this.showBatchImport = !this.showBatchImport;
      },
      runBatchImport() {
        const lines = this.batchImportText.split('\n').filter(l => l.trim());
        let timeH = 10;
        lines.forEach(line => {
          this.activeTrip.itinerary.push({
            time: `${timeH}:00`,
            activity: `參觀 ${line}`,
            location: line
          });
          timeH = (timeH + 1) % 24;
        });
        this.batchImportText = '';
        this.showBatchImport = false;
        this.saveData();
        this.forceUpdateMap();
      },
      openGoogleMaps(loc) {
        if(!loc) return alert('請先輸入地點');
        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}`, '_blank');
      },
      openDirections(dayIdx, idx) {
        // 導航：上一站 -> 這一站
        const flatList = this.activeTrip.itinerary;
        const realIdx = dayIdx * 5 + idx;
        if (realIdx === 0) return this.openGoogleMaps(flatList[0].location);
        
        const origin = flatList[realIdx-1].location;
        const dest = flatList[realIdx].location;
        window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}&travelmode=transit`, '_blank');
      },

      // --- Other Utilities ---
      async fetchWeather() {
        if (!this.activeTrip?.center) return;
        try {
          const { lat, lng } = this.activeTrip.center;
          const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
          const data = await res.json();
          this.weatherData = data.current_weather;
          
          const code = data.current_weather.weathercode;
          if (code < 3) this.weatherTheme = 'sunny';
          else if (code < 50) this.weatherTheme = 'cloudy';
          else this.weatherTheme = 'rainy';
          
        } catch(e) {}
      },
      async fetchRate() {
        if(!this.activeTrip) return;
        try {
          // 免費 API 範例 (注意有次數限制，若失效可換)
          const res = await fetch(`https://api.exchangerate-api.com/v4/latest/HKD`);
          const data = await res.json();
          const rate = data.rates[this.activeTrip.currency];
          if(rate) {
             this.activeTrip.exchangeRate = rate;
             this.saveData();
          }
        } catch(e) {}
      },
      async fetchFlight(type) {
        // 您的 Aviationstack 邏輯保持不變
        const flight = this.activeTrip.flights[type];
        if(!flight.no || !flight.date) return alert('請輸入航班與日期');
        try {
           const res = await fetch(`https://api.aviationstack.com/v1/flights?access_key=${AVIATIONSTACK_KEY}&flight_iata=${flight.no}`);
           const data = await res.json();
           // 簡化模擬
           if(data.data && data.data[0]) {
             const f = data.data[0];
             flight.from = f.departure.iata;
             flight.to = f.arrival.iata;
             this.saveData();
             alert('航班更新成功');
           } else {
             alert('未找到航班 (可能是免費版 API 限制)');
           }
        } catch(e) { console.log(e); }
      },
      addExpense() {
        if(!this.newExpense.name || !this.newExpense.amount) return;
        const d = new Date();
        this.activeTrip.expenses.unshift({
          ...this.newExpense,
          date: `${d.getMonth()+1}/${d.getDate()}`
        });
        this.newExpense = { name: '', amount: null, method: '現金', category: '飲食' };
        this.saveData();
      },
      addShoppingItem() {
        if(!this.newShoppingItem.name) return;
        this.activeTrip.shoppingItems.unshift({...this.newShoppingItem});
        this.newShoppingItem = { name: '', onlinePrice: '', localPrice: '', bought: false };
        this.saveData();
      },
      removeShoppingItem(idx) {
        this.activeTrip.shoppingItems.splice(idx, 1);
        this.saveData();
      }
    }
  }).mount('#app');
</script>
</body>
</html>
